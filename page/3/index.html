<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="frontzhm, zhm, huahua, hua_hua" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="hello world">
<meta property="og:type" content="website">
<meta property="og:title" content="花花的博客">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="花花的博客">
<meta property="og:description" content="hello world">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="花花的博客">
<meta name="twitter:description" content="hello world">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title> 花花的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?60f2cb5747a596a24f2a053f1650c30b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">花花的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/16/canvas_star/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/10/16/canvas_star/" itemprop="url">
                  canvas绘制五角星
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-16T10:48:52+08:00">
                2020-10-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/10/16/canvas_star/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/10/16/canvas_star/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>canvas 绘制多边形的通用步骤：</p>
<ol>
<li>找到每个点的坐标，形成路径</li>
<li>设置状态</li>
<li>绘制</li>
</ol>
<p>五角星的模样：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/star.png" alt="五角星"></p>
<p>如果遇到正某形的情况，可以借助圆来计算。<br>这边，借助两个圆寻找每个点的坐标：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/star_pos.png" alt="五角星1"></p>
<ul>
<li>五角星的外圈相邻点之间的角度是：360/5 = 72</li>
<li>同理，五角星的内圈相邻点之间的角度是：360/5 = 72</li>
<li>于是，五角星两个相邻点的之间的角度是：72/2 = 36</li>
<li>于是，五角星最右边的点和 x 轴之间的角度是：90-36-36 = 18</li>
<li>于是，直角三角形中斜边为 R，一个夹角是 18，则夹角的那边长度是<code>R*cos(18deg)</code>，非夹角的那边长度是<code>R*sin(18deg)</code></li>
<li>于是，外圈最右边的点坐标是<code>(R*cos(18deg),-R*sin(18deg))</code>，外圈往左的一个点是<code>(R*cos(18+72deg),-R*sin(18+72deg))</code>，以此类推</li>
<li>于是，内圈最右边的点坐标是<code>(r*cos(54deg),-r*sin(54deg))</code>，内圈往左的一个点是<code>(r*cos(54+72deg),-r*sin(54+72deg))</code>，以此类推</li>
</ul>
<p>这样可以写一个五角星的路径函数，这里注意 cos 函数需要另外封装下，这样更方便使用：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/canvas_star_code.png" alt="绘制五角星"></p>
<p>五角星需要旋转角度的话，修改成</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ..参数加个rotate即可</span></span><br><span class="line">ctx.lineTo(</span><br><span class="line">  R * cos(<span class="number">18</span> + i * angle - rotate) + x,</span><br><span class="line">  -R * sin(<span class="number">18</span> + i * angle - rotate) + y</span><br><span class="line">);</span><br><span class="line">ctx.lineTo(</span><br><span class="line">  r * cos(<span class="number">54</span> + i * angle - rotate) + x,</span><br><span class="line">  -r * sin(<span class="number">54</span> + i * angle - rotate) + y</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>修改 R 和 r 的值会有很多不同感觉的五角星，两者差距越大，五角星越尖锐，反之越圆润。</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"canvas"</span> <span class="attr">width</span>=<span class="string">"500"</span> <span class="attr">height</span>=<span class="string">"500"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> canvas = <span class="built_in">document</span>.querySelector(<span class="string">"#canvas"</span>);</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="comment">// 角度转化成弧度</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> getRadianFromAngle = <span class="function">(<span class="params">angle</span>) =&gt;</span> (<span class="built_in">Math</span>.PI / <span class="number">180</span>) * angle;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 封装下cos  sin</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> cos = <span class="function">(<span class="params">angle</span>) =&gt;</span> <span class="built_in">Math</span>.cos(getRadianFromAngle(angle));</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> sin = <span class="function">(<span class="params">angle</span>) =&gt;</span> <span class="built_in">Math</span>.sin(getRadianFromAngle(angle));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">getStarPath</span>(<span class="params">&#123; ctx, x, y, R, r, rotate = <span class="number">0</span> &#125;</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">    ctx.beginPath();</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> horn = <span class="number">5</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> angle = <span class="number">360</span> / horn;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; horn; i++) &#123;</span></span><br><span class="line"><span class="undefined">      ctx.lineTo( R * cos(18 + i * angle - rotate) + x, -R * sin(18 + i * angle - rotate) + y );</span></span><br><span class="line"><span class="undefined">      ctx.lineTo( r * cos(54 + i * angle - rotate) + x, -r * sin(54 + i * angle - rotate) + y );</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    ctx.closePath();</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 1.设置路径</span></span></span><br><span class="line"><span class="undefined">  getStarPath(&#123; ctx, x: 200, y: 200, R: 100, r: 50 &#125;);</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 2.设置状态</span></span></span><br><span class="line"><span class="javascript">  ctx.lineWidth = <span class="string">"3"</span>;</span></span><br><span class="line"><span class="javascript">  ctx.strokeStyle = <span class="string">"#f69"</span>;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 3.绘制</span></span></span><br><span class="line"><span class="undefined">  ctx.stroke();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><blockquote>
<p><a href="https://www.imooc.com/video/3488" target="_blank" rel="noopener">liuyubobobo 的绘制五角星 视频</a><br><a href="https://www.imooc.com/learn/133" target="_blank" rel="noopener">liuyubobobo 的 Canvas 绘图与动画基础 视频</a><br><a href="https://www.imooc.com/learn/185" target="_blank" rel="noopener">liuyubobobo 的 Canvas 绘图详解 视频</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/10/canvas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/10/10/canvas/" itemprop="url">
                  学习canvas
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-10T19:44:01+08:00">
                2020-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/10/10/canvas/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/10/10/canvas/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>canvas</code>是一个<code>HTML</code>标签，必须结合<code>JS</code>代码绘制和处理一些图形。</p>
<p>基本涉及到图片处理的相关操作，比如截图功能、合成图片、图片像素级处理、图片的动画，都可以考虑下<code>canvas</code>。</p>
<p>大名鼎鼎的<a href="https://echarts.apache.org/examples/zh/index.html" target="_blank" rel="noopener"><code>echarts</code></a>、<code>d3.js</code>、<code>three.js</code>可视化数据的这些库都是基于canvas。</p>
<p>哦，还能解决大量图片相关面试题，如实现动画时钟。</p>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd5262f51a074592a2d88fc8605a0d87~tplv-k3u1fbpfcp-zoom-1.image" alt="动画时钟"></p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li>特基础知识：创建画布、获取渲染上下文、绘制矩形、绘制三角形、绘制圆弧、绘制文本</li>
<li>设置图形的各种样式，如背景、线、颜色和透明度</li>
<li>高阶知识：缓存路径、保存和恢复状态、移动坐标原点、旋转坐标轴、缩放网格、transform的使用</li>
<li>重点-操作图像：合成、裁剪、动画、控制每个像素、上传和下载</li>
</ul>
<h2 id="创造画布"><a href="#创造画布" class="headerlink" title="创造画布"></a>创造画布</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"tutorial"</span> <span class="attr">width</span>=<span class="string">"150"</span> <span class="attr">height</span>=<span class="string">"150"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上述代码，<code>canvas</code>就创造了一个 150*150 像素的画布了。</p>
<p><code>canvas</code>和<code>img</code>看起来很像，但其只有两个<strong>特有</strong>属性<code>width</code>和<code>height</code>，默认值是 300、150。<br>因为 canvas 是一个标签元素，自然可以使用属性设置，也可使用 css 设置样式。<br><strong>注意的是，如果 CSS 的尺寸与初始画布的比例不一致，它会出现扭曲，这时候就需要明确用属性标明宽高。</strong></p>
<h2 id="获取渲染上下文"><a href="#获取渲染上下文" class="headerlink" title="获取渲染上下文"></a>获取渲染上下文</h2><p>画布创建好，要想绘制图形，需要结合 JS。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>JS 先找到画布 canvas</li>
<li>然后用 canvas 的<code>getContext()</code>，来获得渲染上下文和它的绘画功能。其参数是上下文的格式，一般都是<code>2d</code></li>
</ul>
<p>这里说个基础点，canvas 画布，想象成格子本，每个格子是 1*1 像素，左上角的点是(0,0)，其他的点都有其相应的坐标(x,y)。</p>
<h2 id="绘制矩形"><a href="#绘制矩形" class="headerlink" title="绘制矩形"></a>绘制矩形</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 这里style是为了显示画布大小，这样更好识别(x,y) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">canvas</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">"tutorial"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">width</span>=<span class="string">"150"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">height</span>=<span class="string">"150"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">style</span>=<span class="string">"border:1px solid #ccc;"</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span></span><br><span class="line"><span class="undefined">  ctx.fillRect(25, 25, 100, 100);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>fillRect(x, y, width, height)</code>，用颜色填充出一个矩形，x 和 y 是矩形左上角的坐标，width 和 height 是矩形宽高。</p>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79162ae882a34f4b8ab5d337f4fde217~tplv-k3u1fbpfcp-zoom-1.image" alt="矩形"></p>
<p>当然绘制矩形，canvas 提供三种方法，上面是一个，下面两个类似（还有一个方法在后面）</p>
<ul>
<li><code>strokeRect(x, y, width, height)</code>，用线条绘制一个矩形轮廓</li>
<li><code>clearRect(x, y, width, height)</code>，像橡皮，清除指定矩形区域，让清除部分完全透明</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line">ctx.fillRect(<span class="number">25</span>, <span class="number">25</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">ctx.clearRect(<span class="number">45</span>, <span class="number">45</span>, <span class="number">60</span>, <span class="number">60</span>);</span><br><span class="line">ctx.strokeRect(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>);</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b02fb8eb187344928c96b54903d16079~tplv-k3u1fbpfcp-zoom-1.image" alt="矩形"></p>
<h2 id="绘制三角形"><a href="#绘制三角形" class="headerlink" title="绘制三角形"></a>绘制三角形</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line">ctx.beginPath();</span><br><span class="line">ctx.moveTo(<span class="number">75</span>, <span class="number">50</span>);</span><br><span class="line">ctx.lineTo(<span class="number">100</span>, <span class="number">75</span>);</span><br><span class="line">ctx.lineTo(<span class="number">100</span>, <span class="number">25</span>);</span><br><span class="line">ctx.closePath();</span><br><span class="line">ctx.stroke();</span><br><span class="line"><span class="comment">// ctx.fill();</span></span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99509e37ec3045ec86cd97185d140561~tplv-k3u1fbpfcp-zoom-1.image" alt="三角形"></p>
<p>canvas 绘制图形，只有两种方式，就是我们见到的两种：矩形和路径(由一系列点连成的线段)。所有其他类型的图形都是通过一条或者多条路径组合而成的。</p>
<p>使用路径绘制图形的步骤：</p>
<ul>
<li>准备绘制一个新的形状路径，<code>ctx.beginPath()</code></li>
<li>将笔触移动到指定位置，<code>ctx.moveTo(75, 50)</code></li>
<li>绘制从当前位置到指定位置的直线。<code>ctx.lineTo(100, 75)</code>;</li>
<li>绘制从当前位置到起始笔触的直线，形成封闭图形，路径结束，<code>ctx.closePath()</code></li>
<li>一旦路径生成，你就能通过描边或填充路径区域来渲染图形，<code>ctx.fill()</code>或<code>ctx.stroke()</code></li>
</ul>
<p>小提示，调用 fill()函数时，所有没有闭合的形状都会自动闭合，所以可省略 closePath()，但 stroke 不行哟。</p>
<p>想绘制两个三角形的话，重新启动<code>beginPath</code>开始画就可以了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...之前代码</span></span><br><span class="line">ctx.beginPath();</span><br><span class="line">ctx.moveTo(<span class="number">150</span>, <span class="number">150</span>);</span><br><span class="line">ctx.lineTo(<span class="number">150</span>, <span class="number">40</span>);</span><br><span class="line">ctx.lineTo(<span class="number">50</span>, <span class="number">150</span>);</span><br><span class="line">ctx.closePath();</span><br><span class="line">ctx.fill();</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/53f8095cc5664fc4984c9d590ecdd739~tplv-k3u1fbpfcp-zoom-1.image" alt="三角形"></p>
<h2 id="绘制圆弧"><a href="#绘制圆弧" class="headerlink" title="绘制圆弧"></a>绘制圆弧</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 角度换算成弧度</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRadianFromAngle</span>(<span class="params">angle</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">Math</span>.PI / <span class="number">180</span>) * angle;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line">ctx.beginPath();</span><br><span class="line"><span class="comment">// 顺时针</span></span><br><span class="line">ctx.arc(<span class="number">75</span>, <span class="number">75</span>, <span class="number">32</span>, <span class="number">0</span>, getRadianFromAngle(<span class="number">90</span>), <span class="literal">false</span>);</span><br><span class="line">ctx.closePath();</span><br><span class="line">ctx.stroke();</span><br><span class="line"></span><br><span class="line">ctx.beginPath();</span><br><span class="line"><span class="comment">// 逆时针</span></span><br><span class="line">ctx.arc(<span class="number">75</span>, <span class="number">75</span>, <span class="number">32</span>, <span class="number">0</span>, getRadianFromAngle(<span class="number">135</span>), <span class="literal">true</span>);</span><br><span class="line">ctx.closePath();</span><br><span class="line">ctx.fill();</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a60e4bb6a1b4cd2887869a188429a78~tplv-k3u1fbpfcp-zoom-1.image" alt="弧形"></p>
<p><code>arc(x, y, radius, startRadian, endRadian, anticlockwise)</code>，画一个以<code>（x,y）</code>为圆心的以<code>radius</code>为半径的圆弧（圆），从<code>startRadian</code>开始到<code>endRadian</code>结束，按照<code>anticlockwise</code>给定的方向（anti 是反对的，clockwise 顺时针的，anticlockwise 逆时针，默认值是 false 也就是顺时针）来生成。</p>
<p>说人话：想象拿一个圆规，先确定圆心，圆规一个脚站好，在确定半径，圆规另一个脚拉开特定距离。0 度是圆心的右边，90 度是圆心的下边，180 度是圆心的左边，270 度是圆心的上边，360 度回归右边。画 0 到 90 度，顺时针的话是 1/4 圆，逆时针的话是 3/4 的圆，想象圆规开始画的情景。</p>
<p>注意这里的 arc 只是绘制路径，想要看到需要借助 fill 或者 stroke。</p>
<p>同理，这里说下矩形的另一个方法，<code>rect(x, y, width, height)</code>，相比<code>fillRect(x, y, width, height)</code>不一样的是，<code>fillRect</code>是自动填充出一个矩形，这里的<code>rect</code>只是绘制出路径，还需要用<code>fill</code>或<code>stroke</code>才能看到矩形。换言之，<code>fillRect = rect +fill</code>和<code>strokeRect = rect + stroke</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx.rect(<span class="number">25</span>, <span class="number">25</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">ctx.fill();</span><br></pre></td></tr></table></figure>
<h2 id="绘制文本"><a href="#绘制文本" class="headerlink" title="绘制文本"></a>绘制文本</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line">ctx.font = <span class="string">"28px serif"</span>;</span><br><span class="line">ctx.fillText(<span class="string">"Hello world"</span>, <span class="number">10</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">ctx.font = <span class="string">"28px serif"</span>;</span><br><span class="line">ctx.strokeText(<span class="string">"Hello world"</span>, <span class="number">10</span>, <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> text = ctx.measureText(<span class="string">"foo"</span>);</span><br><span class="line"><span class="comment">// 37</span></span><br><span class="line"><span class="built_in">console</span>.log(text.width);</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9777986d70049c1b2d94f861e62c84c~tplv-k3u1fbpfcp-zoom-1.image" alt="字"></p>
<ul>
<li><code>fillText(text, x, y [, maxWidth])</code>在指定的(x,y)位置填充指定的文本，绘制的最大宽度是可选的.</li>
<li><code>strokeText(text, x, y [, maxWidth])</code>在指定的(x,y)位置绘制文本边框，绘制的最大宽度是可选的.</li>
<li><code>measureText()</code>返回一个 TextMetrics 对象的宽度所在像素，这些体现文本特性的属性。</li>
<li><code>font = value</code>，用来绘制文本的样式. 这个字符串使用和 CSS font 属性相同的语法. 默认的字体是 <code>10px sans-serif</code>。</li>
<li><code>textAlign = value</code>，文本对齐选项. 可选的值包括：start, end, left, right or center. 默认值是 start。</li>
<li><code>textBaseline = value</code>，基线对齐选项. 可选的值包括：top, hanging, middle, alphabetic, ideographic, bottom。默认值是 alphabetic。</li>
<li><code>direction = value</code>，文本方向。可能的值包括：ltr, rtl, inherit。默认值是 inherit。</li>
<li><code>shadowOffsetX = float</code> 设定阴影在 X 轴的延伸距离，它们是不受变换矩阵所影响的。负值表示阴影会往上或左延伸，正值则表示会往下或右延伸，默认为 0。</li>
<li><code>shadowOffsetY = float</code> 设定阴影在 Y 轴的延伸距离，它们是不受变换矩阵所影响的。负值表示阴影会往上或左延伸，正值则表示会往下或右延伸，默认为 0。</li>
<li><code>shadowBlur = float</code>用于设定阴影的模糊程度，其数值并不跟像素数量挂钩，也不受变换矩阵的影响，默认为 0。</li>
<li><code>shadowColor = color</code>用于设定阴影颜色效果，默认是全透明的黑色。</li>
</ul>
<h2 id="设置不同的颜色和透明度"><a href="#设置不同的颜色和透明度" class="headerlink" title="设置不同的颜色和透明度"></a>设置不同的颜色和透明度</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"><span class="comment">// 必须提前写好颜色</span></span><br><span class="line">ctx.fillStyle = <span class="string">"rgba(0,255,0,0.5)"</span>;</span><br><span class="line">ctx.rect(<span class="number">25</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br><span class="line">ctx.fill();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ！！！这里需要重置下路径哈，不然会和上面的混合在一起了</span></span><br><span class="line">ctx.beginPath();</span><br><span class="line">ctx.strokeStyle = <span class="string">"#FF0000"</span>;</span><br><span class="line">ctx.globalAlpha = <span class="number">0.5</span>;</span><br><span class="line">ctx.rect(<span class="number">80</span>, <span class="number">80</span>, <span class="number">40</span>, <span class="number">40</span>);</span><br><span class="line">ctx.stroke();</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd332799af824990b468c35506ec40db~tplv-k3u1fbpfcp-zoom-1.image" alt="色"></p>
<p>前期的 fill 和 stroke 都是黑色，需要别的颜色其实也很简单，想象你拿画笔，先选择特定颜色的画笔，然后画画就是特定颜色的了。这里的颜色同 css 的颜色，可以<code>#ff0000</code>、<code>red</code>、<code>rgba(255,0,0,0.5)</code>等。</p>
<ul>
<li>fillStyle = color</li>
<li>strokeStyle = color</li>
<li>透明度的话，一个是 rgba 模式，还有一个是<code>globalAlpha = 某数值</code></li>
</ul>
<h3 id="设置渐变色"><a href="#设置渐变色" class="headerlink" title="设置渐变色"></a>设置渐变色</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> lineGrad = ctx.createLinearGradient(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">150</span>);</span><br><span class="line">lineGrad.addColorStop(<span class="number">0</span>, <span class="string">"#00ABEB"</span>);</span><br><span class="line">lineGrad.addColorStop(<span class="number">0.5</span>, <span class="string">"#fff"</span>);</span><br><span class="line">lineGrad.addColorStop(<span class="number">0.5</span>, <span class="string">"#26C000"</span>);</span><br><span class="line">lineGrad.addColorStop(<span class="number">1</span>, <span class="string">"#fff"</span>);</span><br><span class="line"></span><br><span class="line">ctx.strokeStyle = lineGrad;</span><br><span class="line">ctx.rect(<span class="number">10</span>, <span class="number">10</span>, <span class="number">130</span>, <span class="number">130</span>);</span><br><span class="line">ctx.stroke();</span><br><span class="line"></span><br><span class="line">ctx.beginPath();</span><br><span class="line"><span class="comment">// 径向渐变</span></span><br><span class="line"><span class="keyword">var</span> radialGrad = ctx.createRadialGradient(<span class="number">45</span>, <span class="number">45</span>, <span class="number">10</span>, <span class="number">52</span>, <span class="number">50</span>, <span class="number">30</span>);</span><br><span class="line">radialGrad.addColorStop(<span class="number">0</span>, <span class="string">"#A7D30C"</span>);</span><br><span class="line">radialGrad.addColorStop(<span class="number">0.9</span>, <span class="string">"#019F62"</span>);</span><br><span class="line">radialGrad.addColorStop(<span class="number">1</span>, <span class="string">"rgba(1,159,98,0)"</span>);</span><br><span class="line"></span><br><span class="line">ctx.fillStyle = radialGrad;</span><br><span class="line">ctx.rect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">150</span>, <span class="number">150</span>);</span><br><span class="line">ctx.fill();</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/28446da5a6b84ed2b10d86a313ca76a1~tplv-k3u1fbpfcp-zoom-1.image" alt="渐变色"></p>
<ul>
<li><code>createLinearGradient(x1, y1, x2, y2)</code>，(x1,y1)渐变的起点与(x2,y2)终点</li>
<li><code>createRadialGradient(x1, y1, r1, x2, y2, r2)</code>，前三个定义一个以 (x1,y1) 为原点，半径为 r1 的圆，后三个参数则定义另一个以 (x2,y2) 为原点，半径为 r2 的圆</li>
<li><code>gradient.addColorStop(position, color)</code>，position 参数必须是一个 0.0 与 1.0 之间的数值，表示渐变中颜色所在的相对位置。例如，0.5 表示颜色会出现在正中间。color 参数必须是一个有效的 CSS 颜色值（如 #FFF， rgba(0,0,0,1)，等等）。</li>
</ul>
<h3 id="设置图案填充"><a href="#设置图案填充" class="headerlink" title="设置图案填充"></a>设置图案填充</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建新 image 对象，用作图案</span></span><br><span class="line"><span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span><br><span class="line">img.src = <span class="string">"https://mdn.mozillademos.org/files/222/Canvas_createpattern.png"</span>;</span><br><span class="line">img.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建图案</span></span><br><span class="line">  <span class="keyword">var</span> ptn = ctx.createPattern(img, <span class="string">"repeat"</span>);</span><br><span class="line">  ctx.fillStyle = ptn;</span><br><span class="line">  ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">150</span>, <span class="number">150</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ab70e739d9347bb89d9557c9edde1e6~tplv-k3u1fbpfcp-zoom-1.image" alt="图案"></p>
<p><code>createPattern(image, type)</code>，Image 可以是一个 Image 对象的引用，或者另一个 canvas 对象。Type 必须是下面的字符串值之一：<code>repeat，repeat-x，repeat-y 和 no-repeat</code>。</p>
<h2 id="设置线段的样式"><a href="#设置线段的样式" class="headerlink" title="设置线段的样式"></a>设置线段的样式</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line">ctx.lineWidth = <span class="number">10</span>;</span><br><span class="line">ctx.lineJoin = <span class="string">"round"</span>;</span><br><span class="line">ctx.setLineDash([<span class="number">40</span>, <span class="number">2</span>]);</span><br><span class="line">ctx.rect(<span class="number">20</span>, <span class="number">20</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">ctx.stroke();</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31824f810b1f4f95b904b3a1422dbb02~tplv-k3u1fbpfcp-zoom-1.image" alt="线段"></p>
<p>线段的样式有以下，需要的时候，细细研究下即可：</p>
<ul>
<li>lineWidth 线宽，是给定路径的中心到两边的粗细，注意最左边的以及所有宽度为奇数的线并不能精确呈现，这就是因为路径的定位问题。就是线宽的时候，需要考虑定位的问题。默认是 1。</li>
<li>lineCap 线端样式，butt，round 和 square。线端两端的帽子，butt 表示没帽子，round 是半圆帽子，square 是方块帽子。默认是 butt。</li>
<li>lineJoin 线端连接处样式，round, bevel 和 miter。连接处是怎么处理的，round 是边角被磨圆，bevel 是水平，miters 默认是 miter。</li>
<li>用 setLineDash 方法和 lineDashOffset 属性来制定虚线样式， setLineDash 方法接受一个数组，来指定线段与间隙的交替；lineDashOffset 属性设置起始偏移量。这个主要用在动画里。</li>
</ul>
<h2 id="缓存路径"><a href="#缓存路径" class="headerlink" title="缓存路径"></a>缓存路径</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"><span class="comment">// 先存矩形路径</span></span><br><span class="line"><span class="keyword">var</span> rectangle = <span class="keyword">new</span> Path2D();</span><br><span class="line">rectangle.rect(<span class="number">10</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> circle = <span class="keyword">new</span> Path2D();</span><br><span class="line">circle.moveTo(<span class="number">125</span>, <span class="number">35</span>);</span><br><span class="line">circle.arc(<span class="number">100</span>, <span class="number">35</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI);</span><br><span class="line"><span class="comment">// 后期显示</span></span><br><span class="line">ctx.stroke(rectangle);</span><br><span class="line">ctx.fill(circle);</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/53ab504cecfc4fbda07cfae9dd927071~tplv-k3u1fbpfcp-zoom-1.image" alt="路径"></p>
<p><code>Path2D</code>对象，用来缓存或记录绘画命令，这样能快速地回顾路径。所有的路径方法比如 moveTo, rect, arc 等，都可以在 Path2D 中使用。</p>
<h2 id="保存状态和恢复状态"><a href="#保存状态和恢复状态" class="headerlink" title="保存状态和恢复状态"></a>保存状态和恢复状态</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 画黑色，保存状态</span></span><br><span class="line">ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">150</span>, <span class="number">150</span>);</span><br><span class="line">ctx.save();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 换蓝色画一个，再保存状态</span></span><br><span class="line">ctx.fillStyle = <span class="string">"#09F"</span>;</span><br><span class="line">ctx.fillRect(<span class="number">15</span>, <span class="number">15</span>, <span class="number">120</span>, <span class="number">120</span>);</span><br><span class="line">ctx.save();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 换白色画一个，不保存状态</span></span><br><span class="line">ctx.fillStyle = <span class="string">"#FFF"</span>;</span><br><span class="line">ctx.globalAlpha = <span class="number">0.5</span>;</span><br><span class="line">ctx.fillRect(<span class="number">30</span>, <span class="number">30</span>, <span class="number">90</span>, <span class="number">90</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恢复上一个状态，也就是蓝色</span></span><br><span class="line">ctx.restore();</span><br><span class="line">ctx.fillRect(<span class="number">45</span>, <span class="number">45</span>, <span class="number">60</span>, <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恢复上上一个状态，也就是黑色</span></span><br><span class="line">ctx.restore();</span><br><span class="line">ctx.fillRect(<span class="number">60</span>, <span class="number">60</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/467277f838984009a5295901fd1807c1~tplv-k3u1fbpfcp-zoom-1.image" alt="保存和恢复状态"></p>
<p>Canvas 的状态就是当前画面应用的所有样式和变形的一个快照，而保存状态和恢复状态是绘制复杂图形时必不可少的方法：</p>
<ul>
<li><code>save()</code>，保存画布(canvas)的所有状态，无参数。当<code>save()</code>方法被调用后，当前的状态就被推送到栈中保存。状态包括之前提到过的各种属性、变形、裁切路径。</li>
<li><code>restore()</code>，恢复 canvas 状态，无参数。当<code>restore()</code>方法被调用后，上一个保存的状态就从栈中弹出，相应的设定都恢复。</li>
</ul>
<h2 id="移动坐标原点"><a href="#移动坐标原点" class="headerlink" title="移动坐标原点"></a>移动坐标原点</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// 将原始状态保存</span></span><br><span class="line">  ctx.save();</span><br><span class="line">  <span class="comment">// 移动原点，画方块</span></span><br><span class="line">  drawSquare(i);</span><br><span class="line">  <span class="comment">// 画完之后，重置回到原始状态</span></span><br><span class="line">  ctx.restore();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">drawSquare</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">  ctx.fillStyle = <span class="string">"#f69"</span>;</span><br><span class="line">  <span class="comment">// 移动原点</span></span><br><span class="line">  ctx.translate(<span class="number">10</span>, <span class="number">10</span> + i * <span class="number">50</span>);</span><br><span class="line">  <span class="comment">// 始终在(0,0)画</span></span><br><span class="line">  ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">25</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c2f772dfae9049dc896e26feb40f7498~tplv-k3u1fbpfcp-zoom-1.image" alt="移动原点2"><br><code>translate(x, y)</code>，x 是左右偏移量，y 是上下偏移量，如下图所示。<br><strong>移动原点前记得保存状态，这样方便恢复状态，不然最后你可能会走到外太空。</strong><br>移动 canvas 原点的好处：调整坐标之后，可以不用调整绘制的位置，这样很多时候更好理解和循环使用。<br><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/581c20c6b28a49328b01a8cec67de48b~tplv-k3u1fbpfcp-zoom-1.image" alt="移动原点"></p>
<h2 id="旋转坐标轴"><a href="#旋转坐标轴" class="headerlink" title="旋转坐标轴"></a>旋转坐标轴</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// 将原始状态保存</span></span><br><span class="line">  ctx.save();</span><br><span class="line">  <span class="comment">// 旋转坐标轴，画方块</span></span><br><span class="line">  drawSquare(i);</span><br><span class="line">  <span class="comment">// 画完之后，重置回到原始状态</span></span><br><span class="line">  ctx.restore();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 角度换算成弧度</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRadianFromAngle</span>(<span class="params">angle</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">Math</span>.PI / <span class="number">180</span>) * angle;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">drawSquare</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">  ctx.fillStyle = <span class="string">`rgb(<span class="subst">$&#123;<span class="number">51</span> * i&#125;</span>,<span class="subst">$&#123;<span class="number">255</span> - <span class="number">51</span> * i&#125;</span>,255)`</span>;</span><br><span class="line">  <span class="comment">// 旋转坐标轴</span></span><br><span class="line">  ctx.rotate(getRadianFromAngle(<span class="number">30</span> * i));</span><br><span class="line">  <span class="comment">// 始终在(0,0)画</span></span><br><span class="line">  ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">80</span>, <span class="number">80</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cca6cf3b5cc642438bf908b0eb5205f5~tplv-k3u1fbpfcp-zoom-1.image" alt="旋转坐标轴"></p>
<p><code>rotate(radian)</code>，旋转坐标轴的角度(以弧度为单位)，它是顺时针方向的。旋转的中心点始终是坐标原点，如果要改变它，我们需要用到 <code>translate</code> 方法。同样记得旋转前保存下状态。</p>
<h2 id="缩放网格"><a href="#缩放网格" class="headerlink" title="缩放网格"></a>缩放网格</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// 将原始状态保存</span></span><br><span class="line">  ctx.save();</span><br><span class="line">  <span class="comment">// 缩放网格，画方块</span></span><br><span class="line">  drawSquare(i);</span><br><span class="line">  <span class="comment">// 画完之后，重置回到原始状态</span></span><br><span class="line">  ctx.restore();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">drawSquare</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">  ctx.fillStyle = <span class="string">`rgb(<span class="subst">$&#123;<span class="number">51</span> * i&#125;</span>,<span class="subst">$&#123;<span class="number">255</span> - <span class="number">51</span> * i&#125;</span>,255)`</span>;</span><br><span class="line">  <span class="comment">// 缩放网格</span></span><br><span class="line">  ctx.scale(<span class="number">1</span>, (i + <span class="number">1</span>) * <span class="number">1</span>);</span><br><span class="line">  <span class="comment">// 同样是20*20，但是y轴上的1个网格本来表示1px,现在就相当于缩放的像素，表面看竖直方向被拉伸</span></span><br><span class="line">  ctx.fillRect(<span class="number">0</span>, <span class="number">10</span> * i, <span class="number">20</span>, <span class="number">20</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/28496e2291b34afc9ccc2ac9b12b5bfe~tplv-k3u1fbpfcp-zoom-1.image" alt="缩放网格"></p>
<p><code>scale(x, y)</code>，可以缩放画布的水平和垂直的单位。两个参数都是实数，可以为负数，x 为水平缩放因子，y 为垂直缩放因子，如果比 1 小，会比缩放图形， 如果比 1 大会放大图形。默认值为 1， 为实际大小。<br>画布初始情况下， 是以左上角坐标为原点的第一象限。如果参数为负实数， 相当于以 x 或 y 轴作为对称轴镜像反转（例如， 使用 translate(0,canvas.height); scale(1,-1); 以 y 轴作为对称轴镜像反转， 就可得到著名的笛卡尔坐标系，左下角为原点）。</p>
<h2 id="一次性设置原点、旋转、缩放"><a href="#一次性设置原点、旋转、缩放" class="headerlink" title="一次性设置原点、旋转、缩放"></a>一次性设置原点、旋转、缩放</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">drawSquare</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">  ctx.fillStyle = <span class="string">`rgb(<span class="subst">$&#123;<span class="number">51</span> * i&#125;</span>,<span class="subst">$&#123;<span class="number">255</span> - <span class="number">51</span> * i&#125;</span>,255)`</span>;</span><br><span class="line">  <span class="comment">// 缩放网格</span></span><br><span class="line">  <span class="comment">// ctx.scale(1,(i+1)*1);</span></span><br><span class="line">  <span class="comment">// 等同于</span></span><br><span class="line">  ctx.transform(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, (i + <span class="number">1</span>) * <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  ctx.fillRect(<span class="number">0</span>, <span class="number">10</span> * i, <span class="number">20</span>, <span class="number">20</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>transform(a, b, c, d, e, f)</code>，这个方法是将当前的变形矩阵乘上一个基于自身参数的矩阵。a 水平方向的缩放，b 竖直方向的倾斜偏移，c 水平方向的倾斜偏移，d 竖直方向的缩放，e(dx)水平方向的移动，f(dy) 竖直方向的移动。如果任意一个参数是 Infinity，变形矩阵也必须被标记为无限大，否则会抛出异常。</li>
<li><code>setTransform(a, b, c, d, e, f)</code>，这个方法会将当前的变形矩阵重置为单位矩阵，然后用相同的参数调用 <code>transform</code> 方法。从根本上来说，该方法是取消了当前变形,然后设置为指定的变形,一步完成。</li>
<li><code>resetTransform()</code>重置当前变形为单位矩阵，它和调用以下语句是一样的：<code>ctx.setTransform(1, 0, 0, 1, 0, 0)</code>;</li>
</ul>
<h2 id="操作图像"><a href="#操作图像" class="headerlink" title="操作图像"></a>操作图像</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式</span></span><br><span class="line"><span class="comment">// html那边加一行代码    &lt;img id='canvasImg' style='display: none;' src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/avatar-panda.png" alt=""&gt;</span></span><br><span class="line"><span class="keyword">var</span> domImg = <span class="built_in">document</span>.querySelector(<span class="string">"#canvasImg"</span>);</span><br><span class="line">domImg.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 图片放在哪</span></span><br><span class="line">  ctx.drawImage(domImg, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式</span></span><br><span class="line"><span class="keyword">var</span> urlImg = <span class="keyword">new</span> Image();</span><br><span class="line"><span class="comment">// 这里的src可以是</span></span><br><span class="line">urlImg.src =</span><br><span class="line">  <span class="string">"https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/avatar-panda.png"</span>;</span><br><span class="line">urlImg.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 图片放在哪，图片可以设置宽高</span></span><br><span class="line">  ctx.drawImage(urlImg, <span class="number">100</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">50</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式</span></span><br><span class="line"><span class="keyword">var</span> urlImg2 = <span class="keyword">new</span> Image();</span><br><span class="line">urlImg2.src =</span><br><span class="line">  <span class="string">"https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/avatar-panda.png"</span>;</span><br><span class="line">urlImg2.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 前四个参数是在原图片上，先找到剪切的点比如这里从图片左上角开始，然后剪切多长多宽如这里是50长宽</span></span><br><span class="line">  <span class="comment">// 后四个参数是将刚刚切出来的图片，放在画布的哪个位置比如100/60，然后在画布上面图片的宽高(比例不对图片会被拉伸)比如25/50</span></span><br><span class="line">  ctx.drawImage(urlImg2, <span class="number">0</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">100</span>, <span class="number">60</span>, <span class="number">25</span>, <span class="number">50</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8c6ae51dfc2a4a89ae7a21446ae4b1dd~tplv-k3u1fbpfcp-zoom-1.image" alt="图像"><br>操作图像是 canvas 很重要的能力，可以合成新的图片等等。</p>
<p>引入图像到 canvas 需要两个步骤：</p>
<ul>
<li>1.获取图片源，图片源可以是<ul>
<li>已存在的 canvas</li>
<li>已存在的 img 元素，</li>
<li>也可以创建 Image 元素，其中的 src 可以是<code>相对地址、绝对地址、data:url、视频的某帧</code></li>
</ul>
</li>
<li>2.使用 drawImage()函数将图片绘制到画布上，drawImage 有三种使用方式<ul>
<li><code>context.drawImage(img,x,y);</code>，在画布上定位图像</li>
<li><code>context.drawImage(img,x,y,width,height);</code>，在画布上定位图像，并规定图像的宽度和高度</li>
<li><code>context.drawImage(img,sx,sy,swidth,sheight,x,y,width,height)</code>，剪切图像，并在画布上定位被剪切的部分(s 是 slice 切片的意思)。</li>
</ul>
</li>
</ul>
<h2 id="合成和裁剪"><a href="#合成和裁剪" class="headerlink" title="合成和裁剪"></a>合成和裁剪</h2><h3 id="合成"><a href="#合成" class="headerlink" title="合成"></a>合成</h3><p><code>globalCompositeOperation = type</code>，如何将一个源（新的）图像绘制到目标（已有）的图像上。，其值是一个标识 12 种遮盖方式的字符串。默认值是<code>source-over</code>，在目标图像上显示源图像。<br><a href="https://www.w3school.com.cn/tags/canvas_globalcompositeoperation.asp" target="_blank" rel="noopener">w3school 的对 12 种绘制方式解释的很到位</a></p>
<h3 id="裁剪"><a href="#裁剪" class="headerlink" title="裁剪"></a>裁剪</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"><span class="comment">// 如果准备裁剪，先存下初始状态，以方便重置</span></span><br><span class="line">ctx.save();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 画一个矩形轮廓</span></span><br><span class="line">ctx.rect(<span class="number">50</span>, <span class="number">50</span>, <span class="number">40</span>, <span class="number">40</span>);</span><br><span class="line">ctx.stroke();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用clip就表示之后的绘图，只有矩形范围内的才能看见</span></span><br><span class="line">ctx.clip();</span><br><span class="line"></span><br><span class="line">ctx.beginPath();</span><br><span class="line"><span class="comment">// 虽然矩形外也有，但是看不见</span></span><br><span class="line">ctx.rect(<span class="number">40</span>, <span class="number">40</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br><span class="line">ctx.fill();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恢复初始状态</span></span><br><span class="line">ctx.restore();</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75c72f2906934832bb2d2e2b8c7059b1~tplv-k3u1fbpfcp-zoom-1.image" alt="裁剪"></p>
<p><code>clip()</code>将当前正在构建的路径转换为当前的裁剪路径，之后的绘图只会显示在裁剪路径内。在特定区域里绘制图形时相当好用。<br>一旦剪切了某个区域，则所有之后的绘图都会被限制在被剪切的区域内（不能访问画布上的其他区域）。所以使用 <code>clip()</code> 方法前保存状态，方便之后恢复。</p>
<h2 id="动起来"><a href="#动起来" class="headerlink" title="动起来"></a>动起来</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"><span class="comment">// 用对象将球的属性存起来，也方便使用</span></span><br><span class="line"><span class="keyword">var</span> ball = &#123;</span><br><span class="line">  x: <span class="number">10</span>,</span><br><span class="line">  y: <span class="number">10</span>,</span><br><span class="line">  vx: <span class="number">5</span>,</span><br><span class="line">  vy: <span class="number">5</span>,</span><br><span class="line">  radius: <span class="number">10</span>,</span><br><span class="line">  color: <span class="string">"#f69"</span>,</span><br><span class="line">  draw() &#123;</span><br><span class="line">    ctx.beginPath();</span><br><span class="line">    <span class="comment">// 画圆</span></span><br><span class="line">    ctx.arc(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, <span class="keyword">this</span>.radius, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>, <span class="literal">true</span>);</span><br><span class="line">    ctx.closePath();</span><br><span class="line">    ctx.fillStyle = <span class="keyword">this</span>.color;</span><br><span class="line">    ctx.fill();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> raf;</span><br><span class="line"><span class="comment">// 画每帧的关键函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 清除画布</span></span><br><span class="line">  ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</span><br><span class="line">  ball.draw();</span><br><span class="line">  <span class="comment">// 设置小球的下一次位置</span></span><br><span class="line">  ball.x += ball.vx;</span><br><span class="line">  ball.y += ball.vy;</span><br><span class="line">  <span class="comment">// 动画的关键</span></span><br><span class="line">  raf = <span class="built_in">window</span>.requestAnimationFrame(draw);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 小球先显示出来</span></span><br><span class="line">ball.draw();</span><br><span class="line"><span class="comment">// 鼠标在canvas的时候，动画启动</span></span><br><span class="line">canvas.addEventListener(<span class="string">"mouseover"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  raf = <span class="built_in">window</span>.requestAnimationFrame(draw);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 动画取消</span></span><br><span class="line">canvas.addEventListener(<span class="string">"mouseout"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.cancelAnimationFrame(raf);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93aa4abc814c41b0b8cce521e5da6b2d~tplv-k3u1fbpfcp-zoom-1.image" alt="动画"></p>
<p>canvas 做动画也是挺炫酷的，做动画的基本步骤：</p>
<ul>
<li>清空 canvas。一般动画一帧一帧的画，如果不需要上一帧的话，直接清除整个画布即可<code>ctx.clearRect(0, 0, canvas.width, canvas.height);</code></li>
<li>适当保存 canvas 的状态。如果画图形的时候涉及到样式变形之类的，记得要保存状态，以便随时恢复。</li>
<li>绘制每帧。这步大概率是重复进行的，以此实现动画的效果 setTimeout/setInterval/requestAnimationFrame</li>
<li>恢复 canvas 的状态</li>
</ul>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial/Advanced_animations" target="_blank" rel="noopener">当然还可以增加边界、加速度以及有个酷酷的小尾巴。</a> 其他精彩动画，如实现时钟、贪吃蛇之类的也有详细代码。</p>
<h2 id="控制每个像素的颜色"><a href="#控制每个像素的颜色" class="headerlink" title="控制每个像素的颜色"></a>控制每个像素的颜色</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"><span class="comment">// 创建10*10像素的图片数据，data是数组，100*100*4的长度</span></span><br><span class="line"><span class="keyword">var</span> imgData = ctx.createImageData(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line"><span class="comment">// 每四项表示一个像素的颜色，分别表示rgba，换言之imgData.data.length始终是总网格的4倍</span></span><br><span class="line"><span class="built_in">console</span>.log(imgData);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; imgData.data.length; i += <span class="number">4</span>) &#123;</span><br><span class="line">  setGridColor(imgData, i, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">  <span class="comment">// 超过一半就换个颜色</span></span><br><span class="line">  <span class="keyword">if</span> (i &gt;= imgData.data.length / <span class="number">2</span>) &#123;</span><br><span class="line">    setGridColor(imgData, i, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">ctx.putImageData(imgData, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [0,255,0,255]</span></span><br><span class="line"><span class="built_in">console</span>.log(getGridColor(imgData, <span class="number">11</span>, <span class="number">11</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 得到位于(100,100)位置的10*10像素的图像数据</span></span><br><span class="line"><span class="keyword">var</span> specialImgData = ctx.getImageData(<span class="number">100</span>, <span class="number">100</span>, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line"><span class="comment">// 将其变成蓝色</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; specialImgData.data.length; i += <span class="number">4</span>) &#123;</span><br><span class="line">  setGridColor(specialImgData, i, <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 再次填充到画布上，其实这样就可以对图片进行各种滤镜处理之类的了</span></span><br><span class="line">ctx.putImageData(specialImgData, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line"><span class="built_in">console</span>.log();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置某个网格的颜色信息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setGridColor</span>(<span class="params">imgData, i, r, g, b, a</span>) </span>&#123;</span><br><span class="line">  imgData.data[i + <span class="number">0</span>] = r;</span><br><span class="line">  imgData.data[i + <span class="number">1</span>] = g;</span><br><span class="line">  imgData.data[i + <span class="number">2</span>] = b;</span><br><span class="line">  imgData.data[i + <span class="number">3</span>] = a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 得到某行某列的特定网格的像素信息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getGridColor</span>(<span class="params">imageData, row, column</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> rIndex = row * (imageData.width * <span class="number">4</span>) + column * <span class="number">4</span> + <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> imageData.data.slice(rIndex, rIndex + <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 设置特定某行某列网格的颜色信息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setSpecialGridColor</span>(<span class="params">imageData, row, column, r, g, b, a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> rIndex = row * (imageData.width * <span class="number">4</span>) + column * <span class="number">4</span> + <span class="number">0</span>;</span><br><span class="line">  imageData.data[rIndex] = r;</span><br><span class="line">  imageData.data[rIndex + <span class="number">1</span>] = g;</span><br><span class="line">  imageData.data[rIndex + <span class="number">2</span>] = b;</span><br><span class="line">  imageData.data[rIndex + <span class="number">3</span>] = a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ede9331cd21b4e3b84f51098dca2d700~tplv-k3u1fbpfcp-zoom-1.image" alt="像素控制"></p>
<ul>
<li><code>createImageData(width,height)</code> 方法创建新的空白 ImageData 对象。ImageData 的<code>data</code>存了所有的像素信息，是一个数组，每四项对应一个像素的 rgba 信息(a 的话 0 是透明，255 是完全可见)，默认是(0,0,0,0)。如数组的 0,1,2,3 对应第一个像素，4,5,6,7 对应第二个像素。 长度是<code>高度 × 宽度 × 4</code> ，索引值从 0 到<code>长度-1</code></li>
<li><code>putImageData(imgData,x,y)</code> 方法将图像数据（从指定的 ImageData 对象）放回画布特定位置上</li>
<li><code>getImageData(left, top, width, height)</code>，这个方法会返回一个 ImageData 对象，它代表了画布区域的对象数据，此画布的四个角落分别表示为(left, top), (left + width, top), (left, top + height), 以及(left + width, top + height)四个点。这些坐标点被设定为画布坐标空间元素。</li>
</ul>
<!-- ## 反锯齿

默认反锯齿是开启的。`imageSmoothingEnabled` -->
<h2 id="上传和下载-canvas-绘制的图片"><a href="#上传和下载-canvas-绘制的图片" class="headerlink" title="上传和下载 canvas 绘制的图片"></a>上传和下载 canvas 绘制的图片</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"tutorial"</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line">ctx.fillRect(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取图片的base64</span></span><br><span class="line"><span class="keyword">var</span> base64 = canvas.toDataURL(<span class="string">"image/png"</span>, <span class="number">1</span>);</span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">"#canvasImg"</span>).src = base64;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(base64);</span><br><span class="line"><span class="comment">// 也可以下载到本地</span></span><br><span class="line"><span class="comment">// openDownloadDialog(base64, `随便起名.png`);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以拿到blob对象，像File那样处理</span></span><br><span class="line">canvas.toBlob(<span class="function"><span class="params">blobObj</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(blobObj);</span><br><span class="line">  <span class="comment">// 当然也可以下载到本地</span></span><br><span class="line">  openDownloadDialog(blobObj, <span class="string">`随便起名blob.png`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里的blob可以是blob文件也可以是base64</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">openDownloadDialog</span>(<span class="params">blob, fileName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> blob === <span class="string">"object"</span> &amp;&amp; blob <span class="keyword">instanceof</span> Blob) &#123;</span><br><span class="line">    blob = URL.createObjectURL(blob); <span class="comment">// 创建blob地址</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> aLink = <span class="built_in">document</span>.createElement(<span class="string">"a"</span>);</span><br><span class="line">  aLink.href = blob;</span><br><span class="line">  <span class="comment">// HTML5新增的属性，指定保存文件名，可以不要后缀，注意，有时候 file:///模式下不会生效</span></span><br><span class="line">  aLink.download = fileName || <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">var</span> event;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.MouseEvent) event = <span class="keyword">new</span> MouseEvent(<span class="string">"click"</span>);</span><br><span class="line">  <span class="comment">// 移动端</span></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    event = <span class="built_in">document</span>.createEvent(<span class="string">"MouseEvents"</span>);</span><br><span class="line">    event.initMouseEvent( <span class="string">"click"</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="built_in">window</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">null</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  aLink.dispatchEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/745d2a9741fc4178b177596de740c146~tplv-k3u1fbpfcp-zoom-1.image" alt="保存和下载"></p>
<ul>
<li><code>canvas.toDataURL(&#39;image/png&#39;)</code>，默认设定。创建一个PNG图片。</li>
<li><code>canvas.toDataURL(&#39;image/jpeg&#39;, quality)</code>，创建一个JPG图片。可以有选择地提供从0到1的品质量，1表示最好品质，0基本不被辨析但有比较小的文件大小。</li>
<li><code>canvas.toBlob(callback, type, encoderOptions)</code>创建了一个在画布中的代表图片的Blob对像。</li>
</ul>
<h2 id="可能用到的canvas代码片段"><a href="#可能用到的canvas代码片段" class="headerlink" title="可能用到的canvas代码片段"></a>可能用到的canvas代码片段</h2><p><a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/Code_snippets/Canvas" target="_blank" rel="noopener">mdn写的很详细，不粘贴了。</a></p>
<ul>
<li>在画布中获取特定颜色的像素数量</li>
<li>在画布中获取某一个像素的颜色</li>
<li>链式调用方法</li>
<li>将canvas图片保存到文件中</li>
<li>将一个远程页面加载到canvas元素上</li>
<li>将图像文件转换为base64字符串</li>
</ul>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial" target="_blank" rel="noopener">MDN 的 Canvas 教程</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/Code_snippets/Canvas" target="_blank" rel="noopener">MDN 的canvas可能用到的代码片段</a><br><a href="https://www.w3school.com.cn/tags/html_ref_canvas.asp" target="_blank" rel="noopener">w3school 的 canvas 教程</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/27/create-md5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/09/27/create-md5/" itemprop="url">
                  怎么给文件生成MD5
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-27T15:53:42+08:00">
                2020-09-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/27/create-md5/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/09/27/create-md5/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>MD5</code> 的核心是通过算法把任意长度的原始数据映射成128 bit 的数据。把一串数据经过处理，得到另一个固定长度的数据。是一种<code>Hash</code>算法，全称为 消息摘要算法版本5（Message Digest Algorithm 5）。</p>
<p>不同原始数据会有不同的 MD5 值。 所以不同的文件MD5的值也不一样。</p>
<p>一般在上传文件的场景里，会根据<code>MD5</code>实现续传、秒传的功能。</p>
<p>本文简单写下怎么生成 MD5，这里用到插件<a href="https://github.com/satazor/js-spark-md5" target="_blank" rel="noopener"><code>spark-md5</code></a>。</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li>怕麻烦，10M以内生成MD5，直接用法一就行</li>
<li>怕麻烦，30M以内生成MD5，直接用法二就行</li>
<li>再大一点，用法三吧</li>
<li>但法三可以用在以上所有场景</li>
</ul>
<h2 id="法一：生成文件的-MD5"><a href="#法一：生成文件的-MD5" class="headerlink" title="法一：生成文件的 MD5"></a>法一：生成文件的 MD5</h2><p>生成文件的 MD5，简单思路如下：</p>
<ul>
<li>创建 FileReader 实例，读文件</li>
<li>读完之后，成功状态下，直接使用<code>SparkMD5.hashBinary</code>。</li>
</ul>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fde1e7bbd9734cc887112930c37f571f~tplv-k3u1fbpfcp-zoom-1.image" alt="生成小文件的MD5"></p>
<p>具体代码在文末。</p>
<h3 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h3><p>这种方式，当文件越大的时候，生成 md5 的速度也就越慢，比如 40M 的文件可能需要 1s 才生成 md5。当页面还有其他的交互的时候，将会堵塞其他交互，导致页面假死状态。<br><!-- 引起 UI 的阻塞，导致页面假死状态 --></p>
<p>举个例子：加个按钮，写个点击事件。选择文件之后，立即点击按钮，会发现，当文件越大的时候，弹框的速度越来越迟钝。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"upload"</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">onchange</span>=<span class="string">"selectLocalFile"</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 这里加个按钮，选择文件完之后 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"alert(1)"</span>&gt;</span>测试线程堵塞<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  upload.onchange = async (e) =&gt; &#123;</span></span><br><span class="line"><span class="undefined">    const file = e.target.files[0];</span></span><br><span class="line"><span class="undefined">    console.time("timeCreateMd5");</span></span><br><span class="line"><span class="undefined">    const md5 = await createFileMd5(file);</span></span><br><span class="line"><span class="undefined">    console.log(file.size);</span></span><br><span class="line"><span class="undefined">    //  会打印timeCreateMd5: 959.31396484375 ms</span></span><br><span class="line"><span class="undefined">    console.timeEnd("timeCreateMd5");</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="法二：在worker中生成md5"><a href="#法二：在worker中生成md5" class="headerlink" title="法二：在worker中生成md5"></a>法二：在worker中生成md5</h2><p>所以我们使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers" target="_blank" rel="noopener"><code>web-worker</code></a> 在 <code>worker 线程</code>计算 <code>hash</code>，这样用户仍可以在主界面正常的交互，不会引起堵塞。<br>当前页面的修改，如下：</p>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c131af0dd01404bbba9744b04539f34~tplv-k3u1fbpfcp-zoom-1.image" alt="md5"></p>
<p>新增在worker里执行的<code>hash.js</code>文件如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">self.importScripts(<span class="string">"https://unpkg.com/spark-md5@3.0.1/spark-md5.min.js"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成文件 hash</span></span><br><span class="line">self.onmessage = <span class="keyword">async</span> e =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> file = e.data</span><br><span class="line">  <span class="keyword">const</span> md5 = <span class="keyword">await</span> createFileMd5(file)</span><br><span class="line">  self.postMessage(md5);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFileMd5</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 同之前的，但以下需要修改，增加self的前缀</span></span><br><span class="line">  isSuccess</span><br><span class="line">        ? resolve(self.SparkMD5.hashBinary(result))</span><br><span class="line">        : reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"读取出错了"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这，其实虽然生成大文件的md5耗费时间长，但起码不会堵塞页面主线程了。</p>
<h3 id="也有缺陷"><a href="#也有缺陷" class="headerlink" title="也有缺陷"></a>也有缺陷</h3><p>可以看到计算md5是将整个文件读完才看到，这样当文件过大是极其耗内存的。所以需要分片读取生成<code>md5</code>。</p>
<h2 id="法三：将文件分片生成md5"><a href="#法三：将文件分片生成md5" class="headerlink" title="法三：将文件分片生成md5"></a>法三：将文件分片生成md5</h2><p>仔细看<a href="https://github.com/satazor/js-spark-md5" target="_blank" rel="noopener">spark-md5</a>，其实作者也是推荐分片读取，类似nodejs里面的流一样，这样不需要占据大量内存。</p>
<p>先将文件，按照一定大小分块chunk，这边直接使用<code>File.slice</code>了。  </p>
<p>然后将chunks传给另一个线程计算md5，这边大文件可能需要进度条，所以有一个进度，按需求使用。</p>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/914521b27b014a22a3141abb6b01c246~tplv-k3u1fbpfcp-zoom-1.image" alt="Chunks"><br><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc3b958aed1e43499e297714dd9080ea~tplv-k3u1fbpfcp-zoom-1.image" alt="hash"></p>
<h2 id="附注：代码"><a href="#附注：代码" class="headerlink" title="附注：代码"></a>附注：代码</h2><h3 id="代码：生成小文件的-MD5"><a href="#代码：生成小文件的-MD5" class="headerlink" title="代码：生成小文件的 MD5"></a>代码：生成小文件的 MD5</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"upload"</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">onchange</span>=<span class="string">"selectLocalFile"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/spark-md5@3.0.1/spark-md5.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> upload = <span class="built_in">document</span>.querySelector(<span class="string">"#upload"</span>);</span></span><br><span class="line"><span class="javascript">      upload.onchange = <span class="keyword">async</span> (e) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> file = e.target.files[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> md5 = <span class="keyword">await</span> createFileMd5(file);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(md5);</span></span><br><span class="line"><span class="undefined">      &#125;;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">createFileMd5</span>(<span class="params">file</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 创建FileReader实例</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> fileReader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 开始读文件</span></span></span><br><span class="line"><span class="undefined">          fileReader.readAsBinaryString(file);</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 文件读完之后，触发load事件</span></span></span><br><span class="line"><span class="javascript">          fileReader.onload = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// e.target就是fileReader实例</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(e.target);</span></span><br><span class="line"><span class="javascript">            <span class="comment">// result是fileReader读到的部分</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> result = e.target.result;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 如果读到的长度和文件长度一致，则读取成功</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> isSuccess = file.size === result.length;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 读取成功，则生成MD5，扔出去。失败就报错</span></span></span><br><span class="line"><span class="undefined">            isSuccess</span></span><br><span class="line"><span class="undefined">              ? resolve(SparkMD5.hashBinary(result))</span></span><br><span class="line"><span class="javascript">              : reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"读取出错了"</span>));</span></span><br><span class="line"><span class="undefined">          &#125;;</span></span><br><span class="line"><span class="javascript">          <span class="comment">//   读取过程中出错也直接报错</span></span></span><br><span class="line"><span class="javascript">          fileReader.onerror = <span class="function"><span class="params">()</span> =&gt;</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"读取出错了"</span>));</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="代码：在worker中生成md5"><a href="#代码：在worker中生成md5" class="headerlink" title="代码：在worker中生成md5"></a>代码：在worker中生成md5</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"upload"</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">onchange</span>=<span class="string">"selectLocalFile"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"alert(1)"</span>&gt;</span>测试线程堵塞<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> upload = <span class="built_in">document</span>.querySelector(<span class="string">"#upload"</span>);</span></span><br><span class="line"><span class="javascript">      upload.onchange = <span class="keyword">async</span> (e) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> file = e.target.files[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.time(<span class="string">"timeCreateMd5"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> md5 = <span class="keyword">await</span> createFileMd5InWorker(file);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(file.size);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.timeEnd(<span class="string">"timeCreateMd5"</span>);</span></span><br><span class="line"><span class="undefined">      &#125;;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 生成文件 md5（web-worker）</span></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">createFileMd5InWorker</span>(<span class="params">file</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 新建worker线程,执行hash.js</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> worker = <span class="keyword">new</span> Worker(<span class="string">"./hash.js"</span>);</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 给线程传file</span></span></span><br><span class="line"><span class="undefined">          worker.postMessage(file);</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 当线程传消息的时候，接受消息</span></span></span><br><span class="line"><span class="javascript">          worker.onmessage = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> md5 = e.data;</span></span><br><span class="line"><span class="undefined">            md5 &amp;&amp; resolve(md5)</span></span><br><span class="line"><span class="undefined">          &#125;;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hash.js</span></span><br><span class="line">self.importScripts(<span class="string">"https://unpkg.com/spark-md5@3.0.1/spark-md5.min.js"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成文件 md5</span></span><br><span class="line">self.onmessage = <span class="keyword">async</span> e =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> file = e.data</span><br><span class="line">  <span class="keyword">const</span> md5 = <span class="keyword">await</span> createFileMd5(file)</span><br><span class="line">  self.postMessage(md5);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFileMd5</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 创建FileReader实例</span></span><br><span class="line">    <span class="keyword">const</span> fileReader = <span class="keyword">new</span> FileReader();</span><br><span class="line">    <span class="comment">// 开始读文件</span></span><br><span class="line">    fileReader.readAsBinaryString(file);</span><br><span class="line">    <span class="comment">// 文件读完之后，触发load事件</span></span><br><span class="line">    fileReader.onload = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// e.target就是fileReader实例，这里用this也是指fileReader实例</span></span><br><span class="line">      <span class="built_in">console</span>.log(e.target);</span><br><span class="line">      <span class="comment">// result是fileReader读到的部分</span></span><br><span class="line">      <span class="keyword">const</span> result = e.target.result;</span><br><span class="line">      <span class="comment">// 如果读到的长度和文件长度一致，则读取成功</span></span><br><span class="line">      <span class="keyword">const</span> isSuccess = file.size === result.length;</span><br><span class="line">      <span class="comment">// 读取成功，则生成MD5，扔出去。失败就报错</span></span><br><span class="line">      isSuccess</span><br><span class="line">        ? resolve(self.SparkMD5.hashBinary(result))</span><br><span class="line">        : reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"读取出错了"</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//   读取过程中出错也直接报错</span></span><br><span class="line">    fileReader.onerror = <span class="function"><span class="params">()</span> =&gt;</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"读取出错了"</span>));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代码：分片读取生成md5"><a href="#代码：分片读取生成md5" class="headerlink" title="代码：分片读取生成md5"></a>代码：分片读取生成md5</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"upload"</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">onchange</span>=<span class="string">"selectLocalFile"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"alert(1)"</span>&gt;</span>测试线程堵塞<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> upload = <span class="built_in">document</span>.querySelector(<span class="string">"#upload"</span>);</span></span><br><span class="line"><span class="javascript">      upload.onchange = <span class="keyword">async</span> (e) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> file = e.target.files[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> chunks = createFileChunk(file)</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.time(<span class="string">"timeCreateMd5"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 这里注意放chunks</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> &#123;md5&#125; = <span class="keyword">await</span> createFileMd5InWorker(chunks);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(file.size);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.timeEnd(<span class="string">"timeCreateMd5"</span>);</span></span><br><span class="line"><span class="undefined">      &#125;;</span></span><br><span class="line"><span class="undefined">      </span></span><br><span class="line"><span class="javascript">      <span class="comment">// 生成文件切片</span></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">createFileChunk</span>(<span class="params">file, size = <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> chunks = [];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> cur = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">while</span> (cur &lt; file.size) &#123;</span></span><br><span class="line"><span class="undefined">          chunks.push(file.slice(cur, cur + size));</span></span><br><span class="line"><span class="undefined">          cur += size;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> chunks;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 生成文件 hash（web-worker）</span></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">createFileMd5InWorker</span>(<span class="params">fileChunks</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> worker = <span class="keyword">new</span> Worker(<span class="string">"./hash.js"</span>);</span></span><br><span class="line"><span class="undefined">          worker.postMessage(&#123; fileChunks &#125;);</span></span><br><span class="line"><span class="javascript">          worker.onmessage = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 这边加了进度条 这里的进度条，看需要显示</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> &#123; percentage, hash &#125; = e.data;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(percentage)</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 计算出hash之后，扔出去</span></span></span><br><span class="line"><span class="undefined">            hash &amp;&amp;resolve(hash);</span></span><br><span class="line"><span class="undefined">          &#125;;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接copy的  https://juejin.im/post/6844904046436843527#heading-17</span></span><br><span class="line">self.importScripts(<span class="string">"./js/lib/spark-md5.min.js"</span>); <span class="comment">// 导入脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成文件 hash</span></span><br><span class="line">self.onmessage = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; fileChunks &#125; = e.data;</span><br><span class="line">  <span class="built_in">console</span>.log(fileChunks)</span><br><span class="line"><span class="comment">//   const &#123; fileChunks &#125; = e.data;</span></span><br><span class="line">  <span class="keyword">const</span> spark = <span class="keyword">new</span> self.SparkMD5.ArrayBuffer();</span><br><span class="line">  <span class="keyword">let</span> percentage = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> loadNext = <span class="function"><span class="params">index</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">    reader.readAsArrayBuffer(fileChunks[index]);</span><br><span class="line">    reader.onload = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">      count++;</span><br><span class="line">      spark.append(e.target.result);</span><br><span class="line">      <span class="keyword">if</span> (count === fileChunks.length) &#123;</span><br><span class="line">        self.postMessage(&#123;</span><br><span class="line">          percentage: <span class="number">100</span>,</span><br><span class="line">          hash: spark.end()</span><br><span class="line">        &#125;);</span><br><span class="line">        self.close();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        percentage += <span class="number">100</span> / fileChunks.length;</span><br><span class="line">        self.postMessage(&#123;</span><br><span class="line">          percentage</span><br><span class="line">        &#125;);</span><br><span class="line">        loadNext(count);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  loadNext(<span class="number">0</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://juejin.im/post/6844904046436843527" target="_blank" rel="noopener">字节跳动面试官：请你实现一个大文件上传和断点续传</a></li>
<li><a href="http://blog.bfw.wiki/user10/15628273380201230054.html" target="_blank" rel="noopener">js 实现 input file 转换成 blob 和 byte 字节流</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/26592209" target="_blank" rel="noopener">三分钟学习md5</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/21/vue-style-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/09/21/vue-style-guide/" itemprop="url">
                  写vue的尽量按照规范来
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-21T15:37:41+08:00">
                2020-09-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编辑器/" itemprop="url" rel="index">
                    <span itemprop="name">编辑器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/21/vue-style-guide/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/09/21/vue-style-guide/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://cn.vuejs.org/v2/style-guide/index.html#%E8%A7%84%E5%88%99%E5%BD%92%E7%B1%BB" target="_blank" rel="noopener">官方的风格指南</a>。  </p>
<p>本文按照自己的逻辑，稍微简化了。规范的好处是，排雷更加容易，踩雷更加艰难，项目看着更赏心悦目。</p>
<h2 id="必要"><a href="#必要" class="headerlink" title="必要"></a>必要</h2><h3 id="组件名为多个单词"><a href="#组件名为多个单词" class="headerlink" title="组件名为多个单词"></a>组件名为多个单词</h3><p>这样做可以避免跟现有的以及未来的 HTML 元素相冲突。比如以前不小心写了个<code>masker</code>的组件，然不生效。</p>
<h3 id="Prop-定义应该尽量详细"><a href="#Prop-定义应该尽量详细" class="headerlink" title="Prop 定义应该尽量详细"></a>Prop 定义应该尽量详细</h3><p>在开发环境下，如果向一个组件提供格式不正确的 prop，Vue 将会告警，以帮助你捕获潜在的错误来源。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">props: &#123;</span><br><span class="line">  status: <span class="built_in">String</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 更好的做法！</span></span><br><span class="line"></span><br><span class="line">props: &#123;</span><br><span class="line">  status: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    validator: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'syncing'</span>,</span><br><span class="line">        <span class="string">'synced'</span>,</span><br><span class="line">        <span class="string">'version-conflict'</span>,</span><br><span class="line">        <span class="string">'error'</span></span><br><span class="line">      ].indexOf(value) !== <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="v-for必须设置key"><a href="#v-for必须设置key" class="headerlink" title="v-for必须设置key"></a>v-for必须设置key</h3><p>始终添加一个唯一的键值，以便你和你的团队永远不必担心一些极端情况。也在少数对性能有严格要求的情况下，为了避免对象固化，你可以刻意做一些非常规的处理。</p>
<h3 id="永远不要把-v-if-和-v-for-同时用在同一个元素上"><a href="#永远不要把-v-if-和-v-for-同时用在同一个元素上" class="headerlink" title="永远不要把 v-if 和 v-for 同时用在同一个元素上"></a>永远不要把 v-if 和 v-for 同时用在同一个元素上</h3><p>如果有这种场景，按照下面的方式改进，以优化性能</p>
<ol>
<li><p>过滤一个列表中的项目 (比如 v-for=”user in users” v-if=”user.isActive”)。在这种情形下，请将 users 替换为一个<code>计算属性</code> (比如 activeUsers)，让其返回过滤后的列表。</p>
</li>
<li><p>为了避免渲染本应该被隐藏的列表 (比如 v-for=”user in users” v-if=”shouldShowUsers”)。这种情形下，请将 v-if 移动至<code>容器元素</code>上 (比如 ul、ol)</p>
</li>
</ol>
<h2 id="强烈推荐"><a href="#强烈推荐" class="headerlink" title="强烈推荐"></a>强烈推荐</h2><h3 id="组件一律使用单文件申明，而不是Vue-component"><a href="#组件一律使用单文件申明，而不是Vue-component" class="headerlink" title="组件一律使用单文件申明，而不是Vue.component"></a>组件一律使用单文件申明，而不是Vue.component</h3><p>只要有能够拼接文件的构建系统，就把每个组件单独分成文件。</p>
<h3 id="组件的文件名的格式要么都是PascalCase，要么都是是kebab-case"><a href="#组件的文件名的格式要么都是PascalCase，要么都是是kebab-case" class="headerlink" title="组件的文件名的格式要么都是PascalCase，要么都是是kebab-case"></a>组件的文件名的格式要么都是PascalCase，要么都是是kebab-case</h3><p>但单词大写开头对于代码编辑器的自动补全最为友好，因为这使得我们在 JS(X) 和模板中引用组件的方式尽可能的一致。然而，混用文件命名方式有的时候会导致大小写不敏感的文件系统的问题，这也是横线连接命名同样完全可取的原因。</p>
<h3 id="基础组件名加特定前缀，比如-Base、App-或-V"><a href="#基础组件名加特定前缀，比如-Base、App-或-V" class="headerlink" title="基础组件名加特定前缀，比如 Base、App 或 V"></a>基础组件名加特定前缀，比如 Base、App 或 V</h3><p>应用特定样式和约定的基础组件 (也就是展示类的、无逻辑的或无状态的组件) 应该全部以一个特定的前缀开头，比如 Base、App 或 V。</p>
<p>好处：</p>
<ol>
<li><p>当你在编辑器中以字母顺序排序时，你的应用的基础组件会全部列在一起，这样更容易识别。</p>
</li>
<li><p>因为组件名应该始终是多个单词，所以这样做可以避免你在包裹简单组件时随意选择前缀 (比如 MyButton、VueButton)。</p>
</li>
<li><p>因为这些组件会被频繁使用，所以你可能想把它们放到全局而不是在各处分别导入它们。使用相同的前缀可以让 webpack 这样工作：</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> requireComponent = <span class="built_in">require</span>.context(<span class="string">"./src"</span>, <span class="literal">true</span>, /Base[A-Z]\w+\.(vue|js)$/)</span><br><span class="line">requireComponent.keys().forEach(<span class="function"><span class="keyword">function</span> (<span class="params">fileName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> baseComponentConfig = requireComponent(fileName)</span><br><span class="line">  baseComponentConfig = baseComponentConfig.default || baseComponentConfig</span><br><span class="line">  <span class="keyword">var</span> baseComponentName = baseComponentConfig.name || (</span><br><span class="line">    fileName</span><br><span class="line">      .replace(<span class="regexp">/^.+\//</span>, <span class="string">''</span>)</span><br><span class="line">      .replace(<span class="regexp">/\.\w+$/</span>, <span class="string">''</span>)</span><br><span class="line">  )</span><br><span class="line">  Vue.component(baseComponentName, baseComponentConfig)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="每个页面只能使用一次的组件应该以-The-前缀命名，以示其唯一性"><a href="#每个页面只能使用一次的组件应该以-The-前缀命名，以示其唯一性" class="headerlink" title="每个页面只能使用一次的组件应该以 The 前缀命名，以示其唯一性"></a>每个页面只能使用一次的组件应该以 The 前缀命名，以示其唯一性</h3><p>这不意味着组件只可用于一个单页面，而是每个页面只使用一次。这些组件永远不接受任何 prop，因为它们是为你的应用定制的，而不是它们在你的应用中的上下文。如果你发现有必要添加 prop，那就表明这实际上是一个可复用的组件，只是目前在每个页面里只使用一次</p>
<h3 id="紧密耦合的组件名依次加父组件前缀"><a href="#紧密耦合的组件名依次加父组件前缀" class="headerlink" title="紧密耦合的组件名依次加父组件前缀"></a>紧密耦合的组件名依次加父组件前缀</h3><p>如果一个组件只在某个父组件的场景下有意义，这层关系应该体现在其名字上。因为编辑器通常会按字母顺序组织文件，所以这样做可以把相关联的文件排在一起。不推荐文件夹嵌套。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">components/</span><br><span class="line">|- TodoList.vue</span><br><span class="line">|- TodoListItem.vue</span><br><span class="line">|- TodoListItemButton.vue</span><br></pre></td></tr></table></figure>
<h3 id="组件名中的单词顺序尽量让相关的在一起"><a href="#组件名中的单词顺序尽量让相关的在一起" class="headerlink" title="组件名中的单词顺序尽量让相关的在一起"></a>组件名中的单词顺序尽量让相关的在一起</h3><p>给组件命名时并不需要遵从自然语言。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">components/</span><br><span class="line">|- SearchButtonClear.vue</span><br><span class="line">|- SearchButtonRun.vue</span><br><span class="line">|- SearchInputExcludeGlob.vue</span><br><span class="line">|- SearchInputQuery.vue</span><br><span class="line">|- SettingsCheckboxLaunchOnStartup.vue</span><br><span class="line">|- SettingsCheckboxTerms.vue</span><br><span class="line"></span><br><span class="line"><span class="comment">// 而不是下面的，这样翻找很困难</span></span><br><span class="line">components/</span><br><span class="line">|- ClearSearchButton.vue</span><br><span class="line">|- ExcludeFromSearchInput.vue</span><br><span class="line">|- LaunchOnStartupCheckbox.vue</span><br><span class="line">|- RunSearchButton.vue</span><br><span class="line">|- SearchInput.vue</span><br><span class="line">|- TermsCheckbox.vue</span><br></pre></td></tr></table></figure>
<p>好处：</p>
<ol>
<li>在多级目录间找来找去，要比在单个 components 目录下滚动查找要花费更多的精力。</li>
<li>存在组件重名 (比如存在多个 ButtonDelete 组件) 的时候在编辑器里更难快速定位。</li>
<li>让重构变得更难，因为为一个移动了的组件更新相关引用时，查找/替换通常并不高效。</li>
</ol>
<h3 id="模板中组件名始终-kebab-case，-lt-my-component-gt-lt-my-component-gt"><a href="#模板中组件名始终-kebab-case，-lt-my-component-gt-lt-my-component-gt" class="headerlink" title="模板中组件名始终 kebab-case，&lt;my-component&gt;&lt;/my-component&gt;"></a>模板中组件名始终 kebab-case，<code>&lt;my-component&gt;&lt;/my-component&gt;</code></h3><p>对于绝大多数项目来说，在单文件组件和字符串模板中组件名应该总是 PascalCase 的——但是在 DOM 模板中总是 kebab-case 的。</p>
<h3 id="组件名应该倾向于完整单词而不是缩写"><a href="#组件名应该倾向于完整单词而不是缩写" class="headerlink" title="组件名应该倾向于完整单词而不是缩写"></a>组件名应该倾向于完整单词而不是缩写</h3><p>编辑器中的自动补全已经让书写长命名的代价非常之低了，而其带来的明确性却是非常宝贵的。不常用的缩写尤其应该避免。</p>
<h3 id="声明-prop的时候用-camelCase，在模板和-JSX-中用-kebab-case"><a href="#声明-prop的时候用-camelCase，在模板和-JSX-中用-kebab-case" class="headerlink" title="声明 prop的时候用 camelCase，在模板和 JSX 中用 kebab-case"></a>声明 prop的时候用 camelCase，在模板和 JSX 中用 kebab-case</h3><p>我们单纯的遵循每个语言的约定。在 JavaScript 中更自然的是 camelCase。而在 HTML 中则是 kebab-case。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">props: &#123;</span><br><span class="line">  greetingText: <span class="built_in">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">welcome-message</span> <span class="attr">greeting-text</span>=<span class="string">"hi"</span>&gt;</span><span class="tag">&lt;/<span class="name">welcome-message</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="多个-attribute-的元素-每个-attribute-一行"><a href="#多个-attribute-的元素-每个-attribute-一行" class="headerlink" title="多个 attribute 的元素,每个 attribute 一行"></a>多个 attribute 的元素,每个 attribute 一行</h3><p>在 JavaScript 中，用多行分隔对象的多个 property 是很常见的最佳实践，因为这样更易读。模板和 JSX 值得我们做相同的考虑。</p>
<h3 id="模板中只能用简单表达式，复杂的用computed"><a href="#模板中只能用简单表达式，复杂的用computed" class="headerlink" title="模板中只能用简单表达式，复杂的用computed"></a>模板中只能用简单表达式，复杂的用computed</h3><p>复杂表达式会让你的模板变得不那么声明式。我们应该尽量描述应该出现的是什么，而非如何计算那个值。而且计算属性和方法使得代码可以重用。</p>
<h3 id="应把复杂计算属性分割为尽可能多的更简单的-property"><a href="#应把复杂计算属性分割为尽可能多的更简单的-property" class="headerlink" title="应把复杂计算属性分割为尽可能多的更简单的 property"></a>应把复杂计算属性分割为尽可能多的更简单的 property</h3><p>好处：</p>
<ul>
<li><p>易于测试。当每个计算属性都包含一个非常简单且很少依赖的表达式时，撰写测试以确保其正确工作就会更加容易。</p>
</li>
<li><p>易于阅读。简化计算属性要求你为每一个值都起一个描述性的名称，即便它不可复用。这使得其他开发者 (以及未来的你) 更容易专注在他们关心的代码上并搞清楚发生了什么。</p>
</li>
<li><p>更好的“拥抱变化”。任何能够命名的值都可能用在视图上。举个例子，我们可能打算展示一个信息，告诉用户他们存了多少钱；也可能打算计算税费，但是可能会分开展现，而不是作为总价的一部分。</p>
</li>
</ul>
<p>小的、专注的计算属性减少了信息使用时的假设性限制，所以需求变更时也用不着那么多重构了</p>
<h3 id="attribute-值尽量都带引号"><a href="#attribute-值尽量都带引号" class="headerlink" title="attribute 值尽量都带引号"></a>attribute 值尽量都带引号</h3><p>在 HTML 中不带空格的 attribute 值是可以没有引号的，但这鼓励了大家在特征值里不写空格，导致可读性变差</p>
<h3 id="指令缩写要么都用，要么都不用"><a href="#指令缩写要么都用，要么都不用" class="headerlink" title="指令缩写要么都用，要么都不用"></a>指令缩写要么都用，要么都不用</h3><p>指令缩写 (用 <code>:</code> 表示 <code>v-bind:</code>、用 <code>@</code> 表示 <code>v-on:</code> 和用 <code>#</code> 表示 <code>v-slot:</code>) 应该要么都用要么都不用。</p>
<h2 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h2><h3 id="组件中选项的顺序"><a href="#组件中选项的顺序" class="headerlink" title="组件中选项的顺序"></a>组件中选项的顺序</h3><ul>
<li>el</li>
<li>name</li>
<li>components/directives/filters</li>
<li>mixins/extends</li>
<li>props</li>
<li>data</li>
<li>computed</li>
<li>watch</li>
<li>created之类的生命周期钩子</li>
<li>methods</li>
<li>template</li>
</ul>
<h3 id="属性顺序"><a href="#属性顺序" class="headerlink" title="属性顺序"></a>属性顺序</h3><ul>
<li>is</li>
<li>v-for</li>
<li>v-if/v-show</li>
<li>v-pre/v-once</li>
<li>id</li>
<li>ref</li>
<li>key</li>
<li>v-model</li>
<li>其他</li>
<li>v-on</li>
<li>v-html/v-text</li>
</ul>
<h3 id="组件中顶级元素的顺序保持一致"><a href="#组件中顶级元素的顺序保持一致" class="headerlink" title="组件中顶级元素的顺序保持一致"></a>组件中顶级元素的顺序保持一致</h3><p>template/script/style</p>
<h2 id="谨慎"><a href="#谨慎" class="headerlink" title="谨慎"></a>谨慎</h2><h3 id="如果一组-v-if-v-else-的元素类型相同，最好使用-key-比如两个-lt-div-gt-元素"><a href="#如果一组-v-if-v-else-的元素类型相同，最好使用-key-比如两个-lt-div-gt-元素" class="headerlink" title="如果一组 v-if + v-else 的元素类型相同，最好使用 key (比如两个 &lt;div&gt; 元素)"></a>如果一组 v-if + v-else 的元素类型相同，最好使用 key (比如两个 <code>&lt;div&gt;</code> 元素)</h3><p>默认情况下，Vue 会尽可能高效的更新 DOM。这意味着其在相同类型的元素之间切换时，会修补已存在的元素，而不是将旧的元素移除然后在同一位置添加一个新元素。如果本不相同的元素被识别为相同，则会出现意料之外的结果。</p>
<h3 id="scoped-中的避免元素选择器，而尽量用类选择器"><a href="#scoped-中的避免元素选择器，而尽量用类选择器" class="headerlink" title="scoped 中的避免元素选择器，而尽量用类选择器"></a>scoped 中的避免元素选择器，而尽量用类选择器</h3><p>在 scoped 样式中，类选择器比元素选择器更好，因为大量使用元素选择器是很慢的。</p>
<h3 id="优先通过-prop-和事件进行父子组件之间的通信，而不是-this-parent-或变更-prop"><a href="#优先通过-prop-和事件进行父子组件之间的通信，而不是-this-parent-或变更-prop" class="headerlink" title="优先通过 prop 和事件进行父子组件之间的通信，而不是 this.$parent 或变更 prop"></a>优先通过 prop 和事件进行父子组件之间的通信，而不是 this.$parent 或变更 prop</h3><p>一个理想的 Vue 应用是 prop 向下传递，事件向上传递的。遵循这一约定会让你的组件更易于理解。然而，在一些边界情况下 prop 的变更或 this.$parent 能够简化两个深度耦合的组件。</p>
<p>问题在于，这种做法在很多简单的场景下可能会更方便。但请当心，不要为了一时方便 (少写代码) 而牺牲数据流向的简洁性 (易于理解)。</p>
<h3 id="应该优先通过-Vuex-管理全局状态，而不是通过-this-root-或一个全局事件总线"><a href="#应该优先通过-Vuex-管理全局状态，而不是通过-this-root-或一个全局事件总线" class="headerlink" title="应该优先通过 Vuex 管理全局状态，而不是通过 this.$root 或一个全局事件总线"></a>应该优先通过 Vuex 管理全局状态，而不是通过 this.$root 或一个全局事件总线</h3><p>通过 this.$root 和/或全局事件总线管理状态在很多简单的情况下都是很方便的，但是并不适用于绝大多数的应用。</p>
<p>Vuex 是 Vue 的官方类 flux 实现，其提供的不仅是一个管理状态的中心区域，还是组织、追踪和调试状态变更的好工具。它很好地集成在了 Vue 生态系统之中 (包括完整的 Vue DevTools 支持)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/04/el-menu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/09/04/el-menu/" itemprop="url">
                  用el-menu自动生成菜单
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-04T17:23:48+08:00">
                2020-09-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vue/" itemprop="url" rel="index">
                    <span itemprop="name">vue</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/04/el-menu/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/09/04/el-menu/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>简约菜单都可以使用<code>el-menu</code>生成，水平的菜单或者垂直的菜单。<br>本文是希望能帮助需求者更快熟悉<a href="https://element.eleme.cn/#/zh-CN/component/menu" target="_blank" rel="noopener"><code>el-menu</code></a>的使用，以及能快速生成n级菜单。  </p>
<h2 id="基础介绍"><a href="#基础介绍" class="headerlink" title="基础介绍"></a>基础介绍</h2><p>使用的时候，最外层是<code>el-menu</code>，其上面属性，是用来配置整个菜单，如水平还是垂直、背景色、文字色、默认激活的菜单子项、默认展开的菜单子项等。<br><code>el-menu</code>的子元素只有三种情况：</p>
<ul>
<li>el-menu-item 就是普通的菜单项</li>
<li>el-submenu 是菜单项里还有子菜单</li>
<li>el-menu-item-group 是菜单项组，就是好几个菜单项有个标题</li>
</ul>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4da43ce46524f2da8d6c6dfd03e5593~tplv-k3u1fbpfcp-zoom-1.image" alt="el-menu"></p>
<h2 id="index的妙用"><a href="#index的妙用" class="headerlink" title="index的妙用"></a>index的妙用</h2><p>建议将每个<code>el-menu-item</code>和<code>el-submenu</code>上加上<code>index</code>的属性。</p>
<p>好处以下：</p>
<ul>
<li>选中的时候，有高亮的状态</li>
<li>方便设置默认选中的菜单，可以<code>default-active=&#39;anyIndex&#39;</code></li>
<li>方便设置默认展开的嵌套菜单，可以<code>:default-openeds=&#39;[&quot;submenuIndex&quot;]&#39;</code>，这里必须是数组哈</li>
<li>点击<code>el-menu-item</code>触发select事件，可以知道选了哪个和路径数组</li>
<li>点击<code>el-submenu</code>触发open/close事件，可以知道选了哪个和路径数组</li>
<li><code>el-menu</code>设置<code>router</code>属性的时候，index作为 path 进行路由跳转</li>
</ul>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76bd1ef71b1b4bf78dd06f0992ff408e~tplv-k3u1fbpfcp-zoom-1.image" alt="el-menu-2"></p>
<h2 id="折叠菜单"><a href="#折叠菜单" class="headerlink" title="折叠菜单"></a>折叠菜单</h2><p>一级菜单每个加特定的图标，然后就可以折叠，这样最大化内容区。</p>
<p>折叠使用的是<code>el-menu</code>的<code>collapse</code>属性。但记得将文字用标签裹起来，且加上<code>slot=&#39;title&#39;</code>，这样框架本身将<code>title</code>会隐藏起来，且在<code>hover</code>的时候显示出来。</p>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e10fee6d80eb4039848e39214b430e07~tplv-k3u1fbpfcp-zoom-1.image" alt="效果图"><br><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f520487ebb143bc9aabe20b7bf8ad5d~tplv-k3u1fbpfcp-zoom-1.image" alt="代码"></p>
<h2 id="重点来了：生成菜单"><a href="#重点来了：生成菜单" class="headerlink" title="重点来了：生成菜单"></a>重点来了：生成菜单</h2><p>先简单点，只有二级菜单。<br>data增加menus，然后将模板部分，该循环循环，该判断判断，常量的地方变成变量。</p>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b99f3b4fe3a243cc876c77e12de2794f~tplv-k3u1fbpfcp-zoom-1.image" alt="效果图"></p>
<h2 id="生成n级菜单，肯定递归哈"><a href="#生成n级菜单，肯定递归哈" class="headerlink" title="生成n级菜单，肯定递归哈"></a>生成n级菜单，肯定递归哈</h2><p>如果没有写过递归组件的，可以尝试先写下三级菜单。</p>
<p>然后将重复的地方，提出来作为一个组件就可以了。</p>
<p>递归组件，需要多思考，多敲哈~ </p>
<p><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4128842dd39f4623b1c2e54b83653cd4~tplv-k3u1fbpfcp-zoom-1.image" alt="效果图"></p>
<p>提取出来的<code>MiddleMenu</code>如下：<br><img src="//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2403fb6335374c148ea7c21ccdeaf50f~tplv-k3u1fbpfcp-zoom-1.image" alt="效果图"></p>
<h2 id="水平菜单和其他属性"><a href="#水平菜单和其他属性" class="headerlink" title="水平菜单和其他属性"></a>水平菜单和其他属性</h2><p>如果觉得还需要什么功能，优先去官网看看。</p>
<ul>
<li>想要水平菜单：<code>mode=&#39;horizontal&#39;</code></li>
<li>想设置菜单的背景色、文字色、激活菜单的文字色(夜间模式)：<code>background-color=&quot;#545c64&quot; text-color=&quot;#fff&quot; active-text-color=&quot;#ffd04b&quot;</code></li>
<li>只想有一个子菜单展开：<code>unique-opened</code></li>
<li>打开子菜单的方式可以设置hover：<code>menu-trigger=&#39;hover&#39;</code></li>
<li>不要折叠的动画效果：<code>:collapse-transition=&#39;false&#39;</code></li>
<li>点击菜单项直接去相应的路由：<code>router</code>，且相应的index设置成路由路径</li>
</ul>
<h2 id="附注代码"><a href="#附注代码" class="headerlink" title="附注代码"></a>附注代码</h2><h3 id="基础介绍代码"><a href="#基础介绍代码" class="headerlink" title="基础介绍代码"></a>基础介绍代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">section(style=&apos;width:210px&apos;)</span><br><span class="line">  el-menu</span><br><span class="line">    el-menu-item 单项菜单1</span><br><span class="line">    el-menu-item 单项菜单2</span><br><span class="line">    el-submenu</span><br><span class="line">      template(slot=&apos;title&apos;) 有子菜单，带展开小箭头</span><br><span class="line">      el-menu-item 子菜单1</span><br><span class="line">      el-menu-item 子菜单2</span><br><span class="line">    el-menu-item-group(title=&apos;菜单组，直接展开&apos;)</span><br><span class="line">      el-menu-item 组员1</span><br><span class="line">      el-menu-item 组员2</span><br></pre></td></tr></table></figure>
<h3 id="加index代码"><a href="#加index代码" class="headerlink" title="加index代码"></a>加index代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;template lang=&apos;pug&apos;&gt;</span><br><span class="line">section(style=&apos;width:210px&apos;)</span><br><span class="line">  el-menu(default-active=&apos;menu1&apos; :default-openeds=&apos;[&quot;submenu1&quot;]&apos;</span><br><span class="line">   @open=&apos;handleOpen&apos; @close=&apos;handleClose&apos; @select=&apos;handleSelect&apos;)</span><br><span class="line">    el-menu-item(index=&apos;menu1&apos;) 单项菜单1</span><br><span class="line">    el-menu-item(index=&apos;menu2&apos;) 单项菜单2</span><br><span class="line">    el-submenu(index=&apos;submenu1&apos;)</span><br><span class="line">      template(slot=&apos;title&apos;) 有子菜单，带展开小箭头</span><br><span class="line">      el-menu-item(index=&apos;menu1-1&apos;) 子菜单1</span><br><span class="line">      el-menu-item(index=&apos;menu1-2&apos;) 子菜单2</span><br><span class="line">    el-menu-item-group(title=&apos;菜单组，直接展开&apos;)</span><br><span class="line">      el-menu-item(index=&apos;menu3&apos;) 组员1</span><br><span class="line">      el-menu-item(index=&apos;menu4&apos;) 组员2</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleOpen (key, keyPath) &#123;</span><br><span class="line">      console.log(&apos;open事件&apos;, key, keyPath)</span><br><span class="line">    &#125;,</span><br><span class="line">    handleClose (key, keyPath) &#123;</span><br><span class="line">      console.log(&apos;close事件&apos;, key, keyPath)</span><br><span class="line">    &#125;,</span><br><span class="line">    handleSelect (key, keyPath) &#123;</span><br><span class="line">      console.log(&apos;select事件&apos;, key, keyPath)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="折叠菜单代码"><a href="#折叠菜单代码" class="headerlink" title="折叠菜单代码"></a>折叠菜单代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;template lang=&apos;pug&apos;&gt;</span><br><span class="line">section(style=&apos;width:210px&apos;)</span><br><span class="line">  el-menu.el-menu-vertical-demo(default-active=&apos;menu1&apos; :collapse=&apos;isCollapse&apos;)</span><br><span class="line">    el-menu-item(index=&apos;menu1&apos;)</span><br><span class="line">      i.el-icon-location</span><br><span class="line">      span(slot=&apos;title&apos;) 单项菜单1</span><br><span class="line">    el-menu-item(index=&apos;menu2&apos;)</span><br><span class="line">      i.el-icon-document</span><br><span class="line">      span(slot=&apos;title&apos;) 单项菜单2</span><br><span class="line">    el-submenu(index=&apos;submenu1&apos;)</span><br><span class="line">      template(slot=&apos;title&apos;)</span><br><span class="line">        i.el-icon-setting</span><br><span class="line">        span(slot=&apos;title&apos;) 有子菜单</span><br><span class="line">      el-menu-item(index=&apos;menu1-1&apos;) 子菜单1</span><br><span class="line">      el-menu-item(index=&apos;menu1-2&apos;) 子菜单2</span><br><span class="line">  div(style=&apos;margin-top:20px&apos;)</span><br><span class="line">    el-button(@click=&apos;isCollapse=!isCollapse&apos;) &#123;&#123;isCollapse?&apos;展开&apos;:&apos;折叠&apos;&#125;&#125;</span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      isCollapse: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="生成菜单，只有二级代码"><a href="#生成菜单，只有二级代码" class="headerlink" title="生成菜单，只有二级代码"></a>生成菜单，只有二级代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;template lang=&apos;pug&apos;&gt;</span><br><span class="line">section(style=&apos;width:210px&apos;)</span><br><span class="line">  el-menu.el-menu-vertical-demo(default-active=&apos;首页&apos; :collapse=&apos;isCollapse&apos;)</span><br><span class="line">    template(v-for=&apos;(item,outerIndex) in menus&apos; )</span><br><span class="line">      el-submenu(v-if=&apos;item.children&apos; :index=&apos;item.text&apos; :key=&apos;outerIndex&apos;)</span><br><span class="line">        template(slot=&apos;title&apos;)</span><br><span class="line">          i(:class=&apos;item.iconClass&apos;)</span><br><span class="line">          span(slot=&apos;title&apos;) &#123;&#123;item.text&#125;&#125;</span><br><span class="line">        el-menu-item(v-for=&apos;(innerItem,innerIndex) in item.children&apos; :key=&apos;innerIndex&apos;</span><br><span class="line">         :index=&apos;innerItem.text&apos;) &#123;&#123;innerItem.text&#125;&#125;</span><br><span class="line">      el-menu-item(v-else :index=&apos;item.text&apos; :key=&apos;outerIndex&apos;)</span><br><span class="line">        i(:class=&apos;item.iconClass&apos;)</span><br><span class="line">        span(slot=&apos;title&apos;) &#123;&#123;item.text&#125;&#125;</span><br><span class="line">  div(style=&apos;margin-top:20px&apos;)</span><br><span class="line">    el-button(@click=&apos;isCollapse=!isCollapse&apos;) &#123;&#123;isCollapse?&apos;展开&apos;:&apos;折叠&apos;&#125;&#125;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data () &#123;</span><br><span class="line">    let menus = [</span><br><span class="line">      &#123; text: &apos;首页&apos;, iconClass: &apos;el-icon-document&apos; &#125;,</span><br><span class="line">      &#123; text: &apos;人员管理&apos;, iconClass: &apos;el-icon-user&apos;, children: [ &#123; text: &apos;教师管理&apos; &#125;, &#123; text: &apos;助教管理&apos; &#125; ] &#125;,</span><br><span class="line">      &#123; text: &apos;权限管理&apos;, iconClass: &apos;el-icon-setting&apos;, children: [ &#123; text: &apos;角色管理&apos; &#125;, &#123; text: &apos;人员角色&apos; &#125; ] &#125;</span><br><span class="line">    ]</span><br><span class="line">    return &#123;</span><br><span class="line">      isCollapse: false,</span><br><span class="line">      menus</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="生成n级菜单代码"><a href="#生成n级菜单代码" class="headerlink" title="生成n级菜单代码"></a>生成n级菜单代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- MiddleMenu.vue --&gt;</span><br><span class="line">&lt;template lang=&quot;pug&quot;&gt;</span><br><span class="line">//- 这里注意不能使用div包裹，因为menu的标签很多是li，不能使用别的标签，所以使用component</span><br><span class="line">component(:is=&apos;menuItem.children?&quot;el-submenu&quot;:&quot;el-menu-item&quot;&apos; :index=&apos;menuItem.text&apos;)</span><br><span class="line">  template(v-if=&apos;menuItem.children&apos;)</span><br><span class="line">    template(slot=&apos;title&apos;)</span><br><span class="line">      i(:class=&apos;menuItem.iconClass&apos;)</span><br><span class="line">      span(slot=&apos;title&apos;) &#123;&#123;menuItem.text&#125;&#125;</span><br><span class="line">    //- 和Index重复的地方，这也是递归的关键</span><br><span class="line">    template(v-for=&apos;(innerItem,innerIndex) in menuItem.children&apos;)</span><br><span class="line">      middle-menu(:menu-item=&apos;innerItem&apos; :key=&apos;innerIndex&apos;)</span><br><span class="line">  template(v-else)</span><br><span class="line">    i(:class=&apos;menuItem.iconClass&apos;)</span><br><span class="line">    span(slot=&apos;title&apos;) &#123;&#123;menuItem.text&#125;&#125;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &apos;middle-menu&apos;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    menuItem: &#123;</span><br><span class="line">      type: Object,</span><br><span class="line">      required: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Index.vue --&gt;</span><br><span class="line">&lt;template lang=&apos;pug&apos;&gt;</span><br><span class="line">section(style=&apos;width:210px&apos;)</span><br><span class="line">  el-menu.el-menu-vertical-demo(default-active=&apos;首页&apos; :collapse=&apos;isCollapse&apos;)</span><br><span class="line">    //- 和MiddleMenu重复的地方</span><br><span class="line">    template(v-for=&apos;(item,outerIndex) in menus&apos; )</span><br><span class="line">      middle-menu( :menu-item=&apos;item&apos; :key=&apos;outerIndex&apos;)</span><br><span class="line">  div(style=&apos;margin-top:20px&apos;)</span><br><span class="line">    el-button(@click=&apos;isCollapse=!isCollapse&apos;) &#123;&#123;isCollapse?&apos;展开&apos;:&apos;折叠&apos;&#125;&#125;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import MiddleMenu from &apos;./components/MiddleMenu&apos;</span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123; MiddleMenu &#125;,</span><br><span class="line">  data () &#123;</span><br><span class="line">    let menus = [</span><br><span class="line">      &#123; text: &apos;首页&apos;, iconClass: &apos;el-icon-document&apos; &#125;,</span><br><span class="line">      &#123; text: &apos;人员管理&apos;,</span><br><span class="line">        iconClass: &apos;el-icon-user&apos;,</span><br><span class="line">        children: [ &#123; text: &apos;教师管理&apos;, children: [&#123; text: &apos;数学系&apos; &#125;] &#125;, &#123; text: &apos;助教管理&apos; &#125; ] &#125;,</span><br><span class="line">      &#123; text: &apos;权限管理&apos;,</span><br><span class="line">        iconClass: &apos;el-icon-setting&apos;,</span><br><span class="line">        children: [ &#123; text: &apos;角色管理&apos; &#125;, &#123; text: &apos;人员角色&apos; &#125; ] &#125;</span><br><span class="line">    ]</span><br><span class="line">    return &#123;</span><br><span class="line">      isCollapse: false,</span><br><span class="line">      menus</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/03/baby_hot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/09/03/baby_hot/" itemprop="url">
                  发烧及应对措施
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-03T12:14:04+08:00">
                2020-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/baby/" itemprop="url" rel="index">
                    <span itemprop="name">baby</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/03/baby_hot/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/09/03/baby_hot/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>孩子反复高热会让家长很受煎熬。  </p>
<p>但是，发热是孩子在积极地对抗感染，不超过41度的发热是烧不坏孩子的。</p>
<p>感染引起的发热本身不会对孩子造成损害，在大脑的体温调控中枢控制下，孩子的体温也不会一直升高。 </p>
<p>发热本身不会导致孩子更多或者异常的哭闹。但发热时频繁的哭闹可能是由于疼痛引起的，如隐藏的原因包括耳部感染、尿路感染、咽喉痛和脑膜炎。</p>
<h2 id="发热的护理"><a href="#发热的护理" class="headerlink" title="发热的护理"></a>发热的护理</h2><p>发热的家庭护理</p>
<ol>
<li>保持孩子的房间凉爽舒适。　　</li>
<li>给孩子穿着轻薄的衣服。　　</li>
<li>鼓励孩子补充足够的水份，鼓励孩子喝各种液体，如水、稀释果汁，或者口服补液盐溶液。　　</li>
<li>让孩子多休息，不建议剧烈运动。</li>
<li>给药前咨询医生</li>
</ol>
<h2 id="什么时候用退烧药"><a href="#什么时候用退烧药" class="headerlink" title="什么时候用退烧药"></a>什么时候用退烧药</h2><p><strong>儿童体温38.5℃以上并且发热伴有不适时可以服用退热药物。</strong></p>
<p>吃退热药是缓解孩子因为发烧而引起的不适，并不是让孩子体温降到正常。</p>
<p>婴幼儿安全的退热药只有对乙酰氨基酚（3个月以上）和布洛芬（6个月以上）。按体重喂药。</p>
<p>需要强调，退热药物可以帮助降低体温让孩子感觉舒服一些，但它们并不能阻止热性惊厥的发作。  </p>
<h2 id="错误的方法"><a href="#错误的方法" class="headerlink" title="错误的方法"></a>错误的方法</h2><ul>
<li>其他任何所谓的中西医退烧药都不要使用，</li>
<li>不要交替使用退烧药，</li>
<li>不要使用退热贴，</li>
<li>不要打退烧针，</li>
<li>不需要物理降温，</li>
<li>不要去做小儿推拿、</li>
<li>更不要使用冰敷和酒精退烧。</li>
</ul>
<h2 id="反复高烧"><a href="#反复高烧" class="headerlink" title="反复高烧"></a>反复高烧</h2><p>2岁内孩子反复高烧，要先考虑流感、幼儿急疹、腺病毒感染、尿路感染（特别是1岁内完全不会表达的婴儿）</p>
<p>童爸认为，绝大多数情况下孩子一天顶多吃2次退烧药就足够多了。</p>
<h2 id="发烧的原因"><a href="#发烧的原因" class="headerlink" title="发烧的原因"></a>发烧的原因</h2><p>当人体被感染后，大脑的体温调控中枢可能会调高人体的温度，从而对抗感染。</p>
<p>在升温期人体觉得很冷的时候，可以适当保暖帮助体温升高；</p>
<p>但是等到体温已经升高进入平台区，孩子的脸部开始变得红润，这时候就应该适当减少衣物。</p>
<h2 id="判断精神状态"><a href="#判断精神状态" class="headerlink" title="判断精神状态"></a>判断精神状态</h2><p>你可以让他看平时他最喜欢的动画片，如果他一看就是很久，看的时候还咯咯地笑个不停，那就说明孩子精神状态不错。</p>
<p>或者吃喜欢的东西，表现出兴趣。</p>
<p>13价肺炎疫苗、hib疫苗、流感疫苗</p>
<h2 id="什么时候看医生"><a href="#什么时候看医生" class="headerlink" title="什么时候看医生"></a>什么时候看医生</h2><ul>
<li>2岁及以上的孩子，发热超过72小时，建议面诊医生。</li>
<li>任何年龄段的孩子，假如伴有昏睡、反应迟钝、惊厥、不吃东西、反复呕吐、呼吸困难、耳朵疼痛等其他严重的症状时，建议立即就医。</li>
<li>孩子伴有脱水（如口干、前囟凹陷或者尿量明显减少），建议立即就医。</li>
<li>热退超过24小时后，再次出现的发热建议面诊医生。</li>
<li>反复发热超过40度，建议面诊医生。</li>
<li>除以上的情况外，您对孩子有任何担心，都可以尽快面诊医生。</li>
</ul>
<p>发热第5天很关键，这是很多疾病的分水岭。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://mp.weixin.qq.com/s/2xfzZ2hmkyFFymgbQ-VHoQ" target="_blank" rel="noopener">卓正的陈英关于发烧的介绍</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/31/compile-text/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/31/compile-text/" itemprop="url">
                  一点点学会编译文本
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-31T16:45:35+08:00">
                2020-08-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/31/compile-text/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/31/compile-text/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!-- hexo遇到{ { } }会出错 -->
<p>使用 vue，都知道<code>左双大括号msg右双大括号</code>，能变成<code>data.msg</code>相对应的值<code>hello</code>。</p>
<p>此文循序渐进实现最终vue中编译文本的效果。</p>
<h2 id="左双大括号msg右双大括号-gt-‘hello’"><a href="#左双大括号msg右双大括号-gt-‘hello’" class="headerlink" title="左双大括号msg右双大括号 =&gt; ‘hello’"></a>左双大括号msg右双大括号 =&gt; ‘hello’</h2><p>这里先不关注 dom 之类的事情，只专注于其中的逻辑。</p>
<p>首先看看以下代码，想想<code>compileText</code>怎么实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123;</span><br><span class="line">  msg: <span class="string">"hello"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> text = <span class="string">"左双大括号msg右双大括号 world"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 想想怎么实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">text = compileText(data, text);</span><br><span class="line"><span class="comment">// 想输出 =&gt; hello world</span></span><br><span class="line"><span class="built_in">console</span>.log(text);</span><br></pre></td></tr></table></figure>
<p>其实这里的逻辑并不难，无外乎先找到<code>左双大括号msg右双大括号</code>，然后将整那个字符串替换成<code>data.msg</code>的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 匹配正则</span></span><br><span class="line">  <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+)\&#125;\&#125;/</span>;</span><br><span class="line">  <span class="keyword">let</span> newText = text.replace(reg, (...args) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 拿到msg</span></span><br><span class="line">    <span class="keyword">let</span> expr = args[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// data里面msg属性的值</span></span><br><span class="line">    <span class="keyword">let</span> value = data[expr];</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回替换完的新字符串</span></span><br><span class="line">  <span class="keyword">return</span> newText;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是 data 里可能也有对象，如<code>{msg:&#39;hello&#39;,person:{name:&#39;hua&#39;右双大括号</code></p>
<p>text 可能就变成<code>左双大括号person.name右双大括号 喜欢西湖</code></p>
<h2 id="左双大括号person-name右双大括号-gt-‘hua’"><a href="#左双大括号person-name右双大括号-gt-‘hua’" class="headerlink" title="左双大括号person.name右双大括号 =&gt; ‘hua’"></a>左双大括号person.name右双大括号 =&gt; ‘hua’</h2><p>其实就是在 <code>compileText</code> 里拿到 <code>value</code> 值的时候，多些操作。</p>
<p>思考下面的 <code>getValue</code> 怎么实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">person</span>: &#123; <span class="attr">name</span>: <span class="string">"hua"</span> &#125; &#125;;</span><br><span class="line"><span class="keyword">let</span> expr = <span class="string">"person.name"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params">data, expr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 想想这里怎么写</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 想输出 =&gt; hua</span></span><br><span class="line"><span class="built_in">console</span>.log(getValue(data, expr));</span><br></pre></td></tr></table></figure>
<p>这里其实就是一层层往下返回，为了写成公用的，会考虑很多层的情况。<br>理解难点是<code>reduce</code>，如果不明白，可以看<a href="https://juejin.im/post/6854573222323552263" target="_blank" rel="noopener">入门怎么使用 reduce</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params">data, expr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 先将每个key分隔开，放进数组里</span></span><br><span class="line">  <span class="keyword">let</span> arr = expr.split(<span class="string">"."</span>);</span><br><span class="line">  <span class="comment">// 下面就是reduce的使用了，写出init和fn，就基本ok了</span></span><br><span class="line">  <span class="keyword">let</span> init = data;</span><br><span class="line">  <span class="keyword">let</span> fn = <span class="function">(<span class="params">acc, cur</span>) =&gt;</span> acc[cur];</span><br><span class="line">  <span class="keyword">let</span> value = arr.reduce(fn, init);</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后升级下 compileText</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 匹配正则</span></span><br><span class="line">  <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+)\&#125;\&#125;/</span>;</span><br><span class="line">  <span class="keyword">let</span> newText = text.replace(reg, (...args) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 拿到msg</span></span><br><span class="line">    <span class="keyword">let</span> expr = args[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// 就改了这里，就能支持多重key</span></span><br><span class="line">    <span class="keyword">let</span> value = getValue(data, expr);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回替换完的新字符串</span></span><br><span class="line">  <span class="keyword">return</span> newText;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// demo演示</span></span><br><span class="line"><span class="keyword">let</span> data = &#123;</span><br><span class="line">  person: &#123; <span class="attr">name</span>: <span class="string">"hua"</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> text = <span class="string">"左双大括号person.name右双大括号 喜欢西湖"</span>;</span><br><span class="line"></span><br><span class="line">text = compileText(data, text);</span><br><span class="line"><span class="comment">// hua 喜欢西湖</span></span><br><span class="line"><span class="built_in">console</span>.log(text);</span><br></pre></td></tr></table></figure>
<h2 id="文本节点编译-lt-div-id-’app’-左双大括号msg右双大括号-lt-b-1-lt-b-左双大括号msg右双大括号-lt-div"><a href="#文本节点编译-lt-div-id-’app’-左双大括号msg右双大括号-lt-b-1-lt-b-左双大括号msg右双大括号-lt-div" class="headerlink" title="文本节点编译 &lt;div id=’app’> 左双大括号msg右双大括号 &lt;b>1&lt;/b> 左双大括号msg右双大括号 &lt;/div>"></a>文本节点编译 &lt;div id=’app’> 左双大括号msg右双大括号 &lt;b>1&lt;/b> 左双大括号msg右双大括号 &lt;/div></h2><p>先试着将<code>div</code>里<strong>子文本节点</strong>里面的表达式正确编译。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>);</span><br><span class="line"><span class="comment">// 找到所有子节点</span></span><br><span class="line"><span class="keyword">let</span> children = [...app.childNodes];</span><br><span class="line">children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 如果是文本节点，就编译</span></span><br><span class="line">  <span class="keyword">if</span> (child.nodeType === <span class="number">3</span>) &#123;</span><br><span class="line">    compileTextNode(child, data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileTextNode</span>(<span class="params">node, data</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 试着写写，就一行代码啦</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>嗯哼，结果如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileTextNode</span>(<span class="params">node, data</span>) </span>&#123;</span><br><span class="line">  node.textContent = compileText(data, node.textContent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="元素节点编译-lt-div-id-’app’-lt-span-左双大括号msg右双大括号-lt-span-lt-div"><a href="#元素节点编译-lt-div-id-’app’-lt-span-左双大括号msg右双大括号-lt-span-lt-div" class="headerlink" title="元素节点编译 &lt;div id=’app’> &lt;span>左双大括号msg右双大括号&lt;/span>&lt;/div>"></a>元素节点编译 &lt;div id=’app’> &lt;span>左双大括号msg右双大括号&lt;/span>&lt;/div></h2><p>现在 span 元素里面有的话，怎么编译呢。<br>其实就是元素节点的话，将其文本元素再挑出来。这里如果深层嵌套，依旧涉及到递归。<br>可以先试试想想，甚至敲敲<code>compileElement</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>);</span><br><span class="line">compileElement(app, data);</span><br><span class="line"><span class="comment">// 增加一个方法，编译元素节点，这里注意，其实只会编译文本节点，如果是元素节点就去找其子文本节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileElement</span>(<span class="params">node, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> children = [...node.childNodes];</span><br><span class="line">  children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">      compileElement(child, data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (child.nodeType === <span class="number">3</span>) &#123;</span><br><span class="line">      compileTextNode(child, data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="避免频繁操作-dom，试试-fragment"><a href="#避免频繁操作-dom，试试-fragment" class="headerlink" title="避免频繁操作 dom，试试 fragment"></a>避免频繁操作 dom，试试 fragment</h2><p>这里 app 里面的节点一直在频繁操作，是很不利于性能的。</p>
<ul>
<li>先将 app 里所有的节点放进文档碎片</li>
<li>编译完之后，再把文档碎片塞进 app 里，完美。</li>
</ul>
<p>代码想想也就没啥大的事了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>);</span><br><span class="line"><span class="comment">// 塞进碎片</span></span><br><span class="line"><span class="keyword">let</span> appFragment = moveToFragment(app);</span><br><span class="line"><span class="comment">// 编辑碎片</span></span><br><span class="line">compileElement(appFragment, data);</span><br><span class="line"><span class="comment">// 碎片在塞进app</span></span><br><span class="line">app.appendChild(appFragment);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">moveToFragment</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line">  <span class="comment">// 来试试写这里实现功能</span></span><br><span class="line">  <span class="keyword">return</span> fragment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答案这样子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">moveToFragment</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line">  <span class="comment">// 高阶可以这样</span></span><br><span class="line">  <span class="comment">// let firstNode;</span></span><br><span class="line">  <span class="comment">// while ((firstNode = node.firstChild)) &#123;</span></span><br><span class="line">  <span class="comment">//   fragment.appendChild(firstNode);</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="keyword">let</span> children = [...node.childNodes];</span><br><span class="line">  children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">    fragment.appendChild(child);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> fragment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="合并写下，编译的整体-demo"><a href="#合并写下，编译的整体-demo" class="headerlink" title="合并写下，编译的整体 demo"></a>合并写下，编译的整体 demo</h2><p>可以直接复制，在本地试试。希望里面的方法能有一些启发。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    左双大括号msg右双大括号</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    左双大括号msg右双大括号</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 塞进碎片</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> appFragment = moveToFragment(app);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 编辑碎片</span></span></span><br><span class="line"><span class="undefined">    compileElement(appFragment, data);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 碎片在塞进app</span></span></span><br><span class="line"><span class="undefined">    app.appendChild(appFragment);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">moveToFragment</span>(<span class="params">node</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span></span><br><span class="line"><span class="javascript">      <span class="comment">// let firstNode;</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// while ((firstNode = node.firstChild)) &#123;</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">//   fragment.appendChild(firstNode);</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> children = [...node.childNodes];</span></span><br><span class="line"><span class="javascript">      children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">        fragment.appendChild(child);</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> fragment;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">compileElement</span>(<span class="params">node, data</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> children = [...node.childNodes];</span></span><br><span class="line"><span class="javascript">      children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (child.nodeType === <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="undefined">          compileElement(child, data);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (child.nodeType === <span class="number">3</span>) &#123;</span></span><br><span class="line"><span class="undefined">          compileTextNode(child, data);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">compileTextNode</span>(<span class="params">node, data</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">      node.textContent = compileText(data, node.textContent);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 匹配正则 注释是高级点的匹配 哈哈哈 我还不会 先粘贴在这里</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// let reg = /\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g;</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+)\&#125;\&#125;/</span>;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> newText = text.replace(reg, (...args) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 拿到msg</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> expr = args[<span class="number">1</span>];</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 就改了这里，就能支持多重key</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> value = getValue(data, expr);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> value;</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 返回替换完的新字符串</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> newText;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params">data, expr</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 先将每个key分隔开，放进数组里</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> arr = expr.split(<span class="string">"."</span>);</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 下面就是reduce的使用了，写出init和fn，就基本ok了</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> init = data;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> fn = <span class="function">(<span class="params">acc, cur</span>) =&gt;</span> acc[cur];</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> value = arr.reduce(fn, init);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> value;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<!--
## <div>左双大括号msg右双大括号</div> => <div>hello</div>

当文本出现在 dom 中的时候，怎么编译。

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  左双大括号msg右双大括号</span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">  左双大括号msg右双大括号</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>拿到一个元素节点里所有的文本节点</li>
<li>遍历所有的文本节点，将文本节点内容中的<code>左双大括号右双大括号</code>正确编译</li>
</ul>
<h3 id="找到一个元素节点里所有的子文本节点"><a href="#找到一个元素节点里所有的子文本节点" class="headerlink" title="找到一个元素节点里所有的子文本节点"></a>找到一个元素节点里所有的子文本节点</h3><p>先找到子文本节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断一个节点是不是文本</span></span><br><span class="line"><span class="keyword">const</span> isText = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">3</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTextNodes</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 最终返回这个数组</span></span><br><span class="line">  <span class="keyword">let</span> textNodes = [];</span><br><span class="line">  <span class="comment">// 这里不能用 node.children 因为其 仅仅表示元素节点</span></span><br><span class="line">  <span class="keyword">let</span> children = [...node.childNodes];</span><br><span class="line">  children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 是文本节点 就push进结果里</span></span><br><span class="line">    isText(child) &amp;&amp; textNodes.push(child);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回拿到的所有文本节点</span></span><br><span class="line">  <span class="keyword">return</span> textNodes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="找到一个元素节点里所有的文本节点"><a href="#找到一个元素节点里所有的文本节点" class="headerlink" title="找到一个元素节点里所有的文本节点"></a>找到一个元素节点里所有的文本节点</h3><p>上面拿到第一层级的子文本节点，如果想继续拿到 <code>span</code> 里的文本节点，就需要递归了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isElement = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> isText = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">3</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTextNodes</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 不是元素节点直接返回空数组，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (!isElement(node)) &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> textNodes = [];</span><br><span class="line">  <span class="comment">// 这里不能用 node.children 因为其 仅仅表示元素节点</span></span><br><span class="line">  <span class="keyword">let</span> children = [...node.childNodes];</span><br><span class="line">  children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 是文本节点 就push进结果里</span></span><br><span class="line">    isText(child) &amp;&amp; textNodes.push(child);</span><br><span class="line">    <span class="comment">// 重点在这里，是元素的话，拿到子节点里面的文本节点，然后和现有的合并</span></span><br><span class="line">    <span class="keyword">if</span> (isElement(child)) &#123;</span><br><span class="line">      textNodes = [...textNodes, ...getTextNodes(child)];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回拿到的所有文本节点</span></span><br><span class="line">  <span class="keyword">return</span> textNodes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再回到例子里，试着遍历文本节点，正确编译。</p>
<h3 id="正确编译所有的文本节点"><a href="#正确编译所有的文本节点" class="headerlink" title="正确编译所有的文本节点"></a>正确编译所有的文本节点</h3><p>这里好像没啥了，直接上码。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  左双大括号msg右双大括号</span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>211221<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>211221 左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="comment">// ...那几个function放这里</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 拿到app里所有文本节点</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">let</span> textNodes = getTextNodes(<span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>));</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(textNodes);</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 遍历替换即可</span></span></span><br><span class="line"><span class="javascript">  textNodes.forEach(<span class="function"><span class="params">textNode</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">    textNode.textContent = compileText(data, textNode.textContent);</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是遍历的时候，频繁操作 dom 了，这是大忌啊。想办法换 fragment 试试。</p>
<h2 id="fragment"><a href="#fragment" class="headerlink" title="fragment"></a>fragment</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">      左双大括号msg右双大括号</span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>211221<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>211221 左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params">data, expr</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 先将每个key分隔开，放进数组里</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> arr = expr.split(<span class="string">"."</span>);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 下面就是reduce的使用了，写出init和fn，就基本ok了</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> init = data;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> fn = <span class="function">(<span class="params">acc, cur</span>) =&gt;</span> acc[cur];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> value = arr.reduce(fn, init);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> value;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 匹配正则</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+)\&#125;\&#125;/</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> newText = text.replace(reg, (...args) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 拿到msg</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">let</span> expr = args[<span class="number">1</span>];</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 就改了这里，就能支持多重key</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">let</span> value = getValue(data, expr);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> value;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 返回替换完的新字符串</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> newText;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="comment">// node</span></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">getTextNodes</span>(<span class="params">node</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> isElement = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">1</span> || node.nodeType === <span class="number">11</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> isText = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">3</span>;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 不是元素节点直接返回空数组</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (!isElement(node)) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> [];</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> textNodes = [];</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 这里不能用 node.children 因为其 仅仅表示元素节点</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> children = [...node.childNodes];</span></span><br><span class="line"><span class="javascript">        children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 是文本节点 就push进结果里</span></span></span><br><span class="line"><span class="undefined">          isText(child) &amp;&amp; textNodes.push(child);</span></span><br><span class="line"><span class="javascript">          <span class="comment">// isText(child) &amp;&amp; (child.textContent = compileText(data, child.textContent));</span></span></span><br><span class="line"><span class="javascript">          <span class="comment">// 是元素的话，拿到子节点里面的文本节点，然后和现有的合并</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">if</span> (isElement(child)) &#123;</span></span><br><span class="line"><span class="undefined">            textNodes = [...textNodes, ...getTextNodes(child)];</span></span><br><span class="line"><span class="javascript">            <span class="comment">// getTextNodes(child,data)</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// textNodes = [...textNodes, ...];</span></span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 返回拿到的所有文本节点</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> textNodes;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">moveInFragment</span>(<span class="params">node</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> children = [...node.childNodes];</span></span><br><span class="line"><span class="javascript">        children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> fragment.appendChild(child));</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> fragment;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      /*</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 要循环这个元素 将里面的内容 换成我们的数据</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> node = <span class="built_in">document</span>.createDocumentFragment();</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> firstChild;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">while</span>(firstChild = el.firstChild)&#123; <span class="comment">// 每次拿到第一个元素就将这个元素放入到文档碎片中</span></span></span><br><span class="line"><span class="javascript">        node.appendChild(firstChild); <span class="comment">// appendChild 是具有移动的功能 </span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    onst defaultRE = <span class="regexp">/\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">const</span> util = &#123;</span></span><br><span class="line"><span class="javascript">    getValue(vm,expr)&#123; <span class="comment">// [msg]</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> keys = expr.split(<span class="string">'.'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> keys.reduce(<span class="function">(<span class="params">memo,current</span>)=&gt;</span>&#123; <span class="comment">// reduce 他具备迭代的功能</span></span></span><br><span class="line"><span class="javascript">            memo = memo[current]; <span class="comment">//  vm.school.name</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> memo</span></span><br><span class="line"><span class="undefined">        &#125;,vm);</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="javascript">    compilerText(node,vm)&#123; <span class="comment">// 编译文本 替换左双大括号school.name右双大括号</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(!node.expr)&#123;</span></span><br><span class="line"><span class="javascript">            node.expr = node.textContent; <span class="comment">// 给节点增加了一个自定义属性 为了方便后续的更新操作</span></span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        node.textContent = node.expr.replace(defaultRE,<span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(util.getValue(vm,args[<span class="number">1</span>]))</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compiler</span>(<span class="params">node,vm</span>)</span>&#123; <span class="comment">// node 就是文档碎片 </span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> childNodes = node.childNodes; <span class="comment">// 只有第一层 只有儿子 没有孙子</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 将类数组转化成数组</span></span></span><br><span class="line"><span class="javascript">    [...childNodes].forEach(<span class="function"><span class="params">child</span>=&gt;</span>&#123; <span class="comment">// 一种是元素 一种是文本 </span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(child.nodeType == <span class="number">1</span>)&#123; <span class="comment">//1 元素  3表示文本</span></span></span><br><span class="line"><span class="javascript">            compiler(child,vm); <span class="comment">// 编译当前元素的孩子节点</span></span></span><br><span class="line"><span class="javascript">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.nodeType == <span class="number">3</span>)&#123;</span></span><br><span class="line"><span class="undefined">            util.compilerText(child,vm);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    */</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">compileNode</span>(<span class="params">node, data</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 先把node里所有阶段移进fragment</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> fragment = moveInFragment(node);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.dir(fragment);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 操作fragment,文本编译</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> textNodes = getTextNodes(fragment);</span></span><br><span class="line"><span class="javascript">        textNodes.forEach(<span class="function"><span class="params">textNode</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">          textNode.textContent = compileText(data, textNode.textContent);</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 替换完之后在重新填充到node里</span></span></span><br><span class="line"><span class="undefined">        node.appendChild(fragment);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span></span><br><span class="line"><span class="javascript">      compileNode(<span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>), data);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&lt;–!&gt;</p>
-->
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/27/radix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/27/radix/" itemprop="url">
                  进制转换的那些事儿
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-27T19:16:56+08:00">
                2020-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/27/radix/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/27/radix/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>总结进制转换的各种情况。注意，字符串类型和数字类型的来回切换。</p>
<p>除了常用的十进制外，js可以直接表示2、8、16进制。</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li><code>console.log( 0b10===2, 02===2, 0x2===2)</code><br>=&gt; 均为true</li>
<li>17的二进制字符串是啥<br>=&gt; <code>(17).toString(2)</code>，”10001”  </li>
<li>二进制字符串<code>&quot;10001&quot;</code>对应的数字是啥<br>=&gt; <code>parseInt(&#39;10001&#39;,2)</code>，17</li>
<li>二进制数字<code>10001</code>对应的数字是啥<br>=&gt; <code>parseInt((10001).toString(),2)</code>，17</li>
<li>二进制数字<code>10001</code>对应的八进制字符串是啥<br>=&gt; <code>parseInt((10001).toString(),2).toString(8)</code>，”21”</li>
<li>都知道的话，就不用往下看了</li>
</ul>
<h2 id="进制的数字格式"><a href="#进制的数字格式" class="headerlink" title="进制的数字格式"></a>进制的数字格式</h2><h3 id="二进制-0b-开头"><a href="#二进制-0b-开头" class="headerlink" title="二进制 - 0b 开头"></a>二进制 - 0b 开头</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0b10</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="built_in">console</span>.log(x)</span><br></pre></td></tr></table></figure>
<h3 id="八进制-0-开头"><a href="#八进制-0-开头" class="headerlink" title="八进制 - 0 开头"></a>八进制 - 0 开头</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">010</span></span><br><span class="line"><span class="comment">// 8</span></span><br><span class="line"><span class="built_in">console</span>.log(x)</span><br></pre></td></tr></table></figure>
<h3 id="十进制-没啥开头"><a href="#十进制-没啥开头" class="headerlink" title="十进制 - 没啥开头"></a>十进制 - 没啥开头</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">10</span></span><br><span class="line"><span class="comment">// 10</span></span><br><span class="line"><span class="built_in">console</span>.log(x)</span><br></pre></td></tr></table></figure>
<h3 id="十六进制-0x-开头"><a href="#十六进制-0x-开头" class="headerlink" title="十六进制 - 0x 开头"></a>十六进制 - 0x 开头</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0x10</span></span><br><span class="line"><span class="comment">// 16</span></span><br><span class="line"><span class="built_in">console</span>.log(x)</span><br></pre></td></tr></table></figure>
<h2 id="数字转换成任意进制的字符串：Number-prototype-toString"><a href="#数字转换成任意进制的字符串：Number-prototype-toString" class="headerlink" title="数字转换成任意进制的字符串：Number.prototype.toString"></a>数字转换成任意进制的字符串：Number.prototype.toString</h2><p>数字类型的可以转化成任意进制的字符串。</p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Number/toString" target="_blank" rel="noopener">mdn的详细解读</a></p>
<p><code>numObj.toString([radix])</code>，radix默认值为 10，范围在2-36。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xTen也可以是0b10001</span></span><br><span class="line"><span class="keyword">var</span> xTen = <span class="number">17</span></span><br><span class="line"><span class="comment">// 转换成2进制 "10001"</span></span><br><span class="line"><span class="keyword">var</span> xTwo = (xTen).toString(<span class="number">2</span>)</span><br><span class="line"><span class="comment">// 转换成8进制 "21"</span></span><br><span class="line"><span class="keyword">var</span> xEight = (xTen).toString(<span class="number">8</span>)</span><br><span class="line"><span class="comment">// 转换成16进制 "11"</span></span><br><span class="line"><span class="keyword">var</span> xSixteen = (xTen).toString(<span class="number">16</span>)</span><br></pre></td></tr></table></figure>
<p>！！！注意，调用toString是数字类型，返回的是字符串类型</p>
<h2 id="任意进制的字符串转化成相应的数字-parseInt-String-radix"><a href="#任意进制的字符串转化成相应的数字-parseInt-String-radix" class="headerlink" title="任意进制的字符串转化成相应的数字: parseInt(String,radix)"></a>任意进制的字符串转化成相应的数字: parseInt(String,radix)</h2><p>任意进制的字符串可以显示成正常的数字，比如二进制”10001”表示的实际数字。</p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/parseInt" target="_blank" rel="noopener">mdn的解释</a></p>
<p><code>parseInt(string, radix)</code>，radix范围在2-36。必须传入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xTen也可以是0b10001</span></span><br><span class="line"><span class="keyword">var</span> xTen = <span class="number">17</span></span><br><span class="line"><span class="comment">// 转换成2进制 "10001"</span></span><br><span class="line"><span class="keyword">var</span> xTwo = (xTen).toString(<span class="number">2</span>)</span><br><span class="line"><span class="comment">// 17，将二进制的字符串，正常表示出来，后面一个参数传入2</span></span><br><span class="line"><span class="keyword">var</span> xTenFormat = <span class="built_in">parseInt</span>(xTwo,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>！！！注意，parseInt是全局函数，第一个参数是字符串，第二个参数是前面的字符串是几进制的。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><blockquote>
<p><a href="https://www.cnblogs.com/amiezhang/p/7940067.html" target="_blank" rel="noopener">浅谈js的数字格式</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/19/observe-arr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/19/observe-arr/" itemprop="url">
                  怎么实现监测数组的变化
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-19T11:42:23+08:00">
                2020-08-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/19/observe-arr/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/19/observe-arr/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://juejin.im/post/6857077890140340238" target="_blank" rel="noopener">之前介绍<code>defineProperty</code></a>的时候说到，其只能监测对象的变化，并不能监测数组的变化。</p>
<p>本文致力于说清楚怎么实现监测数组的变化。</p>
<p><strong>核心思路：找到改变原数组的方法，然后对这些方法进行劫持处理。</strong></p>
<p>上面这句话，是重中之重，务必读三遍，记住了，再往下走。</p>
<p>改变原数组，常用到的方法有<code>push pop shift unshift reverse sort splice</code>。</p>
<p>换言之，这些方法是改变数组的入口。</p>
<h2 id="在数组实例和数组原型之间，加一个新的原型"><a href="#在数组实例和数组原型之间，加一个新的原型" class="headerlink" title="在数组实例和数组原型之间，加一个新的原型"></a>在数组实例和数组原型之间，加一个新的原型</h2><p>直接修改<code>Array.prototype</code>，是极其危险的。<br>换一个思路，复制已有的数组原型，然后修改其中的方法，但这里因为原型上的方法不可枚举，自然也就没法复制。<br>于是再换一个思路，在数组和数组的原型之间，插入一个原型，形成原型链，<code>数组 =&gt; 新原型 =&gt; 数组的原型</code>，可以在新原型上增加同名的方法就可以了。</p>
<p>先借助伪代码理解：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">arr.__proto__ = newPrototype;</span><br><span class="line">newPrototype.__proto__ = <span class="built_in">Array</span>.prototype;</span><br><span class="line"><span class="comment">// 然后可以在新原型上添加同名的方法就可以了</span></span><br><span class="line">newPrototype.push = xxx;</span><br></pre></td></tr></table></figure>
<p>转换成真实的代码如下，核心使用了<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create" target="_blank" rel="noopener">Object.create</a>，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object.create返回一个新对象，而来新对象的__proto__就是传进去的参数。</span></span><br><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"><span class="comment">// 然后可以在新原型上添加同名的方法就可以了</span></span><br><span class="line">newPrototype.push = xxx;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">arr.__proto__ = newPrototype;</span><br></pre></td></tr></table></figure>
<h2 id="以-push-为例，劫持-push"><a href="#以-push-为例，劫持-push" class="headerlink" title="以 push 为例，劫持 push"></a>以 push 为例，劫持 push</h2><p>就是在新原型上重新写一个 push 的方法，里面执行老的 push，但除此之外还可以做点别的事。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在新原型上添加同名push</span></span><br><span class="line">newPrototype.push = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 语义化this</span></span><br><span class="line">  <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"使用了push"</span>);</span><br><span class="line">  <span class="comment">// 最后还是会执行原始的push</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.push.call(curArr, ...args);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">arr.__proto__ = newPrototype;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行push的时候，就会打印了</span></span><br><span class="line">arr.push(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>然后其他的方法也是类似的，试着写写其他的方法</p>
<h2 id="劫持其他的方法"><a href="#劫持其他的方法" class="headerlink" title="劫持其他的方法"></a>劫持其他的方法</h2><p>将其他方法也一起写了，因为逻辑一样，直接遍历即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> methods = [<span class="string">"push"</span>, <span class="string">"pop"</span>, <span class="string">"shift"</span>, <span class="string">"unshift"</span>, <span class="string">"reverse"</span>, <span class="string">"sort"</span>, <span class="string">"splice"</span>];</span><br><span class="line"></span><br><span class="line">methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  newPrototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(<span class="keyword">this</span>, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">arr.__proto__ = newPrototype;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行的时候，就会打印了</span></span><br><span class="line">arr.push(<span class="number">1</span>);</span><br><span class="line">arr.pop();</span><br></pre></td></tr></table></figure>
<h2 id="数组里有数组项的话，也是需要监测的"><a href="#数组里有数组项的话，也是需要监测的" class="headerlink" title="数组里有数组项的话，也是需要监测的"></a>数组里有数组项的话，也是需要监测的</h2><p>这里数组里可能也是有数组的，需要遍历数组的每项，如果是数组的话依然需要指向新的原型。</p>
<p>嗯，对，用到递归了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> methods = [<span class="string">"push"</span>, <span class="string">"pop"</span>, <span class="string">"shift"</span>, <span class="string">"unshift"</span>, <span class="string">"reverse"</span>, <span class="string">"sort"</span>, <span class="string">"splice"</span>];</span><br><span class="line"></span><br><span class="line">methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  newPrototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(<span class="keyword">this</span>, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 既是条件限制，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 整个数组指向新的原型</span></span><br><span class="line">  arr.__proto__ = newPrototype;</span><br><span class="line">  <span class="comment">// 数组的每项，如果是数组，也指向新的原型。</span></span><br><span class="line">  arr.forEach(observeArr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]];</span><br><span class="line">observeArr(arr);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行的时候，就会打印了</span></span><br><span class="line">arr[<span class="number">0</span>].push(<span class="number">1</span>);</span><br><span class="line">arr[<span class="number">1</span>].pop();</span><br></pre></td></tr></table></figure>
<h2 id="数组新添加的项，如果是数组也需要指向新的原型"><a href="#数组新添加的项，如果是数组也需要指向新的原型" class="headerlink" title="数组新添加的项，如果是数组也需要指向新的原型"></a>数组新添加的项，如果是数组也需要指向新的原型</h2><p>能添加元素的方法：<code>push unshift splice</code>。</p>
<p>找到新加的元素，然后是数组的也同样指向新的原型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> methods = [<span class="string">"push"</span>, <span class="string">"pop"</span>, <span class="string">"shift"</span>, <span class="string">"unshift"</span>, <span class="string">"reverse"</span>, <span class="string">"sort"</span>, <span class="string">"splice"</span>];</span><br><span class="line"></span><br><span class="line">methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  newPrototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">let</span> inserted;</span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"push"</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"unshift"</span>:</span><br><span class="line">        inserted = args;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"splice"</span>:</span><br><span class="line">        inserted = args.slice(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    inserted &amp;&amp; observeArr(inserted);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(<span class="keyword">this</span>, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 即是条件限制，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 整个数组指向新的原型</span></span><br><span class="line">  arr.__proto__ = newPrototype;</span><br><span class="line">  <span class="comment">// 数组的每项，如果是数组，也指向新的原型。</span></span><br><span class="line">  arr.forEach(observeArr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这里可以导出去，方便别的文件使用</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> observeArr;</span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">observeArr(arr);</span><br><span class="line"><span class="keyword">let</span> addItem = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.push(addItem);</span><br><span class="line"><span class="comment">// 执行的时候，就会打印了</span></span><br><span class="line">addItem.push(<span class="number">1</span>);</span><br><span class="line">addItem.pop();</span><br></pre></td></tr></table></figure>
<h2 id="综合使用-defineProperty-监测对象和数组"><a href="#综合使用-defineProperty-监测对象和数组" class="headerlink" title="综合使用 defineProperty 监测对象和数组"></a>综合使用 defineProperty 监测对象和数组</h2><p>现在已经有了监测对象的方法，也有了监测数组的方法，将两个综合起来，就能监测数组里面的对象，对象里面的数组了。</p>
<p>将监测数组和监测对象的的可以单独写成一个文件，方便之后使用。</p>
<p>这里为了方便直接运行代码，直接放在一块了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * observeArr的部分</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">// 生成新的原型</span></span><br><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> methods = [<span class="string">"push"</span>, <span class="string">"pop"</span>, <span class="string">"shift"</span>, <span class="string">"unshift"</span>, <span class="string">"reverse"</span>, <span class="string">"sort"</span>, <span class="string">"splice"</span>];</span><br><span class="line"><span class="comment">// 在新原型上面添加以上方法，实现劫持</span></span><br><span class="line">methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  newPrototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">let</span> inserted;</span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"push"</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"unshift"</span>:</span><br><span class="line">        inserted = args;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"splice"</span>:</span><br><span class="line">        inserted = args.slice(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    inserted &amp;&amp; observeArr(inserted);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(<span class="keyword">this</span>, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 新加！！！是对象的话，需要用对象</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.toString.call(arr) === <span class="string">"[object Object]"</span>) &#123;</span><br><span class="line">    observeObj(arr);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="comment">// 整个数组指向新的原型</span></span><br><span class="line">    arr.__proto__ = newPrototype;</span><br><span class="line">    <span class="comment">// 数组的每项，如果是数组，也指向新的原型。</span></span><br><span class="line">    arr.forEach(observeArr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不是对象或者数组的，什么都不做</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * observeObj的部分</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeObj</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 加上参数限制，必须是对象才有劫持，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">"object"</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 新加！！！数组交给数组处理</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) &#123;</span><br><span class="line">    observeArr(obj);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 是对象的话 才开始递归</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, key)) &#123;</span><br><span class="line">      observeKey(obj, key);</span><br><span class="line">      <span class="comment">// 这里劫持该属性的属性值，如果不是对象直接返回，不影响</span></span><br><span class="line">      observeObj(obj[key]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * demo试试</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: [<span class="number">1</span>, <span class="number">2</span>, &#123; <span class="attr">c</span>: <span class="number">2</span> &#125;] &#125;;</span><br><span class="line">observeObj(data);</span><br><span class="line">data.a = <span class="number">2</span>;</span><br><span class="line">data.b.push([<span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [&#123; <span class="attr">a</span>: <span class="string">"数组里的对象"</span> &#125;, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">observeArr(arr);</span><br><span class="line">arr[<span class="number">0</span>].a = <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<h2 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h2><p>当然数组其实可以不通过方法改变，比如直接删除数组可以直接使用 length 属性，或者直接<code>arr[0]=xxx</code>改变数组。 </p>
<p>但只有当使用<code>&quot;push&quot;,&quot;pop&quot;, &quot;shift&quot;,&quot;unshift&quot;,&quot;reverse&quot;,&quot;sort&quot;,&quot;splice&quot;</code>才能检测到数组变化。 </p>
<p>这也是 vue 的缺陷，当然新版的 proxy 将干掉这个缺陷。</p>
<p>所以在使用 vue 的过程中，要尽量使用以上方法操作数组~~~</p>
<h2 id="附注：查看数组的所有属性和方法"><a href="#附注：查看数组的所有属性和方法" class="headerlink" title="附注：查看数组的所有属性和方法"></a>附注：查看数组的所有属性和方法</h2><p>在控制台可以输入<code>dir([])</code>，然后能看到数组所有的属性和方法。</p>
<p>具体用法，可以直接到<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/slice" target="_blank" rel="noopener">到 mdn 上细看，点击侧边栏看对应的方法</a><br><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/array.png" alt="array"></p>
<!-- 

## 以 push 为例，劫持 push

以 push 为例，想想怎么知道用了 push 方法呢。

其实就是在原来的 push 方法上做了劫持，劫持听着高大上，就是高阶函数，里面除了执行 push，还做了其他操作。

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 改写push，这里为了不影响原型上面的push，直接修改arr上的push</span></span><br><span class="line">arr.push = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 语义化this</span></span><br><span class="line">  <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"使用了push"</span>);</span><br><span class="line">  <span class="comment">// 最后还是会执行原始的push</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.push.call(curArr, ...args);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 执行push的时候，就会打印了</span></span><br><span class="line">arr.push(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>现在，试试将其抽象出一个方法，劫持任意一个数组的任意方法。</p>
<h2 id="劫持任意一个数组的任意方法"><a href="#劫持任意一个数组的任意方法" class="headerlink" title="劫持任意一个数组的任意方法"></a>劫持任意一个数组的任意方法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeMethod</span>(<span class="params">arr, method</span>) </span>&#123;</span><br><span class="line">  arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 语义化this</span></span><br><span class="line">    <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 实现劫持方法的操作</span></span><br><span class="line">observeMethod(arr, <span class="string">"push"</span>);</span><br><span class="line">observeMethod(arr, <span class="string">"pop"</span>);</span><br><span class="line">arr.push(<span class="number">1</span>);</span><br><span class="line">arr.pop();</span><br><span class="line"><span class="built_in">console</span>.log(arr);</span><br></pre></td></tr></table></figure>
<p>当然，我们这里只需要劫持，会改变原数组的方法</p>
<h2 id="劫持改变原数组的所有方法"><a href="#劫持改变原数组的所有方法" class="headerlink" title="劫持改变原数组的所有方法"></a>劫持改变原数组的所有方法</h2><p>也就是只需传入想要监测的数组，数组的方法自动劫持。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> methods = [</span><br><span class="line">    <span class="string">"push"</span>,</span><br><span class="line">    <span class="string">"pop"</span>,</span><br><span class="line">    <span class="string">"shift"</span>,</span><br><span class="line">    <span class="string">"unshift"</span>,</span><br><span class="line">    <span class="string">"reverse"</span>,</span><br><span class="line">    <span class="string">"sort"</span>,</span><br><span class="line">    <span class="string">"splice"</span></span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">// 复制一遍上面的</span></span><br><span class="line">  methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 语义化this</span></span><br><span class="line">      <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 实现劫持方法的操作</span></span><br><span class="line">observeArr(arr);</span><br><span class="line">arr.push(<span class="number">1</span>);</span><br><span class="line">arr.pop();</span><br><span class="line"><span class="built_in">console</span>.log(arr);</span><br></pre></td></tr></table></figure>
<p>这里，再往前走，监测数组新加的元素</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> innerArr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.push(innerArr);</span><br><span class="line"><span class="comment">// 希望这里也能监测到新加数组使用了push</span></span><br><span class="line">innerArr.push(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h2 id="递归监测数组新加的元素，还是以-push-为例"><a href="#递归监测数组新加的元素，还是以-push-为例" class="headerlink" title="递归监测数组新加的元素，还是以 push 为例"></a>递归监测数组新加的元素，还是以 push 为例</h2><p>很像之前的 defineProperty 递归对象的属性。其实递归很多都是这个思路。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 不是数组的直接返回，也是递归终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> methods = [</span><br><span class="line">    <span class="string">"push"</span>,</span><br><span class="line">    <span class="string">"pop"</span>,</span><br><span class="line">    <span class="string">"shift"</span>,</span><br><span class="line">    <span class="string">"unshift"</span>,</span><br><span class="line">    <span class="string">"reverse"</span>,</span><br><span class="line">    <span class="string">"sort"</span>,</span><br><span class="line">    <span class="string">"splice"</span></span><br><span class="line">  ];</span><br><span class="line">  methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 语义化this</span></span><br><span class="line">      <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 如果是push,新添加的项都进行监测下，这里不是数组的会递归终止</span></span><br><span class="line">      <span class="keyword">if</span> (method === <span class="string">"push"</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> inserts = args;</span><br><span class="line">        inserts.forEach(<span class="function"><span class="params">item</span> =&gt;</span> observeArr(item));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 实现劫持方法的操作</span></span><br><span class="line">observeArr(arr);</span><br><span class="line"><span class="keyword">let</span> innerArr = [<span class="number">67</span>, <span class="number">78</span>];</span><br><span class="line">arr.push(innerArr);</span><br><span class="line">innerArr.push(<span class="number">89</span>);</span><br><span class="line">arr.pop();</span><br><span class="line"><span class="built_in">console</span>.log(arr, innerArr);</span><br></pre></td></tr></table></figure>
<h2 id="递归，其他增加数组元素的方法"><a href="#递归，其他增加数组元素的方法" class="headerlink" title="递归，其他增加数组元素的方法"></a>递归，其他增加数组元素的方法</h2><p>改变原数组且增加数组元素的方法有：<code>push unshift splice</code>。<br>将所有新增的项，进行监测。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> methods = [</span><br><span class="line">    <span class="string">"push"</span>,</span><br><span class="line">    <span class="string">"pop"</span>,</span><br><span class="line">    <span class="string">"shift"</span>,</span><br><span class="line">    <span class="string">"unshift"</span>,</span><br><span class="line">    <span class="string">"reverse"</span>,</span><br><span class="line">    <span class="string">"sort"</span>,</span><br><span class="line">    <span class="string">"splice"</span></span><br><span class="line">  ];</span><br><span class="line">  methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 语义化this</span></span><br><span class="line">      <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 将新加的项找到</span></span><br><span class="line">      <span class="keyword">let</span> addItems;</span><br><span class="line">      <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"push"</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"unshift"</span>:</span><br><span class="line">          addItems = args;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"splice"</span>:</span><br><span class="line">          addItems = args.slice(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将添加的每项监测</span></span><br><span class="line">      addItems &amp;&amp; addItems.forEach(<span class="function"><span class="params">item</span> =&gt;</span> observeArr(item));</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 实现劫持方法的操作</span></span><br><span class="line">observeArr(arr);</span><br><span class="line"><span class="keyword">let</span> innerArr = [<span class="number">67</span>, <span class="number">78</span>];</span><br><span class="line">arr.push(innerArr);</span><br><span class="line">innerArr.unshift(<span class="number">89</span>);</span><br><span class="line">arr.pop();</span><br><span class="line"><span class="built_in">console</span>.log(arr, innerArr);</span><br></pre></td></tr></table></figure>
<h2 id="综合使用-defineProperty-监测对象和数组-1"><a href="#综合使用-defineProperty-监测对象和数组-1" class="headerlink" title="综合使用 defineProperty 监测对象和数组"></a>综合使用 defineProperty 监测对象和数组</h2><p>换言之，不论对象或者数组都能监测其变化。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 新加！！！给数组的每项，添加监测</span></span><br><span class="line">  arr.forEach(<span class="function"><span class="params">item</span> =&gt;</span> observeObj(item));</span><br><span class="line">  <span class="keyword">let</span> methods = [</span><br><span class="line">    <span class="string">"push"</span>,</span><br><span class="line">    <span class="string">"pop"</span>,</span><br><span class="line">    <span class="string">"shift"</span>,</span><br><span class="line">    <span class="string">"unshift"</span>,</span><br><span class="line">    <span class="string">"reverse"</span>,</span><br><span class="line">    <span class="string">"sort"</span>,</span><br><span class="line">    <span class="string">"splice"</span></span><br><span class="line">  ];</span><br><span class="line">  methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 语义化this</span></span><br><span class="line">      <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 将新加的项找到</span></span><br><span class="line">      <span class="keyword">let</span> addItems;</span><br><span class="line">      <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"push"</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"unshift"</span>:</span><br><span class="line">          addItems = args;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"splice"</span>:</span><br><span class="line">          addItems = args.slice(<span class="number">2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 修改！！！ 将添加的每项监测，是对象的监测对象 是数组的监测数组</span></span><br><span class="line">      addItems &amp;&amp; addItems.forEach(<span class="function"><span class="params">item</span> =&gt;</span> observeObj(item));</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeObj</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 新加！！！数组另外处理</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) &#123;</span><br><span class="line">    observeArr(obj);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 加上参数限制，必须是对象才有劫持，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">"object"</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, key)) &#123;</span><br><span class="line">      observeKey(obj, key);</span><br><span class="line">      <span class="comment">// 这里劫持该属性的属性值，如果不是对象直接返回，不影响</span></span><br><span class="line">      observeObj(obj[key]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: [<span class="number">1</span>, <span class="number">2</span>, &#123; <span class="attr">c</span>: <span class="number">2</span> &#125;] &#125;;</span><br><span class="line">observeObj(data);</span><br><span class="line">data.a = <span class="number">2</span>;</span><br><span class="line">data.b.push([<span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(data.b[<span class="number">2</span>].c);</span><br></pre></td></tr></table></figure>
<p>–&gt;</p>
-->
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/04/write-vue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/04/write-vue/" itemprop="url">
                  defineProperty怎么实现属性劫持
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-04T19:09:42+08:00">
                2020-08-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/04/write-vue/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/04/write-vue/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>defineProperty</code>是vue实现数据劫持的核心，本文一点点的说明<code>defineProperty</code>怎么实现属性劫持的。</p>
<p>其实我们一般的操作对象属性的方式，增加或者修改属性，均可以使用<code>Object.defineProperty</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line"><span class="comment">// 寻常操作：增加/修改 新属性</span></span><br><span class="line">obj.a = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 等同于：</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(o, <span class="string">"a"</span>, &#123;</span><br><span class="line">  value: <span class="number">1</span>,</span><br><span class="line">  writable: <span class="literal">true</span>,</span><br><span class="line">  configurable: <span class="literal">true</span>,</span><br><span class="line">  enumerable: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当然寻常的例子，我们是不会这么玩的，太啰嗦了。  </p>
<p>但<code>defineProperty</code>可以更精确地添加或修改对象的属性。</p>
<h2 id="描述符"><a href="#描述符" class="headerlink" title="描述符"></a>描述符</h2><p>先说个专有名词：<code>描述符</code>。</p>
<p>其实就是<code>defineProperty</code>的第三个参数，是个对象。这个对象的有以下属性：</p>
<ul>
<li>configurable 属性：能不能修改描述符，就是能不能再次修改描述符的其他属性</li>
<li>enumerable 属性：能不能枚举该属性，就是 a 属性能不能被 for 到</li>
<li>writable 属性：能不能修改属性值，就是能不能这样修改<code>obj.a = 1</code></li>
<li>value 属性：该属性的值</li>
<li>get 属性：是个函数，当访问该属性的时候，函数自动调用，<strong>函数返回值就是该属性的值</strong></li>
<li>set 属性：是个函数，当修改该属性的时候，函数自动调用，<strong>函数有且只有一个参数，赋值的新值</strong></li>
</ul>
<p>注意！！！</p>
<ul>
<li><strong>描述符里的<code>value属性 writable属性</code> 与 <code>get属性 set属性</code>是互斥的关系</strong>，只能存在一个</li>
<li>另外的属性默认值都是<code>false</code>，不想<code>false</code>的话，记得配置哈，不细说（主要我也不怎么用）。</li>
</ul>
<h2 id="细说get-和-set"><a href="#细说get-和-set" class="headerlink" title="细说get 和 set"></a>细说get 和 set</h2><ul>
<li>get 属性：是个函数，当访问该属性的时候，函数自动调用，<strong>函数返回值就是该属性的值</strong></li>
<li>set 属性：是个函数，当修改该属性的时候，函数自动调用，<strong>函数有且只有一个参数，赋值的新值</strong></li>
</ul>
<p>默念三遍，背诵。  </p>
<p>写个get 和 set 的例子辅助理解。  </p>
<p><strong>这个例子必须掌握，弄懂之后基本就掌握了数据劫持的精髓了</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> value = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(obj, <span class="string">"b"</span>, &#123;</span><br><span class="line">  get() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"读取b属性"</span>, value);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;,</span><br><span class="line">  set(newValue) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"设置b属性"</span>, newValue);</span><br><span class="line">    value = newValue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 触发get函数，get的返回值就是属性值</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.b);</span><br><span class="line"><span class="comment">// 触发set函数，value的值变成了2，注意！！！，此时内存里，属性值并没有改变</span></span><br><span class="line">obj.b = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// 但是，想要读取属性值的时候，就必然会触发get函数，属性值也自然就改变了，这个思想真的很赞</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.b);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里有个坑：<code>get</code>里是不能有读取的操作，不然一直死循环，所以使用到<code>get set</code>的地方，总需要借助一个变量</p>
</blockquote>
<p>所以，这里，变量<code>value</code>的值就是属性的值，如果想要修改属性，修改 value 的值即可。</p>
<p>这个例子弄懂了，get，set 的精髓，我觉得也就差不多了。</p>
<h2 id="劫持对象的某个属性"><a href="#劫持对象的某个属性" class="headerlink" title="劫持对象的某个属性"></a>劫持对象的某个属性</h2><p>有了刚刚例子的基础，试着写写劫持对象的任意一个属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line">observeKey(obj, <span class="string">"a"</span>);</span><br><span class="line"><span class="comment">// 读取a，触发get函数</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a);</span><br><span class="line"><span class="comment">// 设置a，触发set函数</span></span><br><span class="line">obj.a = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h2 id="劫持对象的所有属性"><a href="#劫持对象的所有属性" class="headerlink" title="劫持对象的所有属性"></a>劫持对象的所有属性</h2><p>再试试劫持对象的所有属性</p>
<p>其实就是遍历：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeObj</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, key)) &#123;</span><br><span class="line">      observeKey(obj, key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span> &#125;;</span><br><span class="line">observeObj(obj);</span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br><span class="line"><span class="comment">// 读取a，触发get函数</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a);</span><br><span class="line"><span class="comment">// 设置a，触发set函数</span></span><br><span class="line">obj.a = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h2 id="劫持对象的所有属性-包括对象类型的属性值"><a href="#劫持对象的所有属性-包括对象类型的属性值" class="headerlink" title="劫持对象的所有属性 - 包括对象类型的属性值"></a>劫持对象的所有属性 - 包括对象类型的属性值</h2><p>上面的有个缺陷，就是当属性值也是对象的时候，不能劫持属性值，如<code>{a:1,c:{b:1}}</code></p>
<p>简单，补上就行。  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeObj</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 加上参数限制，必须是对象才有劫持</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">"object"</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, key)) &#123;</span><br><span class="line">      observeKey(obj, key);</span><br><span class="line">      <span class="comment">// 这里劫持该属性的属性值，如果不是对象直接返回，不影响</span></span><br><span class="line">      observeObj(obj[key]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: &#123; <span class="attr">name</span>: <span class="string">"c"</span> &#125; &#125;;</span><br><span class="line">observeObj(obj);</span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br><span class="line"><span class="comment">// 读取a，触发get函数</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a);</span><br><span class="line"><span class="comment">// 设置a，触发set函数</span></span><br><span class="line">obj.a = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 触发set函数</span></span><br><span class="line">obj.c.name = <span class="string">"d"</span>;</span><br></pre></td></tr></table></figure>
<h2 id="defineProperty的缺陷"><a href="#defineProperty的缺陷" class="headerlink" title="defineProperty的缺陷"></a>defineProperty的缺陷</h2><ul>
<li>不能监测对象删除属性</li>
<li>不能劫持数组的修改</li>
<li><code>observeObj</code>这个函数的缺陷，不能劫持对象的新增属性，只能劫持对象已有的属性</li>
</ul>
<p>这也是vue里面为啥有<code>$set/$delete</code>以及对数组的限制。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: [<span class="number">1</span>, <span class="number">2</span>] &#125;;</span><br><span class="line">observeObj(obj);</span><br><span class="line"><span class="comment">// 新增属性</span></span><br><span class="line">obj.c = <span class="number">3</span>;</span><br><span class="line"><span class="comment">// 不会触发get函数</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.c);</span><br><span class="line"><span class="comment">// 不会触发set函数</span></span><br><span class="line">obj.b.push(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h2 id="defineProperty还可以挂载属性"><a href="#defineProperty还可以挂载属性" class="headerlink" title="defineProperty还可以挂载属性"></a>defineProperty还可以挂载属性</h2><p>其实就是访问<code>options.data.name</code> 可以简写成 <code>options.name</code>，专业话术，将data上的属性挂载到options上</p>
<p>相当于，用<code>defineProperty</code>，在options上增加新属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先挂载单个属性</span></span><br><span class="line"><span class="comment">// options.data相当于source options相当于target</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxyKey</span>(<span class="params">target, source, key</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">    <span class="comment">// 这里的source[key]相当于变量value，所以说最简单的那个例子是核心</span></span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="keyword">return</span> source[key];</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newValue === source[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      source[key] = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 遍历属性，挂载下</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxyObj</span>(<span class="params">target, source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(source, key)) &#123;</span><br><span class="line">      proxyKey(target, source, key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">  data: &#123; <span class="attr">name</span>: <span class="number">1</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line">proxyObj(options, options.data);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(options.name);</span><br></pre></td></tr></table></figure>
<p>话说，vue的属性劫持和挂载属性，核心原理差不多就是上面这些。</p>
<h2 id="defineProperty还能写日志"><a href="#defineProperty还能写日志" class="headerlink" title="defineProperty还能写日志"></a>defineProperty还能写日志</h2><p>比如 obj 有个属性，此属性值经常变化，想要记录其所有变化的值，以此可以形成日志。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> log = [obj.a];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> value = obj.a;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(obj, <span class="string">"a"</span>, &#123;</span><br><span class="line">  get() &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;,</span><br><span class="line">  set(newValue) &#123;</span><br><span class="line">    <span class="keyword">if</span> (newValue === value) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value = newValue;</span><br><span class="line">    log.push(newValue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">obj.a = <span class="number">2</span>;</span><br><span class="line">obj.a = <span class="number">3</span>;</span><br><span class="line">obj.a = <span class="number">4</span>;</span><br><span class="line"><span class="comment">// [1,2,3,4]</span></span><br><span class="line"><span class="built_in">console</span>.log(log);</span><br></pre></td></tr></table></figure>
<p>通用的可以抽离出一个类，专门记录某个值的变化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Archiver</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.archive = [];</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, <span class="string">"a"</span>, &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">      &#125;,</span><br><span class="line">      set(newValue) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newValue === value) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">this</span>.archive.push(newValue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> archiver = <span class="keyword">new</span> Archiver();</span><br><span class="line">archiver.a = <span class="number">1</span>;</span><br><span class="line">archiver.a = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// [1,2]</span></span><br><span class="line"><span class="built_in">console</span>.log(archiver.archive);</span><br></pre></td></tr></table></figure>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener">MDN的defineProperty</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://omizt4opc.bkt.clouddn.com/avatar.jpg"
               alt="frontzhm" />
          <p class="site-author-name" itemprop="name">frontzhm</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">203</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">38</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">frontzhm</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"frontzhm"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
