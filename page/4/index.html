<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="frontzhm, zhm, huahua, hua_hua" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="hello world">
<meta property="og:type" content="website">
<meta property="og:title" content="花花的博客">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="花花的博客">
<meta property="og:description" content="hello world">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="花花的博客">
<meta name="twitter:description" content="hello world">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title> 花花的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?60f2cb5747a596a24f2a053f1650c30b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">花花的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/31/compile-text/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/31/compile-text/" itemprop="url">
                  一点点学会编译文本
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-31T16:45:35+08:00">
                2020-08-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/31/compile-text/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/31/compile-text/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!-- hexo遇到{ { } }会出错 -->
<p>使用 vue，都知道<code>左双大括号msg右双大括号</code>，能变成<code>data.msg</code>相对应的值<code>hello</code>。</p>
<p>此文循序渐进实现最终vue中编译文本的效果。</p>
<h2 id="左双大括号msg右双大括号-gt-‘hello’"><a href="#左双大括号msg右双大括号-gt-‘hello’" class="headerlink" title="左双大括号msg右双大括号 =&gt; ‘hello’"></a>左双大括号msg右双大括号 =&gt; ‘hello’</h2><p>这里先不关注 dom 之类的事情，只专注于其中的逻辑。</p>
<p>首先看看以下代码，想想<code>compileText</code>怎么实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123;</span><br><span class="line">  msg: <span class="string">"hello"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> text = <span class="string">"左双大括号msg右双大括号 world"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 想想怎么实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">text = compileText(data, text);</span><br><span class="line"><span class="comment">// 想输出 =&gt; hello world</span></span><br><span class="line"><span class="built_in">console</span>.log(text);</span><br></pre></td></tr></table></figure>
<p>其实这里的逻辑并不难，无外乎先找到<code>左双大括号msg右双大括号</code>，然后将整那个字符串替换成<code>data.msg</code>的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 匹配正则</span></span><br><span class="line">  <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+)\&#125;\&#125;/</span>;</span><br><span class="line">  <span class="keyword">let</span> newText = text.replace(reg, (...args) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 拿到msg</span></span><br><span class="line">    <span class="keyword">let</span> expr = args[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// data里面msg属性的值</span></span><br><span class="line">    <span class="keyword">let</span> value = data[expr];</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回替换完的新字符串</span></span><br><span class="line">  <span class="keyword">return</span> newText;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是 data 里可能也有对象，如<code>{msg:&#39;hello&#39;,person:{name:&#39;hua&#39;右双大括号</code></p>
<p>text 可能就变成<code>左双大括号person.name右双大括号 喜欢西湖</code></p>
<h2 id="左双大括号person-name右双大括号-gt-‘hua’"><a href="#左双大括号person-name右双大括号-gt-‘hua’" class="headerlink" title="左双大括号person.name右双大括号 =&gt; ‘hua’"></a>左双大括号person.name右双大括号 =&gt; ‘hua’</h2><p>其实就是在 <code>compileText</code> 里拿到 <code>value</code> 值的时候，多些操作。</p>
<p>思考下面的 <code>getValue</code> 怎么实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">person</span>: &#123; <span class="attr">name</span>: <span class="string">"hua"</span> &#125; &#125;;</span><br><span class="line"><span class="keyword">let</span> expr = <span class="string">"person.name"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params">data, expr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 想想这里怎么写</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 想输出 =&gt; hua</span></span><br><span class="line"><span class="built_in">console</span>.log(getValue(data, expr));</span><br></pre></td></tr></table></figure>
<p>这里其实就是一层层往下返回，为了写成公用的，会考虑很多层的情况。<br>理解难点是<code>reduce</code>，如果不明白，可以看<a href="https://juejin.im/post/6854573222323552263" target="_blank" rel="noopener">入门怎么使用 reduce</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params">data, expr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 先将每个key分隔开，放进数组里</span></span><br><span class="line">  <span class="keyword">let</span> arr = expr.split(<span class="string">"."</span>);</span><br><span class="line">  <span class="comment">// 下面就是reduce的使用了，写出init和fn，就基本ok了</span></span><br><span class="line">  <span class="keyword">let</span> init = data;</span><br><span class="line">  <span class="keyword">let</span> fn = <span class="function">(<span class="params">acc, cur</span>) =&gt;</span> acc[cur];</span><br><span class="line">  <span class="keyword">let</span> value = arr.reduce(fn, init);</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后升级下 compileText</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 匹配正则</span></span><br><span class="line">  <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+)\&#125;\&#125;/</span>;</span><br><span class="line">  <span class="keyword">let</span> newText = text.replace(reg, (...args) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 拿到msg</span></span><br><span class="line">    <span class="keyword">let</span> expr = args[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// 就改了这里，就能支持多重key</span></span><br><span class="line">    <span class="keyword">let</span> value = getValue(data, expr);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回替换完的新字符串</span></span><br><span class="line">  <span class="keyword">return</span> newText;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// demo演示</span></span><br><span class="line"><span class="keyword">let</span> data = &#123;</span><br><span class="line">  person: &#123; <span class="attr">name</span>: <span class="string">"hua"</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> text = <span class="string">"左双大括号person.name右双大括号 喜欢西湖"</span>;</span><br><span class="line"></span><br><span class="line">text = compileText(data, text);</span><br><span class="line"><span class="comment">// hua 喜欢西湖</span></span><br><span class="line"><span class="built_in">console</span>.log(text);</span><br></pre></td></tr></table></figure>
<h2 id="文本节点编译-lt-div-id-’app’-左双大括号msg右双大括号-lt-b-1-lt-b-左双大括号msg右双大括号-lt-div"><a href="#文本节点编译-lt-div-id-’app’-左双大括号msg右双大括号-lt-b-1-lt-b-左双大括号msg右双大括号-lt-div" class="headerlink" title="文本节点编译 &lt;div id=’app’> 左双大括号msg右双大括号 &lt;b>1&lt;/b> 左双大括号msg右双大括号 &lt;/div>"></a>文本节点编译 &lt;div id=’app’> 左双大括号msg右双大括号 &lt;b>1&lt;/b> 左双大括号msg右双大括号 &lt;/div></h2><p>先试着将<code>div</code>里<strong>子文本节点</strong>里面的表达式正确编译。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>);</span><br><span class="line"><span class="comment">// 找到所有子节点</span></span><br><span class="line"><span class="keyword">let</span> children = [...app.childNodes];</span><br><span class="line">children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 如果是文本节点，就编译</span></span><br><span class="line">  <span class="keyword">if</span> (child.nodeType === <span class="number">3</span>) &#123;</span><br><span class="line">    compileTextNode(child, data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileTextNode</span>(<span class="params">node, data</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 试着写写，就一行代码啦</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>嗯哼，结果如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileTextNode</span>(<span class="params">node, data</span>) </span>&#123;</span><br><span class="line">  node.textContent = compileText(data, node.textContent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="元素节点编译-lt-div-id-’app’-lt-span-左双大括号msg右双大括号-lt-span-lt-div"><a href="#元素节点编译-lt-div-id-’app’-lt-span-左双大括号msg右双大括号-lt-span-lt-div" class="headerlink" title="元素节点编译 &lt;div id=’app’> &lt;span>左双大括号msg右双大括号&lt;/span>&lt;/div>"></a>元素节点编译 &lt;div id=’app’> &lt;span>左双大括号msg右双大括号&lt;/span>&lt;/div></h2><p>现在 span 元素里面有的话，怎么编译呢。<br>其实就是元素节点的话，将其文本元素再挑出来。这里如果深层嵌套，依旧涉及到递归。<br>可以先试试想想，甚至敲敲<code>compileElement</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>);</span><br><span class="line">compileElement(app, data);</span><br><span class="line"><span class="comment">// 增加一个方法，编译元素节点，这里注意，其实只会编译文本节点，如果是元素节点就去找其子文本节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileElement</span>(<span class="params">node, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> children = [...node.childNodes];</span><br><span class="line">  children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">      compileElement(child, data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (child.nodeType === <span class="number">3</span>) &#123;</span><br><span class="line">      compileTextNode(child, data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="避免频繁操作-dom，试试-fragment"><a href="#避免频繁操作-dom，试试-fragment" class="headerlink" title="避免频繁操作 dom，试试 fragment"></a>避免频繁操作 dom，试试 fragment</h2><p>这里 app 里面的节点一直在频繁操作，是很不利于性能的。</p>
<ul>
<li>先将 app 里所有的节点放进文档碎片</li>
<li>编译完之后，再把文档碎片塞进 app 里，完美。</li>
</ul>
<p>代码想想也就没啥大的事了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>);</span><br><span class="line"><span class="comment">// 塞进碎片</span></span><br><span class="line"><span class="keyword">let</span> appFragment = moveToFragment(app);</span><br><span class="line"><span class="comment">// 编辑碎片</span></span><br><span class="line">compileElement(appFragment, data);</span><br><span class="line"><span class="comment">// 碎片在塞进app</span></span><br><span class="line">app.appendChild(appFragment);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">moveToFragment</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line">  <span class="comment">// 来试试写这里实现功能</span></span><br><span class="line">  <span class="keyword">return</span> fragment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答案这样子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">moveToFragment</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line">  <span class="comment">// 高阶可以这样</span></span><br><span class="line">  <span class="comment">// let firstNode;</span></span><br><span class="line">  <span class="comment">// while ((firstNode = node.firstChild)) &#123;</span></span><br><span class="line">  <span class="comment">//   fragment.appendChild(firstNode);</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="keyword">let</span> children = [...node.childNodes];</span><br><span class="line">  children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">    fragment.appendChild(child);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> fragment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="合并写下，编译的整体-demo"><a href="#合并写下，编译的整体-demo" class="headerlink" title="合并写下，编译的整体 demo"></a>合并写下，编译的整体 demo</h2><p>可以直接复制，在本地试试。希望里面的方法能有一些启发。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    左双大括号msg右双大括号</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    左双大括号msg右双大括号</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 塞进碎片</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> appFragment = moveToFragment(app);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 编辑碎片</span></span></span><br><span class="line"><span class="undefined">    compileElement(appFragment, data);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 碎片在塞进app</span></span></span><br><span class="line"><span class="undefined">    app.appendChild(appFragment);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">moveToFragment</span>(<span class="params">node</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span></span><br><span class="line"><span class="javascript">      <span class="comment">// let firstNode;</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// while ((firstNode = node.firstChild)) &#123;</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">//   fragment.appendChild(firstNode);</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> children = [...node.childNodes];</span></span><br><span class="line"><span class="javascript">      children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">        fragment.appendChild(child);</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> fragment;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">compileElement</span>(<span class="params">node, data</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> children = [...node.childNodes];</span></span><br><span class="line"><span class="javascript">      children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (child.nodeType === <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="undefined">          compileElement(child, data);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (child.nodeType === <span class="number">3</span>) &#123;</span></span><br><span class="line"><span class="undefined">          compileTextNode(child, data);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">compileTextNode</span>(<span class="params">node, data</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">      node.textContent = compileText(data, node.textContent);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 匹配正则 注释是高级点的匹配 哈哈哈 我还不会 先粘贴在这里</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// let reg = /\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g;</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+)\&#125;\&#125;/</span>;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> newText = text.replace(reg, (...args) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 拿到msg</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> expr = args[<span class="number">1</span>];</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 就改了这里，就能支持多重key</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> value = getValue(data, expr);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> value;</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 返回替换完的新字符串</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> newText;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params">data, expr</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 先将每个key分隔开，放进数组里</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> arr = expr.split(<span class="string">"."</span>);</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 下面就是reduce的使用了，写出init和fn，就基本ok了</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> init = data;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> fn = <span class="function">(<span class="params">acc, cur</span>) =&gt;</span> acc[cur];</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> value = arr.reduce(fn, init);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> value;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<!--
## <div>左双大括号msg右双大括号</div> => <div>hello</div>

当文本出现在 dom 中的时候，怎么编译。

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  左双大括号msg右双大括号</span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">  左双大括号msg右双大括号</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>拿到一个元素节点里所有的文本节点</li>
<li>遍历所有的文本节点，将文本节点内容中的<code>左双大括号右双大括号</code>正确编译</li>
</ul>
<h3 id="找到一个元素节点里所有的子文本节点"><a href="#找到一个元素节点里所有的子文本节点" class="headerlink" title="找到一个元素节点里所有的子文本节点"></a>找到一个元素节点里所有的子文本节点</h3><p>先找到子文本节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断一个节点是不是文本</span></span><br><span class="line"><span class="keyword">const</span> isText = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">3</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTextNodes</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 最终返回这个数组</span></span><br><span class="line">  <span class="keyword">let</span> textNodes = [];</span><br><span class="line">  <span class="comment">// 这里不能用 node.children 因为其 仅仅表示元素节点</span></span><br><span class="line">  <span class="keyword">let</span> children = [...node.childNodes];</span><br><span class="line">  children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 是文本节点 就push进结果里</span></span><br><span class="line">    isText(child) &amp;&amp; textNodes.push(child);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回拿到的所有文本节点</span></span><br><span class="line">  <span class="keyword">return</span> textNodes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="找到一个元素节点里所有的文本节点"><a href="#找到一个元素节点里所有的文本节点" class="headerlink" title="找到一个元素节点里所有的文本节点"></a>找到一个元素节点里所有的文本节点</h3><p>上面拿到第一层级的子文本节点，如果想继续拿到 <code>span</code> 里的文本节点，就需要递归了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isElement = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> isText = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">3</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTextNodes</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 不是元素节点直接返回空数组，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (!isElement(node)) &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> textNodes = [];</span><br><span class="line">  <span class="comment">// 这里不能用 node.children 因为其 仅仅表示元素节点</span></span><br><span class="line">  <span class="keyword">let</span> children = [...node.childNodes];</span><br><span class="line">  children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 是文本节点 就push进结果里</span></span><br><span class="line">    isText(child) &amp;&amp; textNodes.push(child);</span><br><span class="line">    <span class="comment">// 重点在这里，是元素的话，拿到子节点里面的文本节点，然后和现有的合并</span></span><br><span class="line">    <span class="keyword">if</span> (isElement(child)) &#123;</span><br><span class="line">      textNodes = [...textNodes, ...getTextNodes(child)];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回拿到的所有文本节点</span></span><br><span class="line">  <span class="keyword">return</span> textNodes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再回到例子里，试着遍历文本节点，正确编译。</p>
<h3 id="正确编译所有的文本节点"><a href="#正确编译所有的文本节点" class="headerlink" title="正确编译所有的文本节点"></a>正确编译所有的文本节点</h3><p>这里好像没啥了，直接上码。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  左双大括号msg右双大括号</span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>211221<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>211221 左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="comment">// ...那几个function放这里</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 拿到app里所有文本节点</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">let</span> textNodes = getTextNodes(<span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>));</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(textNodes);</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 遍历替换即可</span></span></span><br><span class="line"><span class="javascript">  textNodes.forEach(<span class="function"><span class="params">textNode</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">    textNode.textContent = compileText(data, textNode.textContent);</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是遍历的时候，频繁操作 dom 了，这是大忌啊。想办法换 fragment 试试。</p>
<h2 id="fragment"><a href="#fragment" class="headerlink" title="fragment"></a>fragment</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">      左双大括号msg右双大括号</span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>211221<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>211221 左双大括号msg右双大括号<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params">data, expr</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 先将每个key分隔开，放进数组里</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> arr = expr.split(<span class="string">"."</span>);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 下面就是reduce的使用了，写出init和fn，就基本ok了</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> init = data;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> fn = <span class="function">(<span class="params">acc, cur</span>) =&gt;</span> acc[cur];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> value = arr.reduce(fn, init);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> value;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">compileText</span>(<span class="params">data, text</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 匹配正则</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.+)\&#125;\&#125;/</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> newText = text.replace(reg, (...args) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 拿到msg</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">let</span> expr = args[<span class="number">1</span>];</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 就改了这里，就能支持多重key</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">let</span> value = getValue(data, expr);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> value;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 返回替换完的新字符串</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> newText;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="comment">// node</span></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">getTextNodes</span>(<span class="params">node</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> isElement = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">1</span> || node.nodeType === <span class="number">11</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> isText = <span class="function"><span class="params">node</span> =&gt;</span> node.nodeType === <span class="number">3</span>;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 不是元素节点直接返回空数组</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (!isElement(node)) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> [];</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> textNodes = [];</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 这里不能用 node.children 因为其 仅仅表示元素节点</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> children = [...node.childNodes];</span></span><br><span class="line"><span class="javascript">        children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 是文本节点 就push进结果里</span></span></span><br><span class="line"><span class="undefined">          isText(child) &amp;&amp; textNodes.push(child);</span></span><br><span class="line"><span class="javascript">          <span class="comment">// isText(child) &amp;&amp; (child.textContent = compileText(data, child.textContent));</span></span></span><br><span class="line"><span class="javascript">          <span class="comment">// 是元素的话，拿到子节点里面的文本节点，然后和现有的合并</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">if</span> (isElement(child)) &#123;</span></span><br><span class="line"><span class="undefined">            textNodes = [...textNodes, ...getTextNodes(child)];</span></span><br><span class="line"><span class="javascript">            <span class="comment">// getTextNodes(child,data)</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// textNodes = [...textNodes, ...];</span></span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 返回拿到的所有文本节点</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> textNodes;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">moveInFragment</span>(<span class="params">node</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> children = [...node.childNodes];</span></span><br><span class="line"><span class="javascript">        children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> fragment.appendChild(child));</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> fragment;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      /*</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 要循环这个元素 将里面的内容 换成我们的数据</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> node = <span class="built_in">document</span>.createDocumentFragment();</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> firstChild;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">while</span>(firstChild = el.firstChild)&#123; <span class="comment">// 每次拿到第一个元素就将这个元素放入到文档碎片中</span></span></span><br><span class="line"><span class="javascript">        node.appendChild(firstChild); <span class="comment">// appendChild 是具有移动的功能 </span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    onst defaultRE = <span class="regexp">/\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">const</span> util = &#123;</span></span><br><span class="line"><span class="javascript">    getValue(vm,expr)&#123; <span class="comment">// [msg]</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> keys = expr.split(<span class="string">'.'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> keys.reduce(<span class="function">(<span class="params">memo,current</span>)=&gt;</span>&#123; <span class="comment">// reduce 他具备迭代的功能</span></span></span><br><span class="line"><span class="javascript">            memo = memo[current]; <span class="comment">//  vm.school.name</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> memo</span></span><br><span class="line"><span class="undefined">        &#125;,vm);</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="javascript">    compilerText(node,vm)&#123; <span class="comment">// 编译文本 替换左双大括号school.name右双大括号</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(!node.expr)&#123;</span></span><br><span class="line"><span class="javascript">            node.expr = node.textContent; <span class="comment">// 给节点增加了一个自定义属性 为了方便后续的更新操作</span></span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        node.textContent = node.expr.replace(defaultRE,<span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(util.getValue(vm,args[<span class="number">1</span>]))</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compiler</span>(<span class="params">node,vm</span>)</span>&#123; <span class="comment">// node 就是文档碎片 </span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> childNodes = node.childNodes; <span class="comment">// 只有第一层 只有儿子 没有孙子</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 将类数组转化成数组</span></span></span><br><span class="line"><span class="javascript">    [...childNodes].forEach(<span class="function"><span class="params">child</span>=&gt;</span>&#123; <span class="comment">// 一种是元素 一种是文本 </span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(child.nodeType == <span class="number">1</span>)&#123; <span class="comment">//1 元素  3表示文本</span></span></span><br><span class="line"><span class="javascript">            compiler(child,vm); <span class="comment">// 编译当前元素的孩子节点</span></span></span><br><span class="line"><span class="javascript">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(child.nodeType == <span class="number">3</span>)&#123;</span></span><br><span class="line"><span class="undefined">            util.compilerText(child,vm);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    */</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">compileNode</span>(<span class="params">node, data</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 先把node里所有阶段移进fragment</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> fragment = moveInFragment(node);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.dir(fragment);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 操作fragment,文本编译</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> textNodes = getTextNodes(fragment);</span></span><br><span class="line"><span class="javascript">        textNodes.forEach(<span class="function"><span class="params">textNode</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">          textNode.textContent = compileText(data, textNode.textContent);</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 替换完之后在重新填充到node里</span></span></span><br><span class="line"><span class="undefined">        node.appendChild(fragment);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> data = &#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;;</span></span><br><span class="line"><span class="javascript">      compileNode(<span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>), data);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&lt;–!&gt;</p>
-->
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/27/radix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/27/radix/" itemprop="url">
                  进制转换的那些事儿
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-27T19:16:56+08:00">
                2020-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/27/radix/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/27/radix/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>总结进制转换的各种情况。注意，字符串类型和数字类型的来回切换。</p>
<p>除了常用的十进制外，js可以直接表示2、8、16进制。</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li><code>console.log( 0b10===2, 02===2, 0x2===2)</code><br>=&gt; 均为true</li>
<li>17的二进制字符串是啥<br>=&gt; <code>(17).toString(2)</code>，”10001”  </li>
<li>二进制字符串<code>&quot;10001&quot;</code>对应的数字是啥<br>=&gt; <code>parseInt(&#39;10001&#39;,2)</code>，17</li>
<li>二进制数字<code>10001</code>对应的数字是啥<br>=&gt; <code>parseInt((10001).toString(),2)</code>，17</li>
<li>二进制数字<code>10001</code>对应的八进制字符串是啥<br>=&gt; <code>parseInt((10001).toString(),2).toString(8)</code>，”21”</li>
<li>都知道的话，就不用往下看了</li>
</ul>
<h2 id="进制的数字格式"><a href="#进制的数字格式" class="headerlink" title="进制的数字格式"></a>进制的数字格式</h2><h3 id="二进制-0b-开头"><a href="#二进制-0b-开头" class="headerlink" title="二进制 - 0b 开头"></a>二进制 - 0b 开头</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0b10</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="built_in">console</span>.log(x)</span><br></pre></td></tr></table></figure>
<h3 id="八进制-0-开头"><a href="#八进制-0-开头" class="headerlink" title="八进制 - 0 开头"></a>八进制 - 0 开头</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">010</span></span><br><span class="line"><span class="comment">// 8</span></span><br><span class="line"><span class="built_in">console</span>.log(x)</span><br></pre></td></tr></table></figure>
<h3 id="十进制-没啥开头"><a href="#十进制-没啥开头" class="headerlink" title="十进制 - 没啥开头"></a>十进制 - 没啥开头</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">10</span></span><br><span class="line"><span class="comment">// 10</span></span><br><span class="line"><span class="built_in">console</span>.log(x)</span><br></pre></td></tr></table></figure>
<h3 id="十六进制-0x-开头"><a href="#十六进制-0x-开头" class="headerlink" title="十六进制 - 0x 开头"></a>十六进制 - 0x 开头</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0x10</span></span><br><span class="line"><span class="comment">// 16</span></span><br><span class="line"><span class="built_in">console</span>.log(x)</span><br></pre></td></tr></table></figure>
<h2 id="数字转换成任意进制的字符串：Number-prototype-toString"><a href="#数字转换成任意进制的字符串：Number-prototype-toString" class="headerlink" title="数字转换成任意进制的字符串：Number.prototype.toString"></a>数字转换成任意进制的字符串：Number.prototype.toString</h2><p>数字类型的可以转化成任意进制的字符串。</p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Number/toString" target="_blank" rel="noopener">mdn的详细解读</a></p>
<p><code>numObj.toString([radix])</code>，radix默认值为 10，范围在2-36。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xTen也可以是0b10001</span></span><br><span class="line"><span class="keyword">var</span> xTen = <span class="number">17</span></span><br><span class="line"><span class="comment">// 转换成2进制 "10001"</span></span><br><span class="line"><span class="keyword">var</span> xTwo = (xTen).toString(<span class="number">2</span>)</span><br><span class="line"><span class="comment">// 转换成8进制 "21"</span></span><br><span class="line"><span class="keyword">var</span> xEight = (xTen).toString(<span class="number">8</span>)</span><br><span class="line"><span class="comment">// 转换成16进制 "11"</span></span><br><span class="line"><span class="keyword">var</span> xSixteen = (xTen).toString(<span class="number">16</span>)</span><br></pre></td></tr></table></figure>
<p>！！！注意，调用toString是数字类型，返回的是字符串类型</p>
<h2 id="任意进制的字符串转化成相应的数字-parseInt-String-radix"><a href="#任意进制的字符串转化成相应的数字-parseInt-String-radix" class="headerlink" title="任意进制的字符串转化成相应的数字: parseInt(String,radix)"></a>任意进制的字符串转化成相应的数字: parseInt(String,radix)</h2><p>任意进制的字符串可以显示成正常的数字，比如二进制”10001”表示的实际数字。</p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/parseInt" target="_blank" rel="noopener">mdn的解释</a></p>
<p><code>parseInt(string, radix)</code>，radix范围在2-36。必须传入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xTen也可以是0b10001</span></span><br><span class="line"><span class="keyword">var</span> xTen = <span class="number">17</span></span><br><span class="line"><span class="comment">// 转换成2进制 "10001"</span></span><br><span class="line"><span class="keyword">var</span> xTwo = (xTen).toString(<span class="number">2</span>)</span><br><span class="line"><span class="comment">// 17，将二进制的字符串，正常表示出来，后面一个参数传入2</span></span><br><span class="line"><span class="keyword">var</span> xTenFormat = <span class="built_in">parseInt</span>(xTwo,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>！！！注意，parseInt是全局函数，第一个参数是字符串，第二个参数是前面的字符串是几进制的。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><blockquote>
<p><a href="https://www.cnblogs.com/amiezhang/p/7940067.html" target="_blank" rel="noopener">浅谈js的数字格式</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/19/observe-arr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/19/observe-arr/" itemprop="url">
                  怎么实现监测数组的变化
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-19T11:42:23+08:00">
                2020-08-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/19/observe-arr/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/19/observe-arr/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://juejin.im/post/6857077890140340238" target="_blank" rel="noopener">之前介绍<code>defineProperty</code></a>的时候说到，其只能监测对象的变化，并不能监测数组的变化。</p>
<p>本文致力于说清楚怎么实现监测数组的变化。</p>
<p><strong>核心思路：找到改变原数组的方法，然后对这些方法进行劫持处理。</strong></p>
<p>上面这句话，是重中之重，务必读三遍，记住了，再往下走。</p>
<p>改变原数组，常用到的方法有<code>push pop shift unshift reverse sort splice</code>。</p>
<p>换言之，这些方法是改变数组的入口。</p>
<h2 id="在数组实例和数组原型之间，加一个新的原型"><a href="#在数组实例和数组原型之间，加一个新的原型" class="headerlink" title="在数组实例和数组原型之间，加一个新的原型"></a>在数组实例和数组原型之间，加一个新的原型</h2><p>直接修改<code>Array.prototype</code>，是极其危险的。<br>换一个思路，复制已有的数组原型，然后修改其中的方法，但这里因为原型上的方法不可枚举，自然也就没法复制。<br>于是再换一个思路，在数组和数组的原型之间，插入一个原型，形成原型链，<code>数组 =&gt; 新原型 =&gt; 数组的原型</code>，可以在新原型上增加同名的方法就可以了。</p>
<p>先借助伪代码理解：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">arr.__proto__ = newPrototype;</span><br><span class="line">newPrototype.__proto__ = <span class="built_in">Array</span>.prototype;</span><br><span class="line"><span class="comment">// 然后可以在新原型上添加同名的方法就可以了</span></span><br><span class="line">newPrototype.push = xxx;</span><br></pre></td></tr></table></figure>
<p>转换成真实的代码如下，核心使用了<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create" target="_blank" rel="noopener">Object.create</a>，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object.create返回一个新对象，而来新对象的__proto__就是传进去的参数。</span></span><br><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"><span class="comment">// 然后可以在新原型上添加同名的方法就可以了</span></span><br><span class="line">newPrototype.push = xxx;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">arr.__proto__ = newPrototype;</span><br></pre></td></tr></table></figure>
<h2 id="以-push-为例，劫持-push"><a href="#以-push-为例，劫持-push" class="headerlink" title="以 push 为例，劫持 push"></a>以 push 为例，劫持 push</h2><p>就是在新原型上重新写一个 push 的方法，里面执行老的 push，但除此之外还可以做点别的事。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在新原型上添加同名push</span></span><br><span class="line">newPrototype.push = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 语义化this</span></span><br><span class="line">  <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"使用了push"</span>);</span><br><span class="line">  <span class="comment">// 最后还是会执行原始的push</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.push.call(curArr, ...args);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">arr.__proto__ = newPrototype;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行push的时候，就会打印了</span></span><br><span class="line">arr.push(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>然后其他的方法也是类似的，试着写写其他的方法</p>
<h2 id="劫持其他的方法"><a href="#劫持其他的方法" class="headerlink" title="劫持其他的方法"></a>劫持其他的方法</h2><p>将其他方法也一起写了，因为逻辑一样，直接遍历即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> methods = [<span class="string">"push"</span>, <span class="string">"pop"</span>, <span class="string">"shift"</span>, <span class="string">"unshift"</span>, <span class="string">"reverse"</span>, <span class="string">"sort"</span>, <span class="string">"splice"</span>];</span><br><span class="line"></span><br><span class="line">methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  newPrototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(<span class="keyword">this</span>, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">arr.__proto__ = newPrototype;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行的时候，就会打印了</span></span><br><span class="line">arr.push(<span class="number">1</span>);</span><br><span class="line">arr.pop();</span><br></pre></td></tr></table></figure>
<h2 id="数组里有数组项的话，也是需要监测的"><a href="#数组里有数组项的话，也是需要监测的" class="headerlink" title="数组里有数组项的话，也是需要监测的"></a>数组里有数组项的话，也是需要监测的</h2><p>这里数组里可能也是有数组的，需要遍历数组的每项，如果是数组的话依然需要指向新的原型。</p>
<p>嗯，对，用到递归了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> methods = [<span class="string">"push"</span>, <span class="string">"pop"</span>, <span class="string">"shift"</span>, <span class="string">"unshift"</span>, <span class="string">"reverse"</span>, <span class="string">"sort"</span>, <span class="string">"splice"</span>];</span><br><span class="line"></span><br><span class="line">methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  newPrototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(<span class="keyword">this</span>, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 既是条件限制，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 整个数组指向新的原型</span></span><br><span class="line">  arr.__proto__ = newPrototype;</span><br><span class="line">  <span class="comment">// 数组的每项，如果是数组，也指向新的原型。</span></span><br><span class="line">  arr.forEach(observeArr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]];</span><br><span class="line">observeArr(arr);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行的时候，就会打印了</span></span><br><span class="line">arr[<span class="number">0</span>].push(<span class="number">1</span>);</span><br><span class="line">arr[<span class="number">1</span>].pop();</span><br></pre></td></tr></table></figure>
<h2 id="数组新添加的项，如果是数组也需要指向新的原型"><a href="#数组新添加的项，如果是数组也需要指向新的原型" class="headerlink" title="数组新添加的项，如果是数组也需要指向新的原型"></a>数组新添加的项，如果是数组也需要指向新的原型</h2><p>能添加元素的方法：<code>push unshift splice</code>。</p>
<p>找到新加的元素，然后是数组的也同样指向新的原型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> methods = [<span class="string">"push"</span>, <span class="string">"pop"</span>, <span class="string">"shift"</span>, <span class="string">"unshift"</span>, <span class="string">"reverse"</span>, <span class="string">"sort"</span>, <span class="string">"splice"</span>];</span><br><span class="line"></span><br><span class="line">methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  newPrototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">let</span> inserted;</span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"push"</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"unshift"</span>:</span><br><span class="line">        inserted = args;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"splice"</span>:</span><br><span class="line">        inserted = args.slice(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    inserted &amp;&amp; observeArr(inserted);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(<span class="keyword">this</span>, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 即是条件限制，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 整个数组指向新的原型</span></span><br><span class="line">  arr.__proto__ = newPrototype;</span><br><span class="line">  <span class="comment">// 数组的每项，如果是数组，也指向新的原型。</span></span><br><span class="line">  arr.forEach(observeArr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这里可以导出去，方便别的文件使用</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> observeArr;</span><br><span class="line"><span class="comment">// 需要监测的数组，绑定新的原型就可以了</span></span><br><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line">observeArr(arr);</span><br><span class="line"><span class="keyword">let</span> addItem = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.push(addItem);</span><br><span class="line"><span class="comment">// 执行的时候，就会打印了</span></span><br><span class="line">addItem.push(<span class="number">1</span>);</span><br><span class="line">addItem.pop();</span><br></pre></td></tr></table></figure>
<h2 id="综合使用-defineProperty-监测对象和数组"><a href="#综合使用-defineProperty-监测对象和数组" class="headerlink" title="综合使用 defineProperty 监测对象和数组"></a>综合使用 defineProperty 监测对象和数组</h2><p>现在已经有了监测对象的方法，也有了监测数组的方法，将两个综合起来，就能监测数组里面的对象，对象里面的数组了。</p>
<p>将监测数组和监测对象的的可以单独写成一个文件，方便之后使用。</p>
<p>这里为了方便直接运行代码，直接放在一块了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * observeArr的部分</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">// 生成新的原型</span></span><br><span class="line"><span class="keyword">let</span> newPrototype = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> methods = [<span class="string">"push"</span>, <span class="string">"pop"</span>, <span class="string">"shift"</span>, <span class="string">"unshift"</span>, <span class="string">"reverse"</span>, <span class="string">"sort"</span>, <span class="string">"splice"</span>];</span><br><span class="line"><span class="comment">// 在新原型上面添加以上方法，实现劫持</span></span><br><span class="line">methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  newPrototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">let</span> inserted;</span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"push"</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"unshift"</span>:</span><br><span class="line">        inserted = args;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"splice"</span>:</span><br><span class="line">        inserted = args.slice(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    inserted &amp;&amp; observeArr(inserted);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(<span class="keyword">this</span>, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 新加！！！是对象的话，需要用对象</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.toString.call(arr) === <span class="string">"[object Object]"</span>) &#123;</span><br><span class="line">    observeObj(arr);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="comment">// 整个数组指向新的原型</span></span><br><span class="line">    arr.__proto__ = newPrototype;</span><br><span class="line">    <span class="comment">// 数组的每项，如果是数组，也指向新的原型。</span></span><br><span class="line">    arr.forEach(observeArr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不是对象或者数组的，什么都不做</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * observeObj的部分</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeObj</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 加上参数限制，必须是对象才有劫持，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">"object"</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 新加！！！数组交给数组处理</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) &#123;</span><br><span class="line">    observeArr(obj);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 是对象的话 才开始递归</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, key)) &#123;</span><br><span class="line">      observeKey(obj, key);</span><br><span class="line">      <span class="comment">// 这里劫持该属性的属性值，如果不是对象直接返回，不影响</span></span><br><span class="line">      observeObj(obj[key]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * demo试试</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: [<span class="number">1</span>, <span class="number">2</span>, &#123; <span class="attr">c</span>: <span class="number">2</span> &#125;] &#125;;</span><br><span class="line">observeObj(data);</span><br><span class="line">data.a = <span class="number">2</span>;</span><br><span class="line">data.b.push([<span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [&#123; <span class="attr">a</span>: <span class="string">"数组里的对象"</span> &#125;, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">observeArr(arr);</span><br><span class="line">arr[<span class="number">0</span>].a = <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<h2 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h2><p>当然数组其实可以不通过方法改变，比如直接删除数组可以直接使用 length 属性，或者直接<code>arr[0]=xxx</code>改变数组。 </p>
<p>但只有当使用<code>&quot;push&quot;,&quot;pop&quot;, &quot;shift&quot;,&quot;unshift&quot;,&quot;reverse&quot;,&quot;sort&quot;,&quot;splice&quot;</code>才能检测到数组变化。 </p>
<p>这也是 vue 的缺陷，当然新版的 proxy 将干掉这个缺陷。</p>
<p>所以在使用 vue 的过程中，要尽量使用以上方法操作数组~~~</p>
<h2 id="附注：查看数组的所有属性和方法"><a href="#附注：查看数组的所有属性和方法" class="headerlink" title="附注：查看数组的所有属性和方法"></a>附注：查看数组的所有属性和方法</h2><p>在控制台可以输入<code>dir([])</code>，然后能看到数组所有的属性和方法。</p>
<p>具体用法，可以直接到<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/slice" target="_blank" rel="noopener">到 mdn 上细看，点击侧边栏看对应的方法</a><br><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/array.png" alt="array"></p>
<!-- 

## 以 push 为例，劫持 push

以 push 为例，想想怎么知道用了 push 方法呢。

其实就是在原来的 push 方法上做了劫持，劫持听着高大上，就是高阶函数，里面除了执行 push，还做了其他操作。

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 改写push，这里为了不影响原型上面的push，直接修改arr上的push</span></span><br><span class="line">arr.push = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 语义化this</span></span><br><span class="line">  <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"使用了push"</span>);</span><br><span class="line">  <span class="comment">// 最后还是会执行原始的push</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.push.call(curArr, ...args);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 执行push的时候，就会打印了</span></span><br><span class="line">arr.push(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>现在，试试将其抽象出一个方法，劫持任意一个数组的任意方法。</p>
<h2 id="劫持任意一个数组的任意方法"><a href="#劫持任意一个数组的任意方法" class="headerlink" title="劫持任意一个数组的任意方法"></a>劫持任意一个数组的任意方法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeMethod</span>(<span class="params">arr, method</span>) </span>&#123;</span><br><span class="line">  arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 语义化this</span></span><br><span class="line">    <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 实现劫持方法的操作</span></span><br><span class="line">observeMethod(arr, <span class="string">"push"</span>);</span><br><span class="line">observeMethod(arr, <span class="string">"pop"</span>);</span><br><span class="line">arr.push(<span class="number">1</span>);</span><br><span class="line">arr.pop();</span><br><span class="line"><span class="built_in">console</span>.log(arr);</span><br></pre></td></tr></table></figure>
<p>当然，我们这里只需要劫持，会改变原数组的方法</p>
<h2 id="劫持改变原数组的所有方法"><a href="#劫持改变原数组的所有方法" class="headerlink" title="劫持改变原数组的所有方法"></a>劫持改变原数组的所有方法</h2><p>也就是只需传入想要监测的数组，数组的方法自动劫持。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> methods = [</span><br><span class="line">    <span class="string">"push"</span>,</span><br><span class="line">    <span class="string">"pop"</span>,</span><br><span class="line">    <span class="string">"shift"</span>,</span><br><span class="line">    <span class="string">"unshift"</span>,</span><br><span class="line">    <span class="string">"reverse"</span>,</span><br><span class="line">    <span class="string">"sort"</span>,</span><br><span class="line">    <span class="string">"splice"</span></span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">// 复制一遍上面的</span></span><br><span class="line">  methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 语义化this</span></span><br><span class="line">      <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 实现劫持方法的操作</span></span><br><span class="line">observeArr(arr);</span><br><span class="line">arr.push(<span class="number">1</span>);</span><br><span class="line">arr.pop();</span><br><span class="line"><span class="built_in">console</span>.log(arr);</span><br></pre></td></tr></table></figure>
<p>这里，再往前走，监测数组新加的元素</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> innerArr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.push(innerArr);</span><br><span class="line"><span class="comment">// 希望这里也能监测到新加数组使用了push</span></span><br><span class="line">innerArr.push(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h2 id="递归监测数组新加的元素，还是以-push-为例"><a href="#递归监测数组新加的元素，还是以-push-为例" class="headerlink" title="递归监测数组新加的元素，还是以 push 为例"></a>递归监测数组新加的元素，还是以 push 为例</h2><p>很像之前的 defineProperty 递归对象的属性。其实递归很多都是这个思路。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 不是数组的直接返回，也是递归终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> methods = [</span><br><span class="line">    <span class="string">"push"</span>,</span><br><span class="line">    <span class="string">"pop"</span>,</span><br><span class="line">    <span class="string">"shift"</span>,</span><br><span class="line">    <span class="string">"unshift"</span>,</span><br><span class="line">    <span class="string">"reverse"</span>,</span><br><span class="line">    <span class="string">"sort"</span>,</span><br><span class="line">    <span class="string">"splice"</span></span><br><span class="line">  ];</span><br><span class="line">  methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 语义化this</span></span><br><span class="line">      <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 如果是push,新添加的项都进行监测下，这里不是数组的会递归终止</span></span><br><span class="line">      <span class="keyword">if</span> (method === <span class="string">"push"</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> inserts = args;</span><br><span class="line">        inserts.forEach(<span class="function"><span class="params">item</span> =&gt;</span> observeArr(item));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 实现劫持方法的操作</span></span><br><span class="line">observeArr(arr);</span><br><span class="line"><span class="keyword">let</span> innerArr = [<span class="number">67</span>, <span class="number">78</span>];</span><br><span class="line">arr.push(innerArr);</span><br><span class="line">innerArr.push(<span class="number">89</span>);</span><br><span class="line">arr.pop();</span><br><span class="line"><span class="built_in">console</span>.log(arr, innerArr);</span><br></pre></td></tr></table></figure>
<h2 id="递归，其他增加数组元素的方法"><a href="#递归，其他增加数组元素的方法" class="headerlink" title="递归，其他增加数组元素的方法"></a>递归，其他增加数组元素的方法</h2><p>改变原数组且增加数组元素的方法有：<code>push unshift splice</code>。<br>将所有新增的项，进行监测。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> methods = [</span><br><span class="line">    <span class="string">"push"</span>,</span><br><span class="line">    <span class="string">"pop"</span>,</span><br><span class="line">    <span class="string">"shift"</span>,</span><br><span class="line">    <span class="string">"unshift"</span>,</span><br><span class="line">    <span class="string">"reverse"</span>,</span><br><span class="line">    <span class="string">"sort"</span>,</span><br><span class="line">    <span class="string">"splice"</span></span><br><span class="line">  ];</span><br><span class="line">  methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 语义化this</span></span><br><span class="line">      <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 将新加的项找到</span></span><br><span class="line">      <span class="keyword">let</span> addItems;</span><br><span class="line">      <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"push"</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"unshift"</span>:</span><br><span class="line">          addItems = args;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"splice"</span>:</span><br><span class="line">          addItems = args.slice(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将添加的每项监测</span></span><br><span class="line">      addItems &amp;&amp; addItems.forEach(<span class="function"><span class="params">item</span> =&gt;</span> observeArr(item));</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="comment">// 实现劫持方法的操作</span></span><br><span class="line">observeArr(arr);</span><br><span class="line"><span class="keyword">let</span> innerArr = [<span class="number">67</span>, <span class="number">78</span>];</span><br><span class="line">arr.push(innerArr);</span><br><span class="line">innerArr.unshift(<span class="number">89</span>);</span><br><span class="line">arr.pop();</span><br><span class="line"><span class="built_in">console</span>.log(arr, innerArr);</span><br></pre></td></tr></table></figure>
<h2 id="综合使用-defineProperty-监测对象和数组-1"><a href="#综合使用-defineProperty-监测对象和数组-1" class="headerlink" title="综合使用 defineProperty 监测对象和数组"></a>综合使用 defineProperty 监测对象和数组</h2><p>换言之，不论对象或者数组都能监测其变化。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeArr</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arr)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 新加！！！给数组的每项，添加监测</span></span><br><span class="line">  arr.forEach(<span class="function"><span class="params">item</span> =&gt;</span> observeObj(item));</span><br><span class="line">  <span class="keyword">let</span> methods = [</span><br><span class="line">    <span class="string">"push"</span>,</span><br><span class="line">    <span class="string">"pop"</span>,</span><br><span class="line">    <span class="string">"shift"</span>,</span><br><span class="line">    <span class="string">"unshift"</span>,</span><br><span class="line">    <span class="string">"reverse"</span>,</span><br><span class="line">    <span class="string">"sort"</span>,</span><br><span class="line">    <span class="string">"splice"</span></span><br><span class="line">  ];</span><br><span class="line">  methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    arr[method] = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 语义化this</span></span><br><span class="line">      <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`使用了<span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 将新加的项找到</span></span><br><span class="line">      <span class="keyword">let</span> addItems;</span><br><span class="line">      <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"push"</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"unshift"</span>:</span><br><span class="line">          addItems = args;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"splice"</span>:</span><br><span class="line">          addItems = args.slice(<span class="number">2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 修改！！！ 将添加的每项监测，是对象的监测对象 是数组的监测数组</span></span><br><span class="line">      addItems &amp;&amp; addItems.forEach(<span class="function"><span class="params">item</span> =&gt;</span> observeObj(item));</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype[method].call(curArr, ...args);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeObj</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 新加！！！数组另外处理</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) &#123;</span><br><span class="line">    observeArr(obj);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 加上参数限制，必须是对象才有劫持，也是递归的终止条件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">"object"</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, key)) &#123;</span><br><span class="line">      observeKey(obj, key);</span><br><span class="line">      <span class="comment">// 这里劫持该属性的属性值，如果不是对象直接返回，不影响</span></span><br><span class="line">      observeObj(obj[key]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: [<span class="number">1</span>, <span class="number">2</span>, &#123; <span class="attr">c</span>: <span class="number">2</span> &#125;] &#125;;</span><br><span class="line">observeObj(data);</span><br><span class="line">data.a = <span class="number">2</span>;</span><br><span class="line">data.b.push([<span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(data.b[<span class="number">2</span>].c);</span><br></pre></td></tr></table></figure>
<p>–&gt;</p>
-->
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/04/write-vue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/08/04/write-vue/" itemprop="url">
                  defineProperty怎么实现属性劫持
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-04T19:09:42+08:00">
                2020-08-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/04/write-vue/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/04/write-vue/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>defineProperty</code>是vue实现数据劫持的核心，本文一点点的说明<code>defineProperty</code>怎么实现属性劫持的。</p>
<p>其实我们一般的操作对象属性的方式，增加或者修改属性，均可以使用<code>Object.defineProperty</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line"><span class="comment">// 寻常操作：增加/修改 新属性</span></span><br><span class="line">obj.a = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 等同于：</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(o, <span class="string">"a"</span>, &#123;</span><br><span class="line">  value: <span class="number">1</span>,</span><br><span class="line">  writable: <span class="literal">true</span>,</span><br><span class="line">  configurable: <span class="literal">true</span>,</span><br><span class="line">  enumerable: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当然寻常的例子，我们是不会这么玩的，太啰嗦了。  </p>
<p>但<code>defineProperty</code>可以更精确地添加或修改对象的属性。</p>
<h2 id="描述符"><a href="#描述符" class="headerlink" title="描述符"></a>描述符</h2><p>先说个专有名词：<code>描述符</code>。</p>
<p>其实就是<code>defineProperty</code>的第三个参数，是个对象。这个对象的有以下属性：</p>
<ul>
<li>configurable 属性：能不能修改描述符，就是能不能再次修改描述符的其他属性</li>
<li>enumerable 属性：能不能枚举该属性，就是 a 属性能不能被 for 到</li>
<li>writable 属性：能不能修改属性值，就是能不能这样修改<code>obj.a = 1</code></li>
<li>value 属性：该属性的值</li>
<li>get 属性：是个函数，当访问该属性的时候，函数自动调用，<strong>函数返回值就是该属性的值</strong></li>
<li>set 属性：是个函数，当修改该属性的时候，函数自动调用，<strong>函数有且只有一个参数，赋值的新值</strong></li>
</ul>
<p>注意！！！</p>
<ul>
<li><strong>描述符里的<code>value属性 writable属性</code> 与 <code>get属性 set属性</code>是互斥的关系</strong>，只能存在一个</li>
<li>另外的属性默认值都是<code>false</code>，不想<code>false</code>的话，记得配置哈，不细说（主要我也不怎么用）。</li>
</ul>
<h2 id="细说get-和-set"><a href="#细说get-和-set" class="headerlink" title="细说get 和 set"></a>细说get 和 set</h2><ul>
<li>get 属性：是个函数，当访问该属性的时候，函数自动调用，<strong>函数返回值就是该属性的值</strong></li>
<li>set 属性：是个函数，当修改该属性的时候，函数自动调用，<strong>函数有且只有一个参数，赋值的新值</strong></li>
</ul>
<p>默念三遍，背诵。  </p>
<p>写个get 和 set 的例子辅助理解。  </p>
<p><strong>这个例子必须掌握，弄懂之后基本就掌握了数据劫持的精髓了</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> value = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(obj, <span class="string">"b"</span>, &#123;</span><br><span class="line">  get() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"读取b属性"</span>, value);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;,</span><br><span class="line">  set(newValue) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"设置b属性"</span>, newValue);</span><br><span class="line">    value = newValue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 触发get函数，get的返回值就是属性值</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.b);</span><br><span class="line"><span class="comment">// 触发set函数，value的值变成了2，注意！！！，此时内存里，属性值并没有改变</span></span><br><span class="line">obj.b = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// 但是，想要读取属性值的时候，就必然会触发get函数，属性值也自然就改变了，这个思想真的很赞</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.b);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里有个坑：<code>get</code>里是不能有读取的操作，不然一直死循环，所以使用到<code>get set</code>的地方，总需要借助一个变量</p>
</blockquote>
<p>所以，这里，变量<code>value</code>的值就是属性的值，如果想要修改属性，修改 value 的值即可。</p>
<p>这个例子弄懂了，get，set 的精髓，我觉得也就差不多了。</p>
<h2 id="劫持对象的某个属性"><a href="#劫持对象的某个属性" class="headerlink" title="劫持对象的某个属性"></a>劫持对象的某个属性</h2><p>有了刚刚例子的基础，试着写写劫持对象的任意一个属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line">observeKey(obj, <span class="string">"a"</span>);</span><br><span class="line"><span class="comment">// 读取a，触发get函数</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a);</span><br><span class="line"><span class="comment">// 设置a，触发set函数</span></span><br><span class="line">obj.a = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h2 id="劫持对象的所有属性"><a href="#劫持对象的所有属性" class="headerlink" title="劫持对象的所有属性"></a>劫持对象的所有属性</h2><p>再试试劫持对象的所有属性</p>
<p>其实就是遍历：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeObj</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, key)) &#123;</span><br><span class="line">      observeKey(obj, key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span> &#125;;</span><br><span class="line">observeObj(obj);</span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br><span class="line"><span class="comment">// 读取a，触发get函数</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a);</span><br><span class="line"><span class="comment">// 设置a，触发set函数</span></span><br><span class="line">obj.a = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h2 id="劫持对象的所有属性-包括对象类型的属性值"><a href="#劫持对象的所有属性-包括对象类型的属性值" class="headerlink" title="劫持对象的所有属性 - 包括对象类型的属性值"></a>劫持对象的所有属性 - 包括对象类型的属性值</h2><p>上面的有个缺陷，就是当属性值也是对象的时候，不能劫持属性值，如<code>{a:1,c:{b:1}}</code></p>
<p>简单，补上就行。  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeObj</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 加上参数限制，必须是对象才有劫持</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">"object"</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, key)) &#123;</span><br><span class="line">      observeKey(obj, key);</span><br><span class="line">      <span class="comment">// 这里劫持该属性的属性值，如果不是对象直接返回，不影响</span></span><br><span class="line">      observeObj(obj[key]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeKey</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value = obj[key];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"读取属性"</span>, value);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"设置属性"</span>, newValue);</span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: &#123; <span class="attr">name</span>: <span class="string">"c"</span> &#125; &#125;;</span><br><span class="line">observeObj(obj);</span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br><span class="line"><span class="comment">// 读取a，触发get函数</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a);</span><br><span class="line"><span class="comment">// 设置a，触发set函数</span></span><br><span class="line">obj.a = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 触发set函数</span></span><br><span class="line">obj.c.name = <span class="string">"d"</span>;</span><br></pre></td></tr></table></figure>
<h2 id="defineProperty的缺陷"><a href="#defineProperty的缺陷" class="headerlink" title="defineProperty的缺陷"></a>defineProperty的缺陷</h2><ul>
<li>不能监测对象删除属性</li>
<li>不能劫持数组的修改</li>
<li><code>observeObj</code>这个函数的缺陷，不能劫持对象的新增属性，只能劫持对象已有的属性</li>
</ul>
<p>这也是vue里面为啥有<code>$set/$delete</code>以及对数组的限制。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: [<span class="number">1</span>, <span class="number">2</span>] &#125;;</span><br><span class="line">observeObj(obj);</span><br><span class="line"><span class="comment">// 新增属性</span></span><br><span class="line">obj.c = <span class="number">3</span>;</span><br><span class="line"><span class="comment">// 不会触发get函数</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.c);</span><br><span class="line"><span class="comment">// 不会触发set函数</span></span><br><span class="line">obj.b.push(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h2 id="defineProperty还可以挂载属性"><a href="#defineProperty还可以挂载属性" class="headerlink" title="defineProperty还可以挂载属性"></a>defineProperty还可以挂载属性</h2><p>其实就是访问<code>options.data.name</code> 可以简写成 <code>options.name</code>，专业话术，将data上的属性挂载到options上</p>
<p>相当于，用<code>defineProperty</code>，在options上增加新属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先挂载单个属性</span></span><br><span class="line"><span class="comment">// options.data相当于source options相当于target</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxyKey</span>(<span class="params">target, source, key</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">    <span class="comment">// 这里的source[key]相当于变量value，所以说最简单的那个例子是核心</span></span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="keyword">return</span> source[key];</span><br><span class="line">    &#125;,</span><br><span class="line">    set(newValue) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newValue === source[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      source[key] = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 遍历属性，挂载下</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxyObj</span>(<span class="params">target, source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="comment">// 直接使用 obj.hasOwnProperty会提示不规范</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(source, key)) &#123;</span><br><span class="line">      proxyKey(target, source, key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">  data: &#123; <span class="attr">name</span>: <span class="number">1</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line">proxyObj(options, options.data);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(options.name);</span><br></pre></td></tr></table></figure>
<p>话说，vue的属性劫持和挂载属性，核心原理差不多就是上面这些。</p>
<h2 id="defineProperty还能写日志"><a href="#defineProperty还能写日志" class="headerlink" title="defineProperty还能写日志"></a>defineProperty还能写日志</h2><p>比如 obj 有个属性，此属性值经常变化，想要记录其所有变化的值，以此可以形成日志。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> log = [obj.a];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> value = obj.a;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(obj, <span class="string">"a"</span>, &#123;</span><br><span class="line">  get() &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;,</span><br><span class="line">  set(newValue) &#123;</span><br><span class="line">    <span class="keyword">if</span> (newValue === value) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value = newValue;</span><br><span class="line">    log.push(newValue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">obj.a = <span class="number">2</span>;</span><br><span class="line">obj.a = <span class="number">3</span>;</span><br><span class="line">obj.a = <span class="number">4</span>;</span><br><span class="line"><span class="comment">// [1,2,3,4]</span></span><br><span class="line"><span class="built_in">console</span>.log(log);</span><br></pre></td></tr></table></figure>
<p>通用的可以抽离出一个类，专门记录某个值的变化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Archiver</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.archive = [];</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, <span class="string">"a"</span>, &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">      &#125;,</span><br><span class="line">      set(newValue) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newValue === value) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">this</span>.archive.push(newValue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> archiver = <span class="keyword">new</span> Archiver();</span><br><span class="line">archiver.a = <span class="number">1</span>;</span><br><span class="line">archiver.a = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// [1,2]</span></span><br><span class="line"><span class="built_in">console</span>.log(archiver.archive);</span><br></pre></td></tr></table></figure>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener">MDN的defineProperty</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/29/reduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/29/reduce/" itemprop="url">
                  数组的reduce方法的应用场景及相关面试题
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-29T11:49:39+08:00">
                2020-07-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/29/reduce/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/29/reduce/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>reduce 最大的作用：从一个数组得到一个值，对数组中的每个元素执行 reducer 函数(升序执行)</p>
<p>reduce 打开相当于：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里为了可读性更高，更好入门，加上initValue</span></span><br><span class="line">[x1, x2, x3].reduce(f,initValue) </span><br><span class="line"><span class="comment">// f起码是两个参数，相当于</span></span><br><span class="line">f(f(f(initValue,x1),x2) x3);</span><br></pre></td></tr></table></figure>
<p>写reduce的核心 : <strong>就是找到<code>f</code>和<code>initValue</code></strong>，<code>f</code>始终有两个参数：<code>acc item</code></p>
<p>以下既是应用场景，也是可以作为练习reduce的例子</p>
<h2 id="累加数组所有值"><a href="#累加数组所有值" class="headerlink" title="累加数组所有值"></a>累加数组所有值</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sumFn = <span class="function">(<span class="params">acc, item</span>) =&gt;</span> acc + item;</span><br><span class="line"><span class="keyword">const</span> sum = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>].reduce(sumFn, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="built_in">console</span>.log(sum);</span><br></pre></td></tr></table></figure>
<h2 id="累加对象数组里的值"><a href="#累加对象数组里的值" class="headerlink" title="累加对象数组里的值"></a>累加对象数组里的值</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sumFn = <span class="function">(<span class="params">acc, item</span>) =&gt;</span> acc + item.x;</span><br><span class="line"><span class="keyword">const</span> sum = [&#123; <span class="attr">x</span>: <span class="number">1</span> &#125;, &#123; <span class="attr">x</span>: <span class="number">2</span> &#125;, &#123; <span class="attr">x</span>: <span class="number">3</span> &#125;, &#123; <span class="attr">x</span>: <span class="number">4</span> &#125;].reduce(sumFn, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="built_in">console</span>.log(sum);</span><br></pre></td></tr></table></figure>
<h2 id="降维数组，二维变成一维"><a href="#降维数组，二维变成一维" class="headerlink" title="降维数组，二维变成一维"></a>降维数组，二维变成一维</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 之所以用concat不用push 是concat返回合并后的数组，而push返回数组长度</span></span><br><span class="line"><span class="keyword">const</span> flat = <span class="function">(<span class="params">acc, item</span>) =&gt;</span> acc.concat(item);</span><br><span class="line"><span class="keyword">const</span> res = [</span><br><span class="line">  [<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">  [<span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  [<span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">].reduce(flat, []);</span><br><span class="line"><span class="comment">// [0, 1, 2, 3, 4, 5]</span></span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>
<h2 id="扁平化任意维数组-—-面试常考"><a href="#扁平化任意维数组-—-面试常考" class="headerlink" title="扁平化任意维数组 — 面试常考"></a>扁平化任意维数组 — 面试常考</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flat = <span class="function">(<span class="params">acc, item</span>) =&gt;</span> acc.concat(item);</span><br><span class="line"><span class="keyword">const</span> res = [ <span class="number">0</span>, <span class="number">1</span>, [<span class="number">2</span>, <span class="number">3</span>, [<span class="number">4</span>, <span class="number">5</span>]] ].reduce(flat, []);</span><br><span class="line"><span class="comment">// [0, 1, 2, 3, 4, 5]</span></span><br><span class="line"><span class="built_in">console</span>.log(res)</span><br><span class="line"><span class="comment">// 稍微抽象出一个函数，当前项是数组的话 flatten(item) 不是数组的话用concat合并下</span></span><br><span class="line"><span class="keyword">const</span> flatten = <span class="function"><span class="params">arr</span> =&gt;</span></span><br><span class="line">  arr.reduce(</span><br><span class="line">    (acc, item) =&gt; acc.concat(<span class="built_in">Array</span>.isArray(item) ? flatten(item) : item),</span><br><span class="line">    []</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<h2 id="计算数组中每个元素出现的次数-—-面试常考"><a href="#计算数组中每个元素出现的次数-—-面试常考" class="headerlink" title="计算数组中每个元素出现的次数 — 面试常考"></a>计算数组中每个元素出现的次数 — 面试常考</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> names = [<span class="string">"Alice"</span>, <span class="string">"Bob"</span>, <span class="string">"Tiff"</span>, <span class="string">"Bruce"</span>, <span class="string">"Alice"</span>];</span><br><span class="line"><span class="keyword">const</span> getCount = <span class="function">(<span class="params">obj, key</span>) =&gt;</span> &#123;</span><br><span class="line">  key <span class="keyword">in</span> obj || (obj[key] = <span class="number">0</span>);</span><br><span class="line">  obj[key]++;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> res = names.reduce(getCount, &#123;&#125;);</span><br><span class="line"><span class="comment">// &#123; 'Alice': 2, 'Bob': 1, 'Tiff': 1, 'Bruce': 1 &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>
<h2 id="按属性对-object-分类-—-面试常考"><a href="#按属性对-object-分类-—-面试常考" class="headerlink" title="按属性对 object 分类 — 面试常考"></a>按属性对 object 分类 — 面试常考</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按年龄分类</span></span><br><span class="line"><span class="keyword">const</span> people = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"Alice"</span>, <span class="attr">age</span>: <span class="number">21</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"Max"</span>, <span class="attr">age</span>: <span class="number">20</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"Jane"</span>, <span class="attr">age</span>: <span class="number">20</span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getType = <span class="function">(<span class="params">obj, item</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> key = item.age;</span><br><span class="line">  key <span class="keyword">in</span> obj || (obj[key] = []);</span><br><span class="line">  obj[key].push(item);</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> res = people.reduce(getType, &#123;&#125;);</span><br><span class="line"><span class="comment">// &#123; 20: [ &#123; name: 'Max', age: 20 &#125;, &#123; name: 'Jane', age: 20 &#125; ], 21: [&#123; name: 'Alice', age: 21 &#125;] &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>
<p>这里可以稍微升级下，可以对任意字段进行分类</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> classifyArray = <span class="function">(<span class="params">arr, keyClassified</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> getType = <span class="function">(<span class="params">obj, item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = item[keyClassified];</span><br><span class="line">    key <span class="keyword">in</span> obj || (obj[key] = []);</span><br><span class="line">    obj[key].push(item);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> arr.reduce(getType, &#123;&#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> people = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"Alice"</span>, <span class="attr">age</span>: <span class="number">21</span>, <span class="attr">gender</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"Max"</span>, <span class="attr">age</span>: <span class="number">20</span>, <span class="attr">gender</span>: <span class="number">1</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"Jane"</span>, <span class="attr">age</span>: <span class="number">20</span>, <span class="attr">gender</span>: <span class="number">0</span> &#125;</span><br><span class="line">];</span><br><span class="line"><span class="comment">// &#123; '0': [ &#123; id: 1, name: 'Alice', age: 21, gender: 0 &#125;, &#123; id: 3, name: 'Jane', age: 20, gender: 0 &#125; ], '1': [ &#123; id: 2, name: 'Max', age: 20, gender: 1 &#125; ] &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(classifyArray(people, <span class="string">"gender"</span>));</span><br></pre></td></tr></table></figure>
<h2 id="使用扩展运算符处理对象数组中的数组"><a href="#使用扩展运算符处理对象数组中的数组" class="headerlink" title="使用扩展运算符处理对象数组中的数组"></a>使用扩展运算符处理对象数组中的数组</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 合并所有的书</span></span><br><span class="line"><span class="keyword">var</span> friends = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">"Anna"</span>,</span><br><span class="line">    books: [<span class="string">"Bible"</span>, <span class="string">"Harry Potter"</span>],</span><br><span class="line">    age: <span class="number">21</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">"Bob"</span>,</span><br><span class="line">    books: [<span class="string">"War and peace"</span>, <span class="string">"Romeo and Juliet"</span>],</span><br><span class="line">    age: <span class="number">26</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">"Alice"</span>,</span><br><span class="line">    books: [<span class="string">"The Lord of the Rings"</span>, <span class="string">"The Shining"</span>],</span><br><span class="line">    age: <span class="number">18</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sumArr = <span class="function">(<span class="params">oldArr, item</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> [...oldArr, ...item.books];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> res = friends.reduce(sumArr, []);</span><br><span class="line"><span class="comment">// [ 'Bible', 'Harry Potter', 'War and peace', 'Romeo and Juliet', 'The Lord of the Rings', 'The Shining' ]</span></span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>
<h2 id="数组去重-—-面试常考"><a href="#数组去重-—-面试常考" class="headerlink" title="数组去重 — 面试常考"></a>数组去重 — 面试常考</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myArray = [<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"e"</span>, <span class="string">"e"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"d"</span>, <span class="string">"d"</span>, <span class="string">"d"</span>];</span><br><span class="line"><span class="keyword">const</span> addArr = <span class="function">(<span class="params">acc, item</span>) =&gt;</span> (acc.includes(item) ? acc : [...acc, item]);</span><br><span class="line"><span class="keyword">const</span> res = myArray.reduce(addArr, []);</span><br><span class="line"><span class="comment">// [ 'a', 'b', 'c', 'e', 'd' ]</span></span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>
<p>当然还有更简单粗暴的法子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unique = <span class="function"><span class="params">arr</span> =&gt;</span> <span class="built_in">Array</span>.from(<span class="keyword">new</span> <span class="built_in">Set</span>(arr));</span><br><span class="line"><span class="comment">// [ 'a', 'b', 'c', 'e', 'd' ]</span></span><br><span class="line"><span class="built_in">console</span>.log(</span><br><span class="line">  unique([<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"e"</span>, <span class="string">"e"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"d"</span>, <span class="string">"d"</span>, <span class="string">"d"</span>])</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="按顺序运行-promise-—-面试常考"><a href="#按顺序运行-promise-—-面试常考" class="headerlink" title="按顺序运行 promise — 面试常考"></a>按顺序运行 promise — 面试常考</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// promise function 1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p1</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    resolve(a * <span class="number">5</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ！！这个是普通函数哟</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// promise function 2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p2</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    resolve(a - <span class="number">2</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arr = [p1, f, p2];</span><br><span class="line"><span class="keyword">const</span> runOrderly = <span class="function">(<span class="params">acc, item</span>) =&gt;</span> acc.then(item);</span><br><span class="line"><span class="keyword">const</span> res = arr.reduce(runOrderly, <span class="built_in">Promise</span>.resolve(<span class="number">10</span>));</span><br><span class="line"><span class="comment">// 98</span></span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>
<p>再抽象下写个通用的顺序执行的函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> runOrderly = <span class="function">(<span class="params">arr, initValue</span>) =&gt;</span></span><br><span class="line">  arr.reduce(<span class="function">(<span class="params">acc, item</span>) =&gt;</span> acc.then(item), <span class="built_in">Promise</span>.resolve(initValue));</span><br></pre></td></tr></table></figure>
<h2 id="生成组合函数compose-—-面试常考"><a href="#生成组合函数compose-—-面试常考" class="headerlink" title="生成组合函数compose — 面试常考"></a>生成组合函数compose — 面试常考</h2><p>举个例子，就明白啥是组合函数了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sum = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b;</span><br><span class="line"><span class="keyword">const</span> len = <span class="function"><span class="params">str</span> =&gt;</span> str.length;</span><br><span class="line"><span class="keyword">const</span> addCurrency = <span class="function"><span class="params">str</span> =&gt;</span> <span class="string">"$"</span> + str;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在想要先 将两字符求和，然后求长度，再然后再长度前加个$，这就是一个新的函数，是已知函数的组合</span></span><br><span class="line"><span class="keyword">const</span> newFn = <span class="function">(<span class="params">a, b</span>) =&gt;</span> addCurrency(len(sum(a, b)));</span><br><span class="line"><span class="built_in">console</span>.log(newFn(<span class="string">"xyz"</span>, <span class="string">"abc"</span>));</span><br></pre></td></tr></table></figure>
<p>但是不想像上面那样，地狱式嵌套的生成<code>newFn</code>，希望能 <code>compose(addCurrency,len,sum)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose(addCurrency,len,sum)</span></span><br><span class="line"><span class="keyword">const</span> compose = <span class="function">(<span class="params">...fns</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 这里因为最后一个函数是两个参数，和别的不一样，所以这边单独把它扔出来，这样其他的都符合fn(acc)</span></span><br><span class="line">    <span class="keyword">const</span> lastFn = fns.pop();</span><br><span class="line">    <span class="keyword">let</span> initValue = lastFn(...args);</span><br><span class="line">    <span class="keyword">const</span> f = <span class="function">(<span class="params">acc, fn</span>) =&gt;</span> fn(acc);</span><br><span class="line">    <span class="keyword">return</span> fns.reduceRight(f, initValue);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> newFn = compose(addCurrency, len, sum);</span><br><span class="line"><span class="built_in">console</span>.log(newFn(<span class="string">"xyz"</span>, <span class="string">"abc"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用箭头函数简化</span></span><br><span class="line"><span class="keyword">const</span> compose = <span class="function">(<span class="params">...fns</span>) =&gt;</span> (...args) =&gt;</span><br><span class="line">  fns.reduceRight(<span class="function">(<span class="params">acc, fn</span>) =&gt;</span> fn(acc), fns.pop()(...args));</span><br></pre></td></tr></table></figure>
<p>当然如果思维再厉害点，也可以用reduce</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose(addCurrency,len,sum)</span></span><br><span class="line"><span class="keyword">const</span> compose = <span class="function">(<span class="params">...fns</span>) =&gt;</span></span><br><span class="line">  fns.reduce(<span class="function">(<span class="params">acc, cur</span>) =&gt;</span> (...args) =&gt; acc(cur(...args)));</span><br></pre></td></tr></table></figure>
<p>这个法子很不容易想，但是假设现在只组合两个函数，len和sum</p>
<ul>
<li>compose就相当于<code>(...args) =&gt; len(sum(...args))</code></li>
<li>而用reduce的话相当于<code>(...args)=&gt;[len,sum].reduce((acc,curFn)=&gt;(...args) =&gt; acc(curFn(...args)))</code></li>
<li>将<code>[len,sum]</code>换成别的数组也一样</li>
<li>我这也是马后炮啦，下次我自己写估计又只会reduceRight</li>
</ul>
<h2 id="reduce-的坑"><a href="#reduce-的坑" class="headerlink" title="reduce 的坑"></a>reduce 的坑</h2><ul>
<li>空数组不能 reduce</li>
<li><code>reduce(f)</code>没 initValue 的话，f 的第一次参数是<code>arr[0] arr[1] 1 arr</code></li>
<li><code>reduce(f,initValue)</code>有 initValue 的话，f 的第一次参数是<code>initValue arr[0] 0 arr</code></li>
<li><code>f</code>必须至少有两个参数，总共四个参数<code>acc(累计器) cur(当前值) curIndex (当前索引) src (源数组)</code></li>
</ul>
<p>可读性更高的话，可以传入 initValue，这样每次的操作都是一致的不容易出错，所以本文也只说明加initValue的情况。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/map" target="_blank" rel="noopener">mdn 的 map</a></li>
<li><a href="https://www.liaoxuefeng.com/wiki/1022910821149312/1024322552460832" target="_blank" rel="noopener">廖雪峰的map解析</a></li>
<li><a href="http://research.google.com/archive/mapreduce.html" target="_blank" rel="noopener">MapReduce: Simplified Data Processing on Large Clusters 原文</a></li>
<li><a href="https://www.cnblogs.com/fuzhe1989/p/3413457.html" target="_blank" rel="noopener">MapReduce翻译文</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/25/map/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/25/map/" itemprop="url">
                  数组的map方法的应用场景及相关面试题
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-25T15:36:52+08:00">
                2020-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/25/map/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/25/map/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>map最大的作用：从一个数组得到一个新数组，其结果是该数组中的每个元素是调用一次提供的函数后的返回值。  </p>
</blockquote>
<p>上句是核心。</p>
<p>换言之，平时只要有从数组中得到一个新数组的时候，就可以联想下map</p>
<p>大部分情况下，map里的函数传入一个参数就够用。  </p>
<p>以下是应用场景，可以的话，先自己实现下</p>
<h2 id="求数组中每个元素的平方"><a href="#求数组中每个元素的平方" class="headerlink" title="求数组中每个元素的平方"></a>求数组中每个元素的平方</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pow</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>];</span><br><span class="line"><span class="comment">// [1, 4, 9, 16, 25, 36, 49, 64, 81]</span></span><br><span class="line"><span class="keyword">var</span> results = arr.map(pow);</span><br></pre></td></tr></table></figure>
<h2 id="把数组中每个元素变成字符串"><a href="#把数组中每个元素变成字符串" class="headerlink" title="把数组中每个元素变成字符串"></a>把数组中每个元素变成字符串</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>];</span><br><span class="line"><span class="comment">// ['1', '2', '3', '4', '5', '6', '7', '8', '9']</span></span><br><span class="line"><span class="keyword">var</span> results2 = arr.map(<span class="built_in">String</span>);</span><br></pre></td></tr></table></figure>
<h2 id="重新格式化数组中的对象"><a href="#重新格式化数组中的对象" class="headerlink" title="重新格式化数组中的对象"></a>重新格式化数组中的对象</h2><p>就是数组的每项都是对象，然后进行操作。或者对对象的某个值进行改变。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> kvArray = [</span><br><span class="line">  &#123; <span class="attr">key</span>: <span class="number">1</span>, <span class="attr">value</span>: <span class="number">10</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">key</span>: <span class="number">2</span>, <span class="attr">value</span>: <span class="number">20</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">key</span>: <span class="number">3</span>, <span class="attr">value</span>: <span class="number">30</span> &#125;</span><br><span class="line">];</span><br><span class="line"><span class="comment">// [&#123;1: 10&#125;, &#123;2: 20&#125;, &#123;3: 30&#125;]</span></span><br><span class="line"><span class="keyword">var</span> reformattedArray = kvArray.map(<span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rObj = &#123;&#125;;</span><br><span class="line">  rObj[obj.key] = obj.value;</span><br><span class="line">  <span class="keyword">return</span> rObj;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="map用在离散数组的时候"><a href="#map用在离散数组的时候" class="headerlink" title="map用在离散数组的时候"></a>map用在离散数组的时候</h2><p>map遍历的时候，如果当前值是undefined，则直接返回undefined。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [2,4,,,8]</span></span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,,,<span class="number">4</span>].map(<span class="function"><span class="params">item</span>=&gt;</span>item*<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<h2 id="字符串也可使用map，生成新的数组"><a href="#字符串也可使用map，生成新的数组" class="headerlink" title="字符串也可使用map，生成新的数组"></a>字符串也可使用map，生成新的数组</h2><p>如获取字符串中每个字符所对应的 ASCII 码组成的数组</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="built_in">Array</span>.prototype.map;</span><br><span class="line"><span class="keyword">var</span> a = map.call(<span class="string">"Hello World"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x.charCodeAt(<span class="number">0</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// a的值为[72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100]</span></span><br></pre></td></tr></table></figure>
<h2 id="类数组也可使用map，生成新的数组"><a href="#类数组也可使用map，生成新的数组" class="headerlink" title="类数组也可使用map，生成新的数组"></a>类数组也可使用map，生成新的数组</h2><p>比如得到所有选中选项的值，并将其打印：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ele = <span class="built_in">document</span>.querySelectorAll(<span class="string">"select option:checked"</span>);</span><br><span class="line"><span class="keyword">var</span> values = <span class="built_in">Array</span>.prototype.map.call(ele, <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> obj.value;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="map易错的地方-–-面试常碰到"><a href="#map易错的地方-–-面试常碰到" class="headerlink" title="map易错的地方 – 面试常碰到"></a>map易错的地方 – 面试常碰到</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- res的值 --&gt;</span><br><span class="line"><span class="keyword">var</span> res = [<span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>].map(<span class="built_in">parseInt</span>);</span><br></pre></td></tr></table></figure>
<p>如果不小心的话，可能会说成 <code>[1,2,3]</code></p>
<p>考点：map的callback不止一个参数，总共三个参数，cur、index、curIndex。</p>
<p>parseInt可以接受两个参数，所以上面会<code>[1, NaN, NaN]</code>，因为第二个参数index被传进去了。改进方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>].map( <span class="function"><span class="params">item</span> =&gt;</span> <span class="built_in">parseInt</span>(item));</span><br></pre></td></tr></table></figure>
<p><code></code></p>
<h2 id="手写实现map方法"><a href="#手写实现map方法" class="headerlink" title="手写实现map方法"></a>手写实现map方法</h2><p>这里<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/map" target="_blank" rel="noopener">官方的</a>更权威，这里只是简单实现大概逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.map = <span class="function"><span class="keyword">function</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> res = [];</span><br><span class="line">  <span class="comment">// this指当前的数组</span></span><br><span class="line">  <span class="keyword">let</span> curArr = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; curArr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> value = curArr[i];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">"undefined"</span>) &#123;</span><br><span class="line">     <span class="keyword">let</span> mappedValue = fn(value, i, curArr);</span><br><span class="line">     res[i] = mappedValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>此文基本根据文档总结来的，可以细看原文档</p>
<blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/map" target="_blank" rel="noopener">mdn 的 map</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/23/vue3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/23/vue3/" itemprop="url">
                  vue3的特性预览
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-23T17:23:44+08:00">
                2020-07-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/23/vue3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/23/vue3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>据说，8月份vue3就正式发布了！</p>
<p>于是最近，听了大圣的关于vue3直播课，简单整理了下信息。  </p>
<ul>
<li><a href="https://www.yuque.com/woniuppp/vue3" target="_blank" rel="noopener">vue3的特性和源码分析—大圣</a>。</li>
<li><a href="https://www.yuque.com/woniuppp/vue3" target="_blank" rel="noopener">vue3和vue2细致比较：代码</a>。</li>
</ul>
<h2 id="vue3的组成部分"><a href="#vue3的组成部分" class="headerlink" title="vue3的组成部分"></a>vue3的组成部分</h2><ul>
<li>runtime-dom，其核心是runtime-core</li>
<li>reactivity，可以脱离浏览器独立使用</li>
<li>compile-dom，其核心是compile-core</li>
</ul>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue3.png" alt="vue3"></p>
<h2 id="vue3的特点"><a href="#vue3的特点" class="headerlink" title="vue3的特点"></a>vue3的特点</h2><ul>
<li>新增composition api （类似hooks）</li>
<li>新增组件Fragment, Teleport, Suspense</li>
<li>性能 (⽐vue2快了2倍，proxy =&gt; defineProperty，compile-core重写)</li>
<li>更加支持ts</li>
<li>custom renderer api （⾃定义渲染）</li>
</ul>
<h2 id="composition-api是个啥"><a href="#composition-api是个啥" class="headerlink" title="composition api是个啥"></a>composition api是个啥</h2><p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/composition.png" alt="composition"></p>
<blockquote>
<p><a href="https://vue-composition-api-rfc.netlify.com" target="_blank" rel="noopener">Vue Composition API的官方网址</a></p>
</blockquote>
<p>以前data只是数据，改数据的话，需要用methods。<br>而composition就是将数据和修改数据放在一块~~</p>
<ul>
<li>composition =  @vue/reactivity + 生命周期</li>
<li>setup可以将相同的东西 放在一块，比如修改某些变量，不用在data methods watch 上下横跳</li>
<li>同时可以将mixin也换成普通的function</li>
<li><code>@vue/reactivity</code>是响应式的插件，独立于vue，可以在非浏览器中使用，关键方法<code>ref,effect,computed,watchEffect</code>，以下是在node中使用</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/shengxinjing/vue3-vs-vue2/blob/master/workshop/node-reactivity/server.js</span></span><br><span class="line"><span class="keyword">const</span> &#123;ref, computed,effect&#125; = <span class="built_in">require</span>(<span class="string">'@vue/reactivity'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count = ref(<span class="number">1</span>)</span><br><span class="line">setInterval(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">  count.value++</span><br><span class="line">&#125;,<span class="number">1000</span>)</span><br><span class="line"><span class="comment">// let double = computed(()=&gt; count.value*2)</span></span><br><span class="line">effect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'count is'</span>,count.value)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Fragment-Teleport-Suspense是啥"><a href="#Fragment-Teleport-Suspense是啥" class="headerlink" title="Fragment, Teleport, Suspense是啥"></a>Fragment, Teleport, Suspense是啥</h2><ul>
<li>Fragment就是以后vue组件不需要一个根节点了，现在可以这么写template</li>
<li>Teleport就是可以渲染vue的组件内容，到指定的dom节点，做弹窗比较有用。因为弹窗需要渲染到最外层body下面，否则嵌套过多，蒙层可能会被父元素的transform影响</li>
<li>suspend就是异步组件</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Fragment --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>哈喽<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>我真棒<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Teleport --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 现有一个html文件 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"foot-container"</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"module"</span> <span class="attr">src</span>=<span class="string">"/src/main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 写组件的时候 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"confirm-modal"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"isOpen = true"</span>&gt;</span>打开<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 注意这一块代码 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Teleport</span> <span class="attr">to</span>=<span class="string">"#foot-container"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"isOpen"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>底部信息底部信息底部信息底部信息底部信息底部信息<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"isOpen = false"</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Teleport</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> &#123;ref&#125; <span class="keyword">from</span> <span class="string">'vue'</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">      setup()&#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> isOpen = ref(<span class="literal">false</span>)</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> &#123;isOpen&#125;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  Suspense --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 随便来个普通的组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>一个异步小组件<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">timeout</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> setTimeout(resolve, timeout));</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">    name: <span class="string">"AsyncComponent"</span>,</span></span><br><span class="line"><span class="undefined">    props: &#123;</span></span><br><span class="line"><span class="undefined">      timeout: &#123;</span></span><br><span class="line"><span class="javascript">        type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">        required: <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="javascript">    <span class="keyword">async</span> setup(props) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">await</span> sleep(props.timeout);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 使用的时候 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Supense<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Suspense</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> #<span class="attr">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">AsyncComponent</span> <span class="attr">:timeout</span>=<span class="string">"3000"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> #<span class="attr">fallback</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>加载中<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> AsyncComponent <span class="keyword">from</span> <span class="string">'./AsyncComponent.vue'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">  components:&#123;</span></span><br><span class="line"><span class="undefined">    AsyncComponent</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="compile-core是啥"><a href="#compile-core是啥" class="headerlink" title="compile-core是啥"></a>compile-core是啥</h2><p>compile-core，其实就是将template变成js，返回vdom。</p>
<p>而vue3重写了compile-core。</p>
<ul>
<li><a href="https://vue-next-template-explorer.netlify.app" target="_blank" rel="noopener">vue3的模板在线编译</a></li>
<li><a href="https://template-explorer.vuejs.org/" target="_blank" rel="noopener">vue2的模板在线编译</a></li>
</ul>
<p><a href="https://juejin.im/post/5e9faa8fe51d4546fe263eda" target="_blank" rel="noopener">vue3动态标记以及与react的比较</a>，核心点如下：</p>
<ul>
<li>vue2无差别标记所有的节点</li>
<li>vue3动态标记节点，也就是纯静态和动态会被分别标记，一旦_createVNode传第四个参数，就是动态节点。动态节点会维护在一个数组里。且不同类型的节点会进行位运算来判定。</li>
<li>关于diff算法：vue2使用双端比较，vue3加入了最长递增子序列</li>
</ul>
<h2 id="模板的发展史-–-vdom的由来"><a href="#模板的发展史-–-vdom的由来" class="headerlink" title="模板的发展史 – vdom的由来"></a>模板的发展史 – vdom的由来</h2><ul>
<li>$(‘xx’).html(xx)</li>
<li>underscore-字符串， <img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/underscore_template.png" alt="写法图片"></li>
<li>按需更新 <img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vdom1.png" alt="vdom的概念">,<img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vdom_code.png" alt="vdom的简单的代码实现">，ast</li>
<li>这里涉及到编译原理，有空看看这个最小的编译器，<a href="https://github.com/jamiebuilds/the-super-tiny-compiler" target="_blank" rel="noopener">the-super-tiny-compiler</a>,<a href="https://github.com/starkwang/the-super-tiny-compiler-cn" target="_blank" rel="noopener">中文版</a></li>
</ul>
<!-- 科班：算法 编译原理 设计模式 -->
<h2 id="vite可能取代webpack"><a href="#vite可能取代webpack" class="headerlink" title="vite可能取代webpack"></a>vite可能取代webpack</h2><p>vite是用于在开发的时候替换webpack的工具，热更新速度贼快。<br>最大的亮点是<strong>利用浏览器自带的import功能，只解析，不打包</strong>  </p>
<p><a href="https://github.com/shengxinjing/vue3-vs-vue2/blob/master/vite-mini/server.js" target="_blank" rel="noopener">手写实现一个迷你vite</a></p>
<p>核心：</p>
<ul>
<li>路径转化</li>
<li>@vue/compiler-sfc =&gt; 解析vue文件</li>
<li>@vue/compiler-dom =&gt; 解析vue文件的html部分</li>
<li>支持css或者其他类型的，本质上就是一个相应的loader</li>
</ul>
<h2 id="其他资源"><a href="#其他资源" class="headerlink" title="其他资源"></a>其他资源</h2><ul>
<li>ts的语法 <img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/ts.png" alt="ts"></li>
<li><a href="https://github.com/lerna/lerna" target="_blank" rel="noopener">lerna管理前端模块</a></li>
<li><a href="https://jex.im/regulex" target="_blank" rel="noopener">正则可视化</a></li>
<li>prepack实现构建时优化<ul>
<li><a href="https://prepack.io/" target="_blank" rel="noopener">prepack的官网</a></li>
<li><a href="https://github.com/facebook/prepack" target="_blank" rel="noopener">prepack的github</a><br><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/prepack.png" alt="prepack"></li>
</ul>
</li>
</ul>
<h2 id="大圣的各种账号，可以关注看看"><a href="#大圣的各种账号，可以关注看看" class="headerlink" title="大圣的各种账号，可以关注看看"></a>大圣的各种账号，可以关注看看</h2><ul>
<li><a href="https://space.bilibili.com/26995758/video" target="_blank" rel="noopener">B站</a></li>
<li><a href="https://github.com/shengxinjing" target="_blank" rel="noopener">github</a></li>
<li><a href="https://juejin.im/user/59532176f265da6c317d8e14" target="_blank" rel="noopener">掘⾦</a></li>
</ul>
<!-- ## 推荐书籍

* 俞军产品方法论（附注[大圣总结的视频](https://www.bilibili.com/video/BV1LZ4y147QS)）
* 人人都是产品经理
* 增长黑客 -->
<!-- ## ssr

ssr将component变成字符串

爬虫爬的时候，希望有数据。

本地压力测试 [wrk](https://github.com/wg/wrk) -->

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/15/module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/15/module/" itemprop="url">
                  export导出的是变量！！！是变量！！！
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-15T18:56:46+08:00">
                2020-07-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/15/module/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/15/module/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先，建议仔细看看<a href="https://es6.ruanyifeng.com/#docs/module" target="_blank" rel="noopener">es6 入门的 module 语法</a>。</p>
<p>我想说说相对重要的点：</p>
<ul>
<li>每个 js 文件相互独立，是一个单独的<code>module</code>，输出用<code>export</code>，输入是<code>import</code></li>
<li><code>export</code>导出的是变量</li>
<li><code>export default</code>导出的是一个具体的值</li>
<li><code>export var a=1</code>相当于<code>var a=1;export { a }</code></li>
<li><code>export default 1</code>相当于<code>var a=1;export { a as default}</code>，一个<code>module</code>只能有一个<code>default</code></li>
<li><code>export</code>和<code>import</code>只能出现在顶级作用域</li>
<li>as 可以重命名</li>
<li><code>import</code>的变量会变量提升，也就是不管写在哪，总会最先被解析</li>
<li><code>import {a,b} from &#39;./a&#39;</code>，<code>export</code>出去的结构是<code>{a,b}</code>，所以相应的<code>import</code>用的也是<code>{a,b}</code></li>
<li><code>import a from &#39;./a&#39;</code>，<code>export default</code>导出的是一个值，<code>import</code>的时候可以将值赋值给任意一个变量</li>
<li><code>import * as all from &#39;./a&#39;</code>，将 a 里面所有的 export 都拿到，因为<code>export {a}</code>，所以这里的 all 就是<code>{a}</code>，且因为<code>export default</code>也是一种<code>export</code>，所以 all 实质上是<code>{a,default}</code></li>
<li><code>import</code>来的变量，因为是别人家的变量，所以只能读，不能写</li>
<li><code>export {a} from &#39;./a&#39;</code>这句相当于<code>import {a} from &#39;./a&#39;;export {a}</code></li>
</ul>
<h2 id="export导出的是变量"><a href="#export导出的是变量" class="headerlink" title="export导出的是变量"></a><code>export</code>导出的是变量</h2><p>这句怎么理解呢，举个例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line">setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  a++;</span><br><span class="line">&#125;, <span class="number">500</span>);</span><br><span class="line"><span class="keyword">export</span> &#123; a &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; a &#125; <span class="keyword">from</span> <span class="string">"./a"</span>;</span><br><span class="line"><span class="comment">// a会跟随a文件的变化</span></span><br><span class="line">setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a);</span><br><span class="line">&#125;, <span class="number">500</span>);</span><br></pre></td></tr></table></figure>
<p>因为 a 是 a 文件的变量，当 a 的值变化的时候，b 文件的 a 同样变化了，因为 export 出的是一个变量 a,而不是写死的 a 的值</p>
<p>因为<code>export</code>导出的是变量</p>
<p>所以可以有以下写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">export</span> &#123; a, fn &#125;;</span><br><span class="line"><span class="comment">// 如果想多次导出一个变量，可以将变量重命名，相同名字的只能有一个哈</span></span><br><span class="line"><span class="keyword">export</span> &#123; a <span class="keyword">as</span> a1, a <span class="keyword">as</span> a2 &#125;;</span><br></pre></td></tr></table></figure>
<p>所以不能以下写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span></span><br><span class="line"><span class="comment">// 这句相当于 export 1</span></span><br><span class="line"><span class="keyword">export</span> a</span><br></pre></td></tr></table></figure>
<h2 id="export-default导出的是值"><a href="#export-default导出的是值" class="headerlink" title="export default导出的是值"></a><code>export default</code>导出的是值</h2><p>这句怎么理解呢，举个类似上面的例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line">setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  a++;</span><br><span class="line">&#125;, <span class="number">500</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="comment">// 没有&#123;&#125;,就是export default的值，这里可以将值赋值给任意变量，不一定非得a</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">"./a"</span>;</span><br><span class="line"><span class="comment">// a不会随着a文件而变化</span></span><br><span class="line">setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a);</span><br><span class="line">&#125;, <span class="number">500</span>);</span><br></pre></td></tr></table></figure>
<p>因为<code>export default</code>出去的是一个具体的值，一个写死的值，这里就是 1，管他 a 文件后来怎么样呢</p>
<p>因为<code>export default</code>导出的是变量</p>
<p>所以可以有以下写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; a <span class="keyword">as</span> <span class="keyword">default</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>所以不能以下写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">var</span> a = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h2 id="import-有没有"><a href="#import-有没有" class="headerlink" title="import 有没有{}"></a>import 有没有<code>{}</code></h2><p>使用 export default 时，对应的 import 语句不需要使用大括号。<br>使用 export 时，对应的 import 语句需要使用大括号。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; a &#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> b;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; a &#125; <span class="keyword">from</span> <span class="string">"./a"</span>;</span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">"./a"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> all <span class="keyword">from</span> <span class="string">"./a"</span>;</span><br><span class="line"><span class="comment">// 可以看看这里的all，&#123;a:1,default:2&#125;，加深对default的理解</span></span><br><span class="line"><span class="built_in">console</span>.log(all);</span><br><span class="line"><span class="comment">// 注意，这里的b其实是相当于 在这里var b= 2，是b文件自己的变量，可以随意赋值</span></span><br><span class="line">b = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// a是a文件的变量，不可修改，只能a文件自己改，以下这句会报错</span></span><br><span class="line">a = <span class="number">333</span>;</span><br></pre></td></tr></table></figure>
<h2 id="export-from-什么时候用"><a href="#export-from-什么时候用" class="headerlink" title="export from 什么时候用"></a><code>export from</code> 什么时候用</h2><p>我说个应用场景，读者可以举一反三~</p>
<p>项目里请求的接口很多，放在一个文件里太长，也难以维护，一般会以功能模块划分。</p>
<p>现在有个<code>api</code>的文件夹，<code>index.js</code>是将所有的接口转出去，还有<code>project.js task.js</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// project.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> add = <span class="function"><span class="params">()</span> =&gt;</span> axios.post(...)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> remove = <span class="function"><span class="params">()</span> =&gt;</span> axios.post(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// task.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> add = <span class="function"><span class="params">()</span> =&gt;</span> axios.post(...)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> remove = <span class="function"><span class="params">()</span> =&gt;</span> axios.post(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">as</span> project <span class="keyword">from</span> <span class="string">'project'</span>;</span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">as</span> task <span class="keyword">from</span> <span class="string">'task'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在组件使用的时候</span></span><br><span class="line"><span class="keyword">import</span> api <span class="keyword">from</span> <span class="string">'./api'</span></span><br><span class="line">api.project.add()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当然一般为了方便使用会在main.js那边将其挂载在全局</span></span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> api <span class="keyword">from</span> <span class="string">'./api'</span></span><br><span class="line">Vue.prototype.$api = api</span><br><span class="line"><span class="comment">// 组件使用的时候</span></span><br><span class="line"><span class="keyword">this</span>.$api.project.add()</span><br></pre></td></tr></table></figure>
<p>es2020 的提案，<code>import(&#39;./a&#39;)</code>可以在需要的时候加载某个模块，比如点击按钮等等，一种懒加载的机制。<br>webpack 已经实现了，所以在<code>vue-router</code>里可以使用这样懒加载一个页面。  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: <span class="string">"/m"</span>,</span><br><span class="line">  name: <span class="string">"m"</span>,</span><br><span class="line">  component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "m" */</span> <span class="string">"../views/M.vue"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/13/form-validate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/13/form-validate/" itemprop="url">
                  优雅的写表单校验 -- 策略模式的运用
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-13T18:04:49+08:00">
                2020-07-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/13/form-validate/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/13/form-validate/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>假设我们正在编写一个注册的页面，在点击注册按钮之前，有如下几条校验逻辑。</p>
<ul>
<li>用户名不能为空。</li>
<li>密码长度不能少于 6 位。</li>
<li>手机号码必须符合格式。</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http:// xxx.com/register"</span> <span class="attr">id</span>=<span class="string">"registerForm"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>请输入用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"userName"</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>请输入密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"password"</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>请输入手机号码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"phoneNumber"</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>html 的部分很简单，主要想想提交里怎么写？</p>
<p>来，简单构思下~<br>来，简单构思下~<br>来，简单构思下~</p>
<h2 id="凭直觉写的表单校验-v1"><a href="#凭直觉写的表单校验-v1" class="headerlink" title="凭直觉写的表单校验 - v1"></a>凭直觉写的表单校验 - v1</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> form = <span class="built_in">document</span>.querySelector(<span class="string">"#registerForm"</span>);</span><br><span class="line">form.onsubmit = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (form.userName.value === <span class="string">""</span>) &#123;</span><br><span class="line">    alert(<span class="string">"用户名不能为空"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (form.password.value.length &lt; <span class="number">6</span>) &#123;</span><br><span class="line">    alert(<span class="string">"密码不能少于6位"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="regexp">/[0-9]&#123;11,11&#125;/</span>.test(form.phoneNumber.value)) &#123;</span><br><span class="line">    alert(<span class="string">"手机号码格式不正确"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一顿操作猛如虎，好，写完之后，看看代码有何不妥：</p>
<ul>
<li>registerForm.onsubmit 函数比较庞大，包含了很多 if-else 语句，这些语句需要覆盖所有<br>的校验规则。</li>
<li>registerForm.onsubmit 函数缺乏弹性，如果增加了一种新的校验规则，或者想把密码的长<br>度校验从 6 改成 8，我们都必须深入 registerForm.onsubmit 函数的内部实现，这是违反开<br>放—封闭原则的。</li>
<li>算法的复用性差，如果在程序中增加了另外一个表单，这个表单也需要进行一些类似的<br>校验，那我们很可能将这些校验逻辑复制得漫天遍野。</li>
</ul>
<p>联系之前说过的策略模式，来改进代码~</p>
<h2 id="改进版的表单校验-v2"><a href="#改进版的表单校验-v2" class="headerlink" title="改进版的表单校验 - v2"></a>改进版的表单校验 - v2</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将算法的实现单独封装起来</span></span><br><span class="line"><span class="keyword">var</span> strategies = &#123;</span><br><span class="line">  isNonEmpty: <span class="function"><span class="keyword">function</span>(<span class="params">value, errorMsg</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 不为空</span></span><br><span class="line">    <span class="keyword">if</span> (value === <span class="string">""</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> errorMsg;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 这里把length作为参数</span></span><br><span class="line">  minLength: <span class="function"><span class="keyword">function</span>(<span class="params">value, length, errorMsg</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 限制最小长度</span></span><br><span class="line">    <span class="keyword">if</span> (value.length &lt; length) &#123;</span><br><span class="line">      <span class="keyword">return</span> errorMsg;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  isMobile: <span class="function"><span class="keyword">function</span>(<span class="params">value, errorMsg</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 手机号码格式</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/(^1[3|5|8][0-9]&#123;9&#125;$)/</span>.test(value)) &#123;</span><br><span class="line">      <span class="keyword">return</span> errorMsg;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 算法的使用</span></span><br><span class="line"><span class="keyword">let</span> form = <span class="built_in">document</span>.querySelector(<span class="string">"#registerForm"</span>);</span><br><span class="line">form.onsubmit = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> errorMsg = <span class="string">"用户名不能为空"</span>;</span><br><span class="line">  <span class="keyword">if</span> ((strategies.isNonEmpty(registerForm.userName.value), errorMsg)) &#123;</span><br><span class="line">    alert(errorMsg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> errorMsg = <span class="string">"密码长度不能少于6 位"</span>;</span><br><span class="line">  <span class="keyword">if</span> ((strategies.minLength(registerForm.password.value), <span class="number">6</span>, errorMsg)) &#123;</span><br><span class="line">    alert(errorMsg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> errorMsg = <span class="string">"手机号码格式不正确"</span>;</span><br><span class="line">  <span class="keyword">if</span> ((strategies.isMobile(registerForm.phoneNumber.value), errorMsg)) &#123;</span><br><span class="line">    alert(errorMsg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 这里开始ajax请求。。。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>写完之后，我屮艸芔茻！！！这好像和第一版也没什么大的区别。看起来一点也不优雅！！！</p>
<p>但这里提供了关键性思路，提交部分明显就是重复，很容易想到列表循环，这里将其抽象成 validator 的类。</p>
<p>也就是 validator 类提供 add 和 start,，add 负责将每种校验方式放进一个数组，start 负责遍历数组，一旦有返回值直接返回且终止返回。</p>
<p>。。。我觉得有点难度，可以试试写写。</p>
<h2 id="改进版的表单校验-v3"><a href="#改进版的表单校验-v3" class="headerlink" title="改进版的表单校验 - v3"></a>改进版的表单校验 - v3</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> strategies = &#123;</span><br><span class="line">  isNonEmpty(value, errorMsg) &#123;</span><br><span class="line">    <span class="comment">// 不为空</span></span><br><span class="line">    <span class="keyword">if</span> (value === <span class="string">""</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> errorMsg;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  minLength(value, length, errorMsg) &#123;</span><br><span class="line">    <span class="comment">// 限制最小长度</span></span><br><span class="line">    <span class="keyword">if</span> (value.length &lt; length) &#123;</span><br><span class="line">      <span class="keyword">return</span> errorMsg;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  isMobile(value, errorMsg) &#123;</span><br><span class="line">    <span class="comment">// 手机号码格式</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/(^1[3|5|8][0-9]&#123;9&#125;$)/</span>.test(value)) &#123;</span><br><span class="line">      <span class="keyword">return</span> errorMsg;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Validator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.cache = [];</span><br><span class="line">  &#125;</span><br><span class="line">  add(dom, rule, msg) &#123;</span><br><span class="line">    <span class="comment">// 把单个验证表单的fn存下来</span></span><br><span class="line">    <span class="keyword">let</span> [strategy, length] = rule.split(<span class="string">":"</span>);</span><br><span class="line">    <span class="keyword">let</span> params = length ? [dom.value, length, msg] : [dom.value, msg];</span><br><span class="line">    <span class="built_in">console</span>.log(params);</span><br><span class="line">    <span class="keyword">let</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> strategies[strategy](...params);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">this</span>.cache.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  start() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.cache.length; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> errMsg = <span class="keyword">this</span>.cache[i]();</span><br><span class="line">      <span class="keyword">if</span> (errMsg) &#123;</span><br><span class="line">        <span class="keyword">return</span> errMsg;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 应用</span></span><br><span class="line"><span class="keyword">let</span> form = <span class="built_in">document</span>.querySelector(<span class="string">"#registerForm"</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> validator = <span class="keyword">new</span> Validator();</span><br><span class="line">  validator.add(form.userName, <span class="string">"isNonEmpty"</span>, <span class="string">"用户名不能为空"</span>);</span><br><span class="line">  validator.add(form.password, <span class="string">"minLength:6"</span>, <span class="string">"密码不能少于6位"</span>);</span><br><span class="line">  validator.add(form.phoneNumber, <span class="string">"isMobile"</span>, <span class="string">"手机号码格式不正确"</span>);</span><br><span class="line">  <span class="comment">// 需要加新的校验规则，直接添加这里就好</span></span><br><span class="line">  <span class="keyword">let</span> errMsg = validator.start();</span><br><span class="line">  <span class="keyword">return</span> errMsg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// submit里面就很优雅了</span></span><br><span class="line">form.onsubmit = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> errMsg = validateData();</span><br><span class="line">  <span class="keyword">if</span> (errMsg) &#123;</span><br><span class="line">    alert(errMsg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>写完这些之后，其实。。。还有点缺点，比如用户名想同时验证其为空和长度的话，需要单个列出，显然又累赘了，接下来试着将其改成<code>validator.add(form.userName, {isNonEmpty:&#39;用户名不能为空&#39;,&#39;minLength:6&#39;:&#39;用户名长度不能少于6位&#39;})</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">validator.add(form.userName, <span class="string">"isNonEmpty"</span>, <span class="string">"用户名不能为空"</span>);</span><br><span class="line">validator.add(form.userName, <span class="string">"minLength:6"</span>, <span class="string">"用户名长度不能少于6位"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="改进版的表单校验-v4"><a href="#改进版的表单校验-v4" class="headerlink" title="改进版的表单校验 - v4"></a>改进版的表单校验 - v4</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var strategies = 。。。;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Validator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.cache = [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 没事原先的add提取出来</span></span><br><span class="line">  _handleRule(dom, rule, msg) &#123;</span><br><span class="line">    <span class="comment">// 把单个验证表单的fn存下来</span></span><br><span class="line">    <span class="keyword">let</span> [strategy, length] = rule.split(<span class="string">":"</span>);</span><br><span class="line">    <span class="keyword">let</span> params = length ? [dom.value, length, msg] : [dom.value, msg];</span><br><span class="line">    <span class="built_in">console</span>.log(params);</span><br><span class="line">    <span class="keyword">let</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> strategies[strategy](...params);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">this</span>.cache.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  add(dom, rules) &#123;</span><br><span class="line">    rules.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> rule <span class="keyword">in</span> item) &#123;</span><br><span class="line">        <span class="keyword">let</span> msg = item[rule];</span><br><span class="line">        <span class="comment">// 遍历的时候，直接使用就好</span></span><br><span class="line">        <span class="keyword">this</span>._handleRule(dom, rule, msg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  start() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.cache.length; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> errMsg = <span class="keyword">this</span>.cache[i]();</span><br><span class="line">      <span class="keyword">if</span> (errMsg) &#123;</span><br><span class="line">        <span class="keyword">return</span> errMsg;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 应用</span></span><br><span class="line"><span class="keyword">let</span> form = <span class="built_in">document</span>.querySelector(<span class="string">"#registerForm"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> validator = <span class="keyword">new</span> Validator();</span><br><span class="line">  validator.add(form.userName, [</span><br><span class="line">    &#123; <span class="attr">isNonEmpty</span>: <span class="string">"用户名不能为空"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"minLength:6"</span>: <span class="string">"用户名不能少于6位"</span> &#125;</span><br><span class="line">  ]);</span><br><span class="line">  validator.add(form.password, [&#123; <span class="string">"minLength:6"</span>: <span class="string">"密码不能少于6位"</span> &#125;]);</span><br><span class="line">  validator.add(form.phoneNumber, [&#123; <span class="attr">isMobile</span>: <span class="string">"手机号码格式不正确"</span> &#125;]);</span><br><span class="line">  <span class="built_in">console</span>.log(validator);</span><br><span class="line">  <span class="keyword">let</span> errMsg = validator.start();</span><br><span class="line">  <span class="keyword">return</span> errMsg;</span><br><span class="line">&#125;</span><br><span class="line">form.onsubmit = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> errMsg = validateData();</span><br><span class="line">  <span class="keyword">if</span> (errMsg) &#123;</span><br><span class="line">    alert(errMsg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>完结，下次看表单验证的一些插件可能就能加深理解了！</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>这里的案例是《JavaScript的设计模式与开发实践》里面的，写的非常好，强烈安利！！！</p>
<!-- 
## 改进版的表单校验 - v3

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// minLength这个统一传 'minLength:6'，所以这里简单做下判断</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateRule</span>(<span class="params">dom, strategy, errorMsg</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// minLength:6 =&gt; [minLength,6]</span></span><br><span class="line">  <span class="keyword">var</span> params = strategy.split(<span class="string">":"</span>);</span><br><span class="line">  <span class="comment">// 相当于 strategy = params[0] ; params=params.slice(1) 此操作甚秒</span></span><br><span class="line">  strategy = params.shift();</span><br><span class="line">  <span class="comment">// params是传入到strategy的参数，第一个参数是value 第二个可能是另外的参数，这就看params上面的操作了，最后一个是errMsg</span></span><br><span class="line">  params.unshift(dom.value);</span><br><span class="line">  params.push(errorMsg);</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  if (strategies.isNonEmpty(registerForm.userName.value)) &#123;</span></span><br><span class="line"><span class="comment">    alert("用户名不能为空");</span></span><br><span class="line"><span class="comment">    return false;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  <span class="comment">// errorMsg还是返回出来更好，这样更加容易复用</span></span><br><span class="line">  <span class="keyword">if</span> (strategies[strategy](...params)) &#123;</span><br><span class="line">    <span class="keyword">return</span> errorMsg;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 算法的使用</span></span><br><span class="line">submitBtn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> errorMsg = validateRule(</span><br><span class="line">    registerForm.userName,</span><br><span class="line">    <span class="string">"isNonEmpty"</span>,</span><br><span class="line">    <span class="string">"用户名不能为空"</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (errorMsg) &#123;</span><br><span class="line">    alert(errorMsg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> errorMsg = validateRule(</span><br><span class="line">    registerForm.password,</span><br><span class="line">    <span class="string">"minLength:6"</span>,</span><br><span class="line">    <span class="string">"密码长度不能少于6 位"</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (errorMsg) &#123;</span><br><span class="line">    alert(errorMsg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> errorMsg = validateRule(</span><br><span class="line">    registerForm.phoneNumber,</span><br><span class="line">    <span class="string">"isMobile"</span>,</span><br><span class="line">    <span class="string">"手机号码格式不正确"</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (errorMsg) &#123;</span><br><span class="line">    alert(errorMsg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里开始ajax请求。。。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>……….<br>……….<br>……….</p>
<p>继续来，我们是工匠，致力打造最美代码~~</p>
<h2 id="改进版的表单校验-v4-1"><a href="#改进版的表单校验-v4-1" class="headerlink" title="改进版的表单校验 - v4"></a>改进版的表单校验 - v4</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cache = [];</span><br><span class="line">cache.push(validateRule(registerForm.userName, <span class="string">"isNonEmpty"</span>, <span class="string">"用户名不能为空"</span>));</span><br><span class="line">cache.push(</span><br><span class="line">  validateRule(registerForm.password, <span class="string">"minLength:6"</span>, <span class="string">"密码度不能少于6 位"</span>)</span><br><span class="line">);</span><br><span class="line">cache.push(</span><br><span class="line">  validateRule(registerForm.phoneNumber, <span class="string">"isMobile"</span>, <span class="string">"手机号码格式不正确"</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cache.length; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> cur = cache[i];</span><br><span class="line">    <span class="keyword">if</span> (cur) &#123;</span><br><span class="line">      <span class="keyword">return</span> cur;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">submitBtn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> errorMsg = start();</span><br><span class="line">  <span class="keyword">if</span> (errorMsg) &#123;</span><br><span class="line">    alert(errorMsg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 这里开始ajax请求。。。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>代码到了这里增加规则的话就已经方便很多了，只需要 push 相关规则即可，下面的 start 和 click 就不用动了。其实算是封装了变与不变，但是这里<code>strategies cache start</code>都是紧密相关的，可以提取一个 Validator 的类，将他们封装在每个实例里，这样就很方便了。</p>
<h2 id="改进版的表单校验-v5"><a href="#改进版的表单校验-v5" class="headerlink" title="改进版的表单校验 - v5"></a>改进版的表单校验 - v5</h2><p><code>`</code>js<br>class Validator {<br>  constructor() {<br>    this.cache = [];<br>  }<br>  add(dom, strategy, errorMsg) {<br>    let params = strategy.split(“:”);<br>    strategy = params.shift();<br>    params.unshift(dom.value);<br>    params.push(errorMsg);<br>    // 把校验的函数放进cache里，这里不直接存结果，而是存要运行的函数<br>    let res = () =&gt; strategies<a href="...params">strategy</a>;<br>    // 数组每项结构类似于 function(){return isNonEmpty()},运行之后相当于isNonEmpty()<br>    this.cache.push(res);<br>  }</p>
<p>  start() {<br>    for (let i = 0; i &lt; this.cache.length; i++) {<br>      let validatorFn = this.cache[i];<br>      var errorMsg = validatorFn();<br>      if (errorMsg) {<br>        return errorMsg;<br>      }<br>    }<br>  }<br>}</p>
<p>var validataFunc = function() {<br>  // 创建一个validator 对象<br>  var validator = new Validator();<br>  /<strong><strong><strong>***</strong></strong></strong>添加一些校验规则<strong><strong><strong><em>**</em></strong></strong></strong>/<br>  validator.add(registerForm.userName, “isNonEmpty”, “用户名不能为空”);<br>  validator.add(registerForm.password, “minLength:6”, “密码长度不能少于6 位”);<br>  validator.add(registerForm.phoneNumber, “isMobile”, “手机号码格式不正确”);<br>  var errorMsg = validator.start();<br>  return errorMsg;<br>};</p>
<p>submitBtn.onclick = function() {<br>  // 如果errorMsg 有确切的返回值，说明未通过校验<br>  var errorMsg = validataFunc();<br>  if (errorMsg) {<br>    alert(errorMsg);<br>    return false;<br>  }<br>  // 这里开始ajax请求。。。<br>};<br><code>`</code> –&gt;</p>
-->
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/03/mode-strategy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/03/mode-strategy/" itemprop="url">
                  从计算年终奖开始，理解策略模式 - 2/14
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-03T18:55:36+08:00">
                2020-07-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/03/mode-strategy/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/03/mode-strategy/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先，先想下怎么实现这样一个功能。<br>很多公司的年终奖是根据员工的工资基数和年底绩效情况来发放的。<br>例如，绩效为 S 的人年终奖有 4 倍工资，绩效为 A 的人年终奖有 3 倍工资，而绩效为 B 的人年终奖是 2 倍工资。<br>假设财务部要求我们提供一段代码，来方便他们计算员工的年终奖。  </p>
<p>想想。。。<br>想想。。。<br>想想。。。</p>
<h2 id="计算奖金–初始想法"><a href="#计算奖金–初始想法" class="headerlink" title="计算奖金–初始想法"></a>计算奖金–初始想法</h2><p>可能多数人的第一反应是下面的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> calculateBonus = <span class="function"><span class="keyword">function</span>(<span class="params">performanceLevel, salary</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (performanceLevel === <span class="string">"S"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> salary * <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (performanceLevel === <span class="string">"A"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> salary * <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (performanceLevel === <span class="string">"B"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> salary * <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">calculateBonus(<span class="string">"B"</span>, <span class="number">20000</span>); <span class="comment">// 输出：40000</span></span><br><span class="line">calculateBonus(<span class="string">"S"</span>, <span class="number">6000</span>); <span class="comment">// 输出：24000</span></span><br></pre></td></tr></table></figure>
<p>看起来完美得很。但实际有很多缺点：</p>
<ul>
<li>calculateBonus 函数比较庞大，包含了很多 if-else 语句，这些语句需要覆盖所有的逻辑<br>分支。</li>
<li>calculateBonus 函数缺乏弹性，如果增加了一种新的绩效等级 C，或者想把绩效 S 的奖金系数改为 5，那我们必须深入 calculateBonus 函数的内部实现，这是违反开放  封闭原则的。</li>
<li>算法的复用性差，如果在程序的其他地方需要重用这些计算奖金的算法呢？我们的选择只有复制和粘贴。</li>
</ul>
<p>来，再想想，怎么改进？<br>来，再想想，怎么改进？<br>来，再想想，怎么改进？  </p>
<h2 id="计算奖金—升级版"><a href="#计算奖金—升级版" class="headerlink" title="计算奖金—升级版"></a>计算奖金—升级版</h2><p>大逻辑：将各个评级的计算方法封装起来，然后写个对象，将评级和计算方式一一对应，使用的时候就传入评级就好。<br>代码如下：  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> strategies = &#123;</span><br><span class="line">  S: <span class="function"><span class="keyword">function</span>(<span class="params">salary</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> salary * <span class="number">4</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  A: <span class="function"><span class="keyword">function</span>(<span class="params">salary</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> salary * <span class="number">3</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  B: <span class="function"><span class="keyword">function</span>(<span class="params">salary</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> salary * <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> calculateBonus = <span class="function"><span class="keyword">function</span>(<span class="params">level, salary</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> strategies[level](salary);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(calculateBonus(<span class="string">"S"</span>, <span class="number">20000</span>)); <span class="comment">// 输出：80000</span></span><br><span class="line"><span class="built_in">console</span>.log(calculateBonus(<span class="string">"A"</span>, <span class="number">10000</span>)); <span class="comment">// 输出：30000</span></span><br></pre></td></tr></table></figure>
<p>优点：</p>
<ul>
<li>增加等级，只需在策略里增加算法就好</li>
<li>增加等级，calculateBonus函数也不需要修改</li>
<li>赏心悦目</li>
</ul>
<h2 id="初步理解策略模式"><a href="#初步理解策略模式" class="headerlink" title="初步理解策略模式"></a>初步理解策略模式</h2><p>策略模式：封装一系列的算法，根据情况调用不同的算法，目的是将<strong>算法的实现</strong>与<strong>算法的使用</strong>分离开来。</p>
<p>拿年终奖来说：</p>
<ul>
<li>strategies是算法的实现，封装了一系列的算法</li>
<li>calculateBonus是算法的使用</li>
</ul>
<p>以后碰到很多<code>if/else</code>的时候，想想这种改进方式。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li>《JavaScript的设计模式和开发实践》</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://omizt4opc.bkt.clouddn.com/avatar.jpg"
               alt="frontzhm" />
          <p class="site-author-name" itemprop="name">frontzhm</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">207</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">38</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">frontzhm</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"frontzhm"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
