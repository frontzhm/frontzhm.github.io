<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="frontzhm, zhm, huahua, hua_hua" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="hello world">
<meta property="og:type" content="website">
<meta property="og:title" content="花花的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="花花的博客">
<meta property="og:description" content="hello world">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="花花的博客">
<meta name="twitter:description" content="hello world">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> 花花的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?60f2cb5747a596a24f2a053f1650c30b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">花花的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/29/vue_5_source_code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/29/vue_5_source_code/" itemprop="url">
                  组件注册 - 学习vue源码系列3.4
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-29T15:29:33+08:00">
                2021-07-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/29/vue_5_source_code/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/29/vue_5_source_code/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>决定跟着<a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码课程</a>好好学习下<code>vue2</code>的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~</p>
<p>将<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue 的源码</a>clone 到本地，切换到分支<code>2.6</code>。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>vue 中除了内置组件<code>keep-alive</code>等，其他组件必须先注册才能使用，不然就会报错<code>Unknown custom element...</code></p>
<p>vue 有两种注册方式：</p>
<ul>
<li>全局注册</li>
<li>局部注册</li>
</ul>
<h2 id="先看个-demo"><a href="#先看个-demo" class="headerlink" title="先看个 demo"></a>先看个 demo</h2><p>组件的两种注册和使用方式如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/Users/zhm/mygit/vue/dist/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 子组件</span></span><br><span class="line"><span class="undefined">  let Hello = &#123;</span></span><br><span class="line"><span class="undefined">    name: "Hello",</span></span><br><span class="line"><span class="xml">    template: "<span class="tag">&lt;<span class="name">div</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">div</span>&gt;</span>",</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 全局组件</span></span><br><span class="line"><span class="undefined">  let appComponent = &#123;</span></span><br><span class="line"><span class="undefined">    name: "app",</span></span><br><span class="line"><span class="undefined">    // 注册局部组件</span></span><br><span class="line"><span class="undefined">    components: &#123; Hello &#125;,</span></span><br><span class="line"><span class="undefined">    // 使用局部组件</span></span><br><span class="line"><span class="undefined">    template: `</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="undefined">      &#123;&#123;msg&#125;&#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">hello</span>&gt;</span><span class="tag">&lt;/<span class="name">hello</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="undefined">    `,</span></span><br><span class="line"><span class="undefined">    data: () =&gt; (&#123; msg: "App" &#125;),</span></span><br><span class="line"><span class="undefined">    created() &#123;</span></span><br><span class="line"><span class="undefined">      console.log(`组件的$options.components`, this.$options.components);</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 注册全局组件</span></span><br><span class="line"><span class="undefined">  Vue.component(appComponent.name, appComponent);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  console.log("Vue类上的options.components", Vue.options.components);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 根组件实例</span></span><br><span class="line"><span class="undefined">  let vueInstance = new Vue(&#123;</span></span><br><span class="line"><span class="undefined">    el: "#app",</span></span><br><span class="line"><span class="xml">    template: `<span class="tag">&lt;<span class="name">app</span>&gt;</span><span class="tag">&lt;/<span class="name">app</span>&gt;</span>`,</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>看下打印的结果：<br><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_component1.png" alt="vue_component1"></p>
<p>注册全局组件，使用<code>Vue.component(name,componentOptions)</code><br>注册局部组件，使用<code>{components:{hello:hello}}</code></p>
<h2 id="注册全局组件：Vue-component"><a href="#注册全局组件：Vue-component" class="headerlink" title="注册全局组件：Vue.component"></a>注册全局组件：Vue.component</h2><p>看看<code>Vue.component</code>怎么定义的，都做了啥，直接找有点难找，直接贴源码：</p>
<p><code>initAssetRegisters</code>就是在 Vue 上注册 3 个属性，<code>components/filters/directives</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/global-api/assets.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initAssetRegisters</span>(<span class="params">Vue: GlobalAPI</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Create asset registration methods.</span></span><br><span class="line"><span class="comment">   * ASSET_TYPES = [ 'component', 'directive', 'filter' ]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ASSET_TYPES.forEach(<span class="function">(<span class="params">type</span>) =&gt;</span> &#123;</span><br><span class="line">    Vue[type] = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      id: string,</span></span></span><br><span class="line"><span class="function"><span class="params">      definition: Function | Object</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>): <span class="title">Function</span> | <span class="title">Object</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!definition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.options[type + <span class="string">"s"</span>][id];</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp; type === <span class="string">"component"</span>) &#123;</span><br><span class="line">          validateComponentName(id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">"component"</span> &amp;&amp; isPlainObject(definition)) &#123;</span><br><span class="line">          definition.name = definition.name || id;</span><br><span class="line">          definition = <span class="keyword">this</span>.options._base.extend(definition);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">"directive"</span> &amp;&amp; <span class="keyword">typeof</span> definition === <span class="string">"function"</span>) &#123;</span><br><span class="line">          definition = &#123; <span class="attr">bind</span>: definition, <span class="attr">update</span>: definition &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.options[type + <span class="string">"s"</span>][id] = definition;</span><br><span class="line">        <span class="keyword">return</span> definition;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看源码脑壳疼的地方就是，即便是简单的功能，但为了全面考虑，看起来就感觉多了一层窗户纸，模模糊糊的，上面的内容简化下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// component简写为cp</span></span><br><span class="line">Vue.components = <span class="function"><span class="keyword">function</span> (<span class="params">cpName, cpOptions</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 确保component上面有name属性</span></span><br><span class="line">  cpOptions.name = cpOptions.name | cpName;</span><br><span class="line">  <span class="comment">// Vue.extend其实将cpOptions变成一个Vue的子类.</span></span><br><span class="line">  <span class="keyword">const</span> cpClass = Vue.extend(cpOptions);</span><br><span class="line">  <span class="comment">// 所以全局组件一定在Vue.options.components里</span></span><br><span class="line">  Vue.options.components[cpName] = cpClass;</span><br><span class="line">  <span class="keyword">return</span> cpClass;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue.extend其实将cpOptions变成一个Vue的子类,简化下代码如下</span></span><br><span class="line">Vue.extend = <span class="function"><span class="keyword">function</span> (<span class="params">cpOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Sub = <span class="function"><span class="keyword">function</span> <span class="title">VueComponent</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._init(options);</span><br><span class="line">  &#125;;</span><br><span class="line">  Sub.prototype = <span class="built_in">Object</span>.create(Vue.prototype);</span><br><span class="line">  <span class="comment">// 不同的字段合并策略不一样</span></span><br><span class="line">  Sub.options = mergeOptions(Vue.options, cpOptions);</span><br><span class="line">  <span class="keyword">return</span> Sub;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>Vue.options.components[cpName] = cpClass</code>可以看到，全局组件都在<code>Vue.options.components</code>，组件名和组件类一一对应，这样使用组件的时候，就直接调出相应的组件类了。</p>
<h2 id="使用全局组件"><a href="#使用全局组件" class="headerlink" title="使用全局组件"></a>使用全局组件</h2><p>组件类的<code>options</code>上已经合并了<code>Vue.options</code>，而在组件实例化的阶段，会再次执行<code>mergeOptions</code>的操作，将<code>VueComponent.options.components</code>合并到<code>vm.$options.components</code>。</p>
<p>然后在创建 <code>vnode</code> 的过程中，会执行 <code>_createElement</code> 方法，我们再来回顾一下这部分的逻辑，它的定义在 <code>src/core/vdom/create-element.js</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">_createElement</span> (<span class="params"> context: Component, tag?: string | Class&lt;Component&gt; | Function | Object, data?: VNodeData, children?: any, normalizationType?: number </span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">let</span> vnode, ns</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> Ctor</span><br><span class="line">    <span class="keyword">if</span> (isDef(Ctor = resolveAsset(context.$options, <span class="string">'components'</span>, tag))) &#123;</span><br><span class="line">      <span class="comment">// component</span></span><br><span class="line">      vnode = createComponent(Ctor, data, context, children, tag)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看到，根据 tag，然后在<code>options.components</code>里找到相应的<code>Ctor</code>，然后再创建<code>组件的vnode</code><br><code>resolveAsset</code>就是根据 <code>tag</code> 找到<code>Ctor</code> 的方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/utils/options.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveAsset</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  options: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  type: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  id: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  warnMissing?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// type就是 是components 还是 filters之类的</span></span><br><span class="line">  <span class="keyword">const</span> assets = options[type];</span><br><span class="line">  <span class="comment">// id其实这边指的是组件名，或者说是组件的tag也行</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(assets, id)) <span class="keyword">return</span> assets[id];</span><br><span class="line">  <span class="keyword">const</span> camelizedId = camelize(id);</span><br><span class="line">  <span class="comment">// 驼峰的形式</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(assets, camelizedId)) <span class="keyword">return</span> assets[camelizedId];</span><br><span class="line">  <span class="comment">// 首字母大写的形式</span></span><br><span class="line">  <span class="keyword">const</span> PascalCaseId = capitalize(camelizedId);</span><br><span class="line">  <span class="comment">// 连字符的形式</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(assets, PascalCaseId)) <span class="keyword">return</span> assets[PascalCaseId];</span><br><span class="line">  <span class="comment">// fallback to prototype chain</span></span><br><span class="line">  <span class="keyword">const</span> res = assets[id] || assets[camelizedId] || assets[PascalCaseId];</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp; warnMissing &amp;&amp; !res) &#123;</span><br><span class="line">    warn(<span class="string">"Failed to resolve "</span> + type.slice(<span class="number">0</span>, <span class="number">-1</span>) + <span class="string">": "</span> + id, options);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里先用<code>id</code>找，不行就驼峰式<code>id</code>找，首字母大写找，连字符找，所以<code>id</code>形式三种形式都行，找到就返回<code>Ctor</code></p>
<h2 id="注册局部组件"><a href="#注册局部组件" class="headerlink" title="注册局部组件"></a>注册局部组件</h2><p>注册局部组件，其实就是在当前组件的options里加上<code>components:{hello}</code>，而<code>mergeOptions</code>的时候肯定被合并到<code>vm.$options.components</code>上，组件实例化的时候，依旧通过<code>resolveAsset</code>拿到对应的<code>Ctor</code></p>
<p>当然局部组件，只能在组件内才能使用组件。<br>全局组件之所以能被所有的组件使用，是因为组件实例化的时候，<code>Vue.options.components</code>会被合并到<code>vm.$options.components</code>。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码解密课程</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/components/component-register.html#%E5%85%A8%E5%B1%80%E6%B3%A8%E5%86%8C" target="_blank" rel="noopener">vue.js 技术揭秘</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/26/vue_4_source_code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/26/vue_4_source_code/" itemprop="url">
                  组件化_合并配置 - 学习vue源码系列 3-2
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-26T20:14:34+08:00">
                2021-07-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/26/vue_4_source_code/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/26/vue_4_source_code/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>决定跟着<a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码课程</a>好好学习下<code>vue2</code>的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~</p>
<p>将<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue 的源码</a>clone 到本地，切换到分支<code>2.6</code>。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>组件化渲染的那块，我个人觉得挺复杂的，我还没有捋顺，我决定先往后看，看完整体，再来磕硬骨头。</p>
<p>其实 vue 也有点配置为王的感觉，它的配置就是<code>options</code>。</p>
<p>后期组件的各种相关操作，都围绕<code>options</code>展开。</p>
<p>本篇着重看看，<code>vue</code>是怎么处理<code>options</code>的，最最重点的是，怎么合并各个<code>options</code>的。</p>
<!-- new Vue 和子组件初始化的时候
  外部调用场景的配置合并
  组件场景的配置合并
 -->
<h2 id="先看-demo"><a href="#先看-demo" class="headerlink" title="先看 demo"></a>先看 demo</h2><p>尝试先自己想想，这些钩子函数里的这些打印顺序如何。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/Users/zhm/mygit/vue/dist/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  const log = console.log;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 全局mixin</span></span><br><span class="line"><span class="undefined">  Vue.mixin(&#123;</span></span><br><span class="line"><span class="undefined">    created() &#123;</span></span><br><span class="line"><span class="undefined">      log("mixin created");</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 子组件实例</span></span><br><span class="line"><span class="undefined">  let childCompInstance = null;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 子组件</span></span><br><span class="line"><span class="undefined">  let childComp = &#123;</span></span><br><span class="line"><span class="undefined">    name: "MSG",</span></span><br><span class="line"><span class="xml">    template: "<span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>",</span></span><br><span class="line"><span class="undefined">    created() &#123;</span></span><br><span class="line"><span class="undefined">      childCompInstance = this;</span></span><br><span class="line"><span class="undefined">      log("child created");</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    data: () =&gt; (&#123; msg: "Hello Vue" &#125;),</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 根组件实例</span></span><br><span class="line"><span class="undefined">  let vueInstance = new Vue(&#123;</span></span><br><span class="line"><span class="undefined">    el: "#app",</span></span><br><span class="line"><span class="undefined">    created() &#123;</span></span><br><span class="line"><span class="undefined">      log("parent created");</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    render: (h) =&gt; h(childComp),</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  log("Vue构造器上的options", Vue.options);</span></span><br><span class="line"><span class="undefined">  log("Vue实例的options", vueInstance, vueInstance.$options);</span></span><br><span class="line"><span class="undefined">  log(</span></span><br><span class="line"><span class="undefined">    "VueComponent实例的options",</span></span><br><span class="line"><span class="undefined">    childCompInstance,</span></span><br><span class="line"><span class="undefined">    childCompInstance.$options,</span></span><br><span class="line"><span class="undefined">    childCompInstance.$options.__proto__</span></span><br><span class="line"><span class="undefined">  );</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>公布答案：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mixin created</span><br><span class="line">parent created</span><br><span class="line">mixin created</span><br><span class="line">child created</span><br></pre></td></tr></table></figure>
<p>其实定义在 Vue 的 mixin 里的<code>options</code>，会合并<code>Vue</code>构造器的的<code>options</code>里面。</p>
<p>用构造器创建实例的时候，构造器上面的<code>options</code>会和实例的<code>options</code>再次合并。</p>
<p>组件构造器是 Vue 的子类，合并的时候，主要的<code>options</code>在<code>childCompInstance.$options.__proto__</code>里。</p>
<p>看下，例子里后面的打印：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_3_21.png" alt="vue_3_21"></p>
<h2 id="Vue-mixin-和-Vue-构造器的-options-合并"><a href="#Vue-mixin-和-Vue-构造器的-options-合并" class="headerlink" title="Vue.mixin 和 Vue 构造器的 options 合并"></a>Vue.mixin 和 Vue 构造器的 options 合并</h2><p>先说下<code>Vue.mixin</code>是个函数，其传入的<code>options</code>，首先和 Vue 构造器上面的<code>options</code>合并。</p>
<p><code>Vue.mixin</code>执行之后，Vue 构造器上面的<code>options</code>就有了其对应的值。</p>
<p>先来个超简单的示意：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** vue源码 开始 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">Vue.options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将两个options合并成一个options</span></span><br><span class="line"><span class="keyword">const</span> mergeOptions = <span class="function">(<span class="params">parentOptions, childOptions</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> options = &#123;&#125;;</span><br><span class="line">  <span class="comment">// 生命周期的钩子合并的时候都是数组</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> childOptions) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">"created"</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> parentCreated = <span class="built_in">Array</span>.isArray(parentOptions.created)</span><br><span class="line">        ? parentOptions.created</span><br><span class="line">        : parentOptions.created</span><br><span class="line">        ? [parentOptions.created]</span><br><span class="line">        : [];</span><br><span class="line">      <span class="keyword">const</span> childCreated = <span class="built_in">Array</span>.isArray(childOptions.created)</span><br><span class="line">        ? childOptions.created</span><br><span class="line">        : [childOptions.created];</span><br><span class="line">      options.created = [...parentCreated, ...childCreated];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options;</span><br><span class="line">&#125;;</span><br><span class="line">Vue.mixin = <span class="function"><span class="keyword">function</span> <span class="title">mixin</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.options = mergeOptions(Vue.options, options);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** vue源码 结束 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用的例子</span></span><br><span class="line">Vue.mixin(&#123;</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"mixin created"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// &#123;created:[x]&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(Vue.options);</span><br></pre></td></tr></table></figure>
<p>总的来说就是做着上面的事情，然后看 vue 的真正源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/global-api/mixin.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initMixin</span>(<span class="params">Vue: GlobalAPI</span>) </span>&#123;</span><br><span class="line">  Vue.mixin = <span class="function"><span class="keyword">function</span> (<span class="params">mixin: Object</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// mixin就是&#123; created()&#123;&#125; &#125;, this指的是Vue构造器，因为使用的时候是Vue.mixin</span></span><br><span class="line">    <span class="keyword">this</span>.options = mergeOptions(<span class="keyword">this</span>.options, mixin);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/util/options.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeOptions</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  child: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="comment">// parent就是Vue构造器的options,child就是&#123; created()&#123;&#125; &#125;</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span>) &#123;</span><br><span class="line">    checkComponents(child);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> child === <span class="string">"function"</span>) &#123;</span><br><span class="line">    child = child.options;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  normalizeProps(child, vm);</span><br><span class="line">  normalizeInject(child, vm);</span><br><span class="line">  normalizeDirectives(child);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Apply extends and mixins on the child options,</span></span><br><span class="line">  <span class="comment">// but only if it is a raw options object that isn't</span></span><br><span class="line">  <span class="comment">// the result of another mergeOptions call.</span></span><br><span class="line">  <span class="comment">// Only merged options has the _base property.</span></span><br><span class="line">  <span class="keyword">if</span> (!child._base) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.extends) &#123;</span><br><span class="line">      parent = mergeOptions(parent, child.extends, vm);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (child.mixins) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">        parent = mergeOptions(parent, child.mixins[i], vm);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = &#123;&#125;;</span><br><span class="line">  <span class="keyword">let</span> key;</span><br><span class="line">  <span class="comment">// parent就是Vue构造器上面的options，key就是每项键，key不一样合并的策略不一样，先处理parent</span></span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> parent) &#123;</span><br><span class="line">    mergeField(key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// child就是 &#123; created()&#123;&#125; &#125;，在处理child里的（parent没有的）key</span></span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasOwn(parent, key)) &#123;</span><br><span class="line">      mergeField(key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mergeField</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> strat = strats[key] || defaultStrat;</span><br><span class="line">    options[key] = strat(parent[key], child[key], vm, key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Vue-实例的时候"><a href="#Vue-实例的时候" class="headerlink" title="Vue 实例的时候"></a>Vue 实例的时候</h2><p>Vue 构造器上面的<code>options</code>会和实例里参数<code>options</code>合并。<br>当然合并的逻辑是相似的。<br>拿这个例子来说，会变成<code>created:[fn1,fn2]</code>，注意构造器的在前面，参数的在后面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// options就是类似例子的&#123;el:'#app',....&#125;</span></span><br><span class="line">Vue.prototype._init = <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> vm = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 将各种选项合并,合并之后就是&#123;created:[fn1,fn2]&#125;</span></span><br><span class="line">  vm.$options = mergeOptions(</span><br><span class="line">    <span class="comment">// 这里vm.constructor就是Vue,Vue.options&#123;created:[fn1]&#125;</span></span><br><span class="line">    resolveConstructorOptions(vm.constructor),</span><br><span class="line">    <span class="comment">// &#123;created:fn2&#125;</span></span><br><span class="line">    options || &#123;&#125;,</span><br><span class="line">    vm</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里可以简单看下Vue上面的静态属性options</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ASSET_TYPES = [</span><br><span class="line">  <span class="string">'component'</span>,</span><br><span class="line">  <span class="string">'directive'</span>,</span><br><span class="line">  <span class="string">'filter'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initGlobalAPI</span> (<span class="params">Vue: GlobalAPI</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  Vue.options = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  ASSET_TYPES.forEach(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">    Vue.options[type + <span class="string">'s'</span>] = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// this is used to identify the "base" constructor to extend all plain-object</span></span><br><span class="line">  <span class="comment">// components with in Weex's multi-instance scenarios.</span></span><br><span class="line">  Vue.options._base = Vue</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将内置组件扩展到Vue.options.components上，keepAlive transition</span></span><br><span class="line">  extend(Vue.options.components, builtInComponents)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Vue组件实例的时候"><a href="#Vue组件实例的时候" class="headerlink" title="Vue组件实例的时候"></a>Vue组件实例的时候</h2><p>由于组件的构造函数是通过<code>Vue.extend</code>继承自<code>Vue</code>的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Vue.extend = <span class="function"><span class="keyword">function</span> (<span class="params">extendOptions: Object</span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  Sub.options = mergeOptions(</span><br><span class="line">    Super.options,</span><br><span class="line">    extendOptions</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// keep a reference to the super options at extension time.</span></span><br><span class="line">  <span class="comment">// later at instantiation we can check if Super's options have</span></span><br><span class="line">  <span class="comment">// been updated.</span></span><br><span class="line">  Sub.superOptions = Super.options</span><br><span class="line">  Sub.extendOptions = extendOptions</span><br><span class="line">  Sub.sealedOptions = extend(&#123;&#125;, Sub.options)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> Sub</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很显然，组件类的<code>options</code>是组件对象和<code>Vue</code>的<code>options</code>合并的。</p>
<p>组件初始化的时候，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// options有以下属性</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createComponentInstanceForVnode</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vnode: any, <span class="regexp">//</span> we know it<span class="string">'s MountedComponentVNode but flow doesn'</span>t</span></span></span><br><span class="line"><span class="function"><span class="params">  parent: any, <span class="regexp">//</span> activeInstance in lifecycle state</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options: InternalComponentOptions = &#123;</span><br><span class="line">    _isComponent: <span class="literal">true</span>,</span><br><span class="line">    _parentVnode: vnode,</span><br><span class="line">    parent</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> vnode.componentOptions.Ctor(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>vnode.componentOptions.Ctor</code> 就是指向 <code>Vue.extend</code> 的返回值 <code>Sub</code>。执行<code>new</code>的话，就会再次执行<code>this._init(options)</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initInternalComponent</span> (<span class="params">vm: Component, options: InternalComponentOptions</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 组件类的options和Vue类的options并不相同。</span></span><br><span class="line">  <span class="keyword">const</span> opts = vm.$options = <span class="built_in">Object</span>.create(vm.constructor.options)</span><br><span class="line">  <span class="comment">// doing this because it's faster than dynamic enumeration.</span></span><br><span class="line">  <span class="keyword">const</span> parentVnode = options._parentVnode</span><br><span class="line">  opts.parent = options.parent</span><br><span class="line">  opts._parentVnode = parentVnode</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> vnodeComponentOptions = parentVnode.componentOptions</span><br><span class="line">  opts.propsData = vnodeComponentOptions.propsData</span><br><span class="line">  opts._parentListeners = vnodeComponentOptions.listeners</span><br><span class="line">  opts._renderChildren = vnodeComponentOptions.children</span><br><span class="line">  opts._componentTag = vnodeComponentOptions.tag</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.render) &#123;</span><br><span class="line">    opts.render = options.render</span><br><span class="line">    opts.staticRenderFns = options.staticRenderFns</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>initInternalComponent</code> 方法执行，相当于 <code>vm.$options = Object.create(Sub.options)</code>。<br>此时，<code>vm.$options</code>如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vm.$options = &#123;</span><br><span class="line">  parent: Vue <span class="comment">/*父Vue实例*/</span>,</span><br><span class="line">  propsData: <span class="literal">undefined</span>,</span><br><span class="line">  _componentTag: <span class="literal">undefined</span>,</span><br><span class="line">  _parentVnode: VNode <span class="comment">/*父VNode实例*/</span>,</span><br><span class="line">  _renderChildren:<span class="literal">undefined</span>,</span><br><span class="line">  __proto__: &#123;</span><br><span class="line">    components: &#123; &#125;,</span><br><span class="line">    directives: &#123; &#125;,</span><br><span class="line">    filters: &#123; &#125;,</span><br><span class="line">    _base: <span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    _Ctor: &#123;&#125;,</span><br><span class="line">    created: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">created</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'parent created'</span>)</span><br><span class="line">      &#125;, <span class="function"><span class="keyword">function</span> <span class="title">created</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'child created'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    mounted: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">mounted</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'child mounted'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    data() &#123;</span><br><span class="line">       <span class="keyword">return</span> &#123;</span><br><span class="line">         msg: <span class="string">'Hello Vue'</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    template: <span class="string">'&lt;div&gt;&#123;&#123;msg&#125;&#125;&lt;/div&gt;'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="走一遍看看调试"><a href="#走一遍看看调试" class="headerlink" title="走一遍看看调试"></a>走一遍看看调试</h2><p>在<code>vue.js</code>3处打个断点：</p>
<ul>
<li><code>Vue.mixin</code>打个断点</li>
<li><code>Vue.prototype._init</code>里<code>options</code>处打个断点</li>
<li><code>function mergeOptions</code>打个断点</li>
</ul>
<p>先看看mixin:</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code12.gif" alt="vue_source_code12.gif"></p>
<p><code>Vue.mixin</code>之后，Vue的options合并了<code>Vue.mixin</code>的参数，变成这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  components: &#123;&#125;</span><br><span class="line">  created: [ƒ]</span><br><span class="line">  directives: &#123;&#125;</span><br><span class="line">  filters: &#123;&#125;</span><br><span class="line">  _base: ƒ Vue(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>new Vue(options)</code>会再和<code>Vue的options</code>合并，<code>VueComponent</code>的<code>options</code>也会和<code>Vue的options</code>合并：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code13.gif" alt="vue_source_code13.gif"></p>
<p>vue实例的<code>$options</code>是用户传的<code>options</code>和<code>Vue</code>的<code>options</code>的合并，此时vue实例的<code>$options</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  components: &#123;&#125;</span><br><span class="line">  created: (<span class="number">2</span>) [ƒ, ƒ]</span><br><span class="line">  directives: &#123;&#125;</span><br><span class="line">  el: <span class="string">"#app"</span></span><br><span class="line">  filters: &#123;&#125;</span><br><span class="line">  render: <span class="function">(<span class="params">h</span>) =&gt;</span> h(childComp)</span><br><span class="line">  _base: ƒ Vue(options)</span><br><span class="line">  _isVue: <span class="literal">true</span></span><br><span class="line">  _uid: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VueComponent组件实例的options是和Vue的options合并：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code14.gif" alt="vue_source_code14.gif"></p>
<p>显然组件的合并是先走了<code>Vue.extend</code>，然后走了<code>initInternalComponent</code>，最后，组件实例的options就是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">_proto__:&#123;</span><br><span class="line">  components: &#123;<span class="attr">MSG</span>: ƒ&#125;</span><br><span class="line">  created: (<span class="number">2</span>) [ƒ, ƒ]</span><br><span class="line">  data: <span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">msg</span>: <span class="string">"Hello Vue"</span> &#125;)</span><br><span class="line">  directives: &#123;&#125;</span><br><span class="line">  filters: &#123;&#125;</span><br><span class="line">  name: <span class="string">"MSG"</span></span><br><span class="line">  template: <span class="string">"&lt;div&gt;&#123;&#123;msg&#125;&#125;&lt;/div&gt;"</span></span><br><span class="line">  _Ctor: &#123;<span class="number">0</span>: ƒ&#125;</span><br><span class="line">&#125;</span><br><span class="line">parent: Vue &#123;<span class="attr">_uid</span>: <span class="number">0</span>, <span class="attr">_isVue</span>: <span class="literal">true</span>, <span class="attr">$options</span>: &#123;…&#125;, <span class="attr">_renderProxy</span>: <span class="built_in">Proxy</span>, <span class="attr">_self</span>: Vue, …&#125;</span><br><span class="line">propsData: <span class="literal">undefined</span></span><br><span class="line">render: ƒ anonymous( )</span><br><span class="line">staticRenderFns: []</span><br><span class="line">_componentTag: <span class="literal">undefined</span></span><br><span class="line">_parentListeners: <span class="literal">undefined</span></span><br><span class="line">_parentVnode: VNode &#123;<span class="attr">tag</span>: <span class="string">"vue-component-1-MSG"</span>, <span class="attr">data</span>: &#123;…&#125;, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: div, …&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Vue 初始化阶段对于 options 的合并有 2 种方式：</p>
<ul>
<li>外部初始化 Vue 通过 <code>mergeOptions</code> 的过程，合并完的结果保留在 <code>vm.$options</code> 中。</li>
<li>子组件初始化过程通过 <code>initInternalComponent</code> 方式，比<code>mergeOptions</code>的方式要快</li>
</ul>
<p>纵观一些库、框架的设计几乎都是类似的，</p>
<ul>
<li>自身<strong>先</strong>定义了一些默认配置，</li>
<li>同时又可以在<strong>初始化</strong>阶段传入一些自定义配置，</li>
<li>然后 <code>merge</code>配置，来达到定制化不同需求的目的。</li>
</ul>
<!--

## 英语



conclude - conclusion
decide - decision
convert - conversion
permit - permission
admit - admission

eat - ed/es

obese - ob(过多)+ es(吃)
edible = ed(吃) + ible(able能)

- aoeiuy 元音等价
- s d t 等价
- pro 前缀表示 forward  （动态）
- pre 前缀表示 在前面 提前 （静态）
- or ur er ar 后缀 是名词 表示 东西 人（or 机、器、）
- ion 后缀表示 一群人
- 词根后面 后缀前面 经常 是 u/ul/o 连接符 （方便发音更顺滑）
- ate ite ute 动词后缀表示 使...v  形容词后缀  （极少）名词后缀 表示人
- under 表示 未达到 下
- in 进
- axx一般ax就是前缀
- ag a 前缀表示 to 或者 加强语气（想象 啊）
- ent ant 名词后缀 表示人或物；形容词后缀 表示 的
- un 表示 否定前缀
- ed 表示有过的
- ance ence ancy ency后缀 只是表示名词
- prior 优先
- ory 名词后缀
- re 表示 相反、返回回来、反复 又 再
- ex e es 表示 向外 出去 超出
- ive 形容词后缀 表示过大的 过多的  也有直接 的  名词后缀 人或者物
- eas 表示 尽头



- cess ceed grad gred gress后缀表示 to go  走

process  n.进程 过程 v.加工 处理   （一步步向前走 想象流水线，想象向目标前进）
processor n.处理器
procession n.队伍、行列、一行、一列、列队前进
graduate n.本科毕业生 v.毕业
undergraduate n.本科肄业生 本科在读生
ingredient n.原料 要素 组成部分
aggressive adj. 侵略性的 激进的
aggress v.侵略（强行走进去）
aggression n.侵略
progress v/n. 进步 前进 进展
proceed v.前进 继续走

COCA 当代语料库20000词汇  数字越小单词越频繁


progress/process/proceed

progress 向前走 进步前进
process 过程
proceed 向前继续（不停） 活动事情继续做 诉讼
procession 一群人向前走

proceedings n.诉讼 活动

procedure n.程序 步骤

precede v.领先 优先

precedent n.先前的 有先例的
president n.总统 主席
unprecedented adj. 史无前例的
precedence n.优先 居先  （同义词）priority n.优先权 优先
access v.接近 进入 获取 使用
accessible adj.可接近的、可使用的、可获得的、平易近人的
accessory n.配件 附件 从犯 （和主要的东西走在一起的 各种从 文件从 穿搭从 犯罪从）
recession n.衰退（经济）后退 不景气
recede v.往回走 回退 后退 撤退
excessive adj. 过度的
excess n.过度 过度（走过线了 ） 过度的 过量的
exceed vt 超过 胜出
（process proceed）

exceedingly adv.极其地
cease (cess) v.走了（彻底的）、停止、终结 -->
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码解密课程</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/data-driven/" target="_blank" rel="noopener">vue.js 技术揭秘</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/08/doctor_eat_how/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/08/doctor_eat_how/" itemprop="url">
                  如何给儿童选择合适的药物？怎么处理喂药困难
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-08T15:28:13+08:00">
                2021-07-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/baby/" itemprop="url" rel="index">
                    <span itemprop="name">baby</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/08/doctor_eat_how/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/08/doctor_eat_how/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近看知贝的课程，总结下学到的东西，以下图片均来自知贝。</p>
<p>药进入人体有三个过程：吸收、分布、代谢、排泄（ADME）。<br>儿童和成人的过程时间不一样，吸收更强，排泄更慢，所以用药和成人绝不只是缩小版这么简单。</p>
<h2 id="选择成分单一的药物"><a href="#选择成分单一的药物" class="headerlink" title="选择成分单一的药物"></a>选择成分单一的药物</h2><p>不要选择成分复杂的药物。</p>
<p>选择成分单一的药物。有啥症状，用啥药。</p>
<h2 id="怎么选择药物的形状"><a href="#怎么选择药物的形状" class="headerlink" title="怎么选择药物的形状"></a>怎么选择药物的形状</h2><p>药的形状选择：滴剂、粉剂、栓剂、颗粒剂、混悬剂。<br>不要<strong>片状</strong>、胶囊状！<br>切忌不能吃<strong>泡腾片</strong>，那是泡在水里的！</p>
<h2 id="怎么喂药"><a href="#怎么喂药" class="headerlink" title="怎么喂药"></a>怎么喂药</h2><p>喂药的方法：</p>
<ul>
<li><p>颗粒剂：比如奥司他韦颗粒，孟鲁司特颗粒，可以将药物混在食物、果酱、牛奶中。</p>
</li>
<li><p>液体剂：比如美林、泰诺林，可以混在上述食物中。西替利嗪滴剂略有一点苦味，可以混入牛奶或增加甜味再给宝宝吃。</p>
</li>
<li><p>如果在没有口服用药条件或者宝宝拒绝服药的时候，可以考虑更换<strong>栓剂</strong>。</p>
</li>
<li><p>雾化药物，如果宝宝实在不配合，可以在宝宝睡着的时候进行雾化，睡着状态下的雾化效率比哭闹时更高。</p>
</li>
</ul>
<h2 id="吃吐的话，怎么补服"><a href="#吃吐的话，怎么补服" class="headerlink" title="吃吐的话，怎么补服"></a>吃吐的话，怎么补服</h2><p>吃吐的话</p>
<ul>
<li>15min以内，服同等剂量</li>
<li>15-60min以内，如果看到药物，则补服</li>
<li>60min以外，不需要补服</li>
</ul>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://appe3xm9tbf9157.h5.xiaoeknow.com/v1/course/audio/a_5e7c178f02c21_HDTBtNgu?type=2&amp;pro_id=p_5e842f077c849_COgOOGN4" target="_blank" rel="noopener">知贝</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/07/doctor_kit_medical/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/07/doctor_kit_medical/" itemprop="url">
                  家庭药箱准备什么
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-07T20:24:34+08:00">
                2021-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/baby/" itemprop="url" rel="index">
                    <span itemprop="name">baby</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/07/doctor_kit_medical/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/07/doctor_kit_medical/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor16.png" alt="doctor16"></p>
<p>最近看知贝的课程，总结下学到的东西，以下图片均来自知贝。</p>
<h2 id="家庭消毒防护用品"><a href="#家庭消毒防护用品" class="headerlink" title="家庭消毒防护用品"></a>家庭消毒防护用品</h2><ul>
<li>60%以上乙醇的免洗洗手液</li>
<li>湿纸巾</li>
<li>医用外科口罩</li>
</ul>
<h2 id="外伤急救用品"><a href="#外伤急救用品" class="headerlink" title="外伤急救用品"></a>外伤急救用品</h2><ul>
<li>碘伏棉签：消毒</li>
<li>纱布：包扎、固定、按压</li>
<li>人工皮亲水辅料：擦伤、破皮、烫伤的伤口敷裹（3M）</li>
</ul>
<h2 id="发热处理"><a href="#发热处理" class="headerlink" title="发热处理"></a>发热处理</h2><ul>
<li>耳温枪：测温</li>
<li>解热镇痛药：布洛芬（6m+）、对乙酰氨基酚（3m+）</li>
</ul>
<p>成人可以选择：芬必得、必理通<br>孩子选择：美林、泰诺，悬浮液和滴剂都行</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/meilin.png" alt="meilin"></p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/tainuo.jpg" alt="tainuo"></p>
<h2 id="流鼻涕"><a href="#流鼻涕" class="headerlink" title="流鼻涕"></a>流鼻涕</h2><p>生理学海盐水喷鼻剂/电动洗鼻器：当鼻腔结痂、分泌物增多时，湿润、冲洗鼻腔，稀释、清理分泌物。  </p>
<p>使用方法：每侧喷入2~5 喷后，擤鼻涕，每日 2~5 次，根据分泌物及固痂块多少情况，按需使用</p>
<p>注意事项：喷嘴不要对准鼻中隔，而是要对准鼻翼两侧，减少对鼻中隔的刺激</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/wash_nose.png" alt="wash_nose"></p>
<h2 id="腹泻用药"><a href="#腹泻用药" class="headerlink" title="腹泻用药"></a>腹泻用药</h2><ul>
<li>口服补液盐Ⅲ（博叶）：补液盐可以作为腹泻时脱水的预防和治疗。 </li>
</ul>
<p>建议不要丢弃包装和里面的量杯，方便准确冲泡和喂服，一次性配好一袋（250ml 水 + 一袋补液盐），不要把一袋分开配，配好的补液盐室温可以留存 24 小时。</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor10.png" alt="doctor10"></p>
<h2 id="过敏用药"><a href="#过敏用药" class="headerlink" title="过敏用药"></a>过敏用药</h2><ul>
<li>盐酸西替利嗪滴剂：一般用于全身过敏症状，目前国内有<strong>仙特明、澳博达、杰捷</strong>三个品牌。（左最好）</li>
</ul>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor11.png" alt="doctor11"></p>
<h2 id="湿疹、皮炎用药"><a href="#湿疹、皮炎用药" class="headerlink" title="湿疹、皮炎用药"></a>湿疹、皮炎用药</h2><p>皮疹（蚊虫叮咬、过敏都有可能引起皮疹）一般使用</p>
<ul>
<li><strong>地奈德乳膏、丁酸氢化可的松乳膏（尤卓尔）或 糠酸莫米松乳膏（艾洛松）</strong>：，轻症皮疹一般当天见效，严重的一般 1～2 周就见效，不见效去医院。</li>
</ul>
<p>先把手洗干净，挤出少许涂抹于患处，涂抹至肉眼不可见药物为止。</p>
<h2 id="便秘"><a href="#便秘" class="headerlink" title="便秘"></a>便秘</h2><ul>
<li>开塞露（一次用一支或者半支）</li>
<li>聚乙二醇：国内<strong>福松</strong></li>
</ul>
<h2 id="防晒霜"><a href="#防晒霜" class="headerlink" title="防晒霜"></a>防晒霜</h2><p>成分：<strong>氧化锌或二氧化钛</strong>的紫外线散射剂</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor12.png" alt="doctor12"></p>
<h2 id="驱蚊剂"><a href="#驱蚊剂" class="headerlink" title="驱蚊剂"></a>驱蚊剂</h2><p>主要含deet(30%以内)，浓度越高，时间越长。</p>
<p>不能吃，大人涂在小孩的裸露皮肤上。</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor13.png" alt="doctor13"></p>
<h2 id="服药时间"><a href="#服药时间" class="headerlink" title="服药时间"></a>服药时间</h2><p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor14.png" alt="doctor14"></p>
<h2 id="药物有效期"><a href="#药物有效期" class="headerlink" title="药物有效期"></a>药物有效期</h2><p>开封的话：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor15.png" alt="doctor15"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/06/kasel_summer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/06/kasel_summer/" itemprop="url">
                  未命名
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-06T10:57:25+08:00">
                2021-07-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/06/kasel_summer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/06/kasel_summer/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="心得"><a href="#心得" class="headerlink" title="心得"></a>心得</h1><p>我刚开始认为，共情是一件很容易的事情。不就是感受别人的心情嘛，这有啥，但进入课程才发现，其实共情本身也是技能，也需要修炼，我以为的共情是极其浅显的，真正的共情是温暖的。</p>
<p>共情，主要从四个层面，可以慢慢来，也许开始的时候，只能到达其中的某些层面，但没关系，有方向在，一定会越来越好的！</p>
<p>四个层面，我理解的是：</p>
<ul>
<li>从他人的认知层面</li>
<li>感受他人的情感层面</li>
<li>正确说出其感受层面</li>
<li>解决方案层面</li>
</ul>
<p>对应的五个步骤就是：</p>
<ul>
<li>停</li>
<li>看</li>
<li>听</li>
<li>说</li>
<li>做</li>
</ul>
<h2 id="停"><a href="#停" class="headerlink" title="停"></a>停</h2><p>物理层面，要停下你手里的事情，表示接下来的时间和空间，都属于对方，让对方感受到尊重和支持</p>
<p>心理层面，放下心中的对方的偏见，放下对方身上的标签，这样听的事情，会更加的客观和真实，不被带偏</p>
<p>自我层面，这个是最难的，当别人说的时候，如果自己的情绪很激动，或者很气愤，是很难共情的，因为你的心中不是空的，很难装下别人的情绪，放空自己。先察觉自己的情绪，如果不冷静的话，找出情绪的原因，并且处理掉。等到自己的情绪放空，才能真正的感受他人的情绪。</p>
<p>例子里，妈妈回来，看见小宝哭，第一感觉就是责备大宝的例子，我印象挺深刻的，觉得这个场景经常出现。</p>
<p>或许之前很多次，的确是因为大宝让小宝哭了，但不能因此就觉得小宝每次哭就是因为大宝。</p>
<p>我们必须先放下自己对大宝的偏见，放下自我的情绪，必须知道事情的真相之后，才去做相应的方案。</p>
<h2 id="看和听"><a href="#看和听" class="headerlink" title="看和听"></a>看和听</h2><p>第一步，尽量做吧。然后才调动视觉和听觉，其实还有心觉。</p>
<p>看和听都是观察对方的一切。</p>
<p>和对方目光相对，让对方更有说的意愿。</p>
<p>观察对方的肢体行为，肢体语言表达的往往更能体现对方的清除。</p>
<p>听对方说的话，这里的听，不能听语言，还要听语调和语气，以及一些言外之意，隐晦之意。</p>
<p>注意，听的时候，尽管心里翻天覆地，但也必须听完，有时候，重点可能在最后。</p>
<h2 id="回应"><a href="#回应" class="headerlink" title="回应"></a>回应</h2><p>当对方已经表达完毕的时候，此时的回应也是极其重要的。</p>
<p>大部分情况下，在前两步之后，我们需要努力，觉察到其现在的心情和情绪，并且尽量推测情绪的原因，如果不能，就在说出情绪之后，询问，发生了什么事。</p>
<p>比如案例里，小朋友回家重重的摔门，爸爸最开始就问，怎么了，但这个还不够</p>
<p>如果说，爸爸感觉你现在很生气，是不是发生了什么事，我们喝点水先缓下，如果愿意的话，可以跟爸爸说说么</p>
<p>这样的话，孩子觉得被理解了，那么倾诉的愿意就会增强。</p>
<p>当然如果对方的心情很难过，有时候，大家心知肚明的时候，一个拥抱，往往更能安抚和温暖对方。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>情绪的产生总是有原因的。</p>
<p>知道原因之后，就去努力解决。</p>
<p>比如蛋糕坏了，换个角度思考，找出好的方面，从而减缓难过的心情。</p>
<p>比如考试分数不好，那就提高能力，下次考试就会变好。</p>
<p>积极的解决问题，这样情绪才能被很好的释放。</p>
<h2 id="注意点：焦点在目标"><a href="#注意点：焦点在目标" class="headerlink" title="注意点：焦点在目标"></a>注意点：焦点在目标</h2><p>还有个注意点，共情的目标是对方，而不是对方说的其他人和其他事，这个很容易走偏。</p>
<p>案例里，小朋友说，父母吵架了。</p>
<p>当时我的第一反应是，父母为什么吵架了。其实这是不对的，搞错了共情目标。焦点是小朋友，父母吵架了，小朋友什么感受，怎么缓解小朋友的情绪。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>路漫漫其修远兮，吾将上下而求索。<br>会反复看视频。<br>共情也会一直一直继续。<br>愿人人都能被真正倾听，被真正共情。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/06/doctor_medicine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/06/doctor_medicine/" itemprop="url">
                  药品的基础知识
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-06T10:53:37+08:00">
                2021-07-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/baby/" itemprop="url" rel="index">
                    <span itemprop="name">baby</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/06/doctor_medicine/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/06/doctor_medicine/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近看知贝的课程，总结下学到的东西，以下图片均来自知贝。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d851ec612458414e91c73418ba1b82a6~tplv-k3u1fbpfcp-zoom-1.image" alt="doctor7"></p>
<h2 id="区分：药品和非药品"><a href="#区分：药品和非药品" class="headerlink" title="区分：药品和非药品"></a>区分：药品和非药品</h2><p>卫生许可证号里的：<strong>消</strong>字号和<strong>妆</strong>字号 <strong>不是</strong>药品，前者是消毒卫生，后者是化妆品</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b0225f8a07b486fb6bb4ce8e8d4ca92~tplv-k3u1fbpfcp-zoom-1.image" alt="doctor1"></p>
<h2 id="区分：处方药和非处方药"><a href="#区分：处方药和非处方药" class="headerlink" title="区分：处方药和非处方药"></a>区分：处方药和非处方药</h2><p>处方药：需要医生或者医师的药方<br>非处方药：不需要，有<code>OTC</code>的标志。绿色的比红色的则更加安全和有效。  </p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b636201b66f49dbbf677dc774e05f17~tplv-k3u1fbpfcp-zoom-1.image" alt="doctor2"></p>
<h2 id="区分：西药和中成药"><a href="#区分：西药和中成药" class="headerlink" title="区分：西药和中成药"></a>区分：西药和中成药</h2><p>西药：一般从天然产物中提取，成分明确，结构单一，比如布洛芬、对乙酰氨基酚、青霉素<br>中成药：各种成分的混合物。比如消炎片是由野菊花、蒲公英等提取物混合制成  </p>
<p>主要通过国药准字号区分：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor3.png" alt="doctor3"></p>
<h2 id="避开：尚不明确的药"><a href="#避开：尚不明确的药" class="headerlink" title="避开：尚不明确的药"></a>避开：尚不明确的药</h2><p>不良反应那里，尚不明确是早期的时候，没有资源去实验，不代表副作用小。</p>
<p>所以尽量选择，不良反应，很明确的药</p>
<h2 id="区分：药品名字"><a href="#区分：药品名字" class="headerlink" title="区分：药品名字"></a>区分：药品名字</h2><p>有通用的药品名，一般字样很大。而不同的厂家，可以制作同样的药品，但属于不同厂家。但很多药，一般习惯要某个厂家的，比如美林的布洛芬。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5b1e1111633439989e2bb29b712846a~tplv-k3u1fbpfcp-zoom-1.image" alt="doctor5"></p>
<h2 id="区分：抗生素和消炎药"><a href="#区分：抗生素和消炎药" class="headerlink" title="区分：抗生素和消炎药"></a>区分：抗生素和消炎药</h2><p>抗生素：用来抑菌杀菌，比如xx霉素、xx西林、头孢xx、xx沙星、x硝唑等</p>
<p>消炎药：</p>
<ul>
<li>非甾体抗炎药，如阿司匹林、布洛芬、塞来昔布等；</li>
<li>甾体抗炎药，如地塞米松、泼尼松这种主要以「松」结尾的药</li>
</ul>
<p>炎症的功能：免疫系统处理有害刺激或者病原体的自我<strong>保护</strong>措施。</p>
<p>炎症的反应：红肿、发热、疼痛。</p>
<p>导致炎症的有害刺激：</p>
<ul>
<li>烫伤、冻伤、烧伤、过敏、自身免疫反应等；</li>
<li>病原体感染则包括细菌、病毒、真菌等引起的感染。</li>
</ul>
<p>只有确定或者高度怀疑是<strong>细菌感染</strong>，才能使用抗生素。</p>
<h2 id="药物半衰期（t1-2）"><a href="#药物半衰期（t1-2）" class="headerlink" title="药物半衰期（t1/2）"></a>药物半衰期（t1/2）</h2><p>药物半衰期：血液中药物浓度减低到1/2所需要的时间。</p>
<p>很短的话，不适合口服，一般输液、局部使用等<br>比较长的话，可以口服，减少用药的频次</p>
<p>这样保证血液中较长时间有药物存在。</p>
<p>当然哺乳期，半衰期短的药物更加安全。</p>
<h2 id="剂量是毒性的唯一标准"><a href="#剂量是毒性的唯一标准" class="headerlink" title="剂量是毒性的唯一标准"></a>剂量是毒性的唯一标准</h2><p>饭吃多都能撑死。</p>
<p>有些剂量小，也毒性很大。有些剂量大，但毒性小。</p>
<p>有些毒性进入人体很快就排泄掉。有些会累积，或致癌突变，如沙利度胺、利巴韦林等</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/01/hyper-script/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/01/hyper-script/" itemprop="url">
                  h函数为什么叫h？
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-01T19:05:34+08:00">
                2021-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/01/hyper-script/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/01/hyper-script/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>看 vue 源码的时候，提到了<code>snabbdom</code>，而这个库里有个很重要的函数<code>h</code>。</p>
<p>我就好奇了，为啥用<code>h</code>，<code>h</code>是什么的缩写，表示的到底是什么？</p>
<p>然后就翻到<code>hyperScript</code>这个词，然后找到了<a href="https://www.npmjs.com/package/hyperscript" target="_blank" rel="noopener">解释</a></p>
<blockquote>
<p>Create HyperText with JavaScript, on client or server</p>
</blockquote>
<p>而<code>html</code>是<code>HyperText Markup Language</code>的缩写，超文本标记语言，本质是文本，但用的是特殊的标记语言写的，其可以表示 纯文本和媒体资源、表单等其他的非文本，所以是超文本。</p>
<p>那么<code>hyperScript</code>其实是用 js 创建超文本，这里的超文本特指<code>HTML</code>，而 JS 里可以用<code>DOM</code>（document object model）表示<code>HTML</code>，但 js 本身是有<code>DOM API</code>的，为什么作者还要写这个库？</p>
<p>举个例子就明白了：</p>
<p>创建这样的结构:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"parent"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"son"</span>&gt;</span>颜酱真酷<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>传统的方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createDiv</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> span = <span class="built_in">document</span>.createElement(<span class="string">"span"</span>);</span><br><span class="line">  span.className = <span class="string">"son"</span>;</span><br><span class="line">  <span class="keyword">const</span> div = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">  div.className = <span class="string">"parent"</span>;</span><br><span class="line">  div.appendChild(span);</span><br><span class="line">  <span class="keyword">return</span> div;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然这还是结构简单，属性少的情况，如果很多的话，非常繁琐，而且可读性差。</p>
<p>于是想到了，用简单的语句描述，想要的 DOM 结构，然后用函数统一生成想要的结构</p>
<p>其实一个元素的三斧头：标签名、标签的其他自身信息、子元素</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hyperScript</span>(<span class="params">tagName, attrs, children</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> h = hyperScript;</span><br><span class="line"><span class="comment">// 这样执行这个方法就可以生成上面的div了</span></span><br><span class="line">h(<span class="string">"div"</span>, &#123; <span class="attr">className</span>: <span class="string">"parent"</span> &#125;, h(<span class="string">"span"</span>, &#123; <span class="attr">className</span>: <span class="string">"son"</span> &#125;, <span class="string">"颜酱真酷"</span>));</span><br></pre></td></tr></table></figure>
<p>这样可读性强很多，所以这个库的，<code>h函数</code>，是用节点的<strong>描述</strong>（标签名、属性和事件、子元素）去创建<strong>真实</strong>节点的，并返回这个真实节点。</p>
<p>但 <a href="https://github.com/snabbdom/snabbdom/tree/master/src" target="_blank" rel="noopener">snabbdom</a>这个库是处理<code>vnode</code>的，所以它的的<code>h函数</code>，是用节点的<strong>描述</strong>（标签名、标签的其他自身信息、子元素）创建<strong>虚拟</strong>节点的，并返回这个虚拟节点。</p>
<p>于是平时看到<strong>h 函数</strong>的时候，心里的联想是<code>Create Virtual HyperText with JavaScript</code>。 </p>
<p>大白话，h函数就是用节点的描述（标签名、标签的其他自身信息、子元素）创建虚拟节点。</p>
<h2 id="为什么有了-h-函数还要-vnode-函数"><a href="#为什么有了-h-函数还要-vnode-函数" class="headerlink" title="为什么有了 h 函数还要 vnode 函数?"></a>为什么有了 h 函数还要 vnode 函数?</h2><p>其实 <code>h 函数</code>，更多的时候，是便于用户传参，用户只需要考虑三个要素：标签名、标签的其他自身信息、子元素。</p>
<p>但是一个<code>vnode</code>有 6 种属性，其中的 key 是从 data 来的，所以<code>vnode</code>函数需要 5 个参数，用户调用的话，显然增加理解门槛，所以用<code>h函数</code>简化了传参，降低调用门槛，而<code>h函数</code>内部调用<code>vnode</code>函数生成<code>vnode</code></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/892b1a34f9c84d4da90ff769a5c0de91~tplv-k3u1fbpfcp-zoom-1.image" alt="vnode2"><br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a32e2a3b3d264d5894d7e56700184976~tplv-k3u1fbpfcp-zoom-1.image" alt="vnode3"></p>
<p>h函数的参数最多三个，但只有第一个是必传项，第二个参数和第三个都是可传项，所以内部对各种情况作了判断，已生成正确的<code>vnode</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// npm i snabbdom 可以快速在编辑器控制台看下，h三个参数，必填的是第一个，data始终是对象，children可以是数组也可以是字符串</span></span><br><span class="line"><span class="keyword">const</span> &#123; h &#125; = <span class="built_in">require</span>(<span class="string">"snabbdom"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(h(<span class="string">"div.only-sel"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(h(<span class="string">"div.only-data"</span>, &#123; <span class="attr">name</span>: <span class="string">"demo"</span> &#125;));</span><br><span class="line"><span class="built_in">console</span>.log(h(<span class="string">"div.only-text"</span>, <span class="string">"qqq"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(</span><br><span class="line">  h(<span class="string">"div.only-text"</span>, &#123; <span class="attr">key</span>: <span class="string">"data这里设置key"</span> &#125;, [h(<span class="string">"span"</span>), <span class="string">"子text"</span>])</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af1e7b5756b14136acc4e09d13d42f8a~tplv-k3u1fbpfcp-zoom-1.image" alt="vnode4"></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://github.com/creeperyang/blog/issues/33" target="_blank" rel="noopener">解析 snabbdom 源码，教你实现精简的 Virtual DOM 库 #33</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/23/vue_source_code_2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/23/vue_source_code_2/" itemprop="url">
                  数据驱动 - 学习vue源码系列2
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T20:09:56+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/23/vue_source_code_2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/23/vue_source_code_2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>决定跟着<a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码课程</a>好好学习下<code>vue2</code>的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~</p>
<p>将<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue 的源码</a>clone 到本地，切换到分支<code>2.6</code>。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p><code>数据驱动</code>是<code>vue</code>的核心思想。</p>
<p>数据的变化，<code>JQuery</code>通过 操作<code>DOM</code> 更新视图，而<code>vue</code>会自动更新视图，解耦 DOM 和数据。</p>
<p>本节重点，分析 <code>&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</code>怎么变成<code>&lt;div id=&quot;app&quot;&gt;hello&lt;/div&gt;</code>。</p>
<p>切记：分析源码，先做主线任务，然后再是支线任务~~~</p>
<h2 id="new-Vue-发生了什么"><a href="#new-Vue-发生了什么" class="headerlink" title="new Vue 发生了什么"></a>new Vue 发生了什么</h2><p>来找找，实现这样的功能，都涉及到了哪些文件。</p>
<p>从入口文件开始找，Vue 在<code>src/core/instance/index.js</code>定义的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)) &#123;</span><br><span class="line">    warn(<span class="string">"Vue is a constructor and should be called with the `new` keyword"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 这里就执行这一个方法</span></span><br><span class="line">  <span class="keyword">this</span>._init(options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这些都是在原型上挂载相应方法的</span></span><br><span class="line">initMixin(Vue);</span><br><span class="line">stateMixin(Vue);</span><br><span class="line">eventsMixin(Vue);</span><br><span class="line">lifecycleMixin(Vue);</span><br><span class="line">renderMixin(Vue);</span><br></pre></td></tr></table></figure>
<p>这里还有个小细节：书写顺序上，虽然<code>this._init</code>在<code>initMixin(Vue);....</code>之前，但实际上，<code>this._init</code>只有<code>new</code>的时候才执行，而<code>new</code>之前，<code>initMixin(Vue);....</code>已经执行，所以，<code>this._init</code>能调用所有原型上的方法。</p>
<p>从挂载原型的方法上面，显然可以找到<code>initMixin</code>是定义<code>_init</code>方法的，于是找到<code>init.js</code>：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code5.png" alt="vue_source_code5"></p>
<p>依次各种方法，但是什么才是实现<code></code>变成<code>hello</code>的相关代码呢？</p>
<h3 id="小技巧：增加调试"><a href="#小技巧：增加调试" class="headerlink" title="小技巧：增加调试"></a>小技巧：增加调试</h3><p>想要找到这个问题的答案，其实就是建个 demo，然后引入<code>vue</code>文件，在<code>init</code>的相关代码打上<code>debugger</code>，<br>发现哪个执行完之后，<code></code>变成<code>hello</code>了，那就找到了相关的代码了！</p>
<p>我这边偷懒了点，直接在克隆下来的 <code>vue</code> 库里，建个<code>z.html</code>，引入<code>vue</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 这里改成自己的路径 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"vue/dist/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">"#app"</span>,</span></span><br><span class="line"><span class="undefined">    data: &#123;</span></span><br><span class="line"><span class="javascript">      message: <span class="string">"hello"</span>,</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后搜下<code>_init</code>，在这里打上断点，然后再浏览器里运行<code>z.html</code><br><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code6.png" alt="vue_source_code6"><br><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code7.gif" alt="vue_source_code7.gif"></p>
<p>Got it！这里可以断定<code>vm.$mount</code>是让<code></code>变成<code>hello</code>的关键方法！</p>
<h3 id="为什么能-this-message"><a href="#为什么能-this-message" class="headerlink" title="为什么能 this.message"></a>为什么能 this.message</h3><p>方法已经找到，这里再说另外一个事，为什么<code>data</code>里面定义的属性，能直接<code>this.xx</code>访问呢？</p>
<p>在使用一次<code>debugger</code>，这次仔细看下，<code>this</code>里面的属性，开始非常少，然后越来越多：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code8.gif" alt="vue_source_code8.gif"></p>
<p>哟西！很快就发现执行<code>initState(vm)</code>之后，<code>this</code>上面就有了<code>message</code>属性，显然这个文件做了相关的功能。</p>
<p>在<code>state.js</code>里看看：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initState方法</span></span><br><span class="line">initData(vm);</span><br><span class="line"></span><br><span class="line"><span class="comment">// initData方法，这里看到在实例上将data挂载在`this._data`属性上</span></span><br><span class="line">data = vm._data = <span class="keyword">typeof</span> data === <span class="string">"function"</span> ? getData(data, vm) : data || &#123;&#125;;</span><br><span class="line">proxy(vm, <span class="string">`_data`</span>, key);</span><br><span class="line"></span><br><span class="line"><span class="comment">// proxy方法，这里其实做了映射，当访问this.xx的时候，就会访问 this._data.xx</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition);</span><br></pre></td></tr></table></figure>
<h2 id="Vue-实例挂载的实现"><a href="#Vue-实例挂载的实现" class="headerlink" title="Vue 实例挂载的实现"></a>Vue 实例挂载的实现</h2><p>挂载的实现，重点就是<code>this.$mount</code>方法的实现。</p>
<p>寻找特定方法的定义，<code>src</code>全局搜索下<code>$mount</code></p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code9.png" alt="vue_source_code9"></p>
<p>发现定义<code>$mount</code>有三处：</p>
<ul>
<li>platforms/web/entry-runtime-with-compiler.js</li>
<li>platforms/web/runtime/index.js</li>
<li>platforms/weex/runtime/index.js</li>
</ul>
<p>其实也很好理解，之前说过 vue 的三种平台<code>web</code>、<code>weex</code>、<code>服务器</code>，最后一个肯定不需要，前两者，weex 里不支持模板是字符串或者 el 是字符串的模式，所以<code>weex</code>里只有一个，而<code>web</code>里有两种</p>
<h3 id="web-entry-runtime-with-compiler-js"><a href="#web-entry-runtime-with-compiler-js" class="headerlink" title="web/entry-runtime-with-compiler.js"></a>web/entry-runtime-with-compiler.js</h3><p>先看看<code>web/entry-runtime-with-compiler.js</code></p>
<ul>
<li>缓存原有的<code>$mount</code>，重写的时候，是在原有的<code>$mount</code>上增加功能</li>
<li><code>el</code>先判断是否传入，然后统一由<code>query</code>获取<code>dom</code></li>
<li>拿到 dom 之后，先看下是不是<code>body</code>或者<code>html</code>，是的话，警告并终止</li>
<li>如果<code>options</code>有<code>render函数</code>直接返回原有的<code>$mount</code>；没有的话，将<code>template</code>或者<code>el</code>转化为<code>render函数</code>之后才调用原有的<code>$mount</code></li>
<li><strong>重点</strong>看下，这里，怎么将<code>template</code>或者<code>el</code>转化为<code>render函数</code>，其实就是找到<code>DOM</code>字符串<ul>
<li>没有<code>render函数</code>，就两种情况：有<code>template</code>或者<code>el</code>，将最终的<code>DOM</code>字符串赋值给<code>template</code></li>
<li>优先处理<code>template</code>：<ul>
<li><code>template</code>是一个字符串，只支持以<code>#</code>开头，当做 id 获取元素，返回元素的<code>innerHTML</code>，</li>
<li><code>template</code>是一个元素的话，返回元素的<code>innerHTML</code></li>
<li>其他情况不支持</li>
</ul>
</li>
<li>没有<code>template</code>，看下<code>el</code>，获取 el 的<code>outerHTML</code>，在赋值给<code>template</code></li>
</ul>
</li>
<li>然后将<code>DOM</code>字符串用<code>compileToFunctions</code>处理成 <code>render 函数</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 缓存原来的，重写的时候，在原有的基础上增加功能</span></span><br><span class="line"><span class="keyword">const</span> mount = Vue.prototype.$mount;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 如果传入el的话，就去拿到el，query返回dom元素</span></span><br><span class="line">  el = el &amp;&amp; query(el);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="comment">// 不能是body,html</span></span><br><span class="line">  <span class="keyword">if</span> (el === <span class="built_in">document</span>.body || el === <span class="built_in">document</span>.documentElement) &#123;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存options</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">this</span>.$options;</span><br><span class="line">  <span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line">  <span class="keyword">if</span> (!options.render) &#123;</span><br><span class="line">    <span class="keyword">let</span> template = options.template;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">// template是字符串的话，只支持#开头</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">"string"</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (template.charAt(<span class="number">0</span>) === <span class="string">"#"</span>) &#123;</span><br><span class="line">          template = idToTemplate(template);</span><br><span class="line">          <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">          <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp; !template) &#123;</span><br><span class="line">            warn(</span><br><span class="line">              <span class="string">`Template element not found or is empty: <span class="subst">$&#123;options.template&#125;</span>`</span>,</span><br><span class="line">              <span class="keyword">this</span></span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (template.nodeType) &#123;</span><br><span class="line">        <span class="comment">// 元素的话 直接返回内容</span></span><br><span class="line">        template = template.innerHTML;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">      <span class="comment">// 即便有el,还是统一赋值给template</span></span><br><span class="line">      template = getOuterHTML(el);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">// template会统一转化为render函数</span></span><br><span class="line">      <span class="keyword">const</span> &#123; render, staticRenderFns &#125; = compileToFunctions( template, );</span><br><span class="line">      options.render = render;</span><br><span class="line">      options.staticRenderFns = staticRenderFns;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> mount.call(<span class="keyword">this</span>, el, hydrating);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Vue.compile = compileToFunctions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue;</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：只有非正式环境，才有-warn"><a href="#小技巧：只有非正式环境，才有-warn" class="headerlink" title="小技巧：只有非正式环境，才有 warn"></a>小技巧：只有非正式环境，才有 warn</h4><p>这个小技巧很容易在日常的开发中使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isProduction =</span><br><span class="line">  process.env.NODE_ENV === <span class="string">"production"</span>(!isProduction) &amp;&amp; warn(<span class="string">"some warn"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：判断元素是不是-body-或者-html"><a href="#小技巧：判断元素是不是-body-或者-html" class="headerlink" title="小技巧：判断元素是不是 body 或者 html"></a>小技巧：判断元素是不是 body 或者 html</h4><p>这个也很容易</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isBodyOrHtml = el === <span class="built_in">document</span>.body || el === <span class="built_in">document</span>.documentElement;</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：先处理异常情况"><a href="#小技巧：先处理异常情况" class="headerlink" title="小技巧：先处理异常情况"></a>小技巧：先处理异常情况</h4><p>总会先处理异常情况，最后处理相对正常的情况</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(someError)&#123;</span><br><span class="line">  <span class="keyword">return</span> ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ...</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：el-可以是字符串，也可以是元素的写法"><a href="#小技巧：el-可以是字符串，也可以是元素的写法" class="headerlink" title="小技巧：el 可以是字符串，也可以是元素的写法"></a>小技巧：el 可以是字符串，也可以是元素的写法</h4><p>这个一旦涉及到获取元素，就很好使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> el === <span class="string">"string"</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> selected = <span class="built_in">document</span>.querySelector(el);</span><br><span class="line">    <span class="keyword">if</span> (!selected) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp;</span><br><span class="line">        warn(<span class="string">"Cannot find element: "</span> + el);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> selected;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> el;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>元素的判断，也可以用<code>xx.nodeType</code></p>
<h4 id="小技巧：在已有的函数上增加新功能"><a href="#小技巧：在已有的函数上增加新功能" class="headerlink" title="小技巧：在已有的函数上增加新功能"></a>小技巧：在已有的函数上增加新功能</h4><p>如果希望在已有的函数上增加新的功能，可以先缓存原有的方法，然后重写，这样的好处是不需要到原有的函数中增删代码，而且不同的条件，可能需要不同的重写，灵活性更高：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> print = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name);</span><br><span class="line">&#125;;</span><br><span class="line">print(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 想增加新功能的话</span></span><br><span class="line"><span class="keyword">let</span> oldPrint = print;</span><br><span class="line">print = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"想另外加功能"</span>);</span><br><span class="line">  oldPrint.call(<span class="keyword">this</span>, name);</span><br><span class="line">&#125;;</span><br><span class="line">print(<span class="string">"hello"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="mount：platforms-web-runtime-index-js"><a href="#mount：platforms-web-runtime-index-js" class="headerlink" title="$mount：platforms/web/runtime/index.js"></a>$mount：platforms/web/runtime/index.js</h3><p>上面<code>$mount</code>改写，改的就是<code>platforms/web/runtime/index.js</code>定义的<code>$mount</code>，这里注意<code>runtime</code>肯定是需要的，所以先实现这个。而<code>compiler</code>看情况，所以另外的文件实现。</p>
<p>继续看，这里的定义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mountComponent &#125; <span class="keyword">from</span> <span class="string">"core/instance/lifecycle"</span>;</span><br><span class="line"><span class="comment">// public mount method</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> mountComponent(<span class="keyword">this</span>, el, hydrating);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>代码很明了，拿到<code>el</code>，然后让<code>mountComponent</code>实现，继续探索<code>core/instance/lifecycle.js</code></p>
<p>定义了<code>updateComponent</code>，然后实例化<code>Watcher</code>，专业名词<code>渲染watcher</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Watcher <span class="keyword">from</span> <span class="string">"../observer/watcher"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountComponent</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">  updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    vm._update(vm._render(), hydrating);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 渲染watcher，updateComponent传到这里来了</span></span><br><span class="line">  <span class="keyword">new</span> Watcher( vm, updateComponent, noop, &#123;&#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span> );</span><br><span class="line">  <span class="keyword">return</span> vm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>渲染watcher</code>的回调函数中会调用 <code>updateComponent</code> 方法，在此方法中调用 <code>vm._render</code> 方法首先生成<code>虚拟 Node</code>，最终调用 <code>vm._update</code> 更新 <code>DOM</code></p>
<p><code>Watcher</code>在这里起到两个作用，一个是<strong>初始化</strong>的时候会执行回调函数，另一个是当 vm 实例中的监测的<strong>数据发生变化</strong>的时候执行回调函数。</p>
<h2 id="render"><a href="#render" class="headerlink" title="render"></a>render</h2><p>先重点看下<code>_render</code>，打印 vm 实例，看到这个方法在原型上面，全局搜下，很快就知道在<code>core/instance/render.js</code>里：</p>
<p><code>_render</code>函数，返回的是<code>vnode</code>，而<code>vnode</code>是由<code>$createElement</code>这个方法返回的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// render self</span></span><br><span class="line">  <span class="keyword">let</span> vnode;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 这里注意，第一个参数是this，先不用管，render的真正参数是` vm.$createElement`</span></span><br><span class="line">    vnode = render.call(vm._renderProxy, vm.$createElement);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if the returned array contains only a single node, allow it</span></span><br><span class="line">  <span class="comment">// set parent</span></span><br><span class="line">  vnode.parent = _parentVnode;</span><br><span class="line">  <span class="keyword">return</span> vnode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="理解-vnode-和-patch"><a href="#理解-vnode-和-patch" class="headerlink" title="理解 vnode 和 patch"></a>理解 vnode 和 patch</h2><ul>
<li>vnode 其实就是<code>虚拟dom</code>(virtual dom)，因为真实的 node(real dom)属性和方法都非常多，频繁操作费性能，而 vnode 有相对精简的属性，其本身很容易映射成真实的 node，当然 vnode 和 node 本质上都是对象。</li>
<li>patch 就是将 vnode 变成真实的 node，并且插入到文档里（渲染）</li>
</ul>
<p>看个 demo，直观感受 vnode 和 patch，可以在本地运行：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code10.png" alt="vue_source_code10"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    // vnode本质上就是对象，&#123;"sel":"div","data":&#123;&#125;,"text":"Hello World"&#125;，等同于描述<span class="tag">&lt;<span class="name">div</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> vnode = <span class="keyword">new</span> VNode(<span class="string">"div"</span>, <span class="string">"hello"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(vnode));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>); <span class="comment">// 真实dom</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    /* patch的功能：将第二个vnode转化为真实dom，并插入到文档中，销毁掉第一个vnode，。</span></span><br><span class="line"><span class="undefined">     * 这里有个细节，如果首个节点是真实节点，内部会转化为vnode，然后进行操作</span></span><br><span class="line"><span class="undefined">     */</span></span><br><span class="line"><span class="undefined">    patch(app, vnode);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// patch之后，vnode上面的elm就有了</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(vnode);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">/* 各个函数的定义 */</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// VNode的类</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">VNode</span>(<span class="params">tag, text, elm</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.sel = tag;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.text = text;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.elm = elm;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 创建vnode</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">tag, text, elm</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> <span class="keyword">new</span> VNode(tag, text, elm);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 真实的dom转化为vnode</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">elToVNode</span>(<span class="params">el</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> createElement(el.tagName, el.textContent, el);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// patch将第二个vnode转化为真实的dom，然后插入到文档中。第一个节点存在的意义上和第二个节点进行比较，从而精准的进行渲染</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">oldVNode, newVNode</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 第一个节点是真实节点的话，转化为vnode</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (oldVNode.nodeType) &#123;</span></span><br><span class="line"><span class="undefined">        oldVNode = elToVNode(oldVNode);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="comment">// 将第二个节点转化为真实的dom</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> node = <span class="built_in">document</span>.createElement(newVNode.sel);</span></span><br><span class="line"><span class="undefined">      node.textContent = newVNode.text;</span></span><br><span class="line"><span class="undefined">      newVNode.elm = node;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="comment">// 插入到文档中</span></span></span><br><span class="line"><span class="undefined">      oldVNode.elm.parentNode.insertBefore(node, oldVNode.elm);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="comment">// 销毁掉第一个节点（这里是销毁，但很多时候不是）</span></span></span><br><span class="line"><span class="undefined">      oldVNode.elm.parentNode.removeChild(oldVNode.elm);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> newVNode.elm;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样对<code>vnode</code>和<code>patch</code>有个概念之后，继续源码~</p>
<h2 id="源码中的createElement，返回的是vnode"><a href="#源码中的createElement，返回的是vnode" class="headerlink" title="源码中的createElement，返回的是vnode"></a>源码中的createElement，返回的是vnode</h2><p>很容易找到就在<code>src/core/vdom/create-element.js</code>。<br><code>createElement</code>实际上内部调用<code>_createElement</code>，其返回一个<code>vnode</code>。</p>
<p><code>children</code> 表示当前 VNode 的子节点，它是任意类型的，需要被规范为标准的 <code>VNode 数组</code>，根据<code>normalizationType</code>规范的方法也不一样。（<code>normalizationType</code>主要区分<code>render 函数</code>是编译生成的还是用户手写的）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; normalizeChildren, simpleNormalizeChildren &#125; <span class="keyword">from</span> <span class="string">'./helpers/index'</span></span><br><span class="line"><span class="keyword">const</span> SIMPLE_NORMALIZE = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> ALWAYS_NORMALIZE = <span class="number">2</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  data: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  alwaysNormalize: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 当data参数不存在的时候，后面的参数前置</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(data) || isPrimitive(data)) &#123;</span><br><span class="line">    normalizationType = children</span><br><span class="line">    children = data</span><br><span class="line">    data = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isTrue(alwaysNormalize)) &#123;</span><br><span class="line">    normalizationType = ALWAYS_NORMALIZE</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _createElement(context, tag, data, children, normalizationType)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">_createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag?: string | Class&lt;Component&gt; | Function | Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  data?: VNodeData,</span></span></span><br><span class="line"><span class="function"><span class="params">  children?: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType?: number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 针对不同的normalizationType，对children做不同的处理，其实就是扁平化children</span></span><br><span class="line">  <span class="keyword">if</span> (normalizationType === ALWAYS_NORMALIZE) &#123;</span><br><span class="line">    children = normalizeChildren(children)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (normalizationType === SIMPLE_NORMALIZE) &#123;</span><br><span class="line">    children = simpleNormalizeChildren(children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> vnode, ns</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> Ctor</span><br><span class="line">    ns = (context.$vnode &amp;&amp; context.$vnode.ns) || config.getTagNamespace(tag)</span><br><span class="line">    <span class="keyword">if</span> (config.isReservedTag(tag)) &#123;</span><br><span class="line">      <span class="comment">// platform built-in elements</span></span><br><span class="line">      <span class="comment">// 是保留标签的话，直接创建vnode，vnode支持字符串和组件类型，但这里暂时只看字符串就好</span></span><br><span class="line">      vnode = <span class="keyword">new</span> VNode(</span><br><span class="line">        config.parsePlatformTagName(tag), data, children,</span><br><span class="line">        <span class="literal">undefined</span>, <span class="literal">undefined</span>, context</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="children-规范化"><a href="#children-规范化" class="headerlink" title="children 规范化"></a>children 规范化</h3><p><code>src/core/vdom/helpers/normalize-children.js</code>的两个方法：</p>
<ul>
<li><code>simpleNormalizeChildren</code>这个方法很简单，如果<code>children</code>是二维的话，拍平，children 始终是<code>[vnode,vnode]</code>，这里也只考虑到二维的情况</li>
<li><code>normalizeChildren</code>这个稍微麻烦一点，考虑到多维的情况，需要递归，最后也是拍平</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. When the children contains components - because a functional component</span></span><br><span class="line"><span class="comment">// may return an Array instead of a single root. In this case, just a simple</span></span><br><span class="line"><span class="comment">// normalization is needed - if any child is an Array, we flatten the whole</span></span><br><span class="line"><span class="comment">// thing with Array.prototype.concat. It is guaranteed to be only 1-level deep</span></span><br><span class="line"><span class="comment">// because functional components already normalize their own children.</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">simpleNormalizeChildren</span>(<span class="params">children: any</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children[i])) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.concat.apply([], children);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> children;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. When the children contains constructs that always generated nested Arrays,</span></span><br><span class="line"><span class="comment">// e.g. &lt;template&gt;, &lt;slot&gt;, v-for, or when the children is provided by user</span></span><br><span class="line"><span class="comment">// with hand-written render functions / JSX. In such cases a full normalization</span></span><br><span class="line"><span class="comment">// is needed to cater to all possible types of children values.</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeChildren</span>(<span class="params">children: any</span>): ?<span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isPrimitive(children)</span><br><span class="line">    ? [createTextVNode(children)]</span><br><span class="line">    : <span class="built_in">Array</span>.isArray(children)</span><br><span class="line">    ? normalizeArrayChildren(children)</span><br><span class="line">    : <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isTextNode</span>(<span class="params">node</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isDef(node) &amp;&amp; isDef(node.text) &amp;&amp; isFalse(node.isComment);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeArrayChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  children: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  nestedIndex?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = [];</span><br><span class="line">  <span class="keyword">let</span> i, c, lastIndex, last;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">    c = children[i];</span><br><span class="line">    <span class="keyword">if</span> (isUndef(c) || <span class="keyword">typeof</span> c === <span class="string">"boolean"</span>) <span class="keyword">continue</span>;</span><br><span class="line">    lastIndex = res.length - <span class="number">1</span>;</span><br><span class="line">    last = res[lastIndex];</span><br><span class="line">    <span class="comment">//  nested</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(c)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (c.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        c = normalizeArrayChildren(c, <span class="string">`<span class="subst">$&#123;nestedIndex || <span class="string">""</span>&#125;</span>_<span class="subst">$&#123;i&#125;</span>`</span>);</span><br><span class="line">        <span class="comment">// merge adjacent text nodes 合并</span></span><br><span class="line">        <span class="keyword">if</span> (isTextNode(c[<span class="number">0</span>]) &amp;&amp; isTextNode(last)) &#123;</span><br><span class="line">          res[lastIndex] = createTextVNode(last.text + (c[<span class="number">0</span>]: any).text);</span><br><span class="line">          c.shift();</span><br><span class="line">        &#125;</span><br><span class="line">        res.push.apply(res, c);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：扁平化二维数组"><a href="#小技巧：扁平化二维数组" class="headerlink" title="小技巧：扁平化二维数组"></a>小技巧：扁平化二维数组</h4><p>其实扁平化二维数组，可以利用下<code>concat</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> [].concat(...arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>[].concat(1,[4])</code>就是<code>[1,4]</code></p>
<h2 id="update其实大部分功能就是patch"><a href="#update其实大部分功能就是patch" class="headerlink" title="update其实大部分功能就是patch"></a>update其实大部分功能就是<code>patch</code></h2><p>找特定的方法，基本都是搜索，后期不再赘述。</p>
<p><code>_update</code>在<code>src/core/instance/lifecycle.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hydrating服务端才用到，否则就是false</span></span><br><span class="line">Vue.prototype._update = <span class="function"><span class="keyword">function</span> (<span class="params">vnode: VNode, hydrating?: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vm: Component = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 缓存之前的dom</span></span><br><span class="line">  <span class="keyword">const</span> prevEl = vm.$el;</span><br><span class="line">  <span class="comment">// 缓存之前的vnode</span></span><br><span class="line">  <span class="keyword">const</span> prevVnode = vm._vnode;</span><br><span class="line">  <span class="keyword">const</span> restoreActiveInstance = setActiveInstance(vm);</span><br><span class="line">  <span class="comment">// 新生成的vnode赋值</span></span><br><span class="line">  vm._vnode = vnode;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">    <span class="comment">// initial render 首次渲染走这里 首次的时候 挂载真实的el上 这里的patch和上面的例子相似 根据vnode创建真实的dom，然后插入到文档中，__patch__返回真实的dom</span></span><br><span class="line">    vm.$el = vm.__patch__(vm.$el, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(vm.$el);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>仔细看下<code>__patch__</code>，这里需要层层向上找，其实和上面的简单例子的主体逻辑很像了</p>
<p>但这里为什么用<code>createPatchFunction</code>生成<code>patch</code>呢？</p>
<p>vue 有三种平台，前面说过了，服务器端不需要渲染 dom，忽略。而 web 和 weex 都需要渲染，但“平台 DOM” 的方法是不同的，并且对 “DOM” 包括的属性模块创建和更新也不尽相同。因此每个平台都有各自的 nodeOps 和 modules，所以存放在各自的平台里。<br>但是 patch 的主要逻辑是相似的，这样通过 createPatchFunction 把差异化参数提前固化，这样不用每次调用 patch 的时候都传递 nodeOps 和 modules 了，这种函数柯里化的编程技巧也非常值得学习。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/platforms/web/runtime/index.js */</span></span><br><span class="line"><span class="keyword">import</span> &#123; patch &#125; <span class="keyword">from</span> <span class="string">"./patch"</span>;</span><br><span class="line"><span class="comment">// 浏览器需要，服务器不需要，noop是空函数</span></span><br><span class="line">Vue.prototype.__patch__ = inBrowser ? patch : noop;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* src/platforms/web/runtime/patch.js */</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPatchFunction &#125; <span class="keyword">from</span> <span class="string">"core/vdom/patch"</span>;</span><br><span class="line"><span class="comment">// nodeOps是增删改查dom的方法合集，modules是attrs, klass, events, domProps等这种的解析</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> patch: <span class="built_in">Function</span> = createPatchFunction(&#123; nodeOps, modules &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* src/core/vdom/patch.js */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createPatchFunction</span>(<span class="params">backend</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...定义很多和真实dom相关的函数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">oldVnode, vnode, hydrating, removeOnly</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 首次渲染，是真实的dom 这边只贴出与其相关的代码</span></span><br><span class="line">    <span class="keyword">const</span> isRealElement = isDef(oldVnode.nodeType);</span><br><span class="line">    <span class="comment">// replacing existing element</span></span><br><span class="line">    <span class="comment">// 缓存 旧的dom</span></span><br><span class="line">    <span class="keyword">const</span> oldElm = oldVnode.elm;</span><br><span class="line">    <span class="comment">// 缓存 旧的dom 父元素</span></span><br><span class="line">    <span class="keyword">const</span> parentElm = nodeOps.parentNode(oldElm);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create new node 根据新的vnode创建dom 并在父元素里旧元素前面插入新的dom</span></span><br><span class="line">    createElm(</span><br><span class="line">      vnode,</span><br><span class="line">      insertedVnodeQueue,</span><br><span class="line">      oldElm._leaveCb ? <span class="literal">null</span> : parentElm,</span><br><span class="line">      nodeOps.nextSibling(oldElm)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// destroy old node</span></span><br><span class="line">    <span class="keyword">if</span> (isDef(parentElm)) &#123;</span><br><span class="line">      <span class="comment">// 移除旧的dom</span></span><br><span class="line">      removeVnodes(parentElm, [oldVnode], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回 新的dom</span></span><br><span class="line">    <span class="keyword">return</span> vnode.elm;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!--
### 小技巧：利用高阶函数封装相同的部分，生成不同的函数

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFn</span>(<span class="params">&#123; nodeOp, s &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">&#123; x, y, z &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(&#123; x, y, z &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// a平台</span></span><br><span class="line"><span class="keyword">const</span> nodeOp = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> fn = createFn(&#123; nodeOp &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// b平台</span></span><br><span class="line"><span class="keyword">const</span> nodeOp = &#123; <span class="attr">b</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> s = <span class="string">"b"</span>;</span><br><span class="line"><span class="keyword">const</span> fn = createFn(&#123; nodeOp, s &#125;);</span><br><span class="line"><span class="string">``</span><span class="string">` --&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### debugger 调试\_update</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>html</span><br><span class="line">&lt;div id=<span class="string">"app"</span>&gt;&#123;&#123;message&#125;&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;!-- 这里换成绝对路径 --&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src="vue/</span>dist/vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  const vm2 = new Vue(&#123;</span></span><br><span class="line">    el: "#app",</span><br><span class="line">    data: &#123;</span><br><span class="line">      message: <span class="string">"hello"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    render(createElement) &#123;</span><br><span class="line">      <span class="keyword">return</span> createElement(</span><br><span class="line">        <span class="string">"section"</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          attrs: &#123; <span class="attr">id</span>: <span class="string">"box"</span> &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">this</span>.message</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>在<code>dist/vue.js</code>，这里打上断点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._update = <span class="function"><span class="keyword">function</span> (<span class="params">vnode, hydrating</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">debugger</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里务必明确，开始的<code>#app</code>是真实的 dom，而后面的<code>section#box</code>是<code>vnode</code>，这里的参数<code>vnode</code>是指<code>section#box</code>，而<code>vm.$el</code>开始指的是<code>#app</code></p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code11.gif" alt="vue_source_code11.gif"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>当引入 <code>vue</code>，首次渲染的过程大概如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">initMixin(Vue); <span class="comment">// ... 引入vue的时候，Vue.prototype已经挂载了各模块属性和方法。 src/core/instance/init.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123; <span class="attr">el</span>: <span class="string">"#app"</span> &#125;); <span class="comment">// 用户创建vm实例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>._init(options); <span class="comment">// src/core/instance/index.js</span></span><br><span class="line"></span><br><span class="line">vm.$mount(vm.$options.el); <span class="comment">// _init方法里 src/core/instance/init.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">template = getOuterHTML(el);</span><br><span class="line"><span class="keyword">const</span> &#123; render, staticRenderFns &#125; = compileToFunctions(template);</span><br><span class="line">options.render = render;</span><br><span class="line">mount.call(<span class="keyword">this</span>, el, hydrating); <span class="comment">// $mount方法里  compiler这里重点是 将template或者el的dom字符串都会变成render函数，之后才是调用runtime的$mount方法  src/platforms/web/entry-runtime-with-compiler.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mountComponent(<span class="keyword">this</span>, el, hydrating); <span class="comment">// $mount方法里 runtime里，此时this已经有了render函数了 src/platforms/web/runtime/index.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  vm._update(vm._render(), hydrating);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">new</span> Watcher(vm, updateComponent, noop, &#123;&#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>) <span class="comment">// mountComponent方法里 建了一个渲染watcher，执行`vm._update(vm._render(), hydrating)`，_render是返回vnode，_update将这个vnode变成真实dom，然后插入到文档中（渲染），首次渲染，_render其实就是执行参数中的render函数 src/core/instance/lifecycle.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.$options</span><br><span class="line">vnode = render.call(vm._renderProxy, vm.$createElement)</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">return</span> vnode <span class="comment">// _render函数里 src/core/instance/render.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vm.$el = vm.__patch__(vm.$el, vnode) <span class="comment">// _update函数里 __patch__就是创建真实dom和插入到文档中 src/core/instance/lifecycle.js</span></span><br><span class="line"></span><br><span class="line">Vue.prototype.__patch__ = inBrowser ? patch : noop <span class="comment">// __patch__就是patch方法  src/platforms/web/runtime/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> patch: <span class="built_in">Function</span> = createPatchFunction(&#123; nodeOps, modules &#125;)</span><br><span class="line"><span class="comment">// web下的patch由createPatchFunction生成 src/platforms/web/runtime/patch.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPatchFunction</span>(<span class="params">backend</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; modules, nodeOps &#125; = backend</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createElm</span> (<span class="params"> vnode, insertedVnodeQueue, parentElm, refElm</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> data = vnode.data</span><br><span class="line">    <span class="keyword">const</span> children = vnode.children</span><br><span class="line">    <span class="keyword">const</span> tag = vnode.tag</span><br><span class="line">    nodeOps.createElement(tag, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span> (<span class="params">oldVnode, vnode, hydrating, removeOnly</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> oldElm = oldVnode.elm</span><br><span class="line">    <span class="comment">// 缓存 旧的dom 父元素</span></span><br><span class="line">    <span class="keyword">const</span> parentElm = nodeOps.parentNode(oldElm)</span><br><span class="line">    <span class="comment">// create new node 根据新的vnode创建dom 并在父元素里旧元素前面插入新的dom</span></span><br><span class="line">    createElm( vnode, insertedVnodeQueue, parentElm, nodeOps.nextSibling(oldElm) )</span><br><span class="line">    <span class="comment">// 移除旧的dom</span></span><br><span class="line">    removeVnodes(parentElm, [oldVnode], <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// 返回 新的dom</span></span><br><span class="line">    <span class="keyword">return</span> vnode.elm</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="comment">// 这里的生成patch函数利用不同平台的modules,但patch的逻辑却相似 src/core/vdom/patch.js</span></span><br></pre></td></tr></table></figure>
<p>这里在借助黄轶老师的图，表示从主线上把模板和数据如何渲染成最终的 DOM 的过程：</p>
<p><img src="https://ustbhuangyi.github.io/vue-analysis/assets/new-vue.png" alt="new-vue.png"></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://coding.imooc.com/lesson/228.html#mid=14869">黄轶老师的 vue2 源码解密课程</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/data-driven/">vue.js 技术揭秘</a></li>
<li><a href="https://my.oschina.net/dongwj/blog/4415074">Snabbdom 的使用</a></li>
</ul>
-->
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/22/radio_component/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/22/radio_component/" itemprop="url">
                  用vue简单封装单选组件
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-22T16:47:56+08:00">
                2021-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vue/" itemprop="url" rel="index">
                    <span itemprop="name">vue</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/22/radio_component/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/22/radio_component/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>表单类的组件，当<code>label</code>的<code>for</code>属性等同于表单元素的<code>ID</code>的时候，点击<code>label</code>就会触发相应的表单元素的点击事件，为一些场景提供方便。</p>
<p>这边根据业务场景，简单封装一个单选组件。</p>
<h2 id="单选的基本使用"><a href="#单选的基本使用" class="headerlink" title="单选的基本使用"></a>单选的基本使用</h2><p>先看下<a href="https://cn.vuejs.org/v2/guide/forms.html" target="_blank" rel="noopener">官方单选的基本使用案例</a>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"example-4"</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">"radio"</span> id=<span class="string">"one"</span> value=<span class="string">"One"</span> v-model=<span class="string">"picked"</span>&gt;</span><br><span class="line">  &lt;label <span class="keyword">for</span>=<span class="string">"one"</span>&gt;One&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">  &lt;br&gt;</span></span><br><span class="line"><span class="regexp">  &lt;input type="radio" id="two" value="Two" v-model="picked"&gt;</span></span><br><span class="line"><span class="regexp">  &lt;label for="two"&gt;Two&lt;/</span>label&gt;</span><br><span class="line">  &lt;br&gt;</span><br><span class="line">  &lt;span&gt;Picked: &#123;&#123; picked &#125;&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#example-4'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    picked: <span class="string">''</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1deb688a9ed341078a52c45c51eba919~tplv-k3u1fbpfcp-zoom-1.image" alt="radio_2"></p>
<h2 id="封装单选组件"><a href="#封装单选组件" class="headerlink" title="封装单选组件"></a>封装单选组件</h2><p>显然，实际业务使用中，这么一个个写<code>radio</code>元素的话，非常繁琐，希望封装之后可以这么使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">radio-component</span> <span class="attr">:value.sync</span>=<span class="string">"xxx"</span> <span class="attr">:options</span>=<span class="string">"[&#123;text:'北京',value:'bj'&#125;]"</span>&gt;</span><span class="tag">&lt;/<span class="name">radio-component</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>简单传入<code>options</code>和<code>value</code>就可以使用了!</p>
<ul>
<li>简单写个<code>id</code>的生成方法</li>
<li>考虑到父组件更好的调用，直接使用了<code>sync</code>语法糖，当然也可以使用<code>v-model</code>语法糖，个人觉得前者更好理解</li>
<li>这里的<code>label</code>内部的内容，在实际项目中，可以换成任意的标签和组件，增加灵活性</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;radio-button-box&quot; style=&quot;display: flex&quot;&gt;</span><br><span class="line">    &lt;div v-for=&quot;(item, index) in optionsWithId&quot; :key=&quot;index&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;radio&quot; hidden :value=&quot;item.value&quot; :id=&quot;item.id&quot; /&gt;</span><br><span class="line">      &lt;label :for=&quot;item.id&quot; @click=&quot;clickRadio(item)&quot;&gt;</span><br><span class="line">        &lt;!-- 此处可以任意更换别的组件或者标签 --&gt;</span><br><span class="line">        &lt;button :class=&quot;&#123; btn: true, selected: value === item.value &#125;&quot;&gt;</span><br><span class="line">          &#123;&#123; item.text &#125;&#125;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/label&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">/**</span><br><span class="line"> * 本组件本质是单选，options可以自定义，但必须有text和value，默认两个选项</span><br><span class="line"> * value是必传项，这里值发生变化的话，通过sync语法糖修改父组件的value，从而改变这里的value</span><br><span class="line"> *</span><br><span class="line"> * 使用方式：&lt;radio-component :value.sync=&quot;xxx&quot;&gt;&lt;/radio-component&gt;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &apos;RadioComponent&apos;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    options: &#123; required: true, type: Array &#125;,</span><br><span class="line">    value: &#123; required: true &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    optionsWithId() &#123;</span><br><span class="line">      // 给每项手动加个id</span><br><span class="line">      this.options.forEach(item =&gt; &#123;</span><br><span class="line">        item.id = `radio$&#123;Math.random()</span><br><span class="line">          .toString()</span><br><span class="line">          .slice(3, 13)&#125;`;</span><br><span class="line">      &#125;);</span><br><span class="line">      return this.options;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    clickRadio(item) &#123;</span><br><span class="line">      this.$emit(&quot;update:value&quot;, item.value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.radio-button-box &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">&#125;</span><br><span class="line">.btn &#123;</span><br><span class="line">  margin-right: 20px;</span><br><span class="line">  padding: 5px 10px;</span><br><span class="line">  border: 1px solid;</span><br><span class="line">  font-size: 12px;</span><br><span class="line">&#125;</span><br><span class="line">.btn.selected &#123;</span><br><span class="line">  background-color: #69f;</span><br><span class="line">  color: #fff;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<h2 id="使用单选组件"><a href="#使用单选组件" class="headerlink" title="使用单选组件"></a>使用单选组件</h2><p>使用的话，其实没啥，存入两个属性就行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;单选组件的使用!&lt;/h1&gt;</span><br><span class="line">    &lt;radio-component :value.sync=&quot;city&quot; :options=&quot;options&quot;&gt;&lt;/radio-component&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import RadioComponent from &quot;./components/RadioComponent.vue&quot;;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;App&quot;,</span><br><span class="line">  components: &#123; RadioComponent &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      city: null,</span><br><span class="line">      options: [</span><br><span class="line">        &#123; text: &quot;北京&quot;, value: &quot;bj&quot; &#125;,</span><br><span class="line">        &#123; text: &quot;上海&quot;, value: &quot;sh&quot; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1214cc76ea7e4f8f8e086b2c423692bf~tplv-k3u1fbpfcp-zoom-1.image" alt="radio_3.gif"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/19/vue_source_code_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/19/vue_source_code_1/" itemprop="url">
                  准备工作 - 学习vue源码系列1
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-19T18:09:17+08:00">
                2021-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/19/vue_source_code_1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/19/vue_source_code_1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>决定跟着<a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的vue2源码课程</a>好好学习下<code>vue2</code>的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~</p>
<p>将<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue的源码</a>clone到本地，切换到分支<code>2.6</code>。</p>
<h2 id="认识-flow"><a href="#认识-flow" class="headerlink" title="认识 flow"></a>认识 flow</h2><p><code>Flow</code> 是 <code>facebook</code> 出品的 <code>JavaScript</code> 静态类型检查工具。<br>vue使用其进行<strong>类型检测</strong>。</p>
<h3 id="怎么使用-flow"><a href="#怎么使用-flow" class="headerlink" title="怎么使用 flow"></a>怎么使用 flow</h3><p>安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i flow-bin -g</span><br></pre></td></tr></table></figure>
<p>创建配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flow init</span><br></pre></td></tr></table></figure>
<p>创建一个 js 文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">split</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str.split(<span class="string">" "</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">split(<span class="number">11</span>);</span><br></pre></td></tr></table></figure>
<p>执行<code>flow</code>命令，就可以检测了，这边会发现报错</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b621c5cbf6024414a0800f9cd70f6d09~tplv-k3u1fbpfcp-zoom-1.image" alt="flow1"></p>
<h3 id="flow-的工作方式"><a href="#flow-的工作方式" class="headerlink" title="flow 的工作方式"></a>flow 的工作方式</h3><p>通常类型检查分成 2 种方式：</p>
<ul>
<li><p>类型推断：通过变量的使用上下文来推断出变量类型，然后根据这些推断来检查类型。(上面的例子就是推断)</p>
</li>
<li><p>类型注释：事先注释好我们期待的类型，Flow 会基于这些注释来判断。(推荐)</p>
</li>
</ul>
<p>类型注释和 ts 非常像：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x: number, y: number</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="string">"Hello"</span>, <span class="number">11</span>);</span><br><span class="line"><span class="comment">// 执行 flow，会报错</span></span><br></pre></td></tr></table></figure>
<p>一般在需要<code>flow</code>检查的文件首行加上<code>/*@flow*/</code></p>
<p>如果可以为<code>undefined</code>或者<code>null</code>的话：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo: string | <span class="keyword">void</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> foo: ?string = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<h3 id="flow-在-vue-源码中的使用"><a href="#flow-在-vue-源码中的使用" class="headerlink" title="flow 在 vue 源码中的使用"></a>flow 在 vue 源码中的使用</h3><p>flow 可以自定义类型，vue 的主目录下<code>.flowconfig</code> 文件， 它是 Flow 的配置文件。<br>这其中的 [libs] 部分用来描述包含指定库<strong>定义</strong>的目录，默认是名为 <code>flow</code> 的目录。</p>
<p>遇到某个类型，想要看数据结构的话，就翻看这里。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c70da7e521c3457abfd2b1417d4b5352~tplv-k3u1fbpfcp-zoom-1.image" alt="flow2"></p>
<h2 id="vue-源码目录设计"><a href="#vue-源码目录设计" class="headerlink" title="vue 源码目录设计"></a>vue 源码目录设计</h2><p>主要看<code>src</code>的设计:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c005a42077124ce797b8985663bd31ba~tplv-k3u1fbpfcp-zoom-1.image" alt="vue_dir1"></p>
<p>功能模块拆分的非常清楚，让阅读性和可维护性都很优雅。</p>
<h2 id="vue-源码构建"><a href="#vue-源码构建" class="headerlink" title="vue 源码构建"></a>vue 源码构建</h2><p><code>Vue.js</code> 源码是基于 <a href="https://github.com/rollup/rollup" target="_blank" rel="noopener">Rollup</a> 构建的，它的构建相关配置都在 <code>scripts</code> 目录下。</p>
<p><code>Rollup</code> 主要是构建 <code>js</code> 文件，不处理其他的文件，相比 <code>webpack</code> 更轻量。</p>
<p>所谓<strong>构建</strong>，就是运行命令之后，生成最终的文件。</p>
<h3 id="构建脚本"><a href="#构建脚本" class="headerlink" title="构建脚本"></a>构建脚本</h3><p>构建脚本是<code>package.json</code>，其中的的<code>build</code>命令，就是构建命令。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c7795d6b3694f728811552b94ebdf96~tplv-k3u1fbpfcp-zoom-1.image" alt="vue_dir2"></p>
<p>vue 的三种运行环境：</p>
<ul>
<li>web（普通的 web 端）</li>
<li>ssr（服务端）</li>
<li>weex（原生）</li>
</ul>
<h3 id="构建过程"><a href="#构建过程" class="headerlink" title="构建过程"></a>构建过程</h3><p><code>src/build.js</code>其实就是获取配置，然后根据环境参数过滤，最后在<code>dist</code>目录生成相应的<code>js</code>文件。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63dc4185d6d946a98660c0fcfe593cdd~tplv-k3u1fbpfcp-zoom-1.image" alt="vue_source_code1"></p>
<p>为了让配置中的<code>entry/dist</code>路径更具可读性，<code>vue</code>进行了一些技巧性的操作:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> builds = &#123;</span><br><span class="line">  <span class="string">"web-runtime-cjs-dev"</span>: &#123;</span><br><span class="line">    <span class="comment">// 这里的 web会被替换成web的绝对路径，resolve就是做这个事的</span></span><br><span class="line">    entry: resolve(<span class="string">"web/entry-runtime.js"</span>),</span><br><span class="line">    <span class="comment">// 同理 dist也是如此</span></span><br><span class="line">    dest: resolve(<span class="string">"dist/vue.runtime.common.dev.js"</span>),</span><br><span class="line">    format: <span class="string">"cjs"</span>,</span><br><span class="line">    env: <span class="string">"development"</span>,</span><br><span class="line">    banner,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>再看下<code>resolve</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resolve = <span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> base = p.split(<span class="string">"/"</span>)[<span class="number">0</span>];</span><br><span class="line">  <span class="comment">// // aliases就是 路径的别名哈希表 &#123;compile:"compiler文件夹的绝对地址",core:.....&#125;</span></span><br><span class="line">  <span class="keyword">if</span> (aliases[base]) &#123;</span><br><span class="line">    <span class="keyword">return</span> path.resolve(aliases[base], p.slice(base.length + <span class="number">1</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> path.resolve(__dirname, <span class="string">"../"</span>, p);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="format属性"><a href="#format属性" class="headerlink" title="format属性"></a>format属性</h3><p><code>format</code>表示 最后生成的 <code>js</code> 文件符合什么规范：</p>
<ul>
<li>commonJS 规范，其实就是<code>require/module.exports</code></li>
<li>ESModule 规范，其实就是<code>import/export</code></li>
<li>umd 规范，算是兼容模式，</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">window, factory</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> exports === <span class="string">"object"</span>) &#123;</span><br><span class="line">    <span class="built_in">module</span>.exports = factory();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> define === <span class="string">"function"</span> &amp;&amp; define.amd) &#123;</span><br><span class="line">    define(factory);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.eventUtil = factory();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//module ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="小技巧：打印错误和文件大小"><a href="#小技巧：打印错误和文件大小" class="headerlink" title="小技巧：打印错误和文件大小"></a>小技巧：打印错误和文件大小</h3><p>有两个函数，可以日常使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSize</span> (<span class="params">code</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (code.length / <span class="number">1024</span>).toFixed(<span class="number">2</span>) + <span class="string">'kb'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// catch(logError) 这样使用非常方便</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logError</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Runtime-Only-VS-Runtime-Compiler"><a href="#Runtime-Only-VS-Runtime-Compiler" class="headerlink" title="Runtime Only VS Runtime + Compiler"></a>Runtime Only VS Runtime + Compiler</h3><p>其实这两个是相对的。</p>
<p>使用<code>vue</code>的时候，如果<code>template</code>是字符串的话，如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  template: <span class="string">'&lt;div&gt;&#123;&#123; hi &#125;&#125;&lt;/div&gt;'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这种代码一般是在运行环境里，由<strong>运行环境</strong>将<code>template</code>编译成<code>render</code>函数，这里特别注意，编译是<strong>运行环境</strong>做的，这样<code>vue</code>就必须包含怎么<code>编译</code>的代码，专业名词就是<code>Compiler</code></p>
<p>当然如果代码里没有这样的字符串，自然也就不需要<code>Compiler</code>。</p>
<p>显然加上<code>Compiler</code>既增加了<code>vue</code>的体积，又让运行环境干编译，会更费时。</p>
<p>那另外一种就好理解了，所谓的<code>Runtime</code>其实就是没有<code>Compiler</code>的<code>vue</code>代码，一般开发是用<code>.vue</code>文件表示模板，而<code>.vue</code>文件，是在你的编辑器里，也称为编译环境里，将其编译成<code>render</code>函数（依靠webpack的vue-loader插件），这样运行环境自然不需要编译，只需要运行就行，专业名词就是<code>Runtime</code></p>
<p>显然<code>Runtime</code>既轻量，又省时。</p>
<p>说句人话，开发的时候如果模板没有字符串的话，直接<code>Runtime</code>就好，不需要<code>Compiler</code></p>
<h2 id="从入口开始"><a href="#从入口开始" class="headerlink" title="从入口开始"></a>从入口开始</h2><p>先找到定义<code>vue</code>的地方！</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/27410c9b056343df8e9e231d5d63b57f~tplv-k3u1fbpfcp-zoom-1.image" alt="vue_source_code3"></p>
<p><code>dist</code>的<code>vue.js</code>是由<code>entry-runtime-with-compiler.js</code>生成的，一层层往上找线索~</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// entry-runtime-with-compiler.js</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'./runtime/index.js'</span></span><br><span class="line"><span class="comment">// runtime/index.js</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'core/index'</span></span><br><span class="line"><span class="comment">// core/index.js</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'./instance/index'</span></span><br><span class="line"><span class="comment">// instance/index  找到啦！</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(<span class="string">'Vue is a constructor and should be called with the `new` keyword'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e33e886890d64dad9a0bd65284a8d1ac~tplv-k3u1fbpfcp-zoom-1.image" alt="vue_source_code4"></p>
<p>这里用函数的形式定义了类，好处是方便在<code>Vue.prototype</code>上面拓展，这样拓展的方法和属性可以分布在别的文件，方便维护。</p>
<h3 id="小技巧：怎么判断有没有用new调用"><a href="#小技巧：怎么判断有没有用new调用" class="headerlink" title="小技巧：怎么判断有没有用new调用"></a>小技巧：怎么判断有没有用new调用</h3><p>其实就是<code>this</code>是不是属于当前实例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">C</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!<span class="keyword">this</span> instanceOf C)&#123;<span class="built_in">console</span>.log(<span class="string">'C is a constructor and should be called with the `new` keyword'</span>)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小技巧：函数的形式定义类，方便拓展"><a href="#小技巧：函数的形式定义类，方便拓展" class="headerlink" title="小技巧：函数的形式定义类，方便拓展"></a>小技巧：函数的形式定义类，方便拓展</h3><p><code>class</code>关键字的方式，拓展会不方便，反而函数的形式更加便捷，可以将方法和属性分门别类在其他文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">C</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="comment">// getName.js</span></span><br><span class="line">C.prototype.getName = <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的vue2源码解密课程</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/prepare/flow.html#flow-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F" target="_blank" rel="noopener">vue.js 技术揭秘</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://omizt4opc.bkt.clouddn.com/avatar.jpg"
               alt="frontzhm" />
          <p class="site-author-name" itemprop="name">frontzhm</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">260</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">39</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">frontzhm</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"frontzhm"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
