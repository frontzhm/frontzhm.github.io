<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="frontzhm, zhm, huahua, hua_hua" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="hello world">
<meta property="og:type" content="website">
<meta property="og:title" content="花花的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="花花的博客">
<meta property="og:description" content="hello world">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="花花的博客">
<meta name="twitter:description" content="hello world">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> 花花的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?60f2cb5747a596a24f2a053f1650c30b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">花花的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/24/throttle_debounce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/08/24/throttle_debounce/" itemprop="url">
                  用吃巧克力来理解 防抖和节流！
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-08-24T18:51:52+08:00">
                2021-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/08/24/throttle_debounce/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/08/24/throttle_debounce/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>词语不陌生，但是回回看，回回忘记，究其根本就是没理解。</p>
<p>让我们先忘掉这两个词语，进入一个新的情境~</p>
<p>现在你是一个 5 岁的宝宝，今天有小朋友要来，妈妈准备了很多巧克力。<br>你一看，赶紧就说，妈妈我要吃巧克力，妈妈给了你一块，你又叨叨了一次，又给了一块。<br>第三次叨叨的时候，妈妈就不太高兴了，你已经吃了 2 块了，剩下的巧克力要等小朋友来吃。</p>
<p>作为一个 5 岁的宝宝，你难以接受，于是，一直跟着妈妈后面叨叨，“妈妈，我要吃巧克力，我好想吃巧克力”。</p>
<p>妈妈被你烦的不行，就妥协的说，“我定个半小时的计时器，计时结束就给你一块，还想要的话，那我们再设置半小时定时器”。<br>于是，妈妈就<strong>设置</strong>了半小时定时器~</p>
<p>但是你只是 5 岁的宝宝啊，心里还是很想很想吃，于是，还是在后面叨叨，但妈妈<strong>无视</strong>你，带上耳塞了。<br>半小时<strong>计时结束</strong>，计时器响了，妈妈果然就<strong>给</strong>你一块了！</p>
<p>吃完之后，你又去叨叨了，于是妈妈<strong>重新设置</strong>了半小时的定时器。</p>
<h2 id="节流-throttle"><a href="#节流-throttle" class="headerlink" title="节流 throttle"></a>节流 throttle</h2><p>好，现在来根据上面的例子，说说妈妈的策略</p>
<p>你一直跟妈妈要巧克力，如果说一次就给一次，妈妈就要给你无数个巧克力，显然妈妈觉得很累。</p>
<p>于是妈妈拿了个定时器，你叨叨的时候，如果定时器还在计时，就无视你，如果计时器不在计时的话，重新计时。计时结束就给一次。</p>
<p>这样大大减少了满足的频次。</p>
<p>现在切换角色，你是开发者，网页里有个查询的按钮，每次点击就会请求接口，返回新的查询数据。</p>
<p>但有些用户（测试），可能无聊，一直点着查询提交按钮，一秒点个十次，服务器就得返回十次数据。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  let times = 0;</span></span><br><span class="line"><span class="undefined">  const fn = () =&gt;</span></span><br><span class="line"><span class="undefined">    console.log(`发送请求$&#123;++times&#125;次`, new Date().toLocaleTimeString());</span></span><br><span class="line"><span class="undefined">  btn.onclick = fn;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e666e65b01fc444d898b262fd0e5ab78~tplv-k3u1fbpfcp-zoom-1.image" alt="debouce_throttle1"></p>
<p>测试就来找你了，“老铁，控制下频次，一秒发一次请求吧”。</p>
<p>这时候，就是节流，你不一定需要记住名词，但你记得怎么控制就行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> times = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> fn = <span class="built_in">console</span>.log(<span class="string">`发送请求<span class="subst">$&#123;++times&#125;</span>次`</span>, <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿一个计时器</span></span><br><span class="line"><span class="keyword">var</span> timer;</span><br><span class="line"><span class="comment">/* 这里的点击就相当于是叨叨要巧克力</span></span><br><span class="line"><span class="comment"> * 每次叨叨的时候，看下计时器在不在计时，</span></span><br><span class="line"><span class="comment"> * 如果正在计时的话，就无视</span></span><br><span class="line"><span class="comment"> * 如果不在计时的话，就重新开始计时</span></span><br><span class="line"><span class="comment"> * 计时结束，妈妈会主动给巧克力，然后关掉计时器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">btn.onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 计时器还在计时，就无视</span></span><br><span class="line">  <span class="keyword">if</span> (timer) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 计时器不在计时，就重新开始计时</span></span><br><span class="line">  timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 计时结束的时候，妈妈主动给巧克力，然后关掉计时器</span></span><br><span class="line">    fn();</span><br><span class="line">    timer = <span class="literal">null</span>;</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="节流的通用版"><a href="#节流的通用版" class="headerlink" title="节流的通用版"></a>节流的通用版</h2><p>把后面的函数用另外一个函数生成，就成了节流的简短版</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">fn, delay</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 拿一个计时器</span></span><br><span class="line">  <span class="keyword">var</span> timer;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 计时器还在计时，就无视</span></span><br><span class="line">    <span class="keyword">if</span> (timer) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计时器不在计时，就重新开始计时</span></span><br><span class="line">    timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 计时结束的时候，妈妈主动给巧克力，然后关掉计时器</span></span><br><span class="line">      fn(...args);</span><br><span class="line">      timer = <span class="literal">null</span>;</span><br><span class="line">    &#125;, delay);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">btn.onclick = throttle(fn, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f6cdae0110440519c32f2c531f60b77~tplv-k3u1fbpfcp-zoom-1.image" alt="debouce_throttle2"></p>
<h2 id="防抖"><a href="#防抖" class="headerlink" title="防抖"></a>防抖</h2><p>重新回到情境里，你已经连续两个小时都在叨叨了，妈妈想要清净会，于是改了主意~</p>
<p>“这是个定时器，如果你叨叨的话，我就重新开始计时；计时结束，我就给你一个巧克力”</p>
<p>你一听这话，就赶紧闭嘴了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> times = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> fn = <span class="built_in">console</span>.log(<span class="string">`发送请求<span class="subst">$&#123;++times&#125;</span>次`</span>, <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿一个计时器</span></span><br><span class="line"><span class="keyword">var</span> timer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 这里的点击就相当于是叨叨要巧克力</span></span><br><span class="line"><span class="comment"> * 每次叨叨的时候，计时器就重新计时</span></span><br><span class="line"><span class="comment"> * 计时结束，妈妈会主动给巧克力</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">btn.onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 只要叨叨，就重新计时</span></span><br><span class="line">  timer &amp;&amp; clearTimeout(timer);</span><br><span class="line">  timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 计时结束，妈妈主动给巧克力，关掉计时器</span></span><br><span class="line">    fn();</span><br><span class="line">    timer = <span class="literal">null</span>;</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3d800242940e4d938dbdba70f6a92587~tplv-k3u1fbpfcp-zoom-1.image" alt="debouce_throttle4"></p>
<p>这就是防抖，叨叨就重新计时，闭嘴了一段时间，才会给巧克力</p>
<h2 id="防抖的通用版"><a href="#防抖的通用版" class="headerlink" title="防抖的通用版"></a>防抖的通用版</h2><p>同理，把后面的函数用另外一个函数生成，就成了防抖的简短版</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">fn, delay</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 拿一个计时器</span></span><br><span class="line">  <span class="keyword">var</span> timer = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 只要叨叨，就重新计时</span></span><br><span class="line">    timer &amp;&amp; clearTimeout(timer);</span><br><span class="line">    timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 计时结束，妈妈主动给巧克力，关掉计时器</span></span><br><span class="line">      fn(...args);</span><br><span class="line">      timer = <span class="literal">null</span>;</span><br><span class="line">    &#125;, delay);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">btn.onclick = debounce(fn, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<h2 id="防抖和节流的异同"><a href="#防抖和节流的异同" class="headerlink" title="防抖和节流的异同"></a>防抖和节流的异同</h2><p>其实通过上面的情景，我觉得你基本能感受到了这两的异同点。</p>
<p>原始情况：只要叨叨，就满足要求。<br>缺点就是：满足的太频繁。</p>
<p>现在用节流和防抖的话：</p>
<ul>
<li>节流是拿一个定时器，你叨叨的时候，如果计时器还在计时的话，就无视；如果不在计时的话，就开始计时；<br>计时结束，主动满足要求。<br>结果就是：你一直叨叨的话，显然每隔一段时间，你就能满足要求</li>
<li>防抖是拿一个定时器，你叨叨的时候，就重新计时；<br>计时结束，主动满足要求。<br>结果就是：你一直叨叨的话，显示不会被满足要求，只有停止叨叨，隔一段时间才会被满足要求</li>
</ul>
<p>相同点：都拿个计时器，计时结束，主动满足要求。<br>不同点：叨叨的时候，<strong>隔段时间就满足</strong>要求 还是 <strong>停止叨叨</strong>隔段时间之后，才满足要求。</p>
<h2 id="怎么选择呢"><a href="#怎么选择呢" class="headerlink" title="怎么选择呢"></a>怎么选择呢</h2><p>其实想选择哪个，看业务情况和你的心情了！</p>
<p>比如，页面滚动的时候，你想实时知道滚动的高度，但这个实时其实没必要到 10 毫秒的程度，那就想着 50 毫秒获取一次，也就是页面在滚动的时候，你希望每隔 50ms 就获取一次，那就显然是节流~</p>
<p>如果你是希望，页面停止滚动的时候，才需要获取，那就显然是防抖~</p>
<p>滚动可以类比为，一直叨叨要巧克力，获取页面高度相当于给巧克力满足你~</p>
<p>如果没有特别的需求只是单纯的想控制获取次数，随你开心啦~~</p>
<p>常用的场景：</p>
<ul>
<li>点击按钮发请求的时候</li>
<li>页面滚动的时候</li>
<li>用户在输入文字实时发请求的时候</li>
</ul>
<h2 id="怎么记忆不混淆"><a href="#怎么记忆不混淆" class="headerlink" title="怎么记忆不混淆"></a>怎么记忆不混淆</h2><p>防抖就理解为，防止你嘴唇不停的抖动，只有不抖了，隔段时间才满足。<br>知道了防抖，另一个就是节流了。</p>
<h2 id="实际怎么使用"><a href="#实际怎么使用" class="headerlink" title="实际怎么使用"></a>实际怎么使用</h2><p>虽然简版的能满足一些场景，但一般不建议使用自己手写的，你知道这么个逻辑就行<br>实际使用的时候，直接使用库里封装好的比较稳妥，以<code>lodash</code>为例:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// npm i lodash 或者 https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js</span></span><br><span class="line">btn.onclick = _.throttle(fn, <span class="number">1000</span>);</span><br><span class="line">btn.onclick = _.debounce(fn, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<p>这里额外注意两个参数：</p>
<ul>
<li>leading，表示开始计时之前，要不要先给你一个巧克力，默认是 false，也就是计时开始之前不给巧克力</li>
<li>trailing，表示计时结束，要不要给你巧克力，默认是 true，也就是计时结束给巧克力</li>
</ul>
<p>这两个参数，根据场景使用，文中的例子就是默认的情况，其他的情况，同理知道，不再细说~</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://www.telerik.com/blogs/debouncing-and-throttling-in-javascript" target="_blank" rel="noopener">debouncing-and-throttling-in-javascript</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/16/vue_8_source_code_mvvm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/08/16/vue_8_source_code_mvvm/" itemprop="url">
                  依赖收集和派发更新 - 学习vue源码系列4.2
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-08-16T09:09:38+08:00">
                2021-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/08/16/vue_8_source_code_mvvm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/08/16/vue_8_source_code_mvvm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>决定跟着<a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码课程</a>好好学习下<code>vue2</code>的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~</p>
<p>将<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue 的源码</a>clone 到本地，切换到分支<code>2.6</code>。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p><code>vue</code>把<code>data</code>变成响应式的目的，就是为了在<code>getter</code>里收集依赖，<code>setter</code>里派发更新。</p>
<p>说人话，就是在<code>getter</code>里将渲染的函数存起来，<code>setter</code>里触发渲染的函数。</p>
<h2 id="简版的-vue：初次渲染"><a href="#简版的-vue：初次渲染" class="headerlink" title="简版的 vue：初次渲染"></a>简版的 vue：初次渲染</h2><p>简版的 vue，做了这几个事：</p>
<ul>
<li>让<code>data</code>变成响应式对象</li>
<li>通过<code>proxy</code>让<code>data</code>上面的属性挂载到实例上</li>
<li>初次渲染</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    function Vue(options) &#123;</span></span><br><span class="line"><span class="undefined">      this.$options = options;</span></span><br><span class="line"><span class="undefined">      this.$el = options.el;</span></span><br><span class="line"><span class="undefined">      // vm变成响应式对象</span></span><br><span class="line"><span class="undefined">      observe(options.data);</span></span><br><span class="line"><span class="undefined">      // data挂载到vm上</span></span><br><span class="line"><span class="undefined">      proxy(this, this.$options.data);</span></span><br><span class="line"><span class="undefined">      // 初次渲染</span></span><br><span class="line"><span class="undefined">      this._update();</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    Vue.prototype._update = function () &#123;</span></span><br><span class="line"><span class="undefined">      const el = document.querySelector(this.$el);</span></span><br><span class="line"><span class="undefined">      el.children[0].innerText = this.message;</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    function observe(obj) &#123;</span></span><br><span class="line"><span class="undefined">      Object.keys(obj).forEach((key) =&gt; defineReactive(obj, key));</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    function defineReactive(obj, key) &#123;</span></span><br><span class="line"><span class="undefined">      let val = obj[key];</span></span><br><span class="line"><span class="undefined">      Object.defineProperty(obj, key, &#123;</span></span><br><span class="line"><span class="undefined">        enumerable: true,</span></span><br><span class="line"><span class="undefined">        configurable: true,</span></span><br><span class="line"><span class="undefined">        get() &#123;</span></span><br><span class="line"><span class="undefined">          return val;</span></span><br><span class="line"><span class="undefined">        &#125;,</span></span><br><span class="line"><span class="undefined">        set(newValue) &#123;</span></span><br><span class="line"><span class="undefined">          val = newValue;</span></span><br><span class="line"><span class="undefined">        &#125;,</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    function proxy(target, source) &#123;</span></span><br><span class="line"><span class="undefined">      Object.keys(source).forEach((key) =&gt; &#123;</span></span><br><span class="line"><span class="undefined">        Object.defineProperty(target, key, &#123;</span></span><br><span class="line"><span class="undefined">          enumerable: true,</span></span><br><span class="line"><span class="undefined">          configurable: true,</span></span><br><span class="line"><span class="undefined">          get() &#123;</span></span><br><span class="line"><span class="undefined">            return source[key];</span></span><br><span class="line"><span class="undefined">          &#125;,</span></span><br><span class="line"><span class="undefined">          set(newValue) &#123;</span></span><br><span class="line"><span class="undefined">            source[key] = newValue;</span></span><br><span class="line"><span class="undefined">          &#125;,</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    const vm = new Vue(&#123;</span></span><br><span class="line"><span class="undefined">      el: "#app",</span></span><br><span class="line"><span class="undefined">      data: &#123;</span></span><br><span class="line"><span class="undefined">        message: "hi",</span></span><br><span class="line"><span class="undefined">      &#125;,</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/mvvm_1.png" alt="mvvm_1"></p>
<h2 id="增加数据变化的更新"><a href="#增加数据变化的更新" class="headerlink" title="增加数据变化的更新"></a>增加数据变化的更新</h2><p><code>data</code>发生变化之后，<code>set</code>里就必须再次触发<code>_this.update()</code>，但因为<code>set</code>并不能直接拿到<code>update</code>，所以需要存储下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span>&gt;</span>change<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  let update = null</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  function Vue(options) &#123;</span></span><br><span class="line"><span class="undefined">    // ...</span></span><br><span class="line"><span class="undefined">    this._update();</span></span><br><span class="line"><span class="undefined">    update = this._update.bind(this)</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">  // defineReactive</span></span><br><span class="line"><span class="undefined">  set(newValue) &#123;</span></span><br><span class="line"><span class="undefined">    val = newValue;</span></span><br><span class="line"><span class="undefined">    update()</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  const vm = new Vue(&#123;</span></span><br><span class="line"><span class="undefined">    el: "#app",</span></span><br><span class="line"><span class="undefined">    data: &#123;</span></span><br><span class="line"><span class="undefined">      message: "hi",</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined">  document.querySelector(".btn").onclick = function () &#123;</span></span><br><span class="line"><span class="undefined">    vm.message = Math.random();</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/mvvm_2.gif" alt="mvvm_2"></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码解密课程</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/reactive/getters.html#dep" target="_blank" rel="noopener">vue.js 技术揭秘</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/10/class_id/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/08/10/class_id/" itemprop="url">
                  给每个实例分配唯一id
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-08-10T16:56:38+08:00">
                2021-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/08/10/class_id/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/08/10/class_id/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>学习<code>vue</code>源码的过程中，发现尤大经常给类的实例加上了唯一的<code>id</code>，后期判断或者添加的时候非常便捷，我觉得是个很好的技巧，本文就说下这个小技巧。</p>
<h2 id="怎么分配id"><a href="#怎么分配id" class="headerlink" title="怎么分配id"></a>怎么分配id</h2><p>其实分配<code>id</code>，操作起来很简单，如下所示就搞定了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = ++id</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &#123;id:1&#125;,&#123;id:2&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> Dog,<span class="keyword">new</span> Dog)</span><br></pre></td></tr></table></figure>
<h2 id="分配id的好处"><a href="#分配id的好处" class="headerlink" title="分配id的好处"></a>分配id的好处</h2><p>分配id的好处，当有个列表里面装很多实例的时候，</p>
<ul>
<li>方便去重</li>
<li>方便判断某个实例在不在其中</li>
<li>即便所有的属性相同，但<code>id</code>始终是不同的，方便调试</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个人可能养好几只狗</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.dogs = []</span><br><span class="line">    <span class="keyword">this</span>.dogsId = []</span><br><span class="line">  &#125;</span><br><span class="line">  addDog(dog)&#123;</span><br><span class="line">    <span class="keyword">const</span> hasDog = <span class="keyword">this</span>.dogsId.includes(dog.id)</span><br><span class="line">    <span class="keyword">if</span>(!hasDog)&#123;</span><br><span class="line">      <span class="keyword">this</span>.dogs.push(dog)</span><br><span class="line">      <span class="keyword">this</span>.dogsId.push(dog.id)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dog1 = <span class="keyword">new</span> Dog()</span><br><span class="line"><span class="keyword">const</span> dog1Copy = &#123;...dog1&#125;</span><br><span class="line"><span class="keyword">const</span> person1 = <span class="keyword">new</span> Person()</span><br><span class="line">person1.addDog(dog1)</span><br><span class="line">person1.addDog(dog1)</span><br><span class="line">person1.addDog(dog1Copy)</span><br><span class="line"><span class="comment">// &#123;dogs:[dog1],dogIds:[1]&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(person1)</span><br></pre></td></tr></table></figure>
<p>这里如果有基础的话，就会知道在没有id的情况下，也可以<code>this.dogs.include(dog)</code>，这种缺点是没那么直观，复制的话，也不会区别。</p>
<h2 id="分配id的场景"><a href="#分配id的场景" class="headerlink" title="分配id的场景"></a>分配id的场景</h2><p>当然不需要列表存实例的话，其实不需要增加id的。</p>
<p>只有一些特定的场景，需要实例列表，而且强调唯一性的话，就可以考虑下。</p>
<p>这边看下<code>vue</code>这边的id使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = uid++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.newDepIds = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">    <span class="keyword">this</span>.newDeps = []</span><br><span class="line">  &#125;</span><br><span class="line">  addDep (dep) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = dep.id</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.newDepIds.has(id)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.newDepIds.add(id)</span><br><span class="line">      <span class="keyword">this</span>.newDeps.push(dep)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/03/vue_6_source_code_reactive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/08/03/vue_6_source_code_reactive/" itemprop="url">
                  响应式原理 - 学习vue源码系列4.2
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-08-03T18:26:28+08:00">
                2021-08-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/08/03/vue_6_source_code_reactive/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/08/03/vue_6_source_code_reactive/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>决定跟着<a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码课程</a>好好学习下<code>vue2</code>的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~</p>
<p>将<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue 的源码</a>clone 到本地，切换到分支<code>2.6</code>。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>前面说了，vue 是怎么实现<strong>初始化</strong>数据渲染和组件化的，但当数据变动的时候，dom 又是怎么更新的呢。</p>
<h2 id="先看个-demo"><a href="#先看个-demo" class="headerlink" title="先看个 demo"></a>先看个 demo</h2><p>数据变更:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>假设希望点击之后能将<code>hello</code>变成<code>hello world</code>的话，寻常怎么操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.修改数据</span></span><br><span class="line"><span class="keyword">const</span> text = <span class="string">"hello world"</span>;</span><br><span class="line"><span class="comment">// 2.获取dom，监听事件</span></span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>).onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 3.手动操作dom重新渲染</span></span><br><span class="line">  app.innerHTML = text;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如果需要多次修改的话，就不得不<strong>每次</strong>都手动操作 dom，重新渲染。</p>
<p>而 vue，去掉了<code>手动操作dom</code>，根据数据变化<strong>自动</strong>操作 dom。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span> @<span class="attr">click</span>=<span class="string">"changeMsg"</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/Users/zhm/mygit/vue/dist/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">"#app"</span>,</span></span><br><span class="line"><span class="undefined">    data: &#123;</span></span><br><span class="line"><span class="javascript">      message: <span class="string">"Hello Vue!"</span>,</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    methods: &#123;</span></span><br><span class="line"><span class="undefined">      changeMsg() &#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 这边只是 改变了数据，其余的由vue本身去更新dom，重新渲染</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">this</span>.message = <span class="string">"Hello World!"</span>;</span></span><br><span class="line"><span class="undefined">      &#125;,</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="响应式对象"><a href="#响应式对象" class="headerlink" title="响应式对象"></a>响应式对象</h2><p>其实<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener"><code>Object.defineProperty</code></a>应该都听过了，嗯，主要就是用这个属性。</p>
<p>普通获取对象属性，设置对象属性都可以用这个，但是比较麻烦，所以一般分场景使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 普通创建属性的方式： **/</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** defineProperty创建、获取和设置属性的方式： **/</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="comment">// ！注意需要另设一个变量，存储属性的值。</span></span><br><span class="line"><span class="keyword">let</span> value = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(obj, <span class="string">"a"</span>, &#123;</span><br><span class="line">  get() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"get"</span>);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;,</span><br><span class="line">  set(newValue) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"set"</span>);</span><br><span class="line">    value = newValue;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 当然获取属性和设置的话，是一样的 */</span></span><br><span class="line"><span class="comment">// 获取</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a);</span><br><span class="line"><span class="comment">// 设置</span></span><br><span class="line">obj.a = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/reactive_1.png" alt="reactive_1"></p>
<p><code>Object.defineProperty</code>的核心就是<code>get</code>和<code>set</code>，因为是函数，所以能做很多事。</p>
<p>所谓的劫持，每次<strong>获取/设置</strong>属性的时候，都会执行<code>get/set</code>函数，既然是函数，自然能做一些别的事情。</p>
<blockquote>
<p>所谓的响应式对象，当对象的某属性有<code>get/set</code>，就称为响应式对象。</p>
</blockquote>
<h2 id="简版的响应式Vue"><a href="#简版的响应式Vue" class="headerlink" title="简版的响应式Vue"></a>简版的响应式Vue</h2><p>先写个简版的响应式<code>Vue</code>，大致有个印象，真实的源码处理的情景比较多，看懂简版的，再看源码，不容易迷路。。。</p>
<p>主要做了以下几件事：</p>
<ul>
<li>用<code>vm._data</code>指向<code>options.data</code></li>
<li>将<code>vm._data</code>上面的属性都代理到<code>vm</code>上</li>
<li><code>vm._data.__ob__</code>指向Observer实例，而这个实例的value是data的响应式</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(&#123; <span class="attr">data</span>: &#123; <span class="attr">a</span>: <span class="number">1</span> &#125; &#125;);</span><br><span class="line"><span class="built_in">console</span>.dir(vm);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.vm = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">this</span>.$options = options;</span><br><span class="line">  <span class="comment">/* this._init() initState()开始 */</span></span><br><span class="line">  initData(<span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">/* this._init() initState()结束 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.$options.data;</span><br><span class="line">  vm._data = data;</span><br><span class="line">  <span class="comment">// 将data上面的属性直接挂在vm上</span></span><br><span class="line">  <span class="built_in">Object</span>.keys(data).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* proxy(vm, "_data", key) 开始 */</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(vm, key, &#123;</span><br><span class="line">      enumerable: <span class="literal">true</span>,</span><br><span class="line">      configurable: <span class="literal">true</span>,</span><br><span class="line">      get() &#123;</span><br><span class="line">        <span class="keyword">return</span> vm._data[key];</span><br><span class="line">      &#125;,</span><br><span class="line">      set(newValue) &#123;</span><br><span class="line">        vm.data[key] = newValue;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">/* proxy(vm, "_data", key) 结束 */</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* observe(data) 开始 */</span></span><br><span class="line">  data.__ob__ = data.__ob__ || <span class="keyword">new</span> Observer(data);</span><br><span class="line">  <span class="comment">/* observe(data) 结束 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Observer</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.value = data;</span><br><span class="line">  <span class="comment">// this.dep = new Dep();</span></span><br><span class="line">  data.__ob__ = <span class="keyword">this</span>;</span><br><span class="line">  <span class="built_in">Object</span>.keys(data).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    defineReactive(data, key);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// defineReactive将 obj.x 这种定义属性的方式  变成Object.defineProperty(obj, 'x' , &#123;get()&#123;&#125;&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">data, key</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// const dep = new Dep();</span></span><br><span class="line">  <span class="keyword">let</span> value = data[key];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(data, key, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// dep.depend();</span></span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span> <span class="title">reactiveSetter</span>(<span class="params">newValue</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// dep.notify();</span></span><br><span class="line">      value = newValue;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/reactive_2.png" alt="reactive_2"></p>
<h2 id="initState"><a href="#initState" class="headerlink" title="initState"></a>initState</h2><p>Vue 的构造函数，开始就是<code>this._init(..)</code>，而<code>Vue.prototype._init = function(){initState(this)}</code>。</p>
<p>这里的<code>initState</code>就是让<code>Vue</code>的<strong>实例</strong>变成响应式对象的关键，这个方法就是对<code>options</code>进行各种初始化的操作，而本文的重点是对<code>data/props</code>的处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/state.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initState</span>(<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._watchers = [];</span><br><span class="line">  <span class="keyword">const</span> opts = vm.$options;</span><br><span class="line">  <span class="keyword">if</span> (opts.props) initProps(vm, opts.props);</span><br><span class="line">  <span class="keyword">if</span> (opts.methods) initMethods(vm, opts.methods);</span><br><span class="line">  <span class="keyword">if</span> (opts.data) &#123;</span><br><span class="line">    initData(vm);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    observe((vm._data = &#123;&#125;), <span class="literal">true</span> <span class="comment">/* asRootData */</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.computed) initComputed(vm, opts.computed);</span><br><span class="line">  <span class="keyword">if</span> (opts.watch &amp;&amp; opts.watch !== nativeWatch) &#123;</span><br><span class="line">    initWatch(vm, opts.watch);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="props-的处理"><a href="#props-的处理" class="headerlink" title="props 的处理"></a>props 的处理</h3><p>先看<code>initProps</code>，主要其实就是</p>
<ul>
<li>遍历<code>options.props</code></li>
<li>每个 prop 变成响应式（set/get），且每个 prop，也同步到<code>vm._props.xx</code></li>
<li>通过<code>proxy</code>把<code>vm._props.xxx</code> 的访问代理到 <code>vm.xxx</code> 上</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/state.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initProps</span>(<span class="params">vm: Component, propsOptions: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> propsData = vm.$options.propsData || &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> props = (vm._props = &#123;&#125;);</span><br><span class="line">  <span class="comment">// cache prop keys so that future props updates can iterate using Array</span></span><br><span class="line">  <span class="comment">// instead of dynamic object key enumeration.</span></span><br><span class="line">  <span class="keyword">const</span> keys = (vm.$options._propKeys = []);</span><br><span class="line">  <span class="keyword">const</span> isRoot = !vm.$parent;</span><br><span class="line">  <span class="comment">// root instance props should be converted</span></span><br><span class="line">  <span class="keyword">if</span> (!isRoot) &#123;</span><br><span class="line">    toggleObserving(<span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> propsOptions) &#123;</span><br><span class="line">    keys.push(key);</span><br><span class="line">    <span class="keyword">const</span> value = validateProp(key, propsOptions, propsData, vm);</span><br><span class="line">    defineReactive(props, key, value);</span><br><span class="line">    <span class="comment">// static props are already proxied on the component's prototype</span></span><br><span class="line">    <span class="comment">// during Vue.extend(). We only need to proxy props defined at</span></span><br><span class="line">    <span class="comment">// instantiation here.</span></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      proxy(vm, <span class="string">`_props`</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  toggleObserving(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="data-的处理"><a href="#data-的处理" class="headerlink" title="data 的处理"></a>data 的处理</h3><p>data 的初始化也做了两件事：</p>
<ul>
<li>遍历<code>data</code>对象，每一个<code>vm._data.xx</code>通过<code>proxy</code>代理到<code>vm._data</code></li>
<li>调用<code>observe</code>观察<code>data</code>变化，将其也变成响应式</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/state.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span>(<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.$options.data;</span><br><span class="line">  data = vm._data = <span class="keyword">typeof</span> data === <span class="string">"function"</span> ? getData(data, vm) : data || &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (!isPlainObject(data)) &#123;</span><br><span class="line">    data = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// proxy data on instance</span></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(data);</span><br><span class="line">  <span class="keyword">const</span> props = vm.$options.props;</span><br><span class="line">  <span class="keyword">const</span> methods = vm.$options.methods;</span><br><span class="line">  <span class="keyword">let</span> i = keys.length;</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i];</span><br><span class="line">    <span class="keyword">if</span> (!isReserved(key)) &#123;</span><br><span class="line">      proxy(vm, <span class="string">`_data`</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// observe data</span></span><br><span class="line">  observe(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="proxy-代理"><a href="#proxy-代理" class="headerlink" title="proxy 代理"></a>proxy 代理</h2><p>初始化 data 和 props 一个关键操作，就是让他们变成响应式，然后代理到<code>vm</code>上。</p>
<p>代理？其实就是就是一个中介。本身只是一个线索，会连接到真实的资源。</p>
<p>举个例子，看下面的<code>obj</code>，有个<code>data</code>属性，现在想<code>obj.a</code>也可以访问到 a 属性，怎么办？</p>
<p>此时<code>obj.a</code>就是一个中介，其真实连接的资源是<code>obj.data.a</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">data</span>: &#123; <span class="attr">a</span>: <span class="number">1</span> &#125; &#125;;</span><br></pre></td></tr></table></figure>
<p>其实还是利用上面的<code>Object.defineProperty</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperty(obj, <span class="string">"a"</span>, &#123;</span><br><span class="line">  get() &#123;</span><br><span class="line">    <span class="comment">// 这里的obj.data.a就相当于存储变量</span></span><br><span class="line">    <span class="keyword">return</span> obj.data.a;</span><br><span class="line">  &#125;,</span><br><span class="line">  set(newValue) &#123;</span><br><span class="line">    obj.data.a = newValue;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a);</span><br></pre></td></tr></table></figure>
<p>现在看源码里，对于<code>proxy</code>的实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/state.js</span></span><br><span class="line"><span class="comment">// const noop = function empty()&#123;&#125;</span></span><br><span class="line"><span class="keyword">const</span> sharedPropertyDefinition = &#123;</span><br><span class="line">  enumerable: <span class="literal">true</span>,</span><br><span class="line">  configurable: <span class="literal">true</span>,</span><br><span class="line">  get: noop,</span><br><span class="line">  set: noop,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// target相当于obj，sourceKey相当于data，key相当于a</span></span><br><span class="line"><span class="comment">// proxy就是可以让vm.x 代理到 vm.data.x</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">target: Object, sourceKey: string, key: string</span>) </span>&#123;</span><br><span class="line">  sharedPropertyDefinition.get = <span class="function"><span class="keyword">function</span> <span class="title">proxyGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[sourceKey][key];</span><br><span class="line">  &#125;;</span><br><span class="line">  sharedPropertyDefinition.set = <span class="function"><span class="keyword">function</span> <span class="title">proxySetter</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>[sourceKey][key] = val;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="observe：给增加一个-Observer-实例"><a href="#observe：给增加一个-Observer-实例" class="headerlink" title="observe：给增加一个 Observer 实例"></a>observe：给增加一个 Observer 实例</h2><p><code>observe</code> 的功能就是用来监测数据的变化，给非 <code>VNode</code> 的对象类型数据添加一个 <code>Observer</code>，如果已经添加过则直接返回，否则在满足一定条件下去实例化一个 <code>Observer</code> 对象实例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">value: any, asRootData: ?boolean</span>): <span class="title">Observer</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(value) || value <span class="keyword">instanceof</span> VNode) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> ob: Observer | <span class="keyword">void</span>;</span><br><span class="line">  <span class="keyword">if</span> (hasOwn(value, <span class="string">"__ob__"</span>) &amp;&amp; value.__ob__ <span class="keyword">instanceof</span> Observer) &#123;</span><br><span class="line">    ob = value.__ob__;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !isServerRendering() &amp;&amp;</span><br><span class="line">    (<span class="built_in">Array</span>.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">    <span class="built_in">Object</span>.isExtensible(value) &amp;&amp;</span><br><span class="line">    !value._isVue</span><br><span class="line">  ) &#123;</span><br><span class="line">    ob = <span class="keyword">new</span> Observer(value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.vmCount++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Observer-类：给对象的每个属性添加-getter-和-setter"><a href="#Observer-类：给对象的每个属性添加-getter-和-setter" class="headerlink" title="Observer 类：给对象的每个属性添加 getter 和 setter"></a>Observer 类：给对象的每个属性添加 getter 和 setter</h2><p><code>Observer</code> 是一个类，它的作用是给对象的属性添加 getter 和 setter，用于依赖收集和派发更新：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Observer class that is attached to each observed</span></span><br><span class="line"><span class="comment"> * object. Once attached, the observer converts the target</span></span><br><span class="line"><span class="comment"> * object's property keys into getter/setters that</span></span><br><span class="line"><span class="comment"> * collect dependencies and dispatch updates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  value: any;</span><br><span class="line">  dep: Dep;</span><br><span class="line">  vmCount: number; <span class="comment">// number of vms that has this object as root $data</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(value: any) &#123;</span><br><span class="line">    <span class="keyword">this</span>.value = value;</span><br><span class="line">    <span class="comment">// 实例化 Dep 对象</span></span><br><span class="line">    <span class="keyword">this</span>.dep = <span class="keyword">new</span> Dep();</span><br><span class="line">    <span class="keyword">this</span>.vmCount = <span class="number">0</span>;</span><br><span class="line">    def(value, <span class="string">"__ob__"</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">      <span class="keyword">const</span> augment = hasProto ? protoAugment : copyAugment;</span><br><span class="line">      augment(value, arrayMethods, arrayKeys);</span><br><span class="line">      <span class="keyword">this</span>.observeArray(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.walk(value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Walk through each property and convert them into</span></span><br><span class="line"><span class="comment">   * getter/setters. This method should only be called when</span></span><br><span class="line"><span class="comment">   * value type is Object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  walk(obj: <span class="built_in">Object</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">      defineReactive(obj, keys[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Observe a list of Array items.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  observeArray(items: <span class="built_in">Array</span>&lt;any&gt;) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.length; i &lt; l; i++) &#123;</span><br><span class="line">      observe(items[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Observer</code> 的构造函数逻辑很简单:</p>
<ul>
<li>实例化 <code>Dep</code> 对象，</li>
<li>通过执行 <code>def</code> 函数把自身实例添加到数据对象 <code>value</code> 的 <code>__ob__</code> 属性上</li>
</ul>
<p><code>def</code>就是给一个对象，定义一个属性，设置一个属性值，默认此属性是不可遍历的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// def的定义</span></span><br><span class="line"><span class="comment">// src/core/util/lang.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">def</span>(<span class="params">obj: Object, key: string, val: any, enumerable?: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    value: val,</span><br><span class="line">    enumerable: !!enumerable,</span><br><span class="line">    writable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>def</code>相当于<code>Object.defineProperty</code>的简单封装。</p>
<h2 id="defineReactive：给对象的某个属性动态添加-getter-和-setter"><a href="#defineReactive：给对象的某个属性动态添加-getter-和-setter" class="headerlink" title="defineReactive：给对象的某个属性动态添加 getter 和 setter"></a>defineReactive：给对象的某个属性动态添加 getter 和 setter</h2><p><code>defineReactive</code> 的功能就是给对象动态添加 <code>getter</code> 和 <code>setter</code>，让对象成为响应式对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/index.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define a reactive property on an Object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  obj: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  customSetter?: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  shallow?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化 Dep 对象的实例</span></span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep();</span><br><span class="line">  <span class="comment">// 拿到 obj 的属性描述符</span></span><br><span class="line">  <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, key);</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.configurable === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cater for pre-defined getter/setters</span></span><br><span class="line">  <span class="keyword">const</span> getter = property &amp;&amp; property.get;</span><br><span class="line">  <span class="keyword">const</span> setter = property &amp;&amp; property.set;</span><br><span class="line">  <span class="keyword">if</span> ((!getter || setter) &amp;&amp; <span class="built_in">arguments</span>.length === <span class="number">2</span>) &#123;</span><br><span class="line">    val = obj[key];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> childOb = !shallow &amp;&amp; observe(val);</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val;</span><br><span class="line">      <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">        dep.depend();</span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.dep.depend();</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">            dependArray(value);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span> <span class="title">reactiveSetter</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val;</span><br><span class="line">      <span class="comment">/* eslint-disable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* eslint-enable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">        customSetter();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        setter.call(obj, newVal);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal;</span><br><span class="line">      &#125;</span><br><span class="line">      childOb = !shallow &amp;&amp; observe(newVal);</span><br><span class="line">      dep.notify();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>defineReactive</code> 函数：</p>
<ul>
<li>最开始初始化 <code>Dep</code> 对象的实例，</li>
<li>接着拿到 <code>obj</code> 的属性描述符，</li>
<li>然后对子对象递归调用 <code>observe</code>方法</li>
</ul>
<p>这样就保证了无论 <code>obj</code> 的结构多复杂，它的所有子属性也能变成响应式的对象，<br>这样我们访问或修改 <code>obj</code> 中一个嵌套较深的属性，也能触发 <code>getter</code> 和 <code>setter</code>。</p>
<p>最后利用 <code>Object.defineProperty</code> 去给 <code>obj</code> 的属性 <code>key</code> 添加 <code>getter</code> 和 <code>setter</code>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>响应式对象，核心就是利用 <code>Object.defineProperty</code> 给数据添加了 <code>getter</code> 和 <code>setter</code>。<br>这样在访问数据以及写数据的时候能自动执行一些逻辑：</p>
<ul>
<li><code>getter</code> 做的事情是依赖收集</li>
<li><code>setter</code> 做的事情是派发更新</li>
</ul>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码解密课程</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/reactive/reactive-object.html" target="_blank" rel="noopener">vue.js 技术揭秘</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/29/vue_5_source_code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/29/vue_5_source_code/" itemprop="url">
                  组件注册 - 学习vue源码系列3.4
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-29T15:29:33+08:00">
                2021-07-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/29/vue_5_source_code/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/29/vue_5_source_code/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>决定跟着<a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码课程</a>好好学习下<code>vue2</code>的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~</p>
<p>将<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue 的源码</a>clone 到本地，切换到分支<code>2.6</code>。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>vue 中除了内置组件<code>keep-alive</code>等，其他组件必须先注册才能使用，不然就会报错<code>Unknown custom element...</code></p>
<p>vue 有两种注册方式：</p>
<ul>
<li>全局注册</li>
<li>局部注册</li>
</ul>
<h2 id="先看个-demo"><a href="#先看个-demo" class="headerlink" title="先看个 demo"></a>先看个 demo</h2><p>组件的两种注册和使用方式如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/Users/zhm/mygit/vue/dist/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 子组件</span></span><br><span class="line"><span class="undefined">  let Hello = &#123;</span></span><br><span class="line"><span class="undefined">    name: "Hello",</span></span><br><span class="line"><span class="xml">    template: "<span class="tag">&lt;<span class="name">div</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">div</span>&gt;</span>",</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 全局组件</span></span><br><span class="line"><span class="undefined">  let appComponent = &#123;</span></span><br><span class="line"><span class="undefined">    name: "app",</span></span><br><span class="line"><span class="undefined">    // 注册局部组件</span></span><br><span class="line"><span class="undefined">    components: &#123; Hello &#125;,</span></span><br><span class="line"><span class="undefined">    // 使用局部组件</span></span><br><span class="line"><span class="undefined">    template: `</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="undefined">      &#123;&#123;msg&#125;&#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">hello</span>&gt;</span><span class="tag">&lt;/<span class="name">hello</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="undefined">    `,</span></span><br><span class="line"><span class="undefined">    data: () =&gt; (&#123; msg: "App" &#125;),</span></span><br><span class="line"><span class="undefined">    created() &#123;</span></span><br><span class="line"><span class="undefined">      console.log(`组件的$options.components`, this.$options.components);</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 注册全局组件</span></span><br><span class="line"><span class="undefined">  Vue.component(appComponent.name, appComponent);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  console.log("Vue类上的options.components", Vue.options.components);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 根组件实例</span></span><br><span class="line"><span class="undefined">  let vueInstance = new Vue(&#123;</span></span><br><span class="line"><span class="undefined">    el: "#app",</span></span><br><span class="line"><span class="xml">    template: `<span class="tag">&lt;<span class="name">app</span>&gt;</span><span class="tag">&lt;/<span class="name">app</span>&gt;</span>`,</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>看下打印的结果：<br><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_component1.png" alt="vue_component1"></p>
<p>注册全局组件，使用<code>Vue.component(name,componentOptions)</code><br>注册局部组件，使用<code>{components:{hello:hello}}</code></p>
<h2 id="注册全局组件：Vue-component"><a href="#注册全局组件：Vue-component" class="headerlink" title="注册全局组件：Vue.component"></a>注册全局组件：Vue.component</h2><p>看看<code>Vue.component</code>怎么定义的，都做了啥，直接找有点难找，直接贴源码：</p>
<p><code>initAssetRegisters</code>就是在 Vue 上注册 3 个属性，<code>components/filters/directives</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/global-api/assets.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initAssetRegisters</span>(<span class="params">Vue: GlobalAPI</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Create asset registration methods.</span></span><br><span class="line"><span class="comment">   * ASSET_TYPES = [ 'component', 'directive', 'filter' ]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ASSET_TYPES.forEach(<span class="function">(<span class="params">type</span>) =&gt;</span> &#123;</span><br><span class="line">    Vue[type] = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      id: string,</span></span></span><br><span class="line"><span class="function"><span class="params">      definition: Function | Object</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>): <span class="title">Function</span> | <span class="title">Object</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!definition) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.options[type + <span class="string">"s"</span>][id];</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp; type === <span class="string">"component"</span>) &#123;</span><br><span class="line">          validateComponentName(id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">"component"</span> &amp;&amp; isPlainObject(definition)) &#123;</span><br><span class="line">          definition.name = definition.name || id;</span><br><span class="line">          definition = <span class="keyword">this</span>.options._base.extend(definition);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">"directive"</span> &amp;&amp; <span class="keyword">typeof</span> definition === <span class="string">"function"</span>) &#123;</span><br><span class="line">          definition = &#123; <span class="attr">bind</span>: definition, <span class="attr">update</span>: definition &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.options[type + <span class="string">"s"</span>][id] = definition;</span><br><span class="line">        <span class="keyword">return</span> definition;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看源码脑壳疼的地方就是，即便是简单的功能，但为了全面考虑，看起来就感觉多了一层窗户纸，模模糊糊的，上面的内容简化下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// component简写为cp</span></span><br><span class="line">Vue.components = <span class="function"><span class="keyword">function</span> (<span class="params">cpName, cpOptions</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 确保component上面有name属性</span></span><br><span class="line">  cpOptions.name = cpOptions.name | cpName;</span><br><span class="line">  <span class="comment">// Vue.extend其实将cpOptions变成一个Vue的子类.</span></span><br><span class="line">  <span class="keyword">const</span> cpClass = Vue.extend(cpOptions);</span><br><span class="line">  <span class="comment">// 所以全局组件一定在Vue.options.components里</span></span><br><span class="line">  Vue.options.components[cpName] = cpClass;</span><br><span class="line">  <span class="keyword">return</span> cpClass;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue.extend其实将cpOptions变成一个Vue的子类,简化下代码如下</span></span><br><span class="line">Vue.extend = <span class="function"><span class="keyword">function</span> (<span class="params">cpOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Sub = <span class="function"><span class="keyword">function</span> <span class="title">VueComponent</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._init(options);</span><br><span class="line">  &#125;;</span><br><span class="line">  Sub.prototype = <span class="built_in">Object</span>.create(Vue.prototype);</span><br><span class="line">  <span class="comment">// 不同的字段合并策略不一样</span></span><br><span class="line">  Sub.options = mergeOptions(Vue.options, cpOptions);</span><br><span class="line">  <span class="keyword">return</span> Sub;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>Vue.options.components[cpName] = cpClass</code>可以看到，全局组件都在<code>Vue.options.components</code>，组件名和组件类一一对应，这样使用组件的时候，就直接调出相应的组件类了。</p>
<h2 id="使用全局组件"><a href="#使用全局组件" class="headerlink" title="使用全局组件"></a>使用全局组件</h2><p>组件类的<code>options</code>上已经合并了<code>Vue.options</code>，而在组件实例化的阶段，会再次执行<code>mergeOptions</code>的操作，将<code>VueComponent.options.components</code>合并到<code>vm.$options.components</code>。</p>
<p>然后在创建 <code>vnode</code> 的过程中，会执行 <code>_createElement</code> 方法，我们再来回顾一下这部分的逻辑，它的定义在 <code>src/core/vdom/create-element.js</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">_createElement</span> (<span class="params"> context: Component, tag?: string | Class&lt;Component&gt; | Function | Object, data?: VNodeData, children?: any, normalizationType?: number </span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">let</span> vnode, ns</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> Ctor</span><br><span class="line">    <span class="keyword">if</span> (isDef(Ctor = resolveAsset(context.$options, <span class="string">'components'</span>, tag))) &#123;</span><br><span class="line">      <span class="comment">// component</span></span><br><span class="line">      vnode = createComponent(Ctor, data, context, children, tag)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看到，根据 tag，然后在<code>options.components</code>里找到相应的<code>Ctor</code>，然后再创建<code>组件的vnode</code><br><code>resolveAsset</code>就是根据 <code>tag</code> 找到<code>Ctor</code> 的方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/utils/options.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveAsset</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  options: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  type: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  id: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  warnMissing?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// type就是 是components 还是 filters之类的</span></span><br><span class="line">  <span class="keyword">const</span> assets = options[type];</span><br><span class="line">  <span class="comment">// id其实这边指的是组件名，或者说是组件的tag也行</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(assets, id)) <span class="keyword">return</span> assets[id];</span><br><span class="line">  <span class="keyword">const</span> camelizedId = camelize(id);</span><br><span class="line">  <span class="comment">// 驼峰的形式</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(assets, camelizedId)) <span class="keyword">return</span> assets[camelizedId];</span><br><span class="line">  <span class="comment">// 首字母大写的形式</span></span><br><span class="line">  <span class="keyword">const</span> PascalCaseId = capitalize(camelizedId);</span><br><span class="line">  <span class="comment">// 连字符的形式</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(assets, PascalCaseId)) <span class="keyword">return</span> assets[PascalCaseId];</span><br><span class="line">  <span class="comment">// fallback to prototype chain</span></span><br><span class="line">  <span class="keyword">const</span> res = assets[id] || assets[camelizedId] || assets[PascalCaseId];</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp; warnMissing &amp;&amp; !res) &#123;</span><br><span class="line">    warn(<span class="string">"Failed to resolve "</span> + type.slice(<span class="number">0</span>, <span class="number">-1</span>) + <span class="string">": "</span> + id, options);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里先用<code>id</code>找，不行就驼峰式<code>id</code>找，首字母大写找，连字符找，所以<code>id</code>形式三种形式都行，找到就返回<code>Ctor</code></p>
<h2 id="注册局部组件"><a href="#注册局部组件" class="headerlink" title="注册局部组件"></a>注册局部组件</h2><p>注册局部组件，其实就是在当前组件的options里加上<code>components:{hello}</code>，而<code>mergeOptions</code>的时候肯定被合并到<code>vm.$options.components</code>上，组件实例化的时候，依旧通过<code>resolveAsset</code>拿到对应的<code>Ctor</code></p>
<p>当然局部组件，只能在组件内才能使用组件。<br>全局组件之所以能被所有的组件使用，是因为组件实例化的时候，<code>Vue.options.components</code>会被合并到<code>vm.$options.components</code>。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码解密课程</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/components/component-register.html#%E5%85%A8%E5%B1%80%E6%B3%A8%E5%86%8C" target="_blank" rel="noopener">vue.js 技术揭秘</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/26/vue_4_source_code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/26/vue_4_source_code/" itemprop="url">
                  组件化_合并配置 - 学习vue源码系列 3-2
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-26T20:14:34+08:00">
                2021-07-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/26/vue_4_source_code/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/26/vue_4_source_code/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>决定跟着<a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码课程</a>好好学习下<code>vue2</code>的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~</p>
<p>将<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue 的源码</a>clone 到本地，切换到分支<code>2.6</code>。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>组件化渲染的那块，我个人觉得挺复杂的，我还没有捋顺，我决定先往后看，看完整体，再来磕硬骨头。</p>
<p>其实 vue 也有点配置为王的感觉，它的配置就是<code>options</code>。</p>
<p>后期组件的各种相关操作，都围绕<code>options</code>展开。</p>
<p>本篇着重看看，<code>vue</code>是怎么处理<code>options</code>的，最最重点的是，怎么合并各个<code>options</code>的。</p>
<!-- new Vue 和子组件初始化的时候
  外部调用场景的配置合并
  组件场景的配置合并
 -->
<h2 id="先看-demo"><a href="#先看-demo" class="headerlink" title="先看 demo"></a>先看 demo</h2><p>尝试先自己想想，这些钩子函数里的这些打印顺序如何。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/Users/zhm/mygit/vue/dist/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  const log = console.log;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 全局mixin</span></span><br><span class="line"><span class="undefined">  Vue.mixin(&#123;</span></span><br><span class="line"><span class="undefined">    created() &#123;</span></span><br><span class="line"><span class="undefined">      log("mixin created");</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 子组件实例</span></span><br><span class="line"><span class="undefined">  let childCompInstance = null;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 子组件</span></span><br><span class="line"><span class="undefined">  let childComp = &#123;</span></span><br><span class="line"><span class="undefined">    name: "MSG",</span></span><br><span class="line"><span class="xml">    template: "<span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>",</span></span><br><span class="line"><span class="undefined">    created() &#123;</span></span><br><span class="line"><span class="undefined">      childCompInstance = this;</span></span><br><span class="line"><span class="undefined">      log("child created");</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    data: () =&gt; (&#123; msg: "Hello Vue" &#125;),</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  // 根组件实例</span></span><br><span class="line"><span class="undefined">  let vueInstance = new Vue(&#123;</span></span><br><span class="line"><span class="undefined">    el: "#app",</span></span><br><span class="line"><span class="undefined">    created() &#123;</span></span><br><span class="line"><span class="undefined">      log("parent created");</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    render: (h) =&gt; h(childComp),</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  log("Vue构造器上的options", Vue.options);</span></span><br><span class="line"><span class="undefined">  log("Vue实例的options", vueInstance, vueInstance.$options);</span></span><br><span class="line"><span class="undefined">  log(</span></span><br><span class="line"><span class="undefined">    "VueComponent实例的options",</span></span><br><span class="line"><span class="undefined">    childCompInstance,</span></span><br><span class="line"><span class="undefined">    childCompInstance.$options,</span></span><br><span class="line"><span class="undefined">    childCompInstance.$options.__proto__</span></span><br><span class="line"><span class="undefined">  );</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>公布答案：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mixin created</span><br><span class="line">parent created</span><br><span class="line">mixin created</span><br><span class="line">child created</span><br></pre></td></tr></table></figure>
<p>其实定义在 Vue 的 mixin 里的<code>options</code>，会合并<code>Vue</code>构造器的的<code>options</code>里面。</p>
<p>用构造器创建实例的时候，构造器上面的<code>options</code>会和实例的<code>options</code>再次合并。</p>
<p>组件构造器是 Vue 的子类，合并的时候，主要的<code>options</code>在<code>childCompInstance.$options.__proto__</code>里。</p>
<p>看下，例子里后面的打印：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_3_21.png" alt="vue_3_21"></p>
<h2 id="Vue-mixin-和-Vue-构造器的-options-合并"><a href="#Vue-mixin-和-Vue-构造器的-options-合并" class="headerlink" title="Vue.mixin 和 Vue 构造器的 options 合并"></a>Vue.mixin 和 Vue 构造器的 options 合并</h2><p>先说下<code>Vue.mixin</code>是个函数，其传入的<code>options</code>，首先和 Vue 构造器上面的<code>options</code>合并。</p>
<p><code>Vue.mixin</code>执行之后，Vue 构造器上面的<code>options</code>就有了其对应的值。</p>
<p>先来个超简单的示意：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** vue源码 开始 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">Vue.options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将两个options合并成一个options</span></span><br><span class="line"><span class="keyword">const</span> mergeOptions = <span class="function">(<span class="params">parentOptions, childOptions</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> options = &#123;&#125;;</span><br><span class="line">  <span class="comment">// 生命周期的钩子合并的时候都是数组</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> childOptions) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">"created"</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> parentCreated = <span class="built_in">Array</span>.isArray(parentOptions.created)</span><br><span class="line">        ? parentOptions.created</span><br><span class="line">        : parentOptions.created</span><br><span class="line">        ? [parentOptions.created]</span><br><span class="line">        : [];</span><br><span class="line">      <span class="keyword">const</span> childCreated = <span class="built_in">Array</span>.isArray(childOptions.created)</span><br><span class="line">        ? childOptions.created</span><br><span class="line">        : [childOptions.created];</span><br><span class="line">      options.created = [...parentCreated, ...childCreated];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options;</span><br><span class="line">&#125;;</span><br><span class="line">Vue.mixin = <span class="function"><span class="keyword">function</span> <span class="title">mixin</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.options = mergeOptions(Vue.options, options);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** vue源码 结束 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用的例子</span></span><br><span class="line">Vue.mixin(&#123;</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"mixin created"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// &#123;created:[x]&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(Vue.options);</span><br></pre></td></tr></table></figure>
<p>总的来说就是做着上面的事情，然后看 vue 的真正源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/global-api/mixin.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initMixin</span>(<span class="params">Vue: GlobalAPI</span>) </span>&#123;</span><br><span class="line">  Vue.mixin = <span class="function"><span class="keyword">function</span> (<span class="params">mixin: Object</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// mixin就是&#123; created()&#123;&#125; &#125;, this指的是Vue构造器，因为使用的时候是Vue.mixin</span></span><br><span class="line">    <span class="keyword">this</span>.options = mergeOptions(<span class="keyword">this</span>.options, mixin);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/util/options.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeOptions</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  child: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="comment">// parent就是Vue构造器的options,child就是&#123; created()&#123;&#125; &#125;</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span>) &#123;</span><br><span class="line">    checkComponents(child);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> child === <span class="string">"function"</span>) &#123;</span><br><span class="line">    child = child.options;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  normalizeProps(child, vm);</span><br><span class="line">  normalizeInject(child, vm);</span><br><span class="line">  normalizeDirectives(child);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Apply extends and mixins on the child options,</span></span><br><span class="line">  <span class="comment">// but only if it is a raw options object that isn't</span></span><br><span class="line">  <span class="comment">// the result of another mergeOptions call.</span></span><br><span class="line">  <span class="comment">// Only merged options has the _base property.</span></span><br><span class="line">  <span class="keyword">if</span> (!child._base) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.extends) &#123;</span><br><span class="line">      parent = mergeOptions(parent, child.extends, vm);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (child.mixins) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">        parent = mergeOptions(parent, child.mixins[i], vm);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = &#123;&#125;;</span><br><span class="line">  <span class="keyword">let</span> key;</span><br><span class="line">  <span class="comment">// parent就是Vue构造器上面的options，key就是每项键，key不一样合并的策略不一样，先处理parent</span></span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> parent) &#123;</span><br><span class="line">    mergeField(key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// child就是 &#123; created()&#123;&#125; &#125;，在处理child里的（parent没有的）key</span></span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasOwn(parent, key)) &#123;</span><br><span class="line">      mergeField(key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mergeField</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> strat = strats[key] || defaultStrat;</span><br><span class="line">    options[key] = strat(parent[key], child[key], vm, key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Vue-实例的时候"><a href="#Vue-实例的时候" class="headerlink" title="Vue 实例的时候"></a>Vue 实例的时候</h2><p>Vue 构造器上面的<code>options</code>会和实例里参数<code>options</code>合并。<br>当然合并的逻辑是相似的。<br>拿这个例子来说，会变成<code>created:[fn1,fn2]</code>，注意构造器的在前面，参数的在后面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// options就是类似例子的&#123;el:'#app',....&#125;</span></span><br><span class="line">Vue.prototype._init = <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> vm = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 将各种选项合并,合并之后就是&#123;created:[fn1,fn2]&#125;</span></span><br><span class="line">  vm.$options = mergeOptions(</span><br><span class="line">    <span class="comment">// 这里vm.constructor就是Vue,Vue.options&#123;created:[fn1]&#125;</span></span><br><span class="line">    resolveConstructorOptions(vm.constructor),</span><br><span class="line">    <span class="comment">// &#123;created:fn2&#125;</span></span><br><span class="line">    options || &#123;&#125;,</span><br><span class="line">    vm</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里可以简单看下Vue上面的静态属性options</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ASSET_TYPES = [</span><br><span class="line">  <span class="string">'component'</span>,</span><br><span class="line">  <span class="string">'directive'</span>,</span><br><span class="line">  <span class="string">'filter'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initGlobalAPI</span> (<span class="params">Vue: GlobalAPI</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  Vue.options = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  ASSET_TYPES.forEach(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">    Vue.options[type + <span class="string">'s'</span>] = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// this is used to identify the "base" constructor to extend all plain-object</span></span><br><span class="line">  <span class="comment">// components with in Weex's multi-instance scenarios.</span></span><br><span class="line">  Vue.options._base = Vue</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将内置组件扩展到Vue.options.components上，keepAlive transition</span></span><br><span class="line">  extend(Vue.options.components, builtInComponents)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Vue组件实例的时候"><a href="#Vue组件实例的时候" class="headerlink" title="Vue组件实例的时候"></a>Vue组件实例的时候</h2><p>由于组件的构造函数是通过<code>Vue.extend</code>继承自<code>Vue</code>的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Vue.extend = <span class="function"><span class="keyword">function</span> (<span class="params">extendOptions: Object</span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  Sub.options = mergeOptions(</span><br><span class="line">    Super.options,</span><br><span class="line">    extendOptions</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// keep a reference to the super options at extension time.</span></span><br><span class="line">  <span class="comment">// later at instantiation we can check if Super's options have</span></span><br><span class="line">  <span class="comment">// been updated.</span></span><br><span class="line">  Sub.superOptions = Super.options</span><br><span class="line">  Sub.extendOptions = extendOptions</span><br><span class="line">  Sub.sealedOptions = extend(&#123;&#125;, Sub.options)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> Sub</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很显然，组件类的<code>options</code>是组件对象和<code>Vue</code>的<code>options</code>合并的。</p>
<p>组件初始化的时候，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// options有以下属性</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createComponentInstanceForVnode</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vnode: any, <span class="regexp">//</span> we know it<span class="string">'s MountedComponentVNode but flow doesn'</span>t</span></span></span><br><span class="line"><span class="function"><span class="params">  parent: any, <span class="regexp">//</span> activeInstance in lifecycle state</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options: InternalComponentOptions = &#123;</span><br><span class="line">    _isComponent: <span class="literal">true</span>,</span><br><span class="line">    _parentVnode: vnode,</span><br><span class="line">    parent</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> vnode.componentOptions.Ctor(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>vnode.componentOptions.Ctor</code> 就是指向 <code>Vue.extend</code> 的返回值 <code>Sub</code>。执行<code>new</code>的话，就会再次执行<code>this._init(options)</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initInternalComponent</span> (<span class="params">vm: Component, options: InternalComponentOptions</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 组件类的options和Vue类的options并不相同。</span></span><br><span class="line">  <span class="keyword">const</span> opts = vm.$options = <span class="built_in">Object</span>.create(vm.constructor.options)</span><br><span class="line">  <span class="comment">// doing this because it's faster than dynamic enumeration.</span></span><br><span class="line">  <span class="keyword">const</span> parentVnode = options._parentVnode</span><br><span class="line">  opts.parent = options.parent</span><br><span class="line">  opts._parentVnode = parentVnode</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> vnodeComponentOptions = parentVnode.componentOptions</span><br><span class="line">  opts.propsData = vnodeComponentOptions.propsData</span><br><span class="line">  opts._parentListeners = vnodeComponentOptions.listeners</span><br><span class="line">  opts._renderChildren = vnodeComponentOptions.children</span><br><span class="line">  opts._componentTag = vnodeComponentOptions.tag</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.render) &#123;</span><br><span class="line">    opts.render = options.render</span><br><span class="line">    opts.staticRenderFns = options.staticRenderFns</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>initInternalComponent</code> 方法执行，相当于 <code>vm.$options = Object.create(Sub.options)</code>。<br>此时，<code>vm.$options</code>如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vm.$options = &#123;</span><br><span class="line">  parent: Vue <span class="comment">/*父Vue实例*/</span>,</span><br><span class="line">  propsData: <span class="literal">undefined</span>,</span><br><span class="line">  _componentTag: <span class="literal">undefined</span>,</span><br><span class="line">  _parentVnode: VNode <span class="comment">/*父VNode实例*/</span>,</span><br><span class="line">  _renderChildren:<span class="literal">undefined</span>,</span><br><span class="line">  __proto__: &#123;</span><br><span class="line">    components: &#123; &#125;,</span><br><span class="line">    directives: &#123; &#125;,</span><br><span class="line">    filters: &#123; &#125;,</span><br><span class="line">    _base: <span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    _Ctor: &#123;&#125;,</span><br><span class="line">    created: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">created</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'parent created'</span>)</span><br><span class="line">      &#125;, <span class="function"><span class="keyword">function</span> <span class="title">created</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'child created'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    mounted: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">mounted</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'child mounted'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    data() &#123;</span><br><span class="line">       <span class="keyword">return</span> &#123;</span><br><span class="line">         msg: <span class="string">'Hello Vue'</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    template: <span class="string">'&lt;div&gt;&#123;&#123;msg&#125;&#125;&lt;/div&gt;'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="走一遍看看调试"><a href="#走一遍看看调试" class="headerlink" title="走一遍看看调试"></a>走一遍看看调试</h2><p>在<code>vue.js</code>3处打个断点：</p>
<ul>
<li><code>Vue.mixin</code>打个断点</li>
<li><code>Vue.prototype._init</code>里<code>options</code>处打个断点</li>
<li><code>function mergeOptions</code>打个断点</li>
</ul>
<p>先看看mixin:</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code12.gif" alt="vue_source_code12.gif"></p>
<p><code>Vue.mixin</code>之后，Vue的options合并了<code>Vue.mixin</code>的参数，变成这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  components: &#123;&#125;</span><br><span class="line">  created: [ƒ]</span><br><span class="line">  directives: &#123;&#125;</span><br><span class="line">  filters: &#123;&#125;</span><br><span class="line">  _base: ƒ Vue(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>new Vue(options)</code>会再和<code>Vue的options</code>合并，<code>VueComponent</code>的<code>options</code>也会和<code>Vue的options</code>合并：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code13.gif" alt="vue_source_code13.gif"></p>
<p>vue实例的<code>$options</code>是用户传的<code>options</code>和<code>Vue</code>的<code>options</code>的合并，此时vue实例的<code>$options</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  components: &#123;&#125;</span><br><span class="line">  created: (<span class="number">2</span>) [ƒ, ƒ]</span><br><span class="line">  directives: &#123;&#125;</span><br><span class="line">  el: <span class="string">"#app"</span></span><br><span class="line">  filters: &#123;&#125;</span><br><span class="line">  render: <span class="function">(<span class="params">h</span>) =&gt;</span> h(childComp)</span><br><span class="line">  _base: ƒ Vue(options)</span><br><span class="line">  _isVue: <span class="literal">true</span></span><br><span class="line">  _uid: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VueComponent组件实例的options是和Vue的options合并：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code14.gif" alt="vue_source_code14.gif"></p>
<p>显然组件的合并是先走了<code>Vue.extend</code>，然后走了<code>initInternalComponent</code>，最后，组件实例的options就是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">_proto__:&#123;</span><br><span class="line">  components: &#123;<span class="attr">MSG</span>: ƒ&#125;</span><br><span class="line">  created: (<span class="number">2</span>) [ƒ, ƒ]</span><br><span class="line">  data: <span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">msg</span>: <span class="string">"Hello Vue"</span> &#125;)</span><br><span class="line">  directives: &#123;&#125;</span><br><span class="line">  filters: &#123;&#125;</span><br><span class="line">  name: <span class="string">"MSG"</span></span><br><span class="line">  template: <span class="string">"&lt;div&gt;&#123;&#123;msg&#125;&#125;&lt;/div&gt;"</span></span><br><span class="line">  _Ctor: &#123;<span class="number">0</span>: ƒ&#125;</span><br><span class="line">&#125;</span><br><span class="line">parent: Vue &#123;<span class="attr">_uid</span>: <span class="number">0</span>, <span class="attr">_isVue</span>: <span class="literal">true</span>, <span class="attr">$options</span>: &#123;…&#125;, <span class="attr">_renderProxy</span>: <span class="built_in">Proxy</span>, <span class="attr">_self</span>: Vue, …&#125;</span><br><span class="line">propsData: <span class="literal">undefined</span></span><br><span class="line">render: ƒ anonymous( )</span><br><span class="line">staticRenderFns: []</span><br><span class="line">_componentTag: <span class="literal">undefined</span></span><br><span class="line">_parentListeners: <span class="literal">undefined</span></span><br><span class="line">_parentVnode: VNode &#123;<span class="attr">tag</span>: <span class="string">"vue-component-1-MSG"</span>, <span class="attr">data</span>: &#123;…&#125;, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: div, …&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Vue 初始化阶段对于 options 的合并有 2 种方式：</p>
<ul>
<li>外部初始化 Vue 通过 <code>mergeOptions</code> 的过程，合并完的结果保留在 <code>vm.$options</code> 中。</li>
<li>子组件初始化过程通过 <code>initInternalComponent</code> 方式，比<code>mergeOptions</code>的方式要快</li>
</ul>
<p>纵观一些库、框架的设计几乎都是类似的，</p>
<ul>
<li>自身<strong>先</strong>定义了一些默认配置，</li>
<li>同时又可以在<strong>初始化</strong>阶段传入一些自定义配置，</li>
<li>然后 <code>merge</code>配置，来达到定制化不同需求的目的。</li>
</ul>
<!--

## 英语



conclude - conclusion
decide - decision
convert - conversion
permit - permission
admit - admission

eat - ed/es

obese - ob(过多)+ es(吃)
edible = ed(吃) + ible(able能)

- aoeiuy 元音等价
- s d t 等价
- pro 前缀表示 forward  （动态）
- pre 前缀表示 在前面 提前 （静态）
- or ur er ar 后缀 是名词 表示 东西 人（or 机、器、）
- ion 后缀表示 一群人
- 词根后面 后缀前面 经常 是 u/ul/o 连接符 （方便发音更顺滑）
- ate ite ute 动词后缀表示 使...v  形容词后缀  （极少）名词后缀 表示人
- under 表示 未达到 下
- in 进
- axx一般ax就是前缀
- ag a 前缀表示 to 或者 加强语气（想象 啊）
- ent ant 名词后缀 表示人或物；形容词后缀 表示 的
- un 表示 否定前缀
- ed 表示有过的
- ance ence ancy ency后缀 只是表示名词
- prior 优先
- ory 名词后缀
- re 表示 相反、返回回来、反复 又 再
- ex e es 表示 向外 出去 超出
- ive 形容词后缀 表示过大的 过多的  也有直接 的  名词后缀 人或者物
- eas 表示 尽头



- cess ceed grad gred gress后缀表示 to go  走

process  n.进程 过程 v.加工 处理   （一步步向前走 想象流水线，想象向目标前进）
processor n.处理器
procession n.队伍、行列、一行、一列、列队前进
graduate n.本科毕业生 v.毕业
undergraduate n.本科肄业生 本科在读生
ingredient n.原料 要素 组成部分
aggressive adj. 侵略性的 激进的
aggress v.侵略（强行走进去）
aggression n.侵略
progress v/n. 进步 前进 进展
proceed v.前进 继续走

COCA 当代语料库20000词汇  数字越小单词越频繁


progress/process/proceed

progress 向前走 进步前进
process 过程
proceed 向前继续（不停） 活动事情继续做 诉讼
procession 一群人向前走

proceedings n.诉讼 活动

procedure n.程序 步骤

precede v.领先 优先

precedent n.先前的 有先例的
president n.总统 主席
unprecedented adj. 史无前例的
precedence n.优先 居先  （同义词）priority n.优先权 优先
access v.接近 进入 获取 使用
accessible adj.可接近的、可使用的、可获得的、平易近人的
accessory n.配件 附件 从犯 （和主要的东西走在一起的 各种从 文件从 穿搭从 犯罪从）
recession n.衰退（经济）后退 不景气
recede v.往回走 回退 后退 撤退
excessive adj. 过度的
excess n.过度 过度（走过线了 ） 过度的 过量的
exceed vt 超过 胜出
（process proceed）

exceedingly adv.极其地
cease (cess) v.走了（彻底的）、停止、终结 -->
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码解密课程</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/data-driven/" target="_blank" rel="noopener">vue.js 技术揭秘</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/08/doctor_eat_how/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/08/doctor_eat_how/" itemprop="url">
                  如何给儿童选择合适的药物？怎么处理喂药困难
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-08T15:28:13+08:00">
                2021-07-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/baby/" itemprop="url" rel="index">
                    <span itemprop="name">baby</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/08/doctor_eat_how/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/08/doctor_eat_how/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近看知贝的课程，总结下学到的东西，以下图片均来自知贝。</p>
<p>药进入人体有三个过程：吸收、分布、代谢、排泄（ADME）。<br>儿童和成人的过程时间不一样，吸收更强，排泄更慢，所以用药和成人绝不只是缩小版这么简单。</p>
<h2 id="选择成分单一的药物"><a href="#选择成分单一的药物" class="headerlink" title="选择成分单一的药物"></a>选择成分单一的药物</h2><p>不要选择成分复杂的药物。</p>
<p>选择成分单一的药物。有啥症状，用啥药。</p>
<h2 id="怎么选择药物的形状"><a href="#怎么选择药物的形状" class="headerlink" title="怎么选择药物的形状"></a>怎么选择药物的形状</h2><p>药的形状选择：滴剂、粉剂、栓剂、颗粒剂、混悬剂。<br>不要<strong>片状</strong>、胶囊状！<br>切忌不能吃<strong>泡腾片</strong>，那是泡在水里的！</p>
<h2 id="怎么喂药"><a href="#怎么喂药" class="headerlink" title="怎么喂药"></a>怎么喂药</h2><p>喂药的方法：</p>
<ul>
<li><p>颗粒剂：比如奥司他韦颗粒，孟鲁司特颗粒，可以将药物混在食物、果酱、牛奶中。</p>
</li>
<li><p>液体剂：比如美林、泰诺林，可以混在上述食物中。西替利嗪滴剂略有一点苦味，可以混入牛奶或增加甜味再给宝宝吃。</p>
</li>
<li><p>如果在没有口服用药条件或者宝宝拒绝服药的时候，可以考虑更换<strong>栓剂</strong>。</p>
</li>
<li><p>雾化药物，如果宝宝实在不配合，可以在宝宝睡着的时候进行雾化，睡着状态下的雾化效率比哭闹时更高。</p>
</li>
</ul>
<h2 id="吃吐的话，怎么补服"><a href="#吃吐的话，怎么补服" class="headerlink" title="吃吐的话，怎么补服"></a>吃吐的话，怎么补服</h2><p>吃吐的话</p>
<ul>
<li>15min以内，服同等剂量</li>
<li>15-60min以内，如果看到药物，则补服</li>
<li>60min以外，不需要补服</li>
</ul>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://appe3xm9tbf9157.h5.xiaoeknow.com/v1/course/audio/a_5e7c178f02c21_HDTBtNgu?type=2&amp;pro_id=p_5e842f077c849_COgOOGN4" target="_blank" rel="noopener">知贝</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/07/doctor_kit_medical/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/07/doctor_kit_medical/" itemprop="url">
                  家庭药箱准备什么
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-07T20:24:34+08:00">
                2021-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/baby/" itemprop="url" rel="index">
                    <span itemprop="name">baby</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/07/doctor_kit_medical/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/07/doctor_kit_medical/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor16.png" alt="doctor16"></p>
<p>最近看知贝的课程，总结下学到的东西，以下图片均来自知贝。</p>
<h2 id="家庭消毒防护用品"><a href="#家庭消毒防护用品" class="headerlink" title="家庭消毒防护用品"></a>家庭消毒防护用品</h2><ul>
<li>60%以上乙醇的免洗洗手液</li>
<li>湿纸巾</li>
<li>医用外科口罩</li>
</ul>
<h2 id="外伤急救用品"><a href="#外伤急救用品" class="headerlink" title="外伤急救用品"></a>外伤急救用品</h2><ul>
<li>碘伏棉签：消毒</li>
<li>纱布：包扎、固定、按压</li>
<li>人工皮亲水辅料：擦伤、破皮、烫伤的伤口敷裹（3M）</li>
</ul>
<h2 id="发热处理"><a href="#发热处理" class="headerlink" title="发热处理"></a>发热处理</h2><ul>
<li>耳温枪：测温</li>
<li>解热镇痛药：布洛芬（6m+）、对乙酰氨基酚（3m+）</li>
</ul>
<p>成人可以选择：芬必得、必理通<br>孩子选择：美林、泰诺，悬浮液和滴剂都行</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/meilin.png" alt="meilin"></p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/tainuo.jpg" alt="tainuo"></p>
<h2 id="流鼻涕"><a href="#流鼻涕" class="headerlink" title="流鼻涕"></a>流鼻涕</h2><p>生理学海盐水喷鼻剂/电动洗鼻器：当鼻腔结痂、分泌物增多时，湿润、冲洗鼻腔，稀释、清理分泌物。  </p>
<p>使用方法：每侧喷入2~5 喷后，擤鼻涕，每日 2~5 次，根据分泌物及固痂块多少情况，按需使用</p>
<p>注意事项：喷嘴不要对准鼻中隔，而是要对准鼻翼两侧，减少对鼻中隔的刺激</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/wash_nose.png" alt="wash_nose"></p>
<h2 id="腹泻用药"><a href="#腹泻用药" class="headerlink" title="腹泻用药"></a>腹泻用药</h2><ul>
<li>口服补液盐Ⅲ（博叶）：补液盐可以作为腹泻时脱水的预防和治疗。 </li>
</ul>
<p>建议不要丢弃包装和里面的量杯，方便准确冲泡和喂服，一次性配好一袋（250ml 水 + 一袋补液盐），不要把一袋分开配，配好的补液盐室温可以留存 24 小时。</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor10.png" alt="doctor10"></p>
<h2 id="过敏用药"><a href="#过敏用药" class="headerlink" title="过敏用药"></a>过敏用药</h2><ul>
<li>盐酸西替利嗪滴剂：一般用于全身过敏症状，目前国内有<strong>仙特明、澳博达、杰捷</strong>三个品牌。（左最好）</li>
</ul>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor11.png" alt="doctor11"></p>
<h2 id="湿疹、皮炎用药"><a href="#湿疹、皮炎用药" class="headerlink" title="湿疹、皮炎用药"></a>湿疹、皮炎用药</h2><p>皮疹（蚊虫叮咬、过敏都有可能引起皮疹）一般使用</p>
<ul>
<li><strong>地奈德乳膏、丁酸氢化可的松乳膏（尤卓尔）或 糠酸莫米松乳膏（艾洛松）</strong>：，轻症皮疹一般当天见效，严重的一般 1～2 周就见效，不见效去医院。</li>
</ul>
<p>先把手洗干净，挤出少许涂抹于患处，涂抹至肉眼不可见药物为止。</p>
<h2 id="便秘"><a href="#便秘" class="headerlink" title="便秘"></a>便秘</h2><ul>
<li>开塞露（一次用一支或者半支）</li>
<li>聚乙二醇：国内<strong>福松</strong></li>
</ul>
<h2 id="防晒霜"><a href="#防晒霜" class="headerlink" title="防晒霜"></a>防晒霜</h2><p>成分：<strong>氧化锌或二氧化钛</strong>的紫外线散射剂</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor12.png" alt="doctor12"></p>
<h2 id="驱蚊剂"><a href="#驱蚊剂" class="headerlink" title="驱蚊剂"></a>驱蚊剂</h2><p>主要含deet(30%以内)，浓度越高，时间越长。</p>
<p>不能吃，大人涂在小孩的裸露皮肤上。</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor13.png" alt="doctor13"></p>
<h2 id="服药时间"><a href="#服药时间" class="headerlink" title="服药时间"></a>服药时间</h2><p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor14.png" alt="doctor14"></p>
<h2 id="药物有效期"><a href="#药物有效期" class="headerlink" title="药物有效期"></a>药物有效期</h2><p>开封的话：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor15.png" alt="doctor15"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/06/kasel_summer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/06/kasel_summer/" itemprop="url">
                  未命名
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-06T10:57:25+08:00">
                2021-07-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/06/kasel_summer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/06/kasel_summer/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="心得"><a href="#心得" class="headerlink" title="心得"></a>心得</h1><p>我刚开始认为，共情是一件很容易的事情。不就是感受别人的心情嘛，这有啥，但进入课程才发现，其实共情本身也是技能，也需要修炼，我以为的共情是极其浅显的，真正的共情是温暖的。</p>
<p>共情，主要从四个层面，可以慢慢来，也许开始的时候，只能到达其中的某些层面，但没关系，有方向在，一定会越来越好的！</p>
<p>四个层面，我理解的是：</p>
<ul>
<li>从他人的认知层面</li>
<li>感受他人的情感层面</li>
<li>正确说出其感受层面</li>
<li>解决方案层面</li>
</ul>
<p>对应的五个步骤就是：</p>
<ul>
<li>停</li>
<li>看</li>
<li>听</li>
<li>说</li>
<li>做</li>
</ul>
<h2 id="停"><a href="#停" class="headerlink" title="停"></a>停</h2><p>物理层面，要停下你手里的事情，表示接下来的时间和空间，都属于对方，让对方感受到尊重和支持</p>
<p>心理层面，放下心中的对方的偏见，放下对方身上的标签，这样听的事情，会更加的客观和真实，不被带偏</p>
<p>自我层面，这个是最难的，当别人说的时候，如果自己的情绪很激动，或者很气愤，是很难共情的，因为你的心中不是空的，很难装下别人的情绪，放空自己。先察觉自己的情绪，如果不冷静的话，找出情绪的原因，并且处理掉。等到自己的情绪放空，才能真正的感受他人的情绪。</p>
<p>例子里，妈妈回来，看见小宝哭，第一感觉就是责备大宝的例子，我印象挺深刻的，觉得这个场景经常出现。</p>
<p>或许之前很多次，的确是因为大宝让小宝哭了，但不能因此就觉得小宝每次哭就是因为大宝。</p>
<p>我们必须先放下自己对大宝的偏见，放下自我的情绪，必须知道事情的真相之后，才去做相应的方案。</p>
<h2 id="看和听"><a href="#看和听" class="headerlink" title="看和听"></a>看和听</h2><p>第一步，尽量做吧。然后才调动视觉和听觉，其实还有心觉。</p>
<p>看和听都是观察对方的一切。</p>
<p>和对方目光相对，让对方更有说的意愿。</p>
<p>观察对方的肢体行为，肢体语言表达的往往更能体现对方的清除。</p>
<p>听对方说的话，这里的听，不能听语言，还要听语调和语气，以及一些言外之意，隐晦之意。</p>
<p>注意，听的时候，尽管心里翻天覆地，但也必须听完，有时候，重点可能在最后。</p>
<h2 id="回应"><a href="#回应" class="headerlink" title="回应"></a>回应</h2><p>当对方已经表达完毕的时候，此时的回应也是极其重要的。</p>
<p>大部分情况下，在前两步之后，我们需要努力，觉察到其现在的心情和情绪，并且尽量推测情绪的原因，如果不能，就在说出情绪之后，询问，发生了什么事。</p>
<p>比如案例里，小朋友回家重重的摔门，爸爸最开始就问，怎么了，但这个还不够</p>
<p>如果说，爸爸感觉你现在很生气，是不是发生了什么事，我们喝点水先缓下，如果愿意的话，可以跟爸爸说说么</p>
<p>这样的话，孩子觉得被理解了，那么倾诉的愿意就会增强。</p>
<p>当然如果对方的心情很难过，有时候，大家心知肚明的时候，一个拥抱，往往更能安抚和温暖对方。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>情绪的产生总是有原因的。</p>
<p>知道原因之后，就去努力解决。</p>
<p>比如蛋糕坏了，换个角度思考，找出好的方面，从而减缓难过的心情。</p>
<p>比如考试分数不好，那就提高能力，下次考试就会变好。</p>
<p>积极的解决问题，这样情绪才能被很好的释放。</p>
<h2 id="注意点：焦点在目标"><a href="#注意点：焦点在目标" class="headerlink" title="注意点：焦点在目标"></a>注意点：焦点在目标</h2><p>还有个注意点，共情的目标是对方，而不是对方说的其他人和其他事，这个很容易走偏。</p>
<p>案例里，小朋友说，父母吵架了。</p>
<p>当时我的第一反应是，父母为什么吵架了。其实这是不对的，搞错了共情目标。焦点是小朋友，父母吵架了，小朋友什么感受，怎么缓解小朋友的情绪。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>路漫漫其修远兮，吾将上下而求索。<br>会反复看视频。<br>共情也会一直一直继续。<br>愿人人都能被真正倾听，被真正共情。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/06/doctor_medicine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/06/doctor_medicine/" itemprop="url">
                  药品的基础知识
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-06T10:53:37+08:00">
                2021-07-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/baby/" itemprop="url" rel="index">
                    <span itemprop="name">baby</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/06/doctor_medicine/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/06/doctor_medicine/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近看知贝的课程，总结下学到的东西，以下图片均来自知贝。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d851ec612458414e91c73418ba1b82a6~tplv-k3u1fbpfcp-zoom-1.image" alt="doctor7"></p>
<h2 id="区分：药品和非药品"><a href="#区分：药品和非药品" class="headerlink" title="区分：药品和非药品"></a>区分：药品和非药品</h2><p>卫生许可证号里的：<strong>消</strong>字号和<strong>妆</strong>字号 <strong>不是</strong>药品，前者是消毒卫生，后者是化妆品</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b0225f8a07b486fb6bb4ce8e8d4ca92~tplv-k3u1fbpfcp-zoom-1.image" alt="doctor1"></p>
<h2 id="区分：处方药和非处方药"><a href="#区分：处方药和非处方药" class="headerlink" title="区分：处方药和非处方药"></a>区分：处方药和非处方药</h2><p>处方药：需要医生或者医师的药方<br>非处方药：不需要，有<code>OTC</code>的标志。绿色的比红色的则更加安全和有效。  </p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b636201b66f49dbbf677dc774e05f17~tplv-k3u1fbpfcp-zoom-1.image" alt="doctor2"></p>
<h2 id="区分：西药和中成药"><a href="#区分：西药和中成药" class="headerlink" title="区分：西药和中成药"></a>区分：西药和中成药</h2><p>西药：一般从天然产物中提取，成分明确，结构单一，比如布洛芬、对乙酰氨基酚、青霉素<br>中成药：各种成分的混合物。比如消炎片是由野菊花、蒲公英等提取物混合制成  </p>
<p>主要通过国药准字号区分：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/doctor3.png" alt="doctor3"></p>
<h2 id="避开：尚不明确的药"><a href="#避开：尚不明确的药" class="headerlink" title="避开：尚不明确的药"></a>避开：尚不明确的药</h2><p>不良反应那里，尚不明确是早期的时候，没有资源去实验，不代表副作用小。</p>
<p>所以尽量选择，不良反应，很明确的药</p>
<h2 id="区分：药品名字"><a href="#区分：药品名字" class="headerlink" title="区分：药品名字"></a>区分：药品名字</h2><p>有通用的药品名，一般字样很大。而不同的厂家，可以制作同样的药品，但属于不同厂家。但很多药，一般习惯要某个厂家的，比如美林的布洛芬。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5b1e1111633439989e2bb29b712846a~tplv-k3u1fbpfcp-zoom-1.image" alt="doctor5"></p>
<h2 id="区分：抗生素和消炎药"><a href="#区分：抗生素和消炎药" class="headerlink" title="区分：抗生素和消炎药"></a>区分：抗生素和消炎药</h2><p>抗生素：用来抑菌杀菌，比如xx霉素、xx西林、头孢xx、xx沙星、x硝唑等</p>
<p>消炎药：</p>
<ul>
<li>非甾体抗炎药，如阿司匹林、布洛芬、塞来昔布等；</li>
<li>甾体抗炎药，如地塞米松、泼尼松这种主要以「松」结尾的药</li>
</ul>
<p>炎症的功能：免疫系统处理有害刺激或者病原体的自我<strong>保护</strong>措施。</p>
<p>炎症的反应：红肿、发热、疼痛。</p>
<p>导致炎症的有害刺激：</p>
<ul>
<li>烫伤、冻伤、烧伤、过敏、自身免疫反应等；</li>
<li>病原体感染则包括细菌、病毒、真菌等引起的感染。</li>
</ul>
<p>只有确定或者高度怀疑是<strong>细菌感染</strong>，才能使用抗生素。</p>
<h2 id="药物半衰期（t1-2）"><a href="#药物半衰期（t1-2）" class="headerlink" title="药物半衰期（t1/2）"></a>药物半衰期（t1/2）</h2><p>药物半衰期：血液中药物浓度减低到1/2所需要的时间。</p>
<p>很短的话，不适合口服，一般输液、局部使用等<br>比较长的话，可以口服，减少用药的频次</p>
<p>这样保证血液中较长时间有药物存在。</p>
<p>当然哺乳期，半衰期短的药物更加安全。</p>
<h2 id="剂量是毒性的唯一标准"><a href="#剂量是毒性的唯一标准" class="headerlink" title="剂量是毒性的唯一标准"></a>剂量是毒性的唯一标准</h2><p>饭吃多都能撑死。</p>
<p>有些剂量小，也毒性很大。有些剂量大，但毒性小。</p>
<p>有些毒性进入人体很快就排泄掉。有些会累积，或致癌突变，如沙利度胺、利巴韦林等</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://omizt4opc.bkt.clouddn.com/avatar.jpg"
               alt="frontzhm" />
          <p class="site-author-name" itemprop="name">frontzhm</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">264</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">39</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">frontzhm</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"frontzhm"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
