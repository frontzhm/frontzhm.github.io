<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="js," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="决定跟着黄轶老师的 vue2 源码课程好好学习下vue2的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~ 将vue 的源码clone 到本地，切换到分支2.6。 Introduction数据驱动是vue的核心思想。 数据的变化，JQuery通过 操作DOM 更新视图，而vue会自动更新视图，解耦 DOM 和数据。 本节重点，分析 &amp;lt;div id=&amp;quot;a">
<meta name="keywords" content="js">
<meta property="og:type" content="article">
<meta property="og:title" content="数据驱动 - 学习vue源码系列2">
<meta property="og:url" content="http://yoursite.com/2021/06/23/vue_source_code_2/index.html">
<meta property="og:site_name" content="花花的博客">
<meta property="og:description" content="决定跟着黄轶老师的 vue2 源码课程好好学习下vue2的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~ 将vue 的源码clone 到本地，切换到分支2.6。 Introduction数据驱动是vue的核心思想。 数据的变化，JQuery通过 操作DOM 更新视图，而vue会自动更新视图，解耦 DOM 和数据。 本节重点，分析 &amp;lt;div id=&amp;quot;a">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code5.png">
<meta property="og:image" content="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code6.png">
<meta property="og:image" content="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code7.gif">
<meta property="og:image" content="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code8.gif">
<meta property="og:image" content="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code9.png">
<meta property="og:image" content="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code10.png">
<meta property="og:updated_time" content="2021-06-23T12:09:56.722Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="数据驱动 - 学习vue源码系列2">
<meta name="twitter:description" content="决定跟着黄轶老师的 vue2 源码课程好好学习下vue2的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~ 将vue 的源码clone 到本地，切换到分支2.6。 Introduction数据驱动是vue的核心思想。 数据的变化，JQuery通过 操作DOM 更新视图，而vue会自动更新视图，解耦 DOM 和数据。 本节重点，分析 &amp;lt;div id=&amp;quot;a">
<meta name="twitter:image" content="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code5.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/06/23/vue_source_code_2/"/>





  <title> 数据驱动 - 学习vue源码系列2 | 花花的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?60f2cb5747a596a24f2a053f1650c30b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">花花的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/23/vue_source_code_2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="frontzhm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://omizt4opc.bkt.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花花的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                数据驱动 - 学习vue源码系列2
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T20:09:56+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js/" itemprop="url" rel="index">
                    <span itemprop="name">js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/23/vue_source_code_2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/23/vue_source_code_2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>决定跟着<a href="https://coding.imooc.com/lesson/228.html#mid=14869" target="_blank" rel="noopener">黄轶老师的 vue2 源码课程</a>好好学习下<code>vue2</code>的源码，学习过程中，尽量输出自己的所得，提高学习效率，水平有限，不对的话请指正~</p>
<p>将<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">vue 的源码</a>clone 到本地，切换到分支<code>2.6</code>。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p><code>数据驱动</code>是<code>vue</code>的核心思想。</p>
<p>数据的变化，<code>JQuery</code>通过 操作<code>DOM</code> 更新视图，而<code>vue</code>会自动更新视图，解耦 DOM 和数据。</p>
<p>本节重点，分析 <code>&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</code>怎么变成<code>&lt;div id=&quot;app&quot;&gt;hello&lt;/div&gt;</code>。</p>
<p>切记：分析源码，先做主线任务，然后再是支线任务~~~</p>
<h2 id="new-Vue-发生了什么"><a href="#new-Vue-发生了什么" class="headerlink" title="new Vue 发生了什么"></a>new Vue 发生了什么</h2><p>来找找，实现这样的功能，都涉及到了哪些文件。</p>
<p>从入口文件开始找，Vue 在<code>src/core/instance/index.js</code>定义的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)) &#123;</span><br><span class="line">    warn(<span class="string">"Vue is a constructor and should be called with the `new` keyword"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 这里就执行这一个方法</span></span><br><span class="line">  <span class="keyword">this</span>._init(options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这些都是在原型上挂载相应方法的</span></span><br><span class="line">initMixin(Vue);</span><br><span class="line">stateMixin(Vue);</span><br><span class="line">eventsMixin(Vue);</span><br><span class="line">lifecycleMixin(Vue);</span><br><span class="line">renderMixin(Vue);</span><br></pre></td></tr></table></figure>
<p>这里还有个小细节：书写顺序上，虽然<code>this._init</code>在<code>initMixin(Vue);....</code>之前，但实际上，<code>this._init</code>只有<code>new</code>的时候才执行，而<code>new</code>之前，<code>initMixin(Vue);....</code>已经执行，所以，<code>this._init</code>能调用所有原型上的方法。</p>
<p>从挂载原型的方法上面，显然可以找到<code>initMixin</code>是定义<code>_init</code>方法的，于是找到<code>init.js</code>：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code5.png" alt="vue_source_code5"></p>
<p>依次各种方法，但是什么才是实现<code></code>变成<code>hello</code>的相关代码呢？</p>
<h3 id="小技巧：增加调试"><a href="#小技巧：增加调试" class="headerlink" title="小技巧：增加调试"></a>小技巧：增加调试</h3><p>想要找到这个问题的答案，其实就是建个 demo，然后引入<code>vue</code>文件，在<code>init</code>的相关代码打上<code>debugger</code>，<br>发现哪个执行完之后，<code></code>变成<code>hello</code>了，那就找到了相关的代码了！</p>
<p>我这边偷懒了点，直接在克隆下来的 <code>vue</code> 库里，建个<code>z.html</code>，引入<code>vue</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 这里改成自己的路径 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"vue/dist/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">"#app"</span>,</span></span><br><span class="line"><span class="undefined">    data: &#123;</span></span><br><span class="line"><span class="javascript">      message: <span class="string">"hello"</span>,</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后搜下<code>_init</code>，在这里打上断点，然后再浏览器里运行<code>z.html</code><br><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code6.png" alt="vue_source_code6"><br><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code7.gif" alt="vue_source_code7.gif"></p>
<p>Got it！这里可以断定<code>vm.$mount</code>是让<code></code>变成<code>hello</code>的关键方法！</p>
<h3 id="为什么能-this-message"><a href="#为什么能-this-message" class="headerlink" title="为什么能 this.message"></a>为什么能 this.message</h3><p>方法已经找到，这里再说另外一个事，为什么<code>data</code>里面定义的属性，能直接<code>this.xx</code>访问呢？</p>
<p>在使用一次<code>debugger</code>，这次仔细看下，<code>this</code>里面的属性，开始非常少，然后越来越多：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code8.gif" alt="vue_source_code8.gif"></p>
<p>哟西！很快就发现执行<code>initState(vm)</code>之后，<code>this</code>上面就有了<code>message</code>属性，显然这个文件做了相关的功能。</p>
<p>在<code>state.js</code>里看看：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initState方法</span></span><br><span class="line">initData(vm);</span><br><span class="line"></span><br><span class="line"><span class="comment">// initData方法，这里看到在实例上将data挂载在`this._data`属性上</span></span><br><span class="line">data = vm._data = <span class="keyword">typeof</span> data === <span class="string">"function"</span> ? getData(data, vm) : data || &#123;&#125;;</span><br><span class="line">proxy(vm, <span class="string">`_data`</span>, key);</span><br><span class="line"></span><br><span class="line"><span class="comment">// proxy方法，这里其实做了映射，当访问this.xx的时候，就会访问 this._data.xx</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition);</span><br></pre></td></tr></table></figure>
<h2 id="Vue-实例挂载的实现"><a href="#Vue-实例挂载的实现" class="headerlink" title="Vue 实例挂载的实现"></a>Vue 实例挂载的实现</h2><p>挂载的实现，重点就是<code>this.$mount</code>方法的实现。</p>
<p>寻找特定方法的定义，<code>src</code>全局搜索下<code>$mount</code></p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code9.png" alt="vue_source_code9"></p>
<p>发现定义<code>$mount</code>有三处：</p>
<ul>
<li>platforms/web/entry-runtime-with-compiler.js</li>
<li>platforms/web/runtime/index.js</li>
<li>platforms/weex/runtime/index.js</li>
</ul>
<p>其实也很好理解，之前说过 vue 的三种平台<code>web</code>、<code>weex</code>、<code>服务器</code>，最后一个肯定不需要，前两者，weex 里不支持模板是字符串或者 el 是字符串的模式，所以<code>weex</code>里只有一个，而<code>web</code>里有两种</p>
<h3 id="web-entry-runtime-with-compiler-js"><a href="#web-entry-runtime-with-compiler-js" class="headerlink" title="web/entry-runtime-with-compiler.js"></a>web/entry-runtime-with-compiler.js</h3><p>先看看<code>web/entry-runtime-with-compiler.js</code></p>
<ul>
<li>缓存原有的<code>$mount</code>，重写的时候，是在原有的<code>$mount</code>上增加功能</li>
<li><code>el</code>先判断是否传入，然后统一由<code>query</code>获取<code>dom</code></li>
<li>拿到 dom 之后，先看下是不是<code>body</code>或者<code>html</code>，是的话，警告并终止</li>
<li>如果<code>options</code>有<code>render函数</code>直接返回原有的<code>$mount</code>；没有的话，将<code>template</code>或者<code>el</code>转化为<code>render函数</code>之后才调用原有的<code>$mount</code></li>
<li><strong>重点</strong>看下，这里，怎么将<code>template</code>或者<code>el</code>转化为<code>render函数</code>，其实就是找到<code>DOM</code>字符串<ul>
<li>没有<code>render函数</code>，就两种情况：有<code>template</code>或者<code>el</code>，将最终的<code>DOM</code>字符串赋值给<code>template</code></li>
<li>优先处理<code>template</code>：<ul>
<li><code>template</code>是一个字符串，只支持以<code>#</code>开头，当做 id 获取元素，返回元素的<code>innerHTML</code>，</li>
<li><code>template</code>是一个元素的话，返回元素的<code>innerHTML</code></li>
<li>其他情况不支持</li>
</ul>
</li>
<li>没有<code>template</code>，看下<code>el</code>，获取 el 的<code>outerHTML</code>，在赋值给<code>template</code></li>
</ul>
</li>
<li>然后将<code>DOM</code>字符串用<code>compileToFunctions</code>处理成 <code>render 函数</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 缓存原来的，重写的时候，在原有的基础上增加功能</span></span><br><span class="line"><span class="keyword">const</span> mount = Vue.prototype.$mount;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 如果传入el的话，就去拿到el，query返回dom元素</span></span><br><span class="line">  el = el &amp;&amp; query(el);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="comment">// 不能是body,html</span></span><br><span class="line">  <span class="keyword">if</span> (el === <span class="built_in">document</span>.body || el === <span class="built_in">document</span>.documentElement) &#123;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存options</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">this</span>.$options;</span><br><span class="line">  <span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line">  <span class="keyword">if</span> (!options.render) &#123;</span><br><span class="line">    <span class="keyword">let</span> template = options.template;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">// template是字符串的话，只支持#开头</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">"string"</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (template.charAt(<span class="number">0</span>) === <span class="string">"#"</span>) &#123;</span><br><span class="line">          template = idToTemplate(template);</span><br><span class="line">          <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">          <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp; !template) &#123;</span><br><span class="line">            warn(</span><br><span class="line">              <span class="string">`Template element not found or is empty: <span class="subst">$&#123;options.template&#125;</span>`</span>,</span><br><span class="line">              <span class="keyword">this</span></span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (template.nodeType) &#123;</span><br><span class="line">        <span class="comment">// 元素的话 直接返回内容</span></span><br><span class="line">        template = template.innerHTML;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">      <span class="comment">// 即便有el,还是统一赋值给template</span></span><br><span class="line">      template = getOuterHTML(el);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">// template会统一转化为render函数</span></span><br><span class="line">      <span class="keyword">const</span> &#123; render, staticRenderFns &#125; = compileToFunctions( template, );</span><br><span class="line">      options.render = render;</span><br><span class="line">      options.staticRenderFns = staticRenderFns;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> mount.call(<span class="keyword">this</span>, el, hydrating);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Vue.compile = compileToFunctions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue;</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：只有非正式环境，才有-warn"><a href="#小技巧：只有非正式环境，才有-warn" class="headerlink" title="小技巧：只有非正式环境，才有 warn"></a>小技巧：只有非正式环境，才有 warn</h4><p>这个小技巧很容易在日常的开发中使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isProduction =</span><br><span class="line">  process.env.NODE_ENV === <span class="string">"production"</span>(!isProduction) &amp;&amp; warn(<span class="string">"some warn"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：判断元素是不是-body-或者-html"><a href="#小技巧：判断元素是不是-body-或者-html" class="headerlink" title="小技巧：判断元素是不是 body 或者 html"></a>小技巧：判断元素是不是 body 或者 html</h4><p>这个也很容易</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isBodyOrHtml = el === <span class="built_in">document</span>.body || el === <span class="built_in">document</span>.documentElement;</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：先处理异常情况"><a href="#小技巧：先处理异常情况" class="headerlink" title="小技巧：先处理异常情况"></a>小技巧：先处理异常情况</h4><p>总会先处理异常情况，最后处理相对正常的情况</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(someError)&#123;</span><br><span class="line">  <span class="keyword">return</span> ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ...</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：el-可以是字符串，也可以是元素的写法"><a href="#小技巧：el-可以是字符串，也可以是元素的写法" class="headerlink" title="小技巧：el 可以是字符串，也可以是元素的写法"></a>小技巧：el 可以是字符串，也可以是元素的写法</h4><p>这个一旦涉及到获取元素，就很好使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> el === <span class="string">"string"</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> selected = <span class="built_in">document</span>.querySelector(el);</span><br><span class="line">    <span class="keyword">if</span> (!selected) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp;</span><br><span class="line">        warn(<span class="string">"Cannot find element: "</span> + el);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> selected;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> el;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>元素的判断，也可以用<code>xx.nodeType</code></p>
<h4 id="小技巧：在已有的函数上增加新功能"><a href="#小技巧：在已有的函数上增加新功能" class="headerlink" title="小技巧：在已有的函数上增加新功能"></a>小技巧：在已有的函数上增加新功能</h4><p>如果希望在已有的函数上增加新的功能，可以先缓存原有的方法，然后重写，这样的好处是不需要到原有的函数中增删代码，而且不同的条件，可能需要不同的重写，灵活性更高：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> print = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name);</span><br><span class="line">&#125;;</span><br><span class="line">print(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 想增加新功能的话</span></span><br><span class="line"><span class="keyword">let</span> oldPrint = print;</span><br><span class="line">print = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"想另外加功能"</span>);</span><br><span class="line">  oldPrint.call(<span class="keyword">this</span>, name);</span><br><span class="line">&#125;;</span><br><span class="line">print(<span class="string">"hello"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="mount：platforms-web-runtime-index-js"><a href="#mount：platforms-web-runtime-index-js" class="headerlink" title="$mount：platforms/web/runtime/index.js"></a>$mount：platforms/web/runtime/index.js</h3><p>上面<code>$mount</code>改写，改的就是<code>platforms/web/runtime/index.js</code>定义的<code>$mount</code>，这里注意<code>runtime</code>肯定是需要的，所以先实现这个。而<code>compiler</code>看情况，所以另外的文件实现。</p>
<p>继续看，这里的定义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mountComponent &#125; <span class="keyword">from</span> <span class="string">"core/instance/lifecycle"</span>;</span><br><span class="line"><span class="comment">// public mount method</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> mountComponent(<span class="keyword">this</span>, el, hydrating);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>代码很明了，拿到<code>el</code>，然后让<code>mountComponent</code>实现，继续探索<code>core/instance/lifecycle.js</code></p>
<p>定义了<code>updateComponent</code>，然后实例化<code>Watcher</code>，专业名词<code>渲染watcher</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Watcher <span class="keyword">from</span> <span class="string">"../observer/watcher"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountComponent</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">  updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    vm._update(vm._render(), hydrating);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 渲染watcher，updateComponent传到这里来了</span></span><br><span class="line">  <span class="keyword">new</span> Watcher( vm, updateComponent, noop, &#123;&#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span> );</span><br><span class="line">  <span class="keyword">return</span> vm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>渲染watcher</code>的回调函数中会调用 <code>updateComponent</code> 方法，在此方法中调用 <code>vm._render</code> 方法首先生成<code>虚拟 Node</code>，最终调用 <code>vm._update</code> 更新 <code>DOM</code></p>
<p><code>Watcher</code>在这里起到两个作用，一个是<strong>初始化</strong>的时候会执行回调函数，另一个是当 vm 实例中的监测的<strong>数据发生变化</strong>的时候执行回调函数。</p>
<h2 id="render"><a href="#render" class="headerlink" title="render"></a>render</h2><p>先重点看下<code>_render</code>，打印 vm 实例，看到这个方法在原型上面，全局搜下，很快就知道在<code>core/instance/render.js</code>里：</p>
<p><code>_render</code>函数，返回的是<code>vnode</code>，而<code>vnode</code>是由<code>$createElement</code>这个方法返回的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// render self</span></span><br><span class="line">  <span class="keyword">let</span> vnode;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 这里注意，第一个参数是this，先不用管，render的真正参数是` vm.$createElement`</span></span><br><span class="line">    vnode = render.call(vm._renderProxy, vm.$createElement);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if the returned array contains only a single node, allow it</span></span><br><span class="line">  <span class="comment">// set parent</span></span><br><span class="line">  vnode.parent = _parentVnode;</span><br><span class="line">  <span class="keyword">return</span> vnode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="理解-vnode-和-patch"><a href="#理解-vnode-和-patch" class="headerlink" title="理解 vnode 和 patch"></a>理解 vnode 和 patch</h2><ul>
<li>vnode 其实就是<code>虚拟dom</code>(virtual dom)，因为真实的 node(real dom)属性和方法都非常多，频繁操作费性能，而 vnode 有相对精简的属性，其本身很容易映射成真实的 node，当然 vnode 和 node 本质上都是对象。</li>
<li>patch 就是将 vnode 变成真实的 node，并且插入到文档里（渲染）</li>
</ul>
<p>看个 demo，直观感受 vnode 和 patch，可以在本地运行：</p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code10.png" alt="vue_source_code10"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    // vnode本质上就是对象，&#123;"sel":"div","data":&#123;&#125;,"text":"Hello World"&#125;，等同于描述<span class="tag">&lt;<span class="name">div</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> vnode = <span class="keyword">new</span> VNode(<span class="string">"div"</span>, <span class="string">"hello"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(vnode));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> app = <span class="built_in">document</span>.querySelector(<span class="string">"#app"</span>); <span class="comment">// 真实dom</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    /* patch的功能：将第二个vnode转化为真实dom，并插入到文档中，销毁掉第一个vnode，。</span></span><br><span class="line"><span class="undefined">     * 这里有个细节，如果首个节点是真实节点，内部会转化为vnode，然后进行操作</span></span><br><span class="line"><span class="undefined">     */</span></span><br><span class="line"><span class="undefined">    patch(app, vnode);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// patch之后，vnode上面的elm就有了</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(vnode);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">/* 各个函数的定义 */</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// VNode的类</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">VNode</span>(<span class="params">tag, text, elm</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.sel = tag;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.text = text;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.elm = elm;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 创建vnode</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">tag, text, elm</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> <span class="keyword">new</span> VNode(tag, text, elm);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 真实的dom转化为vnode</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">elToVNode</span>(<span class="params">el</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> createElement(el.tagName, el.textContent, el);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// patch将第二个vnode转化为真实的dom，然后插入到文档中。第一个节点存在的意义上和第二个节点进行比较，从而精准的进行渲染</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">oldVNode, newVNode</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 第一个节点是真实节点的话，转化为vnode</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (oldVNode.nodeType) &#123;</span></span><br><span class="line"><span class="undefined">        oldVNode = elToVNode(oldVNode);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="comment">// 将第二个节点转化为真实的dom</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> node = <span class="built_in">document</span>.createElement(newVNode.sel);</span></span><br><span class="line"><span class="undefined">      node.textContent = newVNode.text;</span></span><br><span class="line"><span class="undefined">      newVNode.elm = node;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="comment">// 插入到文档中</span></span></span><br><span class="line"><span class="undefined">      oldVNode.elm.parentNode.insertBefore(node, oldVNode.elm);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="comment">// 销毁掉第一个节点（这里是销毁，但很多时候不是）</span></span></span><br><span class="line"><span class="undefined">      oldVNode.elm.parentNode.removeChild(oldVNode.elm);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> newVNode.elm;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样对<code>vnode</code>和<code>patch</code>有个概念之后，继续源码~</p>
<h2 id="源码中的createElement，返回的是vnode"><a href="#源码中的createElement，返回的是vnode" class="headerlink" title="源码中的createElement，返回的是vnode"></a>源码中的createElement，返回的是vnode</h2><p>很容易找到就在<code>src/core/vdom/create-element.js</code>。<br><code>createElement</code>实际上内部调用<code>_createElement</code>，其返回一个<code>vnode</code>。</p>
<p><code>children</code> 表示当前 VNode 的子节点，它是任意类型的，需要被规范为标准的 <code>VNode 数组</code>，根据<code>normalizationType</code>规范的方法也不一样。（<code>normalizationType</code>主要区分<code>render 函数</code>是编译生成的还是用户手写的）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; normalizeChildren, simpleNormalizeChildren &#125; <span class="keyword">from</span> <span class="string">'./helpers/index'</span></span><br><span class="line"><span class="keyword">const</span> SIMPLE_NORMALIZE = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> ALWAYS_NORMALIZE = <span class="number">2</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  data: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  alwaysNormalize: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 当data参数不存在的时候，后面的参数前置</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(data) || isPrimitive(data)) &#123;</span><br><span class="line">    normalizationType = children</span><br><span class="line">    children = data</span><br><span class="line">    data = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isTrue(alwaysNormalize)) &#123;</span><br><span class="line">    normalizationType = ALWAYS_NORMALIZE</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _createElement(context, tag, data, children, normalizationType)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">_createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag?: string | Class&lt;Component&gt; | Function | Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  data?: VNodeData,</span></span></span><br><span class="line"><span class="function"><span class="params">  children?: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType?: number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 针对不同的normalizationType，对children做不同的处理，其实就是扁平化children</span></span><br><span class="line">  <span class="keyword">if</span> (normalizationType === ALWAYS_NORMALIZE) &#123;</span><br><span class="line">    children = normalizeChildren(children)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (normalizationType === SIMPLE_NORMALIZE) &#123;</span><br><span class="line">    children = simpleNormalizeChildren(children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> vnode, ns</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> Ctor</span><br><span class="line">    ns = (context.$vnode &amp;&amp; context.$vnode.ns) || config.getTagNamespace(tag)</span><br><span class="line">    <span class="keyword">if</span> (config.isReservedTag(tag)) &#123;</span><br><span class="line">      <span class="comment">// platform built-in elements</span></span><br><span class="line">      <span class="comment">// 是保留标签的话，直接创建vnode，vnode支持字符串和组件类型，但这里暂时只看字符串就好</span></span><br><span class="line">      vnode = <span class="keyword">new</span> VNode(</span><br><span class="line">        config.parsePlatformTagName(tag), data, children,</span><br><span class="line">        <span class="literal">undefined</span>, <span class="literal">undefined</span>, context</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="children-规范化"><a href="#children-规范化" class="headerlink" title="children 规范化"></a>children 规范化</h3><p><code>src/core/vdom/helpers/normalize-children.js</code>的两个方法：</p>
<ul>
<li><code>simpleNormalizeChildren</code>这个方法很简单，如果<code>children</code>是二维的话，拍平，children 始终是<code>[vnode,vnode]</code>，这里也只考虑到二维的情况</li>
<li><code>normalizeChildren</code>这个稍微麻烦一点，考虑到多维的情况，需要递归，最后也是拍平</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. When the children contains components - because a functional component</span></span><br><span class="line"><span class="comment">// may return an Array instead of a single root. In this case, just a simple</span></span><br><span class="line"><span class="comment">// normalization is needed - if any child is an Array, we flatten the whole</span></span><br><span class="line"><span class="comment">// thing with Array.prototype.concat. It is guaranteed to be only 1-level deep</span></span><br><span class="line"><span class="comment">// because functional components already normalize their own children.</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">simpleNormalizeChildren</span>(<span class="params">children: any</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children[i])) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.concat.apply([], children);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> children;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. When the children contains constructs that always generated nested Arrays,</span></span><br><span class="line"><span class="comment">// e.g. &lt;template&gt;, &lt;slot&gt;, v-for, or when the children is provided by user</span></span><br><span class="line"><span class="comment">// with hand-written render functions / JSX. In such cases a full normalization</span></span><br><span class="line"><span class="comment">// is needed to cater to all possible types of children values.</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeChildren</span>(<span class="params">children: any</span>): ?<span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isPrimitive(children)</span><br><span class="line">    ? [createTextVNode(children)]</span><br><span class="line">    : <span class="built_in">Array</span>.isArray(children)</span><br><span class="line">    ? normalizeArrayChildren(children)</span><br><span class="line">    : <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isTextNode</span>(<span class="params">node</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isDef(node) &amp;&amp; isDef(node.text) &amp;&amp; isFalse(node.isComment);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeArrayChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  children: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  nestedIndex?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = [];</span><br><span class="line">  <span class="keyword">let</span> i, c, lastIndex, last;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">    c = children[i];</span><br><span class="line">    <span class="keyword">if</span> (isUndef(c) || <span class="keyword">typeof</span> c === <span class="string">"boolean"</span>) <span class="keyword">continue</span>;</span><br><span class="line">    lastIndex = res.length - <span class="number">1</span>;</span><br><span class="line">    last = res[lastIndex];</span><br><span class="line">    <span class="comment">//  nested</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(c)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (c.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        c = normalizeArrayChildren(c, <span class="string">`<span class="subst">$&#123;nestedIndex || <span class="string">""</span>&#125;</span>_<span class="subst">$&#123;i&#125;</span>`</span>);</span><br><span class="line">        <span class="comment">// merge adjacent text nodes 合并</span></span><br><span class="line">        <span class="keyword">if</span> (isTextNode(c[<span class="number">0</span>]) &amp;&amp; isTextNode(last)) &#123;</span><br><span class="line">          res[lastIndex] = createTextVNode(last.text + (c[<span class="number">0</span>]: any).text);</span><br><span class="line">          c.shift();</span><br><span class="line">        &#125;</span><br><span class="line">        res.push.apply(res, c);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="小技巧：扁平化二维数组"><a href="#小技巧：扁平化二维数组" class="headerlink" title="小技巧：扁平化二维数组"></a>小技巧：扁平化二维数组</h4><p>其实扁平化二维数组，可以利用下<code>concat</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> [].concat(...arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>[].concat(1,[4])</code>就是<code>[1,4]</code></p>
<h2 id="update其实大部分功能就是patch"><a href="#update其实大部分功能就是patch" class="headerlink" title="update其实大部分功能就是patch"></a>update其实大部分功能就是<code>patch</code></h2><p>找特定的方法，基本都是搜索，后期不再赘述。</p>
<p><code>_update</code>在<code>src/core/instance/lifecycle.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hydrating服务端才用到，否则就是false</span></span><br><span class="line">Vue.prototype._update = <span class="function"><span class="keyword">function</span> (<span class="params">vnode: VNode, hydrating?: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vm: Component = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 缓存之前的dom</span></span><br><span class="line">  <span class="keyword">const</span> prevEl = vm.$el;</span><br><span class="line">  <span class="comment">// 缓存之前的vnode</span></span><br><span class="line">  <span class="keyword">const</span> prevVnode = vm._vnode;</span><br><span class="line">  <span class="keyword">const</span> restoreActiveInstance = setActiveInstance(vm);</span><br><span class="line">  <span class="comment">// 新生成的vnode赋值</span></span><br><span class="line">  vm._vnode = vnode;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">    <span class="comment">// initial render 首次渲染走这里 首次的时候 挂载真实的el上 这里的patch和上面的例子相似 根据vnode创建真实的dom，然后插入到文档中，__patch__返回真实的dom</span></span><br><span class="line">    vm.$el = vm.__patch__(vm.$el, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(vm.$el);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>仔细看下<code>__patch__</code>，这里需要层层向上找，其实和上面的简单例子的主体逻辑很像了</p>
<p>但这里为什么用<code>createPatchFunction</code>生成<code>patch</code>呢？</p>
<p>vue 有三种平台，前面说过了，服务器端不需要渲染 dom，忽略。而 web 和 weex 都需要渲染，但“平台 DOM” 的方法是不同的，并且对 “DOM” 包括的属性模块创建和更新也不尽相同。因此每个平台都有各自的 nodeOps 和 modules，所以存放在各自的平台里。<br>但是 patch 的主要逻辑是相似的，这样通过 createPatchFunction 把差异化参数提前固化，这样不用每次调用 patch 的时候都传递 nodeOps 和 modules 了，这种函数柯里化的编程技巧也非常值得学习。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/platforms/web/runtime/index.js */</span></span><br><span class="line"><span class="keyword">import</span> &#123; patch &#125; <span class="keyword">from</span> <span class="string">"./patch"</span>;</span><br><span class="line"><span class="comment">// 浏览器需要，服务器不需要，noop是空函数</span></span><br><span class="line">Vue.prototype.__patch__ = inBrowser ? patch : noop;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* src/platforms/web/runtime/patch.js */</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPatchFunction &#125; <span class="keyword">from</span> <span class="string">"core/vdom/patch"</span>;</span><br><span class="line"><span class="comment">// nodeOps是增删改查dom的方法合集，modules是attrs, klass, events, domProps等这种的解析</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> patch: <span class="built_in">Function</span> = createPatchFunction(&#123; nodeOps, modules &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* src/core/vdom/patch.js */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createPatchFunction</span>(<span class="params">backend</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...定义很多和真实dom相关的函数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">oldVnode, vnode, hydrating, removeOnly</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 首次渲染，是真实的dom 这边只贴出与其相关的代码</span></span><br><span class="line">    <span class="keyword">const</span> isRealElement = isDef(oldVnode.nodeType);</span><br><span class="line">    <span class="comment">// replacing existing element</span></span><br><span class="line">    <span class="comment">// 缓存 旧的dom</span></span><br><span class="line">    <span class="keyword">const</span> oldElm = oldVnode.elm;</span><br><span class="line">    <span class="comment">// 缓存 旧的dom 父元素</span></span><br><span class="line">    <span class="keyword">const</span> parentElm = nodeOps.parentNode(oldElm);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create new node 根据新的vnode创建dom 并在父元素里旧元素前面插入新的dom</span></span><br><span class="line">    createElm(</span><br><span class="line">      vnode,</span><br><span class="line">      insertedVnodeQueue,</span><br><span class="line">      oldElm._leaveCb ? <span class="literal">null</span> : parentElm,</span><br><span class="line">      nodeOps.nextSibling(oldElm)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// destroy old node</span></span><br><span class="line">    <span class="keyword">if</span> (isDef(parentElm)) &#123;</span><br><span class="line">      <span class="comment">// 移除旧的dom</span></span><br><span class="line">      removeVnodes(parentElm, [oldVnode], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回 新的dom</span></span><br><span class="line">    <span class="keyword">return</span> vnode.elm;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!--
### 小技巧：利用高阶函数封装相同的部分，生成不同的函数

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFn</span>(<span class="params">&#123; nodeOp, s &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">&#123; x, y, z &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(&#123; x, y, z &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// a平台</span></span><br><span class="line"><span class="keyword">const</span> nodeOp = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> fn = createFn(&#123; nodeOp &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// b平台</span></span><br><span class="line"><span class="keyword">const</span> nodeOp = &#123; <span class="attr">b</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> s = <span class="string">"b"</span>;</span><br><span class="line"><span class="keyword">const</span> fn = createFn(&#123; nodeOp, s &#125;);</span><br><span class="line"><span class="string">``</span><span class="string">` --&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### debugger 调试\_update</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>html</span><br><span class="line">&lt;div id=<span class="string">"app"</span>&gt;&#123;&#123;message&#125;&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;!-- 这里换成绝对路径 --&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src="vue/</span>dist/vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  const vm2 = new Vue(&#123;</span></span><br><span class="line">    el: "#app",</span><br><span class="line">    data: &#123;</span><br><span class="line">      message: <span class="string">"hello"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    render(createElement) &#123;</span><br><span class="line">      <span class="keyword">return</span> createElement(</span><br><span class="line">        <span class="string">"section"</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          attrs: &#123; <span class="attr">id</span>: <span class="string">"box"</span> &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">this</span>.message</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>在<code>dist/vue.js</code>，这里打上断点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._update = <span class="function"><span class="keyword">function</span> (<span class="params">vnode, hydrating</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">debugger</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里务必明确，开始的<code>#app</code>是真实的 dom，而后面的<code>section#box</code>是<code>vnode</code>，这里的参数<code>vnode</code>是指<code>section#box</code>，而<code>vm.$el</code>开始指的是<code>#app</code></p>
<p><img src="https://blog-huahua.oss-cn-beijing.aliyuncs.com/blog/code/vue_source_code11.gif" alt="vue_source_code11.gif"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>当引入 <code>vue</code>，首次渲染的过程大概如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">initMixin(Vue); <span class="comment">// ... 引入vue的时候，Vue.prototype已经挂载了各模块属性和方法。 src/core/instance/init.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123; <span class="attr">el</span>: <span class="string">"#app"</span> &#125;); <span class="comment">// 用户创建vm实例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>._init(options); <span class="comment">// src/core/instance/index.js</span></span><br><span class="line"></span><br><span class="line">vm.$mount(vm.$options.el); <span class="comment">// _init方法里 src/core/instance/init.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">template = getOuterHTML(el);</span><br><span class="line"><span class="keyword">const</span> &#123; render, staticRenderFns &#125; = compileToFunctions(template);</span><br><span class="line">options.render = render;</span><br><span class="line">mount.call(<span class="keyword">this</span>, el, hydrating); <span class="comment">// $mount方法里  compiler这里重点是 将template或者el的dom字符串都会变成render函数，之后才是调用runtime的$mount方法  src/platforms/web/entry-runtime-with-compiler.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mountComponent(<span class="keyword">this</span>, el, hydrating); <span class="comment">// $mount方法里 runtime里，此时this已经有了render函数了 src/platforms/web/runtime/index.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  vm._update(vm._render(), hydrating);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">new</span> Watcher(vm, updateComponent, noop, &#123;&#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>) <span class="comment">// mountComponent方法里 建了一个渲染watcher，执行`vm._update(vm._render(), hydrating)`，_render是返回vnode，_update将这个vnode变成真实dom，然后插入到文档中（渲染），首次渲染，_render其实就是执行参数中的render函数 src/core/instance/lifecycle.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.$options</span><br><span class="line">vnode = render.call(vm._renderProxy, vm.$createElement)</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">return</span> vnode <span class="comment">// _render函数里 src/core/instance/render.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vm.$el = vm.__patch__(vm.$el, vnode) <span class="comment">// _update函数里 __patch__就是创建真实dom和插入到文档中 src/core/instance/lifecycle.js</span></span><br><span class="line"></span><br><span class="line">Vue.prototype.__patch__ = inBrowser ? patch : noop <span class="comment">// __patch__就是patch方法  src/platforms/web/runtime/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> patch: <span class="built_in">Function</span> = createPatchFunction(&#123; nodeOps, modules &#125;)</span><br><span class="line"><span class="comment">// web下的patch由createPatchFunction生成 src/platforms/web/runtime/patch.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPatchFunction</span>(<span class="params">backend</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; modules, nodeOps &#125; = backend</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createElm</span> (<span class="params"> vnode, insertedVnodeQueue, parentElm, refElm</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> data = vnode.data</span><br><span class="line">    <span class="keyword">const</span> children = vnode.children</span><br><span class="line">    <span class="keyword">const</span> tag = vnode.tag</span><br><span class="line">    nodeOps.createElement(tag, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span> (<span class="params">oldVnode, vnode, hydrating, removeOnly</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> oldElm = oldVnode.elm</span><br><span class="line">    <span class="comment">// 缓存 旧的dom 父元素</span></span><br><span class="line">    <span class="keyword">const</span> parentElm = nodeOps.parentNode(oldElm)</span><br><span class="line">    <span class="comment">// create new node 根据新的vnode创建dom 并在父元素里旧元素前面插入新的dom</span></span><br><span class="line">    createElm( vnode, insertedVnodeQueue, parentElm, nodeOps.nextSibling(oldElm) )</span><br><span class="line">    <span class="comment">// 移除旧的dom</span></span><br><span class="line">    removeVnodes(parentElm, [oldVnode], <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// 返回 新的dom</span></span><br><span class="line">    <span class="keyword">return</span> vnode.elm</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="comment">// 这里的生成patch函数利用不同平台的modules,但patch的逻辑却相似 src/core/vdom/patch.js</span></span><br></pre></td></tr></table></figure>
<p>这里在借助黄轶老师的图，表示从主线上把模板和数据如何渲染成最终的 DOM 的过程：</p>
<p><img src="https://ustbhuangyi.github.io/vue-analysis/assets/new-vue.png" alt="new-vue.png"></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li><a href="https://coding.imooc.com/lesson/228.html#mid=14869">黄轶老师的 vue2 源码解密课程</a></li>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/v2/data-driven/">vue.js 技术揭秘</a></li>
<li><a href="https://my.oschina.net/dongwj/blog/4415074">Snabbdom 的使用</a></li>
</ul>
-->
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/js/" rel="tag"># js</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/06/22/radio_component/" rel="next" title="用vue简单封装单选组件">
                <i class="fa fa-chevron-left"></i> 用vue简单封装单选组件
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/07/01/hyper-script/" rel="prev" title="h函数为什么叫h？">
                h函数为什么叫h？ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2021/06/23/vue_source_code_2/"
           data-title="数据驱动 - 学习vue源码系列2" data-url="http://yoursite.com/2021/06/23/vue_source_code_2/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://omizt4opc.bkt.clouddn.com/avatar.jpg"
               alt="frontzhm" />
          <p class="site-author-name" itemprop="name">frontzhm</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">258</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">39</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#new-Vue-发生了什么"><span class="nav-number">2.</span> <span class="nav-text">new Vue 发生了什么</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#小技巧：增加调试"><span class="nav-number">2.1.</span> <span class="nav-text">小技巧：增加调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么能-this-message"><span class="nav-number">2.2.</span> <span class="nav-text">为什么能 this.message</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vue-实例挂载的实现"><span class="nav-number">3.</span> <span class="nav-text">Vue 实例挂载的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#web-entry-runtime-with-compiler-js"><span class="nav-number">3.1.</span> <span class="nav-text">web/entry-runtime-with-compiler.js</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小技巧：只有非正式环境，才有-warn"><span class="nav-number">3.1.1.</span> <span class="nav-text">小技巧：只有非正式环境，才有 warn</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小技巧：判断元素是不是-body-或者-html"><span class="nav-number">3.1.2.</span> <span class="nav-text">小技巧：判断元素是不是 body 或者 html</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小技巧：先处理异常情况"><span class="nav-number">3.1.3.</span> <span class="nav-text">小技巧：先处理异常情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小技巧：el-可以是字符串，也可以是元素的写法"><span class="nav-number">3.1.4.</span> <span class="nav-text">小技巧：el 可以是字符串，也可以是元素的写法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小技巧：在已有的函数上增加新功能"><span class="nav-number">3.1.5.</span> <span class="nav-text">小技巧：在已有的函数上增加新功能</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mount：platforms-web-runtime-index-js"><span class="nav-number">3.2.</span> <span class="nav-text">$mount：platforms/web/runtime/index.js</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#render"><span class="nav-number">4.</span> <span class="nav-text">render</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#理解-vnode-和-patch"><span class="nav-number">5.</span> <span class="nav-text">理解 vnode 和 patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码中的createElement，返回的是vnode"><span class="nav-number">6.</span> <span class="nav-text">源码中的createElement，返回的是vnode</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#children-规范化"><span class="nav-number">6.1.</span> <span class="nav-text">children 规范化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小技巧：扁平化二维数组"><span class="nav-number">6.1.1.</span> <span class="nav-text">小技巧：扁平化二维数组</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#update其实大部分功能就是patch"><span class="nav-number">7.</span> <span class="nav-text">update其实大部分功能就是patch</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">frontzhm</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"frontzhm"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
